<!DOCTYPE html>
<html>
 mywebglflightspace a program  by NGUYEN.Chung (freeware 2015) <br />
 H key: help 
 "https://b3d8783ddc02a86af1ce60266a06c20f1a961f99.nogoogledrive.com/host/0B6GM9ay7ImZLOXpiUkx5bFhacXc/mywebglflightspace.html" 
<head>
<title>mywebglflightspace sim</title>
<link id="ico" rel="shortcut icon" href="soleilbright.ico">
<!--link rel="shortcut icon" href="http://sites.google.com/site/chungkn1400/mywebglflight/mywebglflight.ico"-->
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
</head>
<body   onunload="close();"  bgcolor="#C0C0FF" onKeyUp="keyup(event);" onKeyDown="keydown(event);" onmousedown=""  onmouseup="" onmousemove="">
    <br />
	<div id="divmsg" >
    <textarea rows="1" cols="40" id="msg">loading...</textarea>
	</div>
	<div style="position:absolute;top:7910px;left:10px;zindex:4;">
	<input type="text"  onblur="resetkeys();" id="intext" maxlength="1" size="1" value=""/>
	</div>
	<div id="mydiv2" style="position:absolute;top:7900px;left:0px;z-index:300;" >
	<canvas id="canvasmsg" style="border:none;top:0px;left:0px;" width="600" height="400"></canvas>
	</div>
	<div id="mydiv" style="position:absolute;top:7900px;left:0px;zindex:1;">
    <canvas id="canvas" style="border: none;top:0px;left:0px;" width="620" height="419"></canvas><!--620x419-->
	<br />
	</div>
	<div id="divbutton" style="position:absolute;top:8310px;left:0px;z-index:150;">
	<button id="reset"  onclick="subreset();">reset</button>
	<button id="fullscreen"  onclick="sizescreen();">fullscreen</button>
	<button id="loadsave"  onclick="subloadsave();">loadsave</button>
	<input type="text"  id="clock" maxlength="2" size="2" value="18:05"/>
	<input type="text"  id="intext0" maxlength="85" size="78" value=""/>
    <br />
    </div>
	<div id="mapdiv" style="position:absolute;top:100px;left:0px;width:100%;height:100%;">
    </div>	
    <div id="radiodiv" style="position:absolute;top:6000px;left:0px;width:40px;height:20px;">>	
    <iframe id="radio" src="" style="width:40px;height:20px;"></iframe>
	</div>
	<div id="savediv" style="position:absolute;top:4000px;left:0px;width:100%;height:100%;">
<button id="load"  onclick="subload();">load</button>
<button id="save"  onclick="subsave();">save</button>
<button id="delete"  onclick="subdelete();">delete</button>
<button id="export"  onclick="subexport();">export</button>
<button id="import"  onclick="subimport();">import</button>
<button id="quit"  onclick="gamesavequit=1;">quit</button>
<br/><br/>
<div id="gamesave">
<input type="checkbox" id="save0check" name="gamesave" value="new" />new 
<input type="text" id="save0text" name="gamesavetext" value="newname" size=47 />
<input type="text" id="save0date" name="gamesavedate" value="date" size=20 /><br/>
</div>
<input type="file" id="gamesavefiles" name="files[]" hidden />
    </div>
<!-- replace nogoogle / google to enable googleapi -->
<!--script src="https://maps.nogoogleapis.com/maps/api/js?v=3&libraries=places&language=en" type="text/javascript" ></script-->
<!--script type="text/javascript" src="https://www.nogoogle.com/jsapi"></script-->
<!--script type="text/javascript" src="https://b3d8783ddc02a86af1ce60266a06c20f1a961f99.nogoogledrive.com/host/0B6GM9ay7ImZLOXpiUkx5bFhacXc/jscompile_chung.js"></script-->
<script type="text/javascript" src="jscompile_chung.js"></script>
<script type="text/javascript" src="gamesave.js"></script>
<script type="text/javascript" src='https://code.responsivevoice.org/responsivevoice.js'></script>
<script type="text/javascript" >
var canvasmsg = document.getElementById('canvasmsg');
var contextmsg = canvasmsg.getContext('2d');
function clearinfomsg(){
contextmsg.clearRect (0,0,canvasmsg.width,canvasmsg.height);
}
function printinfomsg(msg){
contextmsg.clearRect (0,0,canvasmsg.width,canvasmsg.height);
contextmsg.font = "12pt Arial";
contextmsg.fillStyle = '#009900';
contextmsg.fillText(msg,canvasmsg.width*0.4,20);
}
function printinfomsg2(){
contextmsg.clearRect (0,0,canvasmsg.width,canvasmsg.height);
contextmsg.font = "11pt Arial";
contextmsg.fillStyle = '#00ff00';
contextmsg.fillText("info",30,30);
if(iinfo>0){
 for(var i=1;i<=iinfo;i++){
   contextmsg.fillText(textinfo[i],xinfo[i]-20,yinfo[i]-20);}}
}
var urlradio="https://chungswebsite.blogspot.fr/p/blog-page_20.html";
var folderradio="https://b3d8783ddc02a86af1ce60266a06c20f1a961f99.nogoogledrive.com/host/0B6GM9ay7ImZLOXpiUkx5bFhacXc/mp3player/";
folderradio="";//replace with your custom folder
function startradio(){
 urlradio=folderradio+"radio_mp3.html"
 document.getElementById('radio').src=urlradio;	
}
var waitkey=0;
function subreset(){
x=0;y=0;z=30;
document.getElementById('intext').focus();
}
var tcompile=0;//tcompile=1;//
var cssscale=1/1,cssscaley=1/1;
var lat=48,lng=2,city="Paris";
var flytolat=lat,flytolng=lng,flytoname="flyto";
function subcombo20(){
var o1=0;
if (combotext=="flyto"){lat=flytolat;lng=flytolng;}
if (combotext=="deauville marinas"){lat=49.36198047661674   ;lng=0.07262960190958628   ;o1=120;}
if (combotext=="deauville plage"){lat=49.35600551121942   ;lng=0.06075459446313726   ;o1=110;}
if (combotext=="trouville plage"){lat=49.36663106706898   ;lng=0.07818353983048315   ;o1=130;}
if (combotext=="nancy"){lat=48.69306979368741   ;lng=6.182922715725031   ;o1=70;}
if (combotext=="crickvenica"){lat=45.1734569955986   ;lng=14.689314428610118   ;o1=-110;}
if (combotext=="paris tolbiac"){lat=48.826125291730506   ;lng=2.3570559500472212   ;o1=0;}
if (combotext=="paris defense"){lat=48.891977155490395   ;lng=2.237673523003608   ;o1=160;}
if (combotext=="ivry romain roland"){lat=48.80346335679542   ;lng=2.3934673532940915   ;o1=-50;}
if (combotext=="orsay"){lat=48.706787   ;lng=2.180894999999964   ;o1=-30;}
if (combotext=="le barcares"){lat=42.78764305091493   ;lng=3.0338932951133533   ;o1=175;} 
if (combotext=="jerusalem"){lat=31.776636707589287   ;lng=35.2337121963501   ;o1=36.3920;}
if (combotext=="marseille"){lat=43.2803905;lng=5.405139   ;o1=36.3920;}
if (combotext=="nice"){lat=43.7031905;lng=7.252817  ;o1=36.3920;}
if (combotext=="arcachon"){lat=44.6514284;lng=-1.171656  ;o1=36.3920;}
if (combotext=="grenoble"){lat=45.1841656;lng=5.7155425 ;o1=36.3920;}
if (combotext=="san francisco"){lat=37.7577;lng=-122.4376 ;o1=36.3920;}
if (combotext=="new york"){lat=40.7033121;lng=-73.97968 ;o1=36.3920;}
if (combotext=="atlanta"){lat=33.7677129;lng=-84.42060 ;o1=36.3920;}
if (combotext=="rio"){lat=-22.8650853;lng=-43.13109 ;o1=36.3920;}
if (combotext=="hong kong"){lat=22.3700556;lng=114.153758 ;o1=36.3920;}
if (combotext=="athenes"){lat=37.9908372;lng=23.7383394 ;o1=36.3920;}
if (combotext=="perth"){lat=-31.9546529;lng=115.852662 ;o1=36.3920;}
if (combotext=="le caire"){lat=30.04441959;lng=31.23571160;o1=36.3920;}
if (combotext=="washington"){lat=38.8850399;lng=-77.08054296;o1=36.3920;}
if (combotext=="tajmahal"){lat=27.17015;lng=78.002155;o1=36.3920;}
}
//nogoogle.load("search", "1");
//nogoogle.load("jquery", "1.4.2");
//nogoogle.load("jqueryui", "1.7.2");
var auxvar=null,auxvar2=null,auxtext="";
/*if (nogoogle.loader.ClientLocation) {
    lat = nogoogle.loader.ClientLocation.latitude;
    lng = nogoogle.loader.ClientLocation.longitude;
	city= nogoogle.loader.ClientLocation.address.city;
	//alert(city);
}*/
var MERCATOR_RANGE = 256;
function degreesToRadians(deg) {
  return deg * (Math.PI / 180);
}
function radiansToDegrees(rad) {
  return rad / (Math.PI / 180);
}
var pixeloriginx=MERCATOR_RANGE / 2;
var pixeloriginy=MERCATOR_RANGE / 2;
var pixelsPerLonDegree = MERCATOR_RANGE / 360;
var pixelsPerLonRadian = MERCATOR_RANGE / (2 * Math.PI);

var pointx=0,pointy=0,worldx=0,worldy=0,zoom=13;
function MercatorLatLngtoPoint(lat,lng) {
  pointx = pixeloriginx + lng * pixelsPerLonDegree;
  // NOTE(appleton): Truncating to 0.9999 effectively limits latitude to
  // 89.189.  This is about a third of a tile past the edge of the world tile.
  var siny=Math.min(Math.max(Math.sin(degreesToRadians(lat)),-0.9999),0.9999);
  pointy = pixeloriginy+0.5*Math.log((1+siny)/(1-siny))*pixelsPerLonRadian;  
};

function MercatorPointtoLatLng(pointx,pointy) {
  lng=(pointx-pixeloriginx)/pixelsPerLonDegree;
  var latRadians = (pointy-pixeloriginy)/pixelsPerLonRadian;
  lat=radiansToDegrees(2*Math.atan(Math.exp(latRadians))-Math.PI/2);
};
function getlatlng(zoom,worldx,worldy){
pointx = worldx / Math.pow(2,zoom);
pointy = worldy / Math.pow(2,zoom);
MercatorPointtoLatLng(pointx,pointy);
}
function getworldxy(zoom,lat,lng){
MercatorLatLngtoPoint(lat,lng);
worldx=pointx*Math.pow(2,zoom);
worldy=pointy*Math.pow(2,zoom);
}
function getmap(zoom,lat,lng,size,type0,scale){
var type=type0;
if(type=="jpg"){type="jpg-baseline";}
var mapstyle="&style=feature:road%7Cvisibility:off&style=element:labels%7Cvisibility:off&style=element:geometry.stroke%7Cvisibility:off";
return "https://maps.nogoogleapis.com/maps/api/staticmap?center="+lat+","+lng+"&zoom="+zoom+"&scale="+scale+"&size="+size+"x"+size+"&maptype=satellite&format="+type+mapstyle;
//var mapstyle="&style=feature:road%7Cvisibility:on&style=element:labels%7Cvisibility:off&style=element:geometry.stroke%7Cvisibility:off";
//return "https://maps.nogoogleapis.com/maps/api/staticmap?center="+lat+","+lng+"&zoom="+zoom+"&scale="+scale+"&size="+size+"x"+size+"&maptype=hybrid&format="+type+mapstyle;
} 
function getterrain(zoom,lat,lng,size,type0,scale){
var type=type0;
if(type=="jpg"){type="jpg-baseline";}
//var mapstyle="&style=element:all%7Cvisibility:off";
//mapstyle+="&style=element:geometry.fill%7Cvisibility:on";
//mapstyle+="&style=feature:road%7Cvisibility:off";
var mapstyle="&style=feature:road%7Cvisibility:off&style=element:labels%7Cvisibility:off&style=element:geometry.stroke%7Cvisibility:off";
return "https://maps.nogoogleapis.com/maps/api/staticmap?center="+lat+","+lng+"&zoom="+zoom+"&scale="+scale+"&size="+size+"x"+size+"&maptype=terrain&format="+type+mapstyle;
} 
</script>
<script type="text/javascript">
var folder="http://sites.google.com/site/chungkn1400/mywebglflight/";
var folderdrive="https://b3d8783ddc02a86af1ce60266a06c20f1a961f99.nogoogledrive.com/host/0B6GM9ay7ImZLOXpiUkx5bFhacXc/";
folder="";
var myurl=document.location.href;
//if(myurl.indexOf("mywebglflightlocal")>0){
 folder="";//set this to use local sound folder
 folderdrive="";
//}
var test=0;if(folder==""){test=1;};
var timer0=0,timer1=0;
function timer(){
return Date.now();
//return (new Date()).getTime();//ms
}
function sleep(dt){
var t=timer(),dt1=Math.min(20000,dt);while(timer()<(t+dt1)){}}
function submsg(text){
 document.getElementById("msg").value=text;
 //document.getElementById("divmsg").innerHTML;
}
var head = document.getElementsByTagName('head')[0];
var tjsload=0,jsfilelist=[],njsfile=0,jslist=[],tloading=[];
function addjavascript(jsfilepath){
submsg("addjavascript("+jsfilepath+")");
jslist[njsfile]=document.createElement("script");
var js=jslist[njsfile];
js.type = "text/javascript";
js.src = folder+jsfilepath;
js.async=false;
//js.onreadystatechange = jscallback;
tjsload+=1;jsfilelist[njsfile]=jsfilepath;
var i=njsfile;
tloading[i]=1;
js.onload = function(){setTimeout("jscallback();",100);
              setTimeout("deletejsfile("+i+");",4000);
			  tloading[i]=0;
			  };
njsfile+=1;
head.appendChild(js);
var t=timer()+30,dt=0;
while(timer()<t){dt=0;}
/*if(jsfilepath.indexOf("objtxt.js")>=0 ||
   jsfilepath.indexOf("oog.js")>=0 ||
   jsfilepath.indexOf("wav.js")>=0 ||
   jsfilepath.indexOf("mp3.js")>=0 ||
   jsfilepath.indexOf("jpg.js")>=0 ||
   jsfilepath.indexOf("png.js")>=0){head.removeChild(js);}*/
}
function msgloading(){
  for(var i=0;i<njsfile;i++){
    if(tloading[i]==1){submsg("loading "+jsfilelist[i]);break;}
  }
}
function deletejsfile(i){
var msg="",err="",jsfile="";
jsfile=jsfilelist[i];
     if(jsfile.indexOf("objtxt.js")>=0 ||
        jsfile.indexOf("oog.js")>=0 ||
        jsfile.indexOf("wav.js")>=0 ||
	    jsfile.indexOf("mp3.js")>=0 ||
		jsfile.indexOf("jpg.js")>=0 ||
		jsfile.indexOf("256.js")>=0 ||
		jsfile.indexOf("/srtm/")>=0 ||
		jsfile.indexOf("png.js")>=0){
      if(jsfile.substr(jsfile.length-3,3)==".js"){
	    jsfile=jsfile.substr(0,jsfile.length-3);
		//try{eval(jsfile+"=null;");}catch(e){err+="/"+jsfile;}
		try{head.removeChild(jslist[i]);}catch(e){err+="/js:"+jsfile;}
		msg+="/"+jsfile;
		};}
}
function deletejsfilelist(){
  var msg="",err="",jsfile="";
  for(var i=0;i<njsfile;i++){jsfile=jsfilelist[i];
     if(jsfile.indexOf("objtxt.js")>=0 ||
        jsfile.indexOf("oog.js")>=0 ||
        jsfile.indexOf("wav.js")>=0 ||
	    jsfile.indexOf("mp3.js")>=0 ||
		jsfile.indexOf("jpg.js")>=0 ||
		jsfile.indexOf("png.js")>=0){
      if(jsfile.substr(jsfile.length-3,3)==".js"){
	    jsfile=jsfile.substr(0,jsfile.length-3);
		try{eval(jsfile+"=null;");}catch(e){err+="/"+jsfile;}
		try{head.removeChild(jslist[i]);}catch(e){err+="/js:"+jsfile;}
		msg+="/"+jsfile;
		};}
  };
  //alert(msg);
  //alert("err="+err);
}
function addjavascripttext(jstext){
submsg("addjavatext("+jstext+")");
var js = document.createElement("script");
js.type = "text/javascript";
if(tcompile==1){
 js.text = compile(document.getElementById(jstext).text);
}else{
 js.text = document.getElementById(jstext).text;
}
js.async=0;
head.appendChild(js);
}
function jscallback(){tjsload-=1;
   if(tjsload==0){setTimeout("addmain();",100);};}
var twebaudio=0;
function addmain(){   
   addjavascripttext("main0");
   if(window.AudioContext || window.webkitAudioContext){
      twebaudio=1;
	  setTimeout('addjavascripttext("webaudio");',400);
   }else{
      twebaudio=0;
	  setTimeout('addjavascripttext("htmlaudio");',400);
	  }	  
   setTimeout('addjavascripttext("main2");',1200);
   }
addjavascript("glMatrix-0.9.5.min.js");
//addjavascript("glMatrix-0.9.6.js");
addjavascript("webgl-utils.js");
addjavascript("seedrandom.min.js");
addjavascript("vk_keys.js");
addjavascript("base64binary.js");
addjavascript("c150objtxt.js");
addjavascript("c150jpg.js");
addjavascript("map2jpg.js");
addjavascript("cloudpng.js");
addjavascript("sunpng.js");
addjavascript("bousspng.js");
addjavascript("c150redjpg.js");
addjavascript("piste12jpg.js");
addjavascript("tower1jpg.js");
addjavascript("tower1nightjpg.js");
addjavascript("c150minus6objtxt.js");
addjavascript("c150cockpit4png.js");
addjavascript("compas256jpg.js");
//addjavascript("helice2jpg.js");
addjavascript("arrowpng.js");
addjavascript("waterjpg.js");
addjavascript("treejpg.js");
addjavascript("tree14jpg.js");
addjavascript("tree1jpg.js");
addjavascript("sunback2jpg.js");
addjavascript("radar2png.js");
addjavascript("azimut2png.js");
addjavascript("explosionjpg.js");
addjavascript("impactjpg.js");
/*addjavascript("shipobjtxt.js");
addjavascript("shipjpg.js");
addjavascript("bloodjpg.js");
addjavascript("spitfirelowobjtxt.js");
addjavascript("spitfirejpg.js");
addjavascript("spitfirecockpitobjtxt.js");
addjavascript("zeroobjtxt.js");
addjavascript("zerojpg.js");*/
addjavascript("f14cockpitobjtxt.js");
/*addjavascript("shipcarrierobjtxt.js");
addjavascript("shipcarrierjpg.js");
*/
addjavascript("avion2mp3.js");
addjavascript("pneump3.js");
addjavascript("shootmp3.js");
addjavascript("explosionmp3.js");

/*addjavascript("yougo256.js");
addjavascript("grece256.js");
addjavascript("hawai256.js");
addjavascript("japan256.js");
addjavascript("egypt256.js");
addjavascript("vietnam256.js");*/
addjavascript("skydomeobjtxt.js");
addjavascript("skydomejpg.js");
addjavascript("skydome2jpg.js");
addjavascript("skydome3jpg.js");
addjavascript("waterseajpg.js");
addjavascript("viseurpng.js");
addjavascript("rainmp3.js");
addjavascript("rainjpg.js");
addjavascript("skydome4jpg.js");
addjavascript("thundermp3.js");
//addjavascript("sailshipjpg.js");
//addjavascript("sailshipobjtxt.js");
//addjavascript("crickreliefjpg.js");
//addjavascript("crick256jpg.js");
addjavascript("airporttower256png.js");
/*addjavascript("tankobjtxt.js");
addjavascript("tankjpg.js");*/
addjavascript("jet4mp3.js");
addjavascript("alphajetobjtxt.js");
addjavascript("alphajetcockpitobjtxt.js");
addjavascript("alphajetjpg.js");

/*addjavascript("eiffeltowerpng.js");
addjavascript("libertystatuepng.js");
addjavascript("christriopng.js");
addjavascript("domerockpng.js");
addjavascript("gizahpng.js");
addjavascript("capitolepng.js");
addjavascript("tajmahalpng.js");
addjavascript("buddahpng.js");*/
addjavascript("horse00jpg.js");
addjavascript("horse00objtxt.js");
addjavascript("horse01objtxt.js");
addjavascript("horse02objtxt.js");
addjavascript("horsemp3.js");
addjavascript("elephant00jpg.js");
addjavascript("elephant00objtxt.js");
addjavascript("elephant01objtxt.js");
addjavascript("elephant02objtxt.js");
addjavascript("elephantmp3.js");
addjavascript("girafe00jpg.js");
addjavascript("girafe00objtxt.js");
addjavascript("girafe01objtxt.js");
addjavascript("girafe02objtxt.js");
addjavascript("zebra00jpg.js");
addjavascript("birdjpg.js");
addjavascript("birdobjtxt.js");
addjavascript("bird2objtxt.js");
addjavascript("antilope00objtxt.js");
addjavascript("antilope01objtxt.js");
addjavascript("antilope02objtxt.js");
addjavascript("antilope00jpg.js");
addjavascript("cloudblackpng.js");
/*addjavascript("chevyjpg.js");
addjavascript("volantjpg.js");
*/
addjavascript("watermp3.js");
addjavascript("crashmp3.js");
addjavascript("carmp3.js");

addjavascript("rocjpg.js");
addjavascript("rocobjtxt.js");
//addjavascript("rpmpng.js");
addjavascript("starposition1000.js");
addjavascript("spaceshipobjtxt.js");
addjavascript("explodemp3.js");
addjavascript("fighterobjtxt.js");
setTimeout("msgloading();",20000);
</script> 
<script type="text" id="main0">
var weatherurl="http://api.openweathermap.org/data/2.5/weather?lat=48&lon=2";
var wclouds=20;
/*var xmlhttp;
function httpGet(theUrl,callback) 
{
	if (window.XMLHttpRequest)
    {// code for IE7+, Firefox, Chrome, Opera, Safari
        xmlhttp=new XMLHttpRequest();
    }
    else
    {// code for IE6, IE5
        xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
    }
    xmlhttp.onreadystatechange=function()
    {
        if (xmlhttp.readyState==4 && xmlhttp.status==200)
        {callback(xmlhttp.responseText);
        }
    }
    xmlhttp.open("GET", theUrl, false);
    xmlhttp.send();    
} 
function getlatlong(responseText){
            var respdata=(responseText);
			var i=respdata.indexOf('"lat"'),j=0;
			var data=respdata.substr(i+5,40);
			i=data.indexOf(':');j=data.indexOf(',');
			lat=eval(data.substring(i+1,j));
			i=respdata.indexOf('"lng"');
			data=respdata.substr(i+5,40);
			i=data.indexOf(':');j=data.indexOf('}');
			lng=eval(data.substring(i+1,j));
			//alert(respdata.substr(200,400));
			//alert(lat+"/"+lng);
			weatherurl="http://api.openweathermap.org/data/2.5/weather?lat="+lat+"&lon="+lng;
			setTimeout("httpGet(weatherurl,getweather);",70);
}			
function getweather(responseText){
            var weatherdata=(responseText);
			var i=weatherdata.indexOf('"clouds":'),j=0;
			var data=weatherdata.substr(i+10,100);
			i=data.indexOf(':');j=data.indexOf('}');
			wclouds=eval(data.substring(i+1,j));
			//alert(weatherdata.substr(200,400));
			//alert("wclouds="+wclouds);
}	
try{		
//httpGet("http://api.hostip.info/get_json.php?position=true",getlatlong);
weatherurl="http://api.openweathermap.org/data/2.5/weather?lat="+lat+"&lon="+lng;
httpGet(weatherurl,getweather);
}catch (e){wclouds=Math.sqrt(Math.random())*Math.random()*90;}
*/
wclouds=Math.sqrt(Math.random())*Math.random()*90;
var tjoy="getGamepads" in navigator,joy=null,button=new Array(17);
var joyx=0,joyy=0,joyz=0,joyr=0,timejoy=0,timebutt=new Array(17);
for(var i=0;i<17;i++){timebutt[i]=0;}
function testjoystick(){
 for(var i=1;i<17;i++){button[i]=0;}
 joyx=0;joyy=0;joyz=0;joyr=0;
 if(!tjoy){return;}
 joy=navigator.getGamepads()[0];
 if(!joy){return}
 var butt=null,nbutt=joy.buttons.length;
 if(nbutt>16){nbutt=16;}
 for(var i=0;i<nbutt;i++){
   if(tframe>timebutt[i+1]){
	butt=joy.buttons[i];
    if (typeof(butt)=="object"){if(butt.pressed){button[i+1]=1;};
	   }else{if(butt==1.0){button[i+1]=1;};}
   }	   
 }
 var naxes=joy.axes.length; 
 if(naxes>0){joyx=joy.axes[0]-1;if(Math.abs(joyx)<0.09){joyx=0;};}
 if(naxes>1){joyy=joy.axes[1]-1;if(Math.abs(joyy)<0.09){joyy=0;};}
 if(naxes>2){joyr=joy.axes[2]-1;if(Math.abs(joyr)<0.09){joyr=0;};}
 if(naxes>3){joyz=joy.axes[3];if(Math.abs(joyz)<0.09){joyz=0;};}
}
function b(i){if(button[i]==1){
  timebutt[i]=tframe+150;button[i]=0;return 1;
}else{return 0;};}
//var irnd=0,nrnd=50000,random=new Array(nrnd);
//for(var i=0;i<nrnd;i++){random[i]=Math.random();}
function Mathrandom(){return Math.random();
//  irnd+=1;if(irnd>=nrnd){irnd=0;};
//  return random[irnd];
}
var seedrand=parseInt(new Date().getTime());
Math.seedrandom(seedrand);
</script>
<script type="text" id="webaudio" >
var audioctx = new (window.AudioContext || window.webkitAudioContext)();
var songlength;
function loadsound(source,url){
source.request = new XMLHttpRequest();
source.request.open('GET', url, true);
source.request.responseType = 'arraybuffer';
source.request.onload = function() {
var audioData = source.request.response;
audioctx.decodeAudioData(audioData, function(buffer) {
//myBuffer = buffer;
songlength = buffer.duration;
source.buffer = buffer;
source.playbackRate.value = 1.0;
//source.connect(audioctx.destination);
source.loopStart=0.5;
source.loopEnd=songlength-0.5;
source.gainNode = audioctx.createGain();
source.connect(source.gainNode);
source.gainNode.connect(audioctx.destination);
source.gainNode.gain.value = 1.0;
if(source.onload){source.onload();}
},
function(e){alert("Error with decoding audio data" + e.err);});
}
source.request.send();
}
function loadsound64(source,data){
var audioData = Base64Binary.decodeArrayBuffer(data.split(",")[1]);
audioctx.decodeAudioData(audioData, function(buffer) {
//myBuffer = buffer;
songlength = buffer.duration;
source.buffer = buffer;
source.playbackRate.value = 1.0;
//source.connect(audioctx.destination);
source.loopStart=0.5;
source.loopEnd=songlength-0.5;
source.gainNode = audioctx.createGain();
source.connect(source.gainNode);
source.gainNode.connect(audioctx.destination);
source.gainNode.gain.value = 1.0;
if(source.onload){source.onload();}
audioData=null;
},
function(e){alert("Error with decoding audio data" + e.err);});
}
function setvol(source,vol){
  if(source.gainNode){source.gainNode.gain.value = vol;}
}
function setspeed(source,speed){
  if(source.playbackRate){source.playbackRate.value=speed;}
}
function playloop(source){source.loop=true;source.start(0);}
function playsound(source) {if(!source.gainNode){return;}
  var sourcex = audioctx.createBufferSource(); // creates a sound source
  sourcex.buffer = source.buffer;  // tell the source which sound to play
  sourcex.loop=false;
  if(source.playbackRate){
     if(sourcex.playbackRate){sourcex.playbackRate.value=source.playbackRate.value;}
  }	 
  sourcex.connect(source.gainNode);       // connect the source to the audioctx's destination (the speakers)
  sourcex.start(0);                           // play the source now                                           // note: on older systems, may have to use deprecated noteOn(time);
}
var wav="mp3",browser="";
if(navigator.userAgent.toLowerCase().indexOf('firefox') > -1){wav="ogg";browser="firefox";};
//if(navigator.userAgent.toLowerCase().indexOf('chrome') > -1){wav="wav";};
//alert(navigator.userAgent+" "+wav);
var audiosrc="";
/*var myaudio = audioctx.createBufferSource();
myaudio.volume=0;
loadsound64(myaudio,avion2mp3);
myaudio.onload=function(){
 setTimeout("playloop(myaudio);",300);
 setTimeout("setvol(myaudio,0.3);",300);
 setTimeout("setspeed(myaudio,1.0);",300);
 }*/
var myaudiojet = audioctx.createBufferSource();
myaudiojet.volume=0;
loadsound64(myaudiojet,jet4mp3);
myaudiojet.onload=function(){
 setTimeout("playloop(myaudiojet);",320);
 setTimeout("setvol(myaudiojet,0.3);",320);
 setTimeout("setspeed(myaudiojet,1.0);",320);
 }
/*var myaudiocar = audioctx.createBufferSource();
myaudiocar.volume=0;
loadsound64(myaudiocar,carmp3);
myaudiocar.onload=function(){
 setTimeout("playloop(myaudiocar);",340);
 setTimeout("setvol(myaudiocar,0.03);",340);
 setTimeout("setspeed(myaudiocar,1.0);",340);
 }*/
var myaudiopneu = audioctx.createBufferSource();
//audiosrc=folder+"pneu."+wav;
myaudiopneu.volume=0;
loadsound64(myaudiopneu,pneump3);
myaudiopneu.onload=function(){
 setTimeout("playsound(myaudiopneu);",500);
 setTimeout("setvol(myaudiopneu,0.4);",500);
 setTimeout("setspeed(myaudiopneu,1.0);",500);
 }
var tsoundpneu=0;
function soundpneu(){
 if(tframe>tsoundpneu+700.350){
   tsoundpneu=tframe;
   playsound(myaudiopneu);
 }}
var myaudioshoot = audioctx.createBufferSource();
//audiosrc=folder+"shoot."+wav;
myaudioshoot.volume=0;
loadsound64(myaudioshoot,shootmp3);
myaudioshoot.onload=function(){
 setTimeout("playloop(myaudioshoot);",500);
 setTimeout("setvol(myaudioshoot,0.002);",500);
 setTimeout("setspeed(myaudioshoot,1.0);",500);
 }
var tshoot=0;
function soundshoot(){
   tshoot=tframe+750;
   }
var myaudioexplosion = audioctx.createBufferSource();
//audiosrc=folder+"explosion."+wav;
myaudioexplosion.volume=0;
loadsound64(myaudioexplosion,explosionmp3);
myaudioexplosion.onload=function(){
 setTimeout("playsound(myaudioexplosion);",700);
 setTimeout("setvol(myaudioexplosion,0.3);",500);
 setTimeout("setspeed(myaudioexplosion,0.70);",500);
 }
var texplosion=0;
function soundexplosion(){
   if(timer()>texplosion+100){
     texplosion=timer();
     playsound(myaudioexplosion);
}} 
var myaudioexplode = audioctx.createBufferSource();
//audiosrc=folder+"explode."+wav;
myaudioexplode.volume=0;
loadsound64(myaudioexplode,explodemp3);
myaudioexplode.onload=function(){
 //setTimeout("playsound(myaudioexplode);",700);
 setTimeout("setvol(myaudioexplode,0.6);",500);
 setTimeout("setspeed(myaudioexplode,0.97);",500);
 }
var texplode=0;
function soundexplode(){
   if(timer()>texplode+500){
     texplode=timer();
     playsound(myaudioexplode);
}} 
var myaudiorain = audioctx.createBufferSource();
//audiosrc=folder+"rain."+wav;
myaudiorain.volume=0;
loadsound64(myaudiorain,rainmp3);
myaudiorain.onload=function(){
 //setTimeout("playloop(myaudiorain);",800);
 setTimeout("setvol(myaudiorain,0.3);",700);
 setTimeout("setspeed(myaudiorain,1.0);",700);
 }
var tsoundrain=0;
function soundrain(){
   if(tframe>tsoundrain+4500){tsoundrain=tframe;
      setvol(myaudiorain,0.37);
	  playsound(myaudiorain);}
   }
function stopsoundrain(){
   if(tframe<tsoundrain+4500){tsoundrain=0;setvol(myaudiorain,0.002);}
}
var myaudiothunder = audioctx.createBufferSource();
//audiosrc=folder+"thunder."+wav;
myaudiothunder.volume=0;
loadsound64(myaudiothunder,thundermp3);
myaudiothunder.onload=function(){
 setTimeout("playsound(myaudiothunder);",900);
 setTimeout("setvol(myaudiothunder,0.7);",800);
 setTimeout("setspeed(myaudiothunder,1.0);",800);
 }
var tthunder=0;
function soundthunder(){
   playsound(myaudiothunder);
   } 
var myaudiohorse = audioctx.createBufferSource();
myaudiohorse.volume=0;
loadsound64(myaudiohorse,horsemp3);
myaudiohorse.onload=function(){
 //setTimeout("playsound(myaudiohorse);",900);
 setTimeout("setvol(myaudiohorse,0.4);",800);
 setTimeout("setspeed(myaudiohorse,1.0);",800);
 }
var tsoundhorse=0;
function soundhorse(){
 if(tframe>tsoundhorse+700){
   tsoundhorse=tframe;
   setspeed(myaudiohorse,1.0);
   setvol(myaudiohorse,0.25);
   playsound(myaudiohorse);
 };} 
function soundgirafe(){
 if(tframe>tsoundhorse+700){
   tsoundhorse=tframe;
   setspeed(myaudiohorse,1.05);
   setvol(myaudiohorse,0.25);
   playsound(myaudiohorse);
 };} 
function soundzebra(){
 if(tframe>tsoundhorse+700){
   tsoundhorse=tframe;
   setspeed(myaudiohorse,1.0);
   setvol(myaudiohorse,0.25);
   playsound(myaudiohorse);
 };} 
function soundantilope(){
 if(tframe>tsoundhorse+700){
   tsoundhorse=tframe;
   setspeed(myaudiohorse,1.04);
   setvol(myaudiohorse,0.25);
   playsound(myaudiohorse);
 };} 
var myaudioelephant = audioctx.createBufferSource();
myaudioelephant.volume=0;
loadsound64(myaudioelephant,elephantmp3);
myaudioelephant.onload=function(){
 //setTimeout("playsound(myaudioelephant);",900);
 setTimeout("setvol(myaudioelephant,0.4);",800);
 setTimeout("setspeed(myaudioelephant,1.0);",800);
 }
var tsoundelephant=0;
function soundelephant(){
 if(tframe>tsoundelephant+700){
   tsoundelephant=tframe;
   setvol(myaudioelephant,0.3);
   playsound(myaudioelephant);
 };} 
var myaudiowater = audioctx.createBufferSource();
myaudiowater.volume=0;
loadsound64(myaudiowater,watermp3);
myaudiowater.onload=function(){
 //setTimeout("playsound(myaudiowater);",900);
 setTimeout("setvol(myaudiowater,0.4);",800);
 setTimeout("setspeed(myaudiowater,1.0);",800);
 }
var tsoundwater=0;
function soundwater(){
 if(tframe>tsoundwater+700){
   tsoundwater=tframe;
   setvol(myaudiowater,0.4);
   playsound(myaudiowater);
 }else{planedo2+=Math.min(350,(350-Math.abs(tframe-tsoundwater-350)))/500;
 }} 
var myaudiocrash = audioctx.createBufferSource();
myaudiocrash.volume=0;
loadsound64(myaudiocrash,crashmp3);
myaudiocrash.onload=function(){
 //setTimeout("playsound(myaudiocrash);",900);
 setTimeout("setvol(myaudiocrash,0.4);",800);
 setTimeout("setspeed(myaudiocrash,1.0);",800);
 }
var tsoundcrash=0;
function soundcrash(){
 if(tframe>tsoundcrash+2000){
   tsoundcrash=tframe;
   setvol(myaudiocrash,0.4);
   playsound(myaudiocrash);
 };} 
function closewebaudio(){
  //myaudio.buffer=null;
  myaudiojet.buffer=null;
  myaudiopneu.buffer=null;
  myaudioshoot.buffer=null;
  myaudioexplosion.buffer=null;
  myaudioexplode.buffer=null;
  myaudiorain.buffer=null;
  myaudiothunder.buffer=null;
  myaudiohorse.buffer=null;
  myaudioelephant.buffer=null;
  myaudiowater.buffer=null;
  myaudiocrash.buffer=null;
}   
</script>
<script type="text" id="htmlaudio" >
var wav="mp3",browser="";
if(navigator.userAgent.toLowerCase().indexOf('firefox') > -1){wav="ogg";browser="firefox";};
//if(navigator.userAgent.toLowerCase().indexOf('chrome') > -1){wav="wav";};
//alert(navigator.userAgent+" "+wav);
var myaudio = new Audio();
myaudio.src=folder+"jet4."+wav;//"avion2."+wav;
myaudio.volume=0.3;
myaudio.play();
myaudio.loop=true;
var myaudio1 = new Audio();
myaudio1.src=folder+"jet4."+wav;//"avion2."+wav;
myaudio1.volume=0.3;
setTimeout("myaudio1.play();",4000);
myaudio1.loop=true;
var myaudio2 = new Audio();
myaudio2.src=folder+"jet44."+wav;//"avion22."+wav;
myaudio2.volume=0.3;
setTimeout("myaudio2.play();",2000);
myaudio2.loop=true;
var myaudio21 = new Audio();
myaudio21.src=folder+"jet44."+wav;//"avion22."+wav;
myaudio21.volume=0.3;
setTimeout("myaudio21.play();",6000);
myaudio21.loop=true;
var audio=null,audiosrc=null,tsoundwait=0;
function playsound(mymp3){
audio= new Audio();
audiosrc =mymp3; 
audio.src=audiosrc;
audio.volume=1.0;
audio.addEventListener('canplay',function(){audio.play();setTimeout('tsoundwait=0;',200);});
audio.load();
}
var myaudiopneu = new Audio()
myaudiopneu.src=folder+"pneu2."+wav;
myaudiopneu.volume=0.002;
myaudiopneu.loop=true;
myaudiopneu.play();
var tpneu=0;
function soundpneu(){
   //tsoundwait=1;
   //setTimeout('playsound(folder+"pneu."+wav);',200);
   tpneu=timer()+750;
   }
//soundpneu();   
var myaudioshoot = new Audio()
myaudioshoot.src=folder+"shoot."+wav;
myaudioshoot.volume=0.002;
myaudioshoot.loop=true;
myaudioshoot.play();
var tshoot=0;
function soundshoot(){
   tshoot=tframe+750;
   }
var myaudioexplode=[],iaudioexplode=0;
function soundexplode(){
iaudioexplode+=1;
var i=iaudioexplode;
myaudioexplode[i]=new Audio();
myaudioexplode[i].src=folder+"explode."+wav;
myaudioexplode[i].volume=0.9;
myaudioexplode[i].loop=false;
myaudioexplode[i].play();
setTimeout('myaudioexplode['+i+'].src="";',8000);
};
function soundexplosion(){};
function soundrain(){};
function stopsoundrain(){};
function soundthunder(){};
function soundhorse(){};
function soundgirafe(){};
function soundzebra(){};
function soundantilope(){};
function soundelephant(){};
var tsoundwater=0;
function soundwater(){};
function soundcrash(){};
</script>
<script type="text/javascript">
var tshoot=0,tpneu=0;
function soundshoot(){};
function soundpneu(){};
function soundexplosion(){};
function soundrain(){};
function stopsoundrain(){};
function soundthunder(){};
function soundhorse(){};
function soundgirafe(){};
function soundzebra(){};
function soundantilope(){};
function soundelephant(){};
var tsoundwater=0;
function soundwater(){};
function soundcrash(){};
</script>
<script id="vshader2d" type="x-shader/x-vertex">
    attribute vec3 a_position;
    varying vec2 v_texcoord;
	uniform float u_texscalex,u_texscaley; 
	uniform float u_textdx,u_textdy;
    uniform float u_scalex,u_scaley;	
	uniform float u_dx,u_dy;

    void main() {
	  float x=u_dx+a_position.x*u_scalex*0.025*(1.0+abs(u_dx));
      float y=u_dy+a_position.y*u_scaley*0.025*(1.0+abs(u_dy));
	  gl_Position = vec4(x,y,a_position.z,1.0);
      v_texcoord.x = u_textdx+a_position.x*0.02*u_texscalex+0.5;
      v_texcoord.y = u_textdy+a_position.y*0.02*u_texscaley+0.5;
    }   
</script>
<script id="fshader2d" type="x-shader/x-fragment">
precision mediump float;
varying vec2 v_texcoord;
uniform sampler2D u_sampler;
uniform vec4 ucolor;
void main() {
    gl_FragColor = texture2D(u_sampler, v_texcoord);
		if(ucolor.a>0.001){
		 gl_FragColor.a+=ucolor.a;
		 gl_FragColor.r+=ucolor.r;
		 gl_FragColor.g+=ucolor.g;
		 gl_FragColor.b+=ucolor.b;
		} 		
}
</script>
<script id="shader-fs" type="x-shader/x-fragment">
    precision mediump float;
	//precision highp float;

    varying vec2 vTextureCoord;
	varying float color;

    uniform sampler2D uSampler;
	uniform vec4 ucolor;
	uniform float ucolormin;
	uniform float ushadow;

    void main(void) {
        gl_FragColor = texture2D(uSampler, vTextureCoord);
		if(ucolor.a>0.001){
	     if(gl_FragColor.a<0.5 ||
     	   ((gl_FragColor.r+gl_FragColor.g+gl_FragColor.b)<ucolormin)){discard;}
		 else{
		 float color2;
		 color2=color;
		 if(ucolor.a<9.0){gl_FragColor.a*=ucolor.a;
		   gl_FragColor.r*=ucolor.r*color2;
		   gl_FragColor.g*=ucolor.g*color2;
		   gl_FragColor.b*=ucolor.b*color2;
		 }else if(ucolor.a>20.0){
		    if(gl_FragColor.r>0.9){discard;}
			else{
		    gl_FragColor.a*=ucolor.a-20.0;
		    gl_FragColor.r*=ucolor.r*color2;
		    gl_FragColor.g*=ucolor.g*color2;
		    gl_FragColor.b*=ucolor.b*color2;
			}
		 }else if(ucolor.a>9.0){
		    //color2*=0.5+0.5*gl_FragColor.r;
		    gl_FragColor.a*=ucolor.a-10.0;
		 }
		 if(ushadow>-1.9){
		   float t=(vTextureCoord.y-0.5)*2.0;
		   t=sqrt(1.04-t*t);
		   if(vTextureCoord.x<(0.5+ushadow*t)){
		     gl_FragColor.rgb*=0.6;}
		   else if(vTextureCoord.x>(0.5+(1.0+ushadow)*t)){
		     gl_FragColor.rgb*=0.6;}
		   }
		 }
		}		 		
    }
</script>
<script id="shader-fssky" type="x-shader/x-fragment">
    precision mediump float;
	//precision highp float;

    varying vec2 vTextureCoord;
	varying float color;

    uniform sampler2D uSampler;
	uniform float uhour;
	uniform vec4 ucolor;

    void main(void) {
        gl_FragColor = texture2D(uSampler, vTextureCoord);
		float k,k1,v;
		v=vTextureCoord.y;
		k=(abs(12.0-uhour))/19.5;
		k=max(0.0,min(1.0,(1.0-v)*3.5*k));
		k1=1.0-k;
		gl_FragColor.r= (k*gl_FragColor.r + k1*ucolor.r); 
		gl_FragColor.g= (k*gl_FragColor.g + k1*ucolor.g); 
		gl_FragColor.b= (k*gl_FragColor.b + k1*ucolor.b); 
    }
</script>
<script id="shader-vs" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec2 aTextureCoord;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;

    varying vec2 vTextureCoord;
	varying float color;


    void main(void) {
        //gl_Position = uPMatrix * (uMVMatrix * vec4(aVertexPosition, 1.0));
        gl_Position = (uMVMatrix * vec4(aVertexPosition, 1.0));
        vTextureCoord = aTextureCoord;
		color=min(1.15,0.75+abs(gl_Position.y*0.65));
    }
</script>
<script id="shader-fstree" type="x-shader/x-fragment">
    precision mediump float;
	//precision highp float;

    varying vec2 vTextureCoord;

    uniform sampler2D uSampler;

    void main(void) {
	   if(vTextureCoord.x>-1.0){
        gl_FragColor = texture2D(uSampler, vTextureCoord);
		if(gl_FragColor.r>0.7){discard;};
	   }else{discard;};	
    }
</script>
<script id="shader-vstree" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec2 aTextureCoord;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
	uniform float ucos1;
	uniform float usin1;

    varying vec2 vTextureCoord;

    void main(void) {
	    float x=aVertexPosition.x;
	    float y=aVertexPosition.y;
	    float z=aVertexPosition.z;
		//if(z<0.15 || z>20.0){vTextureCoord.x=-2.0;
		if(z<0.15){vTextureCoord.x=-2.0;
		  gl_Position = uPMatrix * (uMVMatrix * vec4(x,y,z, 1.0)); 
		}else{
		if(int(mod(floor((x+y)*100.0),20.0))==1){
		 if(aTextureCoord.x<0.2){x-=usin1*2.0;y+=ucos1*2.0;z-=0.7;}
		 else if(aTextureCoord.x>0.8){x+=usin1*2.0;y-=ucos1*2.0;z-=0.7;}
		 else{z+=2.7;}
		}else{
		 if(aTextureCoord.x<0.2){x-=usin1;y+=ucos1;}
		 if(aTextureCoord.x>0.8){x+=usin1;y-=ucos1;}
        }
		//gl_Position = uPMatrix * (uMVMatrix * vec4(x,y,z, 1.0));
		gl_Position = (uMVMatrix * vec4(x,y,z, 1.0));
        vTextureCoord = aTextureCoord;
		};
    }
</script>
<script id="shader-fssol" type="x-shader/x-fragment">
    precision mediump float;
	//precision highp float;

    varying vec2 vTextureCoord;
    varying vec2 vTextureCoord2;
	varying float color;

    uniform sampler2D uSampler;
    uniform sampler2D uSampler2;
	uniform float hour;
	uniform vec4 ucolor;

    void main(void) {
	 float color0;
	 if(color<9000.0){color0=color;}
	 else if(color<19000.0){color0=color-10000.0;}
	 else {color0=(color-20000.0);}
	 if(color0<-1.0){discard;}else{
	 if(color0>99.0){gl_FragColor=vec4(0.2,0.6,0.9,1.0);
	 }else{
	   if((hour<6.0 || hour>18.0)&& color<19000.0){
	          gl_FragColor = texture2D(uSampler, vTextureCoord);
              float color2=color0*(1.0-0.37*(abs(12.0-hour)-4.0)/8.0);
	          if(color>9000.0){color2*=0.5+0.5*gl_FragColor.r;}
			  gl_FragColor.rgb*=color2;
	   }else{
		float color2=color0;
		vec4 fcolor2=texture2D(uSampler2, vTextureCoord2);
		gl_FragColor = texture2D(uSampler, vTextureCoord);
		//if(vTextureCoord2.x>0.0 && vTextureCoord2.x<1.0){
  		//  if(vTextureCoord2.y>0.0 && vTextureCoord2.y<1.0){
		//    test=1;}}
		//if(test==1){
		  //color2=max(0.25,color0/(1.0+(fcolor2.r+fcolor2.g+fcolor2.b)*9.0));
		  //color2=max(0.25,color0/(1.0+(3.0-fcolor2.r-fcolor2.g-fcolor2.b)*9.0));
		  if(color<19000.0){
		    color2=max(0.15,color0/(1.0+(3.0-fcolor2.r-fcolor2.g-fcolor2.b)*4.0));
		  }//else{
		  //  color2=max(0.15,color0*(fcolor2.r+fcolor2.g+fcolor2.b));
		  //}
		  //color2=max(0.25,color0*(fcolor2.r+fcolor2.g+fcolor2.b)/3.0);
        //}
		//gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
        //if(abs(color2-1.0)>0.001){
		    if(color>9000.0){
			  if(color<19000.0){
     			color2*=0.5+0.5*gl_FragColor.r;gl_FragColor.g*=1.2;
			    gl_FragColor.rgb*=0.1+color2*fcolor2.rgb;
			  }else{
			    gl_FragColor.rgb*=0.1+color2*3.0*fcolor2.rgb;
			  }
			}else{gl_FragColor.rgb*=0.1+color2;}
			//gl_FragColor.g*=0.1+color2*fcolor2.g;
			//gl_FragColor.b*=0.1+color2*fcolor2.b;
        /*}else{
		      color2=max(0.15,color0);
		      if(color>9000.0){color2*=0.5+0.5*gl_FragColor.r;gl_FragColor.g*=1.2;}
		      gl_FragColor.rgb*=0.1+color2;
			  };*/
	   }
	 }
	 gl_FragColor*=ucolor;
     }	 
    }
</script>
<script id="shader-vssol" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec2 aTextureCoord;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
	uniform float xmin;
	uniform float xmax;
	uniform float ymin;
	uniform float ymax;
	uniform float x0;
	uniform float y0;
	uniform int type;

    varying vec2 vTextureCoord;
    varying vec2 vTextureCoord2;
	varying float color;


    void main(void) {
	    float x=aVertexPosition.x;
	    float y=aVertexPosition.y;
	    float z=aVertexPosition.z;
        if(type<4 || type==6){		
		 if(x<xmin){x+=xmax-xmin;}
		 if(x>xmax){x-=xmax-xmin;}
		 if(y<ymin){y+=ymax-ymin;}
		 if(y>ymax){y-=ymax-ymin;}
		}
		color=0.0;
		if(type==3 || type==6){
		 if(x<x0 || x>(x0+xmax-xmin)){color=-2.0;}
		 if(y<y0 || y>(y0+ymax-ymin)){color=-2.0;}
		} 
       if(color>=-1.0){		
		if(type==0 || type==3 || type==6){color=1.0;}
		else if(type==5){
		  if(z<9.0){color=1.0;}else{color=1.0+(z-8.8)*0.034;if(color>1.9){color=1.9;};};}
		else{
		  if(z<9.0){color=1.0;}else{color=1.0+(z-8.8)*0.1;if(color>1.9){color=1.9;};};}
		float xpiste=(xmax-xmin)*0.5;
        float ypiste=(ymax-ymin)*0.5;		
		if(type==1 || type==3 || type==6){
		 if(abs(x-xpiste)<62.0){
		   if(abs(y-ypiste)<62.0){//z=0.1+max(0.0,-10.0+30.0*floor(z/30.0));
		                          color*=1.9;};}
		 float dxwater=x-(xpiste+500.0);//waterx
		 float dywater=y-(ypiste-400.0);
		 float distwater=dxwater*dxwater+dywater*dywater;
		 if((distwater)<10000.0){z=-0.53;color=0.7;if(distwater<7000.0){color=99.7;};};
		};
        //gl_Position = uPMatrix * (uMVMatrix * vec4(x,y,z, 1.0));
        gl_Position = (uMVMatrix * vec4(x,y,z, 1.0));
        if(type!=3 && type!=6){vTextureCoord=aTextureCoord;
		}else{
		   vTextureCoord.x=(x-x0)/(xmax-xmin);
           vTextureCoord.y=(y-y0)/(ymax-ymin);
		   }
		if(type==4){color=1.07;}//airport   
        if(type!=6){
		 float distshadow=300.0;		
		 vTextureCoord2.y=0.5+(x-(xmax+xmin)*0.5)*0.5/distshadow;
		 vTextureCoord2.x=0.5-(y-(ymax+ymin)*0.5)*0.5/distshadow;
	   }else{
	     float distshadow=300.0;		
		 vTextureCoord2.y=0.5+(x)/distshadow;
		 vTextureCoord2.x=0.5-(y)/distshadow;
	   }
	   }
	   if(type==3 || type==4){color+=10000.0;}
	   else if(type==6){color+=20000.0;}
	}
</script>
	<script id="shader-vsb" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec2 aTextureCoord;

    uniform vec3 usunPosition;
    uniform vec3 ucameraPosition;
    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
	uniform float usize;
	uniform vec4 ucolor;	

    varying vec2 vTextureCoord;
	varying float alpha,r,g,b;


/*    void main(void) {
        gl_Position = uPMatrix * (uMVMatrix * (vec4(aVertexPosition, 1.0)));
        vTextureCoord = aTextureCoord;
		}
		*/
void main() {
        //alpha=abs(aTextureCoord.x)*0.3;if(alpha>1.0){alpha=1.0;};
        alpha=abs(aTextureCoord.y)*0.25;if(alpha>1.0){alpha=1.0;};
		float color=1.2-abs(aTextureCoord.x*usize)*0.2;if(color<0.1){color=0.1;};
		float distcloud=length(aVertexPosition - ucameraPosition);
		color*=(20.0+distcloud)/(4.0+distcloud);
		if(usize<0.0){color=1.0;};//sun
    	if(aTextureCoord.x>0.0){vTextureCoord.x=1.0;}else{vTextureCoord.x=0.0;}
    	if(aTextureCoord.y>0.0){vTextureCoord.y=1.0;}else{vTextureCoord.y=0.0;}
		vec3 worldPosition = aVertexPosition;
		//vec3 ucameraPosition2=uMVMatrix[3].xyz;
		vec3 eyeVector = normalize(worldPosition - ucameraPosition);
        float time=(usunPosition.z-ucameraPosition.z+30.0)*0.4/300.0;
		float distsun=length(usunPosition-worldPosition);
		//if(distsun>500.0){distsun=500.0;};
		float dist=length(normalize(usunPosition-ucameraPosition)-eyeVector);
		if(distsun>200.0){time*=0.8*(dist);}else{time*=1.0;alpha=1.0;};
		if(time>1.0){time=1.0;};
		if(time<0.0){time=0.0;};
		alpha*=ucolor.a;//(2.0-time);
		r=(3.0-2.0*time)*color*ucolor.r;
		g=time*color*ucolor.g;
		b=time*color*ucolor.b;

		vec3 CamUp= vec3(0.0,0.0,1.0);
		vec3 sideVector = normalize(cross(eyeVector,CamUp));
		vec3 upVector = normalize(cross(sideVector,eyeVector));

		float width = 30.0*usize;
		float height = 15.0*usize;
        int type=0;
        type=int(floor(mod(abs(aTextureCoord.x*100.0),2.0)));
        if(type==0){	
		worldPosition += sideVector * (aTextureCoord.x * width);
		}else{
		worldPosition -= sideVector * (aTextureCoord.x * width);
		}
        type=int(floor(mod(abs(aTextureCoord.y*100.0),2.0)));
        if(type==0){	
		worldPosition += upVector * (aTextureCoord.y+0.5*(abs(aTextureCoord.y)-1.0)) * height;
		}else{
		worldPosition -= upVector * (aTextureCoord.y-0.5*(abs(aTextureCoord.y)-1.0)) * height;
		}

		//gl_Position = uPMatrix *(uMVMatrix *  vec4( worldPosition, 1.0 ));
		gl_Position = (uMVMatrix *  vec4( worldPosition, 1.0 ));
    //gl_Position = uPMatrix * uMVMatrix *  vec4( aVertexPosition, 1.0 );
    }
	</script>
	<script id="shader-fsb" type="x-shader/x-fragment">
    precision mediump float;
	//precision highp float;

    varying vec2 vTextureCoord;
	varying float alpha,r,g,b;

    uniform sampler2D uSampler;

    void main(void) {
        //gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
        gl_FragColor = texture2D(uSampler, vTextureCoord);
		gl_FragColor.a*=alpha;
		gl_FragColor.r*=r;
		gl_FragColor.g*=g;
		gl_FragColor.b*=b;
    }
	</script>
<script id="shader-fsstar" type="x-shader/x-fragment">
    precision mediump float;
	//precision highp float;
    uniform float ualpha;
    void main(void) {
        gl_FragColor = vec4(1.0,1.0,1.0,ualpha);
    }
</script>
<script id="shader-vsstar" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec2 aTextureCoord;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
	uniform float ucos1;
	uniform float usin1;
	uniform float usin2;

    void main(void) {
	    float x=aVertexPosition.x;
	    float y=aVertexPosition.y;
	    float z=aVertexPosition.z;
		float r=aTextureCoord.x;
		if(r<-0.1){x+=usin1*r;y-=ucos1*r;
		}else if(r>0.1){x+=usin1*r;y-=ucos1*r;
		}else{r=aTextureCoord.y;
		      x-=ucos1*r*usin2;y-=usin1*r*usin2;
		      z+=r*1.25*sqrt(ucos1*ucos1+usin1*usin1);}
        //gl_Position = uPMatrix * (uMVMatrix * vec4(x,y,z, 1.0));
        gl_Position = (uMVMatrix * vec4(x,y,z, 1.0));
    }
</script>

<script type="text" id="main2" >

    var gl;
	var canvas;

    //window.onunload=close;
	//window.onbeforeunload=close;
    var tclose=0,timeoutkey=null,timeouttick=null;
	function subquit(){
        savecookie();
	    close();
    	//alert("bye");
	    document.location.href="http://chung.blogvie.com/links/";
		//document.location.href="https://www.nogoogle.com/search?q=mywebglflight&rct=j";
	                   //http://chungswebsite.blogspot.fr/search/label/mywebglflight";
	}				   
	function close(){
	try{
	//clearTimeout(timeoutkey);
	clearTimeout(timeouttick);
	if(tclose<2){tclose=3;
	closesounds();
	//return;// "bye bye";
	deletetextures();
	deletejsfilelist();
	}}catch(e){};
	//alert("close end");
	}
	function closesounds(){
	if(twebaudio==1){closewebaudio();return;}
	myaudio.pause();myaudio.src="";
	myaudio1.pause();myaudio1.src="";
	myaudio2.pause();myaudio2.src="";
	myaudio21.pause();myaudio21.src="";
	myaudiopneu.pause();myaudiopneu.src="";
	myaudioshoot.pause();myaudioshoot.src="";
	audio.pause();audio.src="";
    }
	var fullscreen=0,winx=0,winy=900,windx=620,windy=419,windx0=windx,windy0=windy;
	var windxmax=620,windymax=430,winwidth=620,winheight=430;
	scrollTo(0,0);
	winy=document.getElementById("mydiv").getBoundingClientRect().top;
	winx=document.getElementById("mydiv").getBoundingClientRect().left;
	//canvas.width  = (1/cssscale)*Math.min(canvas.width,window.innerWidth-20);
    //canvas.height = (1/cssscaley)*Math.min(canvas.height,window.innerHeight-36);
    document.getElementById("intext0").size=Math.min(85,parseInt((window.innerWidth-212)/8));
	//windx = canvas.width;
    //windy = canvas.height;
	windxmax=window.innerWidth-20;
	windymax=window.innerHeight-36;
	winwidth=window.innerWidth;
	winheight=window.innerHeight;
	function sizescreen(){
	    if(fullscreen==0){fullscreen=1;
		                  canvas.width  = parseInt(window.innerWidth*0.98);
                          canvas.height = parseInt(window.innerHeight*0.94);
						 }else{fullscreen=0;
						  canvas.width=620;canvas.height=430;};
	if(cssscale<1){cssscale=1;}
	if(cssscale>4){cssscale=4;}
	if(cssscaley<1){cssscaley=1;}
	if(cssscaley>4){cssscaley=4;}
	//cssscale=1.3;
	//cssscaley=1.3;
	canvasmsg.width  = Math.min(canvas.width,window.innerWidth-20);
    canvasmsg.height = Math.min(canvas.height,window.innerHeight-36);
	windx0=canvasmsg.width;
	windy0=canvasmsg.height;
	canvas.width  = Math.min(canvas.width,window.innerWidth-20);
    canvas.height = Math.min(canvas.height,window.innerHeight-36);
	var width0=canvas.width,height0=canvas.height;
	canvas.width=parseInt(canvas.width*(1/cssscale));
	canvas.height=parseInt(canvas.height*(1/cssscaley));
	var cssscale1=width0/canvas.width;
	var cssscaley1=height0/canvas.height;
			gl.viewportWidth = canvas.width;
            gl.viewportHeight = canvas.height;
			windx = canvas.width;
            windy = canvas.height;
            gl.viewport(0, 0, windx,windy);
            document.getElementById("canvas").setAttribute("style",
	         "border: none;top:0px;left:0px;-ms-transform: scale("+cssscale1+","+cssscaley1+"); /* IE 9 */-webkit-transform: scale("+cssscale+","+cssscaley+"); /* Chrome, Safari, Opera */transform: scale("+cssscale+","+cssscaley+");-ms-transform-origin: 0 0;-webkit-transform-origin: 0 0;transform-origin: 0 0;z-index:100;");
	         //"border: red 1px solid;top:0px;left:0px;-ms-transform: scale("+cssscale+",1); /* IE 9 */-webkit-transform: scale("+cssscale+",1); /* Chrome, Safari, Opera */transform: scale("+cssscale+",1);-ms-transform-origin: 0 0;-webkit-transform-origin: 0 0;transform-origin: 0 0;";
            document.getElementById("canvasmsg").setAttribute("style",
	         "border: none;top:0px;left:0px;z-index:300;");
            document.getElementById("intext0").size=Math.min(85+40,parseInt((window.innerWidth-212+100)/8));
            document.getElementById("divbutton").setAttribute("style",
	         "position:absolute;top:"+parseInt(winy+windy*cssscaley+2)+"px;left:0px;");
			 waitkey=0;
 }
var cssscale0=cssscale,cssscaley0=cssscaley;
function subscale(scale){return;
cssscale0=cssscale;cssscaley0=cssscaley;
cssscale*=scale;cssscaley*=scale;
fullscreen-=1;sizescreen();
cssscale=cssscale0;cssscaley=cssscaley0;
} 
function subcssscale(){ 
var crlf=String.fromCharCode(10),msg="";
var cssx0=cssscale,cssy0=cssscaley;  
  if(cssscale<=1){cssscale=1.2;
  }else if(cssscale<=1.2+0.01){cssscale=1.4;
  }else if(cssscaley<=1){cssscaley=1.2;
  }else if(cssscaley<=1.2+0.01){cssscaley=1.4;
  }else{cssscale=1;cssscaley=1;}
  msg="cssscalex="+cssscale;
  if(cssscale==1){msg+=" normal";}
  if(Math.abs(cssscale-1.2)<0.01){msg+=" lowerres,faster";}
  if(Math.abs(cssscale-1.4)<0.01){msg+=" more lowerres,faster";}
  msg+=crlf+"cssscaley="+cssscaley;
  if(cssscaley==1){msg+=" normal";}
  if(Math.abs(cssscaley-1.2)<0.01){msg+=" lowerres,faster";}
  if(Math.abs(cssscaley-1.4)<0.01){msg+=" more lowerres,faster";}
  
  if(confirm("set cssscale to "+crlf+crlf+msg+crlf+"?")){
    fullscreen-=1;sizescreen();
  }else{cssscale=cssx0;cssscaley=cssy0;}	
}
	/*var winwidth=620,winheight=419;
	scrollTo(0,0);
	winy=document.getElementById("mydiv").getBoundingClientRect().top;
	winx=document.getElementById("mydiv").getBoundingClientRect().left;
	canvas.width  = Math.min(canvas.width,window.innerWidth-20);
    canvas.height = Math.min(canvas.height,window.innerHeight-36);
    document.getElementById("intext0").size=Math.min(85,parseInt((window.innerWidth-212)/8));
	windx = canvas.width;
    windy = canvas.height;
	winwidth=window.innerWidth;
	winheight=window.innerHeight;
	function sizescreen(){
	    if(fullscreen==0){fullscreen=1;
		                  canvas.width  = window.innerWidth*0.98;
                          canvas.height = window.innerHeight*0.94;
						 }else{fullscreen=0;
						  canvas.width=620;canvas.height=419;};
	canvas.width  = Math.min(canvas.width,window.innerWidth-22);
    canvas.height = Math.min(canvas.height,window.innerHeight-36);
			gl.viewportWidth = canvas.width;
            gl.viewportHeight = canvas.height;
			windx = canvas.width;
            windy = canvas.height;
            gl.viewport(0, 0, windx,windy);
            //document.getElementById("canvas").style.zIndex="1";
            document.getElementById("canvas").setAttribute("style",
	         "border: none;top:0px;left:0px;");
            document.getElementById("intext0").size=Math.min(85,parseInt((window.innerWidth-212)/8));
			waitkey=0;
 }*/					 

    function initGL(canvas) {
        try {
            gl = canvas.getContext("experimental-webgl");
            //gl = canvas.getContext("webgl");
			gl.viewportWidth = canvas.width;
            gl.viewportHeight = canvas.height;
        } catch (e) {
        }
        if (!gl) {
            alert("Could not initialise WebGL, sorry :-(");
        }
    }


    function getShader(gl, id) {
        var shaderScript = document.getElementById(id);
        if (!shaderScript) {
            return null;
        }

        var str = "";
        var k = shaderScript.firstChild;
        while (k) {
            if (k.nodeType == 3) {
                str += k.textContent;
            }
            k = k.nextSibling;
        }

        var shader;
        if (shaderScript.type == "x-shader/x-fragment") {
            shader = gl.createShader(gl.FRAGMENT_SHADER);
        } else if (shaderScript.type == "x-shader/x-vertex") {
            shader = gl.createShader(gl.VERTEX_SHADER);
        } else {
            return null;
        }

        gl.shaderSource(shader, str);
        gl.compileShader(shader);

        if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
            alert(gl.getShaderInfoLog(shader));
            return null;
        }

        return shader;
    }


    var shaderProgram,solProgram,cloudProgram,treeProgram,skyProgram;
	var program2d,starProgram;

    function initShaders() {
        var fragmentShader = getShader(gl, "shader-fs");
        var fragmentShadersky = getShader(gl, "shader-fssky");
        var vertexShader = getShader(gl, "shader-vs");
        var fragmentShadersol = getShader(gl, "shader-fssol");
        var vertexShadersol = getShader(gl, "shader-vssol");
	    var vshadercloud = getShader(gl,"shader-vsb");
	    var fshadercloud = getShader(gl,"shader-fsb");
        var fshadertree = getShader(gl, "shader-fstree");
        var vshadertree = getShader(gl, "shader-vstree");
        var fshader = getShader(gl, "fshader2d");
        var vshader = getShader(gl, "vshader2d");
        var fshaderstar = getShader(gl, "shader-fsstar");
        var vshaderstar = getShader(gl, "shader-vsstar");
	
        program2d = gl.createProgram();
        gl.attachShader(program2d, vshader);
        gl.attachShader(program2d, fshader);
        gl.linkProgram(program2d);

        if (!gl.getProgramParameter(program2d, gl.LINK_STATUS)) {
            alert("Could not initialise shaders2d");
        }

        shaderProgram = gl.createProgram();
        gl.attachShader(shaderProgram, vertexShader);
        gl.attachShader(shaderProgram, fragmentShader);
        gl.linkProgram(shaderProgram);

        if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
            alert("Could not initialise shaders");
        }

        skyProgram = gl.createProgram();
        gl.attachShader(skyProgram, vertexShader);
        gl.attachShader(skyProgram, fragmentShadersky);
        gl.linkProgram(skyProgram);

        if (!gl.getProgramParameter(skyProgram, gl.LINK_STATUS)) {
            alert("Could not initialise skyshaders");
        }
		
        solProgram = gl.createProgram();
        gl.attachShader(solProgram, vertexShadersol);
        gl.attachShader(solProgram, fragmentShadersol);
        gl.linkProgram(solProgram);

        if (!gl.getProgramParameter(solProgram, gl.LINK_STATUS)) {
            alert("Could not initialise solshaders");
        }
        
		cloudProgram = gl.createProgram();
        gl.attachShader(cloudProgram, vshadercloud);
        gl.attachShader(cloudProgram, fshadercloud);
        gl.linkProgram(cloudProgram);

        if (!gl.getProgramParameter(cloudProgram, gl.LINK_STATUS)) {
            alert("Could not initialise cloudshaders");
        }

		treeProgram = gl.createProgram();
        gl.attachShader(treeProgram, vshadertree);
        gl.attachShader(treeProgram, fshadertree);
        gl.linkProgram(treeProgram);

        if (!gl.getProgramParameter(treeProgram, gl.LINK_STATUS)) {
            alert("Could not initialise treeshaders");
        }

		starProgram = gl.createProgram();
        gl.attachShader(starProgram, vshaderstar);
        gl.attachShader(starProgram, fshaderstar);
        gl.linkProgram(starProgram);

        if (!gl.getProgramParameter(starProgram, gl.LINK_STATUS)) {
            alert("Could not initialise starshaders");
        }

        gl.useProgram(program2d);

        program2d.vertexPositionAttribute = gl.getAttribLocation(program2d, "a_position");
        gl.enableVertexAttribArray(program2d.vertexPositionAttribute);

        //program2d.textureCoordAttribute = gl.getAttribLocation(program2d, "a_texcoord");
        //gl.enableVertexAttribArray(program2d.textureCoordAttribute);

        program2d.samplerUniform = gl.getUniformLocation(program2d, "u_sampler");
        program2d.texscalexUniform = gl.getUniformLocation(program2d, "u_texscalex");
        program2d.texscaleyUniform = gl.getUniformLocation(program2d, "u_texscaley");
        program2d.textdxUniform = gl.getUniformLocation(program2d, "u_textdx");
        program2d.textdyUniform = gl.getUniformLocation(program2d, "u_textdy");
        program2d.colorUniform = gl.getUniformLocation(program2d, "ucolor");
        program2d.scalexUniform = gl.getUniformLocation(program2d, "u_scalex");
        program2d.scaleyUniform = gl.getUniformLocation(program2d, "u_scaley");
        program2d.dxUniform = gl.getUniformLocation(program2d, "u_dx");
        program2d.dyUniform = gl.getUniformLocation(program2d, "u_dy");


        gl.useProgram(shaderProgram);

        shaderProgram.vertexPositionAttribute = gl.getAttribLocation(shaderProgram, "aVertexPosition");
        gl.enableVertexAttribArray(shaderProgram.vertexPositionAttribute);

        shaderProgram.textureCoordAttribute = gl.getAttribLocation(shaderProgram, "aTextureCoord");
        gl.enableVertexAttribArray(shaderProgram.textureCoordAttribute);

        shaderProgram.pMatrixUniform = gl.getUniformLocation(shaderProgram, "uPMatrix");
        shaderProgram.mvMatrixUniform = gl.getUniformLocation(shaderProgram, "uMVMatrix");
        shaderProgram.samplerUniform = gl.getUniformLocation(shaderProgram, "uSampler");
        shaderProgram.colorUniform = gl.getUniformLocation(shaderProgram, "ucolor");
        shaderProgram.colorminUniform = gl.getUniformLocation(shaderProgram, "ucolormin");
        shaderProgram.shadowUniform = gl.getUniformLocation(shaderProgram, "ushadow");

        gl.useProgram(skyProgram);

        skyProgram.vertexPositionAttribute = gl.getAttribLocation(skyProgram, "aVertexPosition");
        gl.enableVertexAttribArray(skyProgram.vertexPositionAttribute);

        skyProgram.textureCoordAttribute = gl.getAttribLocation(skyProgram, "aTextureCoord");
        gl.enableVertexAttribArray(skyProgram.textureCoordAttribute);

        skyProgram.pMatrixUniform = gl.getUniformLocation(skyProgram, "uPMatrix");
        skyProgram.mvMatrixUniform = gl.getUniformLocation(skyProgram, "uMVMatrix");
        skyProgram.samplerUniform = gl.getUniformLocation(skyProgram, "uSampler");
        skyProgram.colorUniform = gl.getUniformLocation(skyProgram, "ucolor");
        skyProgram.hourUniform = gl.getUniformLocation(skyProgram, "uhour");

        gl.useProgram(solProgram);

        solProgram.vertexPositionAttribute = gl.getAttribLocation(solProgram, "aVertexPosition");
        gl.enableVertexAttribArray(solProgram.vertexPositionAttribute);

        solProgram.textureCoordAttribute = gl.getAttribLocation(solProgram, "aTextureCoord");
        gl.enableVertexAttribArray(solProgram.textureCoordAttribute);

        solProgram.pMatrixUniform = gl.getUniformLocation(solProgram, "uPMatrix");
        solProgram.mvMatrixUniform = gl.getUniformLocation(solProgram, "uMVMatrix");
        solProgram.samplerUniform = gl.getUniformLocation(solProgram, "uSampler");
        solProgram.samplerUniform2 = gl.getUniformLocation(solProgram, "uSampler2");
        solProgram.xmin = gl.getUniformLocation(solProgram, "xmin");
        solProgram.xmax = gl.getUniformLocation(solProgram, "xmax");
        solProgram.ymin = gl.getUniformLocation(solProgram, "ymin");
        solProgram.ymax = gl.getUniformLocation(solProgram, "ymax");
        solProgram.x0 = gl.getUniformLocation(solProgram, "x0");
        solProgram.y0 = gl.getUniformLocation(solProgram, "y0");
        solProgram.type = gl.getUniformLocation(solProgram, "type");
        solProgram.hour = gl.getUniformLocation(solProgram, "hour");
        solProgram.colorUniform = gl.getUniformLocation(solProgram, "ucolor");

        gl.useProgram(cloudProgram);

        cloudProgram.vertexPositionAttribute = gl.getAttribLocation(cloudProgram, "aVertexPosition");
        gl.enableVertexAttribArray(cloudProgram.vertexPositionAttribute);

        cloudProgram.textureCoordAttribute = gl.getAttribLocation(cloudProgram, "aTextureCoord");
        gl.enableVertexAttribArray(cloudProgram.textureCoordAttribute);

        cloudProgram.pMatrixUniform = gl.getUniformLocation(cloudProgram, "uPMatrix");
        cloudProgram.mvMatrixUniform = gl.getUniformLocation(cloudProgram, "uMVMatrix");
        cloudProgram.cameraPositionUniform = gl.getUniformLocation(cloudProgram, "ucameraPosition");
        cloudProgram.sunPositionUniform = gl.getUniformLocation(cloudProgram, "usunPosition");
        cloudProgram.sizeUniform = gl.getUniformLocation(cloudProgram, "usize");
        cloudProgram.samplerUniform = gl.getUniformLocation(cloudProgram, "uSampler");
        cloudProgram.colorUniform = gl.getUniformLocation(cloudProgram, "ucolor");
		
        gl.useProgram(treeProgram);

        treeProgram.vertexPositionAttribute = gl.getAttribLocation(treeProgram, "aVertexPosition");
        gl.enableVertexAttribArray(treeProgram.vertexPositionAttribute);

        treeProgram.textureCoordAttribute = gl.getAttribLocation(treeProgram, "aTextureCoord");
        gl.enableVertexAttribArray(treeProgram.textureCoordAttribute);

        treeProgram.pMatrixUniform = gl.getUniformLocation(treeProgram, "uPMatrix");
        treeProgram.mvMatrixUniform = gl.getUniformLocation(treeProgram, "uMVMatrix");
        treeProgram.cos1Uniform = gl.getUniformLocation(treeProgram, "ucos1");
        treeProgram.sin1Uniform = gl.getUniformLocation(treeProgram, "usin1");
        treeProgram.samplerUniform = gl.getUniformLocation(treeProgram, "uSampler");
	
        gl.useProgram(starProgram);

        starProgram.vertexPositionAttribute = gl.getAttribLocation(starProgram, "aVertexPosition");
        gl.enableVertexAttribArray(starProgram.vertexPositionAttribute);

        starProgram.textureCoordAttribute = gl.getAttribLocation(starProgram, "aTextureCoord");
        gl.enableVertexAttribArray(starProgram.textureCoordAttribute);

        starProgram.pMatrixUniform = gl.getUniformLocation(starProgram, "uPMatrix");
        starProgram.mvMatrixUniform = gl.getUniformLocation(starProgram, "uMVMatrix");
        starProgram.cos1Uniform = gl.getUniformLocation(starProgram, "ucos1");
        starProgram.sin1Uniform = gl.getUniformLocation(starProgram, "usin1");		
        starProgram.sin2Uniform = gl.getUniformLocation(starProgram, "usin2");		
        starProgram.alphaUniform = gl.getUniformLocation(starProgram, "ualpha");		
	
		}
		
    var texturelist=[],itexturelist=0;
	function handleLoadedTexture00(texture) {
        gl.bindTexture(gl.TEXTURE_2D, texture);
        gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, canvas2);
        //gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        //gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
        gl.bindTexture(gl.TEXTURE_2D, null);
        texture.width=canvas2.width;
		texture.height=canvas2.height;
    }
	function handleLoadedTexture0(texture) {
        gl.bindTexture(gl.TEXTURE_2D, texture);
        gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, texture.image);
        //gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        //gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
        gl.bindTexture(gl.TEXTURE_2D, null);
        texture.width=texture.image.width;
		texture.height=texture.image.height;
		//texture.image.src=null;
    }
	function handleLoadedTexture(texture) {
	    if(texture.image.src==null){return;}
	    handleLoadedTexture0(texture);
		itexturelist+=1;
		texturelist[itexturelist]=texture;
		setTimeout("deleteimagelist("+itexturelist+");",500);
	}
	function deleteimagelist(i){
	    var texture=texturelist[i];
		texture.image.src=null;
	}
    function gettexturedata(texture){
	  // Create a framebuffer backed by the texture
      var framebuffer = gl.createFramebuffer();
      gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);
      gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture, 0);
      // Read the contents of the framebuffer (data stores the pixel data)
      var data = new Uint8Array(texture.width * texture.height * 4);
      gl.readPixels(0,0,texture.width,texture.height,gl.RGBA,gl.UNSIGNED_BYTE,data);
      gl.bindFramebuffer(gl.FRAMEBUFFER, null);
      gl.deleteFramebuffer(framebuffer);
	  return data;
    }
	var earthcolorr=1,earthcolorg=1,earthcolorb=1;
	function getearthcolor(texture){
	    var data=gettexturedata(texture);
		var wx=texture.width,wy=texture.height;
		earthcolorr=1;earthcolorg=1;earthcolorb=1;
		for(var i=-10;i<10;i++){
		  for(var j=-10;j<10;j++){
		    var ij=(parseInt(wx*(0.5+0.3*i/10))*wy+parseInt(wy*(0.5+0.3*j/10)))*4;
			earthcolorr+=(data[ij]/255-earthcolorr)*0.07;
			earthcolorg+=(data[ij+1]/255-earthcolorg)*0.07;
			earthcolorb+=(data[ij+2]/255-earthcolorb)*0.07;
			}}
		data=[];data=null;
	}

    var solTexture,objTexture,cloudTexture,skyTexture,sunTexture,boussTexture;
	var pisteTexture,towerTexture,cockpitTexture,compasTexture,heliceTexture,arrowTexture;
	var waterTexture,treeTexture,radarTexture,azimutTexture,tirTexture,impactTexture;
	var shipTexture,bloodTexture,spitfireTexture,f14Texture,shipcarrierTexture;
	var skydomeTexture,fighterTexture,seaTexture,viseurTexture,rainTexture;
	var sailshipTexture,solTexture2,solTexture1,solTexture3,solTexture4;
	var airporttowerTexture,tankTexture,towernightTexture;
	var alphajetTexture,eiffeltowerTexture,libertystatueTexture;
	var christrioTexture,domerockTexture,gizahTexture,capitoleTexture;
	var tajmahalTexture,buddahTexture,tree2Texture,tree3Texture;
	var horse00Texture,elephant00Texture,girafe00Texture;
	var zebra00Texture,birdTexture,antilope00Texture;
	var cloudblackTexture,carTexture,volantTexture;
	var rocTexture,rpmTexture,soleilTexture,soleilmaskTexture,soleilbrightTexture;
	var soleilwhiteTexture,soleilblueTexture,soleilredTexture;
	var earthTexture,earthmaskTexture,moonTexture,jupiterTexture,venusTexture;
	var mercureTexture,neptunTexture,saturnTexture,saturnmaskTexture;
	var planetTexture,planet2Texture,planet3Texture,europaTexture,marsTexture;
	var ioTexture,spaceshipTexture,voielacteeTexture,plutoTexture;
	var explode0Texture,explode1Texture,explode2Texture,explode3Texture,explode4Texture;
	var compas0Texture,compas1Texture;
	var rttFramebuffer,rttTexture,renderbuffer;

    function gldeleteTexture(texture){
	    if(texture){gl.deleteTexture(texture);
		            texture.image.src=null;
	                };}
	function deletetextures(){
        //cancelRequestAnimationFrame(); 
	    for(var i=1;i<=itexturelist;i++){
		   gldeleteTexture(texturelist[i]);
		}
    }
    function initTexture() {
        solTexture = gl.createTexture();
        solTexture.image = new Image();
        solTexture.image.onload = function () {
            //auxvar=solTexture.image.width;
			handleLoadedTexture(solTexture);
        }
        solTexture.image.src = map2jpg;

		
		/*solTexture1 = gl.createTexture();
        solTexture1.image = new Image();
        solTexture1.image.onload = function () {
            //auxvar=solTexture1.image.width;
			//canvastext.drawImage(solTexture1.image,0,0,1024,1024);
			handleLoadedTexture(solTexture1);
			//setTimeout("solTexture1.image.src=null;",300);
        }

        //lat=45.1734569955986;lng=14.6893;
		if(tgmap==1){treinitgmap=timer()+22000;}
		//combotext="trouville plage";subcombo2();
		//combotext="crickvenica";subcombo2();
		zoom=13;
        //solTexture1.image.crossOrigin = "anonymous";
        //solTexture1.image.src = getmap(zoom,lat,lng,512,"png",2);//map2jpg;
        solTexture1.image.src = crick256jpg;//1024jpg;//map2jpg;

        solTexture2 = gl.createTexture();
        solTexture2.image = new Image();
        solTexture2.image.onload = function () {
			handleLoadedTexture(solTexture2);
			solTexture2.data=gettexturedata(solTexture2);
			solTexture2.datasize=parseInt(Math.sqrt(solTexture2.data.length/4));
            treinitgmap=timer()+1000;
			//auxvar=solTexture2.datasize;
		}
        //solTexture2.image.crossOrigin = "anonymous";
        //solTexture2.image.src = getterrain(zoom,lat,lng,512,"jpg",1);//map2jpg;
        solTexture2.image.src = crickreliefjpg;//map2jpg;

		solTexture3 = gl.createTexture();
        solTexture3.image = new Image();
        solTexture3.image.onload = function () {
			handleLoadedTexture(solTexture3);
        }

        solTexture3.image.src = crick256jpg;//1024jpg;//map2jpg;
		
		solTexture4 = gl.createTexture();
        solTexture4.image = new Image();
        solTexture4.image.onload = function () {
			handleLoadedTexture(solTexture4);
        }

        solTexture4.image.src = crick256jpg;//1024jpg;//map2jpg;
        */
        objTexture = gl.createTexture();
        objTexture.image = new Image();
        objTexture.image.onload = function () {
            handleLoadedTexture(objTexture)
        }

        objTexture.image.src = c150jpg;

        objTexture2 = gl.createTexture();
        objTexture2.image = new Image();
        objTexture2.image.onload = function () {
            handleLoadedTexture(objTexture2)
        }

        objTexture2.image.src = c150redjpg;
        
        cloudTexture = gl.createTexture();
        cloudTexture.image = new Image();
        cloudTexture.image.onload = function () {
            handleLoadedTexture(cloudTexture)
        }

        cloudTexture.image.src = cloudpng;
		
        sunTexture = gl.createTexture();
        sunTexture.image = new Image();
        sunTexture.image.onload = function () {
            handleLoadedTexture(sunTexture)
        }

        sunTexture.image.src = sunpng;
		
        boussTexture = gl.createTexture();
        boussTexture.image = new Image();
        boussTexture.image.onload = function () {
            handleLoadedTexture(boussTexture)
        }

        boussTexture.image.src = bousspng;

        pisteTexture = gl.createTexture();
        pisteTexture.image = new Image();
        pisteTexture.image.onload = function () {
            handleLoadedTexture(pisteTexture)
        }

        pisteTexture.image.src = piste12jpg;

        towerTexture = gl.createTexture();
        towerTexture.image = new Image();
        towerTexture.image.onload = function () {
            handleLoadedTexture(towerTexture)
        }

        towerTexture.image.src = tower1jpg;

        towernightTexture = gl.createTexture();
        towernightTexture.image = new Image();
        towernightTexture.image.onload = function () {
            handleLoadedTexture(towernightTexture)
        }

        towernightTexture.image.src = tower1nightjpg;

        cockpitTexture = gl.createTexture();
        cockpitTexture.image = new Image();
        cockpitTexture.image.onload = function () {
            handleLoadedTexture(cockpitTexture)
        }

        cockpitTexture.image.src = c150cockpit4png;

        compasTexture = gl.createTexture();
        compasTexture.image = new Image();
        compasTexture.image.onload = function () {
            handleLoadedTexture(compasTexture)
        }

        compasTexture.image.src = compas256jpg;
        /*
        heliceTexture = gl.createTexture();
        heliceTexture.image = new Image();
        heliceTexture.image.onload = function () {
            handleLoadedTexture(heliceTexture)
        }

        heliceTexture.image.src = helice2jpg;
        */
        arrowTexture = gl.createTexture();
        arrowTexture.image = new Image();
        arrowTexture.image.onload = function () {
            handleLoadedTexture(arrowTexture)
        }

        arrowTexture.image.src = arrowpng;
        
        waterTexture = gl.createTexture();
        waterTexture.image = new Image();
        waterTexture.image.onload = function () {
            handleLoadedTexture(waterTexture)
        }

        waterTexture.image.src = waterjpg;

        treeTexture = gl.createTexture();
        treeTexture.image = new Image();
        treeTexture.image.onload = function () {
            handleLoadedTexture(treeTexture)
        }
        treeTexture.image.src = treejpg;

        tree2Texture = gl.createTexture();
        tree2Texture.image = new Image();
        tree2Texture.image.onload = function () {
            handleLoadedTexture(tree2Texture)
        }
        tree2Texture.image.src = tree14jpg;
		
        tree3Texture = gl.createTexture();
        tree3Texture.image = new Image();
        tree3Texture.image.onload = function () {
            handleLoadedTexture(tree3Texture)
        }
        tree3Texture.image.src = tree1jpg;
		
        radarTexture = gl.createTexture();
        radarTexture.image = new Image();
        radarTexture.image.onload = function () {
            handleLoadedTexture(radarTexture)
        }

        radarTexture.image.src = radar2png;

        azimutTexture = gl.createTexture();
        azimutTexture.image = new Image();
        azimutTexture.image.onload = function () {
            handleLoadedTexture(azimutTexture)
        }

        azimutTexture.image.src = azimut2png;
        
        rttFramebuffer = gl.createFramebuffer();
        gl.bindFramebuffer(gl.FRAMEBUFFER, rttFramebuffer);
        rttFramebuffer.width = 512;
        rttFramebuffer.height = 512;
        rttTexture = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_2D, rttTexture);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
        gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA, rttFramebuffer.width, rttFramebuffer.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
        renderbuffer = gl.createRenderbuffer();
        gl.bindRenderbuffer(gl.RENDERBUFFER, renderbuffer);
        gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, rttFramebuffer.width, rttFramebuffer.height);
        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, rttTexture, 0);
        gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, renderbuffer);

        gl.bindTexture(gl.TEXTURE_2D, null);
        gl.bindRenderbuffer(gl.RENDERBUFFER, null);
        gl.bindFramebuffer(gl.FRAMEBUFFER, null);

	
        /*skyTexture = gl.createTexture();
        skyTexture.image = new Image();
        skyTexture.image.onload = function () {
            handleLoadedTexture(skyTexture)
        }

        skyTexture.image.src = sunback2jpg;
		*/
        tirTexture = gl.createTexture();
        tirTexture.image = new Image();
        tirTexture.image.onload = function () {
            handleLoadedTexture(tirTexture)
        }

        tirTexture.image.src = explosionjpg;
		
        impactTexture = gl.createTexture();
        impactTexture.image = new Image();
        impactTexture.image.onload = function () {
            handleLoadedTexture(impactTexture)
        }

        impactTexture.image.src = impactjpg;
		/*
        shipTexture = gl.createTexture();
        shipTexture.image = new Image();
        shipTexture.image.onload = function () {
            handleLoadedTexture(shipTexture)
        }
        
        shipTexture.image.src = shipjpg;
		
        bloodTexture = gl.createTexture();
        bloodTexture.image = new Image();
        bloodTexture.image.onload = function () {
            handleLoadedTexture(bloodTexture)
        }

        bloodTexture.image.src = bloodjpg;
		
        spitfireTexture = gl.createTexture();
        spitfireTexture.image = new Image();
        spitfireTexture.image.onload = function () {
            handleLoadedTexture(spitfireTexture)
        }

        spitfireTexture.image.src = spitfirejpg;
        */
        f14Texture = gl.createTexture();
        f14Texture.image = new Image();
        f14Texture.image.onload = function () {
            handleLoadedTexture(f14Texture)
        }

        f14Texture.image.src = "f14cockpit.jpg";
		/*
        shipcarrierTexture = gl.createTexture();
        shipcarrierTexture.image = new Image();
        shipcarrierTexture.image.onload = function () {
            handleLoadedTexture(shipcarrierTexture)
        }

        shipcarrierTexture.image.src = shipcarrierjpg;
        */
        skydomeTexture = gl.createTexture();
        skydomeTexture.image = new Image();
        skydomeTexture.image.onload = function () {
            handleLoadedTexture(skydomeTexture)
			skydomejpg=null;skydome2jpg=null;
			skydome3jpg=null;skydome4jpg=null;
        }

        if(wclouds<12){skydomeTexture.image.src = skydome3jpg;
        }else if(wclouds<50){skydomeTexture.image.src = skydomejpg;
        }else if(wclouds<75){skydomeTexture.image.src = skydome2jpg;
		}else{skydomeTexture.image.src = skydome4jpg;}
		

        fighterTexture = gl.createTexture();
        fighterTexture.image = new Image();
        fighterTexture.image.onload = function () {
            handleLoadedTexture(fighterTexture)
        }

        fighterTexture.image.src = "fighter.jpg";
        
        seaTexture = gl.createTexture();
        seaTexture.image = new Image();
        seaTexture.image.onload = function () {
            handleLoadedTexture(seaTexture)
        }

        seaTexture.image.src = waterseajpg;

        viseurTexture = gl.createTexture();
        viseurTexture.image = new Image();
        viseurTexture.image.onload = function () {
            handleLoadedTexture(viseurTexture)
        }

        viseurTexture.image.src = viseurpng;

        rainTexture = gl.createTexture();
        rainTexture.image = new Image();
        rainTexture.image.onload = function () {
            handleLoadedTexture(rainTexture)
        }

        rainTexture.image.src = rainjpg;

        /*sailshipTexture = gl.createTexture();
        sailshipTexture.image = new Image();
        sailshipTexture.image.onload = function () {
            handleLoadedTexture(sailshipTexture)
        }

        sailshipTexture.image.src = sailshipjpg;
        */
        airporttowerTexture = gl.createTexture();
        airporttowerTexture.image = new Image();
        airporttowerTexture.image.onload = function () {
            handleLoadedTexture(airporttowerTexture)
        }

        airporttowerTexture.image.src = airporttower256png;

        /*tankTexture = gl.createTexture();
        tankTexture.image = new Image();
        tankTexture.image.onload = function () {
            handleLoadedTexture(tankTexture)
        }

        tankTexture.image.src = tankjpg;
        */
        alphajetTexture = gl.createTexture();
        alphajetTexture.image = new Image();
        alphajetTexture.image.onload = function () {
            handleLoadedTexture(alphajetTexture)
        }
        alphajetTexture.image.src = alphajetjpg;
        
        /*eiffeltowerTexture = gl.createTexture();
        eiffeltowerTexture.image = new Image();
        eiffeltowerTexture.image.onload = function () {
            handleLoadedTexture(eiffeltowerTexture)
        }
        eiffeltowerTexture.image.src = eiffeltowerpng;

        libertystatueTexture = gl.createTexture();
        libertystatueTexture.image = new Image();
        libertystatueTexture.image.onload = function () {
            handleLoadedTexture(libertystatueTexture)
        }
        libertystatueTexture.image.src = libertystatuepng;

        christrioTexture = gl.createTexture();
        christrioTexture.image = new Image();
        christrioTexture.image.onload = function () {
            handleLoadedTexture(christrioTexture)
        }
        christrioTexture.image.src = christriopng;

        domerockTexture = gl.createTexture();
        domerockTexture.image = new Image();
        domerockTexture.image.onload = function () {
            handleLoadedTexture(domerockTexture)
        }
        domerockTexture.image.src = domerockpng;

        gizahTexture = gl.createTexture();
        gizahTexture.image = new Image();
        gizahTexture.image.onload = function () {
            handleLoadedTexture(gizahTexture)
        }
        gizahTexture.image.src = gizahpng;

        capitoleTexture = gl.createTexture();
        capitoleTexture.image = new Image();
        capitoleTexture.image.onload = function () {
            handleLoadedTexture(capitoleTexture)
        }
        capitoleTexture.image.src = capitolepng;

        tajmahalTexture = gl.createTexture();
        tajmahalTexture.image = new Image();
        tajmahalTexture.image.onload = function () {
            handleLoadedTexture(tajmahalTexture)
        }
        tajmahalTexture.image.src = tajmahalpng;

        buddahTexture = gl.createTexture();
        buddahTexture.image = new Image();
        buddahTexture.image.onload = function () {
            handleLoadedTexture(buddahTexture)
        }
        buddahTexture.image.src = buddahpng;*/

        horse00Texture = gl.createTexture();
        horse00Texture.image = new Image();
        horse00Texture.image.onload = function () {
            handleLoadedTexture(horse00Texture)
        }
        horse00Texture.image.src = horse00jpg;

        elephant00Texture = gl.createTexture();
        elephant00Texture.image = new Image();
        elephant00Texture.image.onload = function () {
            handleLoadedTexture(elephant00Texture)
        }
        elephant00Texture.image.src = elephant00jpg;

        girafe00Texture = gl.createTexture();
        girafe00Texture.image = new Image();
        girafe00Texture.image.onload = function () {
            handleLoadedTexture(girafe00Texture)
        }
        girafe00Texture.image.src = girafe00jpg;

        zebra00Texture = gl.createTexture();
        zebra00Texture.image = new Image();
        zebra00Texture.image.onload = function () {
            handleLoadedTexture(zebra00Texture)
        }
        zebra00Texture.image.src = zebra00jpg;

        birdTexture = gl.createTexture();
        birdTexture.image = new Image();
        birdTexture.image.onload = function () {
            handleLoadedTexture(birdTexture)
        }
        birdTexture.image.src = birdjpg;

        antilope00Texture = gl.createTexture();
        antilope00Texture.image = new Image();
        antilope00Texture.image.onload = function () {
            handleLoadedTexture(antilope00Texture)
        }
        antilope00Texture.image.src = antilope00jpg;

        cloudblackTexture = gl.createTexture();
        cloudblackTexture.image = new Image();
        cloudblackTexture.image.onload = function () {
            handleLoadedTexture(cloudblackTexture)
        }
        cloudblackTexture.image.src = cloudblackpng;

        /*carTexture = gl.createTexture();
        carTexture.image = new Image();
        carTexture.image.onload = function () {
            handleLoadedTexture(carTexture)
        }
        carTexture.image.src = chevyjpg;

        volantTexture = gl.createTexture();
        volantTexture.image = new Image();
        volantTexture.image.onload = function () {
            handleLoadedTexture(volantTexture)
        }
        volantTexture.image.src = volantjpg;
        */
        rocTexture = gl.createTexture();
        rocTexture.image = new Image();
        rocTexture.image.onload = function () {
            handleLoadedTexture(rocTexture)
        }
        rocTexture.image.src = rocjpg;

        /*rpmTexture = gl.createTexture();
        rpmTexture.image = new Image();
        rpmTexture.image.onload = function () {
            handleLoadedTexture(rpmTexture)
        }
        rpmTexture.image.src = rpmpng;
        */
        soleilTexture = gl.createTexture();
        soleilTexture.image = new Image();
        soleilTexture.image.onload = function () {
            handleLoadedTexture(soleilTexture)
        }
        soleilTexture.image.src = "soleil.jpg";

        soleilmaskTexture = gl.createTexture();
        soleilmaskTexture.image = new Image();
        soleilmaskTexture.image.onload = function () {
            handleLoadedTexture(soleilmaskTexture)
        }
        soleilmaskTexture.image.src = "soleilmask.png";

        soleilbrightTexture = gl.createTexture();
        soleilbrightTexture.image = new Image();
        soleilbrightTexture.image.onload = function () {
            handleLoadedTexture(soleilbrightTexture)
        }
        soleilbrightTexture.image.src = "soleilbright.jpg";

        soleilwhiteTexture = gl.createTexture();
        soleilwhiteTexture.image = new Image();
        soleilwhiteTexture.image.onload = function () {
            handleLoadedTexture(soleilwhiteTexture)
        }
        soleilwhiteTexture.image.src = "soleilwhite.jpg";

        soleilblueTexture = gl.createTexture();
        soleilblueTexture.image = new Image();
        soleilblueTexture.image.onload = function () {
            handleLoadedTexture(soleilblueTexture)
        }
        soleilblueTexture.image.src = "soleilblue.jpg";

        soleilredTexture = gl.createTexture();
        soleilredTexture.image = new Image();
        soleilredTexture.image.onload = function () {
            handleLoadedTexture(soleilredTexture)
        }
        soleilredTexture.image.src = "soleilred.jpg";

        earthTexture = gl.createTexture();
        earthTexture.image = new Image();
        earthTexture.image.onload = function () {
            handleLoadedTexture(earthTexture)
        }
        earthTexture.image.src = "earth.jpg";

        earthmaskTexture = gl.createTexture();
        earthmaskTexture.image = new Image();
        earthmaskTexture.image.onload = function () {
            handleLoadedTexture(earthmaskTexture)
        }
        earthmaskTexture.image.src = "earthmask.png";

        moonTexture = gl.createTexture();
        moonTexture.image = new Image();
        moonTexture.image.onload = function () {
            handleLoadedTexture(moonTexture)
        }
        moonTexture.image.src = "moon.jpg";

        jupiterTexture = gl.createTexture();
        jupiterTexture.image = new Image();
        jupiterTexture.image.onload = function () {
            handleLoadedTexture(jupiterTexture)
        }
        jupiterTexture.image.src = "jupiter.jpg";

        venusTexture = gl.createTexture();
        venusTexture.image = new Image();
        venusTexture.image.onload = function () {
            handleLoadedTexture(venusTexture)
        }
        venusTexture.image.src = "venus.jpg";

        mercureTexture = gl.createTexture();
        mercureTexture.image = new Image();
        mercureTexture.image.onload = function () {
            handleLoadedTexture(mercureTexture)
        }
        mercureTexture.image.src = "mercure.jpg";

        neptunTexture = gl.createTexture();
        neptunTexture.image = new Image();
        neptunTexture.image.onload = function () {
            handleLoadedTexture(neptunTexture)
        }
        neptunTexture.image.src = "neptun.jpg";

        saturnTexture = gl.createTexture();
        saturnTexture.image = new Image();
        saturnTexture.image.onload = function () {
            handleLoadedTexture(saturnTexture)
        }
        saturnTexture.image.src = "saturn.jpg";

        saturnmaskTexture = gl.createTexture();
        saturnmaskTexture.image = new Image();
        saturnmaskTexture.image.onload = function () {
            handleLoadedTexture(saturnmaskTexture)
        }
        saturnmaskTexture.image.src = "saturnmask.png";

        ioTexture = gl.createTexture();
        ioTexture.image = new Image();
        ioTexture.image.onload = function () {
            handleLoadedTexture(ioTexture)
        }
        ioTexture.image.src = "io.jpg";

        planetTexture = gl.createTexture();
        planetTexture.image = new Image();
        planetTexture.image.onload = function () {
            handleLoadedTexture(planetTexture)
        }
        planetTexture.image.src = "planet.jpg";

        planet2Texture = gl.createTexture();
        planet2Texture.image = new Image();
        planet2Texture.image.onload = function () {
            handleLoadedTexture(planet2Texture)
        }
        planet2Texture.image.src = "planet2.jpg";

        planet3Texture = gl.createTexture();
        planet3Texture.image = new Image();
        planet3Texture.image.onload = function () {
            handleLoadedTexture(planet3Texture)
        }
        planet3Texture.image.src = "planet3.jpg";

        spaceshipTexture = gl.createTexture();
        spaceshipTexture.image = new Image();
        spaceshipTexture.image.onload = function () {
            handleLoadedTexture(spaceshipTexture)
        }
        spaceshipTexture.image.src = "spaceship.jpg";

        voielacteeTexture = gl.createTexture();
        voielacteeTexture.image = new Image();
        voielacteeTexture.image.onload = function () {
            handleLoadedTexture(voielacteeTexture)
        }
        voielacteeTexture.image.src = "voielactee.jpg";
        
        europaTexture = gl.createTexture();
        europaTexture.image = new Image();
        europaTexture.image.onload = function () {
            handleLoadedTexture(europaTexture)
        }
        europaTexture.image.src = "europa.jpg";

        marsTexture = gl.createTexture();
        marsTexture.image = new Image();
        marsTexture.image.onload = function () {
            handleLoadedTexture(marsTexture)
        }
        marsTexture.image.src = "mars.jpg";

        plutoTexture = gl.createTexture();
        plutoTexture.image = new Image();
        plutoTexture.image.onload = function () {
            handleLoadedTexture(plutoTexture)
        }
        plutoTexture.image.src = "pluton.jpg";

        /*explode0Texture = gl.createTexture();
        explode0Texture.image = new Image();
        explode0Texture.image.onload = function () {
            handleLoadedTexture(explode0Texture)
        }
        explode0Texture.image.src = "explode0.jpg";*/

        explode1Texture = gl.createTexture();
        explode1Texture.image = new Image();
        explode1Texture.image.onload = function () {
            handleLoadedTexture(explode1Texture)
        }
        explode1Texture.image.src = "explode1.jpg";

        /*explode2Texture = gl.createTexture();
        explode2Texture.image = new Image();
        explode2Texture.image.onload = function () {
            handleLoadedTexture(explode2Texture)
        }
        explode2Texture.image.src = "explode2.jpg";*/

        explode3Texture = gl.createTexture();
        explode3Texture.image = new Image();
        explode3Texture.image.onload = function () {
            handleLoadedTexture(explode3Texture)
        }
        explode3Texture.image.src = "explode3.jpg";

        explode4Texture = gl.createTexture();
        explode4Texture.image = new Image();
        explode4Texture.image.onload = function () {
            handleLoadedTexture(explode4Texture)
        }
        explode4Texture.image.src = "explode4.jpg";

        compas0Texture = gl.createTexture();
        compas0Texture.image = new Image();
        compas0Texture.image.onload = function () {
            handleLoadedTexture(compas0Texture)
        }
        compas0Texture.image.src = "compas0.png";

        compas1Texture = gl.createTexture();
        compas1Texture.image = new Image();
        compas1Texture.image.onload = function () {
            handleLoadedTexture(compas1Texture)
        }
        compas1Texture.image.src = "compas1.png";

		}

//libertystatue
var lat2=40.689249,lng2=-74.0444999;
getworldxy(zoom,lat2,lng2);
var libertystatuex=worldx,libertystatuey=worldy;
//Eiffel Tower
lat2=48.85837;lng2=2.2944810;
getworldxy(zoom,lat2,lng2);
var eiffeltowerx=worldx,eiffeltowery=worldy;
//Christ rio
lat2=-22.951916;lng2=-43.210487;
getworldxy(zoom,lat2,lng2);
var christriox=worldx,christrioy=worldy;
//Dome of the Rock 
lat2=31.778019;lng2=35.23540800;
getworldxy(zoom,lat2,lng2);
var domerockx=worldx,domerocky=worldy;
//The Great Pyramid at Giza 
lat2=29.979234;lng2=31.13420199;
getworldxy(zoom,lat2,lng2);
var gizahx=worldx,gizahy=worldy;
//United States Capitol 
lat2=38.889939;lng2=-77.00905;
getworldxy(zoom,lat2,lng2);
var capitolex=worldx,capitoley=worldy;
//taj mahal
lat2=27.175015;lng2=78.042155;
getworldxy(zoom,lat2,lng2);
var tajmahalx=worldx,tajmahaly=worldy;
//hongkong Buddha
lat2=22.253985;lng2=113.904984;
getworldxy(zoom,lat2,lng2);
var buddahx=worldx,buddahy=worldy;

    function drawrttshadow() {
      //gl.bindRenderbuffer(gl.RENDERBUFFER, renderbuffer);
      gl.bindFramebuffer(gl.FRAMEBUFFER, rttFramebuffer);
      //gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, rttTexture, 0);
      drawshadow();
      gl.bindFramebuffer(gl.FRAMEBUFFER, null);
      //gl.bindRenderbuffer(gl.RENDERBUFFER, null);
    }
	
    var mvMatrix = mat4.create();
    var mvMatrixStack = [];
    var pMatrix = mat4.create();
    var pvMatrix = mat4.create();
    var camx=0,camy=0,camz=0;

    function mvPushMatrix() {
        var copy = mat4.create();
        mat4.set(mvMatrix, copy);
        mvMatrixStack.push(copy);
    }

    function mvPopMatrix() {
        if (mvMatrixStack.length == 0) {
            throw "Invalid popMatrix!";
        }
        mvMatrix = mvMatrixStack.pop();
    }

    var scaletexture=1;
    function setMatrixUniformssol() {
        gl.uniformMatrix4fv(solProgram.pMatrixUniform, false, pMatrix);
        //gl.uniformMatrix4fv(solProgram.mvMatrixUniform, false, mvMatrix);
	    mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        gl.uniformMatrix4fv(solProgram.mvMatrixUniform, false, pvMatrix);
        if(tgmap>=0){
		gl.uniform1f(solProgram.xmin, x-dxmaxmin2);
        gl.uniform1f(solProgram.xmax, x+dxmaxmin2);
        gl.uniform1f(solProgram.ymin, y-dymaxmin2);
        gl.uniform1f(solProgram.ymax, y+dymaxmin2);
        /*gl.uniform1f(solProgram.xmin, xmin);
        gl.uniform1f(solProgram.xmax, xmax);
        gl.uniform1f(solProgram.ymin, ymin);
        gl.uniform1f(solProgram.ymax, ymax);*/
        gl.uniform1f(solProgram.x0, xmin);
        gl.uniform1f(solProgram.y0, ymin);
        if(tgmap==0){gl.uniform1i(solProgram.type, 1);
		}else if(z<zsol+zgrass){gl.uniform1i(solProgram.type, 6);
		}else{gl.uniform1i(solProgram.type, 3);}
        gl.uniform1f(solProgram.hour, hour);
		}
		else{
		gl.uniform1f(solProgram.xmin, x-(xmax-xmin)/8);
        gl.uniform1f(solProgram.xmax, x+(xmax-xmin)/8);
        gl.uniform1f(solProgram.ymin, y-(ymax-ymin)/8);
        gl.uniform1f(solProgram.ymax, y+(ymax-ymin)/8);
        gl.uniform1f(solProgram.x0, xmin+(xmax-xmin)*3/8);
        gl.uniform1f(solProgram.y0, ymin+(ymax-ymin)*3/8);
		gl.uniform1i(solProgram.type, 3);}
        gl.uniform1f(solProgram.hour, hour);
        gl.uniform4f(solProgram.colorUniform,colorr,colorg,colorb,colora);
    }
    function setMatrixUniformspiste() {
        gl.uniformMatrix4fv(solProgram.pMatrixUniform, false, pMatrix);
        //gl.uniformMatrix4fv(solProgram.mvMatrixUniform, false, mvMatrix);
	    mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        gl.uniformMatrix4fv(solProgram.mvMatrixUniform, false, pvMatrix);
        gl.uniform1f(solProgram.xmin, x-dxmaxmin2);
        gl.uniform1f(solProgram.xmax, x+dxmaxmin2);
        gl.uniform1f(solProgram.ymin, y-dymaxmin2);
        gl.uniform1f(solProgram.ymax, y+dymaxmin2);
        gl.uniform1f(solProgram.x0, xmin);
        gl.uniform1f(solProgram.y0, ymin);
        gl.uniform1i(solProgram.type, 2);
        gl.uniform1f(solProgram.hour, hour);
        gl.uniform4f(solProgram.colorUniform,colorr,colorg,colorb,colora);
    }
    function setMatrixUniformstown() {
        gl.uniformMatrix4fv(solProgram.pMatrixUniform, false, pMatrix);
        //gl.uniformMatrix4fv(solProgram.mvMatrixUniform, false, mvMatrix);
	    mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        gl.uniformMatrix4fv(solProgram.mvMatrixUniform, false, pvMatrix);
        gl.uniform1f(solProgram.xmin, x-dxmaxmin2);
        gl.uniform1f(solProgram.xmax, x+dxmaxmin2);
        gl.uniform1f(solProgram.ymin, y-dymaxmin2);
        gl.uniform1f(solProgram.ymax, y+dymaxmin2);
        gl.uniform1f(solProgram.x0, xmin);
        gl.uniform1f(solProgram.y0, ymin);
        gl.uniform1i(solProgram.type, 2);
        gl.uniform1f(solProgram.hour, hour);
        gl.uniform4f(solProgram.colorUniform,colorr,colorg,colorb,colora);
    }
    function setMatrixUniformssea() {
        gl.uniformMatrix4fv(solProgram.pMatrixUniform, false, pMatrix);
        //gl.uniformMatrix4fv(solProgram.mvMatrixUniform, false, mvMatrix);
	    mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        gl.uniformMatrix4fv(solProgram.mvMatrixUniform, false, pvMatrix);
        gl.uniform1f(solProgram.xmin, x-(xmax-xmin)*4);
        gl.uniform1f(solProgram.xmax, x+(xmax-xmin)*4);
        gl.uniform1f(solProgram.ymin, y-(ymax-ymin)*4);
        gl.uniform1f(solProgram.ymax, y+(ymax-ymin)*4);
        gl.uniform1f(solProgram.x0, xmin);
        gl.uniform1f(solProgram.y0, ymin);
        gl.uniform1i(solProgram.type, 2);
        gl.uniform1f(solProgram.hour, hour);
        gl.uniform4f(solProgram.colorUniform,colorr,colorg,colorb,colora);
    }
	 var colorr=1.0,colorg=1.0,colorb=1.0,colora=1.0,colormin=0,colorshadow=-2;
     function setMatrixUniforms() {
        gl.uniformMatrix4fv(shaderProgram.pMatrixUniform, false, pMatrix);
        //gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, mvMatrix);
	    mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, pvMatrix);
        gl.uniform4f(shaderProgram.colorUniform,colorr,colorg,colorb,colora);
        gl.uniform1f(shaderProgram.colorminUniform,colormin);
        gl.uniform1f(shaderProgram.shadowUniform,colorshadow);
    }
    function setskyMatrixUniforms() {
        gl.uniformMatrix4fv(skyProgram.pMatrixUniform, false, pMatrix);
        //gl.uniformMatrix4fv(skyProgram.mvMatrixUniform, false, mvMatrix);
	    mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        gl.uniformMatrix4fv(skyProgram.mvMatrixUniform, false, pvMatrix);
        gl.uniform4f(skyProgram.colorUniform,clearr,clearg,clearb,1.0);
        gl.uniform1f(skyProgram.hourUniform,hour); 
    }
   function setcloudMatrixUniforms() {
        //gl.uniform3fv(cloudProgram.cameraPositionUniform,[x,y,z]);
        gl.uniform1f(cloudProgram.sizeUniform,cloudsize);
        gl.uniform3f(cloudProgram.sunPositionUniform,x+sunx,y+suny,z+sunz);
        gl.uniform3f(cloudProgram.cameraPositionUniform,camx,camy,camz);
        gl.uniformMatrix4fv(cloudProgram.pMatrixUniform, false, pMatrix);
        //gl.uniformMatrix4fv(cloudProgram.mvMatrixUniform, false, mvMatrix);
	    mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        gl.uniformMatrix4fv(cloudProgram.mvMatrixUniform, false, pvMatrix);
        gl.uniform4f(cloudProgram.colorUniform,colorr,colorg,colorb,colora);
    }
   function setsunMatrixUniforms() {
        //gl.uniform3fv(cloudProgram.cameraPositionUniform,[x,y,z]);
        gl.uniform1f(cloudProgram.sizeUniform,-1.0);
        gl.uniform3f(cloudProgram.sunPositionUniform,x+sunx1,y+suny1,z+sunz1);
        gl.uniform3f(cloudProgram.cameraPositionUniform,camx,camy,camz);
        gl.uniformMatrix4fv(cloudProgram.pMatrixUniform, false, pMatrix);
        //gl.uniformMatrix4fv(cloudProgram.mvMatrixUniform, false, mvMatrix);
	    mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        gl.uniformMatrix4fv(cloudProgram.mvMatrixUniform, false, pvMatrix);
        gl.uniform4f(cloudProgram.colorUniform,colorr,colorg,colorb,colora);
    }
   function setMatrixUniformstree() {
        var k=1.0;
		if(treetype==0){k=1.1;}
		if(treetype==2){k=1.1;}
        if(tourelle==0 || tfoot==1 || tcar==1){
		  gl.uniform1f(treeProgram.cos1Uniform,k*cos1);
          gl.uniform1f(treeProgram.sin1Uniform,k*sin1);
        }else{
		  gl.uniform1f(treeProgram.cos1Uniform,k*tcos1);
          gl.uniform1f(treeProgram.sin1Uniform,k*tsin1);
		}
		gl.uniformMatrix4fv(treeProgram.pMatrixUniform, false, pMatrix);
        //gl.uniformMatrix4fv(treeProgram.mvMatrixUniform, false, mvMatrix);
	    mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        gl.uniformMatrix4fv(treeProgram.mvMatrixUniform, false, pvMatrix);
    }
   var rstar=1;
   function setMatrixUniformsstar() {
        if(tourelle==0){
		  gl.uniform1f(starProgram.cos1Uniform,cos1*0.8*rstar);
          gl.uniform1f(starProgram.sin1Uniform,sin1*0.8*rstar);
          gl.uniform1f(starProgram.sin2Uniform,sin2);
        }else{
		  gl.uniform1f(starProgram.cos1Uniform,tcos1*0.8*rstar);
          gl.uniform1f(starProgram.sin1Uniform,tsin1*0.8*rstar);
          gl.uniform1f(starProgram.sin2Uniform,tsin2);
		}
        gl.uniform1f(starProgram.alphaUniform,colora);
        gl.uniformMatrix4fv(starProgram.pMatrixUniform, false, pMatrix);
        //gl.uniformMatrix4fv(starProgram.mvMatrixUniform, false, mvMatrix);
	    mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        gl.uniformMatrix4fv(starProgram.mvMatrixUniform, false, pvMatrix);
    }
   var texscalex=1,texscaley=1,textdx=0,textdy=0,scalex2d=1;scaley2d=1,dx2d=0,dy2d=0;   
   function setMatrixUniforms2D() {
        gl.uniform1f(program2d.texscalexUniform,texscalex);
        gl.uniform1f(program2d.texscaleyUniform,texscaley);
        gl.uniform1f(program2d.textdxUniform,textdx);
        gl.uniform1f(program2d.textdyUniform,textdy);
        gl.uniform4f(program2d.colorUniform,colorr,colorg,colorb,colora);
        gl.uniform1f(program2d.scalexUniform,scalex2d);
        gl.uniform1f(program2d.scaleyUniform,scaley2d);
        gl.uniform1f(program2d.dxUniform,dx2d);
        gl.uniform1f(program2d.dyUniform,dy2d);
   }
 

    function degtorad(degrees) {
        return degrees * Math.PI / 180;
    }

    var solVertexPositionBuffer;
    var solVertexTextureCoordBuffer;
    var solVertexIndexBuffer;
	var solVertexIndices,soltextureCoords;
	var height,solvertices,height1,height2;
	var cloudVertexPositionBuffer;
    var cloudVertexTextureCoordBuffer;
	var cloudvertices;
	var cloudtextureCoords,cloudscale;
	var sunVertexPositionBuffer;
    var sunVertexTextureCoordBuffer;
	var sunvertices,suntextureCoords;
	var boussVertexPositionBuffer;
    var boussVertexTextureCoordBuffer;
    var bouss2VertexTextureCoordBuffer;
	var boussvertices,bouss2textureCoords;
	var pisteVertexPositionBuffer;
    var pisteVertexTextureCoordBuffer;
	var pistevertices;
	var towerVertexPositionBuffer;
    var towerVertexTextureCoordBuffer;
	var towervertices,towertexcoords;
	var townVertexPositionBuffer;
    var townVertexTextureCoordBuffer;
	var townvertices,townx,towny,townz,towno1,towndx,towndz;
	var waterVertexPositionBuffer;
    var waterVertexTextureCoordBuffer;
	var watervertices;
	var seaVertexPositionBuffer;
    var seaVertexTextureCoordBuffer;
	var seavertices,seatextureCoords;
	var treeVertexPositionBuffer;
    var treeVertexTextureCoordBuffer;
	var treevertices;
	var tirVertexPositionBuffer;
    var tirVertexTextureCoordBuffer;
	var tirvertices,tirx,tiry,tirz,vtirx,vtiry,vtirz,ttir,tirsize,tirtype;
	var starVertexPositionBuffer;
    var starVertexTextureCoordBuffer;
	var starvertices;
	var dustVertexPositionBuffer;
    var dustVertexTextureCoordBuffer;
	var dustvertices;
	var portVertexPositionBuffer;
    var portVertexTextureCoordBuffer;
	var portvertices;

	var n=256,nmap=60,index=0,nmap2=nmap,distmap2=0;
	var scale=n*70/nmap;
	var n4=scale;
	var ncloud=parseInt(40*1.2*1.2),ncloud2=0;
	var xmax=0.97*(scale*(8.0*n)/n-n4), ymax=0.97*(scale*(n*8.0/n)-n4);
	var xmin=0.97*(scale*(8.0*0)/n-n4), ymin=0.97*(scale*(0*8.0/n)-n4);
	var xmaxmin2=(xmax+xmin)/2,dxmaxmin2=(xmax-xmin)/2;
	var ymaxmin2=(ymax+ymin)/2,dymaxmin2=(ymax-ymin)/2;
	var sunx=1000,suny=200,sunz=800;
	var boussx=43,boussy=43,boussz=0,landing=0;
	var npiste=7,ntown=10,ntree=700,ntir=200,itir=0;
	var nstar=140*7;ndust=50;nstar=nstars-2;//787-2+700;
    var pistex=dxmaxmin2;
	var pistey=dymaxmin2;
	var pistez=0.1;
	var waterx=dxmaxmin2+500;
	var watery=dymaxmin2-400;
	var seaheight=0;
	function append(tab,values){
	  for(var i=0;i<values.length;i++){
	     tab[index]=values[i];index+=1;
	  }
	}
	function appendrot(tab,values,s,t,rot){
	  var co1=Math.cos(rot);
	  var si1=Math.sin(rot);
	  for(var i=0;i<values.length;i++){
	     var xx=values[i];i++;if(i>=values.length){break;};
		 var yy=values[i];i++;if(i>=values.length){break;};
         tab[index]=s+(xx-s)*co1-(yy-t)*si1;index+=1;
		 tab[index]=t+(xx-s)*si1+(yy-t)*co1;index+=1; 
	     tab[index]=values[i];index+=1;
	  }
	}
	var treinitsol=-10,zsolmin=0;
	function reinitsol(){
	    zsolmin=0;
	    if(solmap && solmap!=""){reinitsolmap(solmap);return;}
	    Math.seedrandom(seedrand);
	    irnd=0;
        //solVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, solVertexPositionBuffer);
        //var vertices = new Array(3*n*n);
		//height=new Array((n+1)*(n+1));
		if(tgmap==0){
		var heightx=new Array((n+1)*(n+1));
		var heighty=new Array((n+1)*(n+1));
		var w=1.0,wx=1.0,wy=1.0;
		for (var j=0; j < n; j++) {
        for(var i=0;i<n;i++){
		   if(Mathrandom()<0.2){w=Mathrandom()+0.35;}
		   wx+=(w-wx)*0.3;
		   heightx[i*n+j]=Math.cos(80*wx*(i)/nmap);
		}}
		for (var i=0; i < n; i++) {
        for(var j=0;j<n;j++){
		   if(Mathrandom()<0.2){w=Mathrandom()+0.35;}
		   wy+=(w-wy)*0.3;
		   heighty[i*n+j]=Math.cos(80*wy*(j)/nmap);
		}}
		}
        seaheight=5.05;if(tsea==0){seaheight=0;}
		if(tgmap==0){
		for (var i=0; i <= n; i++) {
        for(var j=0;j<n;j++){
		   var ij=i*n+j;
		   height[ij]=5*heightx[ij]*heighty[ij];//(Math.cos(80*(i)/nmap)*Math.cos(80*(j)/nmap))*4.0;
		   height2[ij]=1;
		}}
		var nmount=35*2;if(seaheight<0.1){nmount=35;}
		for(var i=0;i<nmount;i++){
		   var imount=n*(0.5+0.9*(Mathrandom()-0.5));
		   var jmount=n*(0.5+0.9*(Mathrandom()-0.5));
		   var hmount=14*(1+Mathrandom());
		   var dj=8;
		   for(var j=-dj;j<dj;j++){
		   for(var k=-dj;k<dj;k++){
		      var jj=parseInt(j+imount),kk=parseInt(k+jmount);
			  if(jj>0 && jj<n && kk>0 && kk<n){
			    height[jj*n+kk]+=hmount*Math.cos(Math.abs(3.1416*j*0.5/dj))*Math.cos(Math.abs(3.1416*k*0.5/dj));
			  }
		   }
		   }
		}
		}
		if(tgmap==1){initgmap();
		}
		if(tgmap==0){
		for (var i=0; i <= n; i++) {
        for(var j=0;j<n;j++){
		   height[i*n+j]-=seaheight;
		   if(height[i*n+j]<-0.4){height[i*n+j]=-0.4;}
		   }
		}
        }		

		zsolmin=999;
		var zsolmin2=999;
		var ij=0,h=0;
		if(tgmap==1){updatesrtm();
		for (var i=0; i < n; i++) {
        for(var j=0;j<n;j++){
		   ij=i*n+j;
		   h=height1[ij];
		   if(height[ij]<=0 && h>4){
		      zsolmin2=Math.min(zsolmin2,height[ij]+h);
		      height2[ij]=-1;
		      height2[ij+1]=-1;
		      height2[ij+1+n]=-1;
		      if(i>1 && j>1){
			   height2[ij-n]=-1;
		       height2[ij-n-1]=-1;
		       height2[ij-n+1]=-1;
		       height2[ij-1]=-1;
		       height2[ij-1+n]=-1;
		       height2[ij-1-n]=-1;}
		   }
		   if((height[ij]>0 || h>4) && h>0){
		      height[ij]+=h;}
		   if(zsolmin>height[ij]){zsolmin+=0.00025*(height[ij]-zsolmin);}
		   }
		}
        }
        zsolmin=Math.max(0,zsolmin);
        zsolmin2=Math.max(0,zsolmin2);		

		//x=0.25*(scale*((n)*8.0)/n-n4);y=x;
		var px=0,py=0;
		index=0;
		pistez=0.1+Math.max(0,-5+5*Math.floor(height[158*n+158])/5);
		for (var i=0; i < n; i++) {
        for(var j=0;j<n;j++){
		   if(height2[i*n+j]<0){height[i*n+j]=zsolmin2;}
		   px=(scale*(i*8.0/n)-n4);py=scale*(j*8.0/n)-n4
    	   if(Math.abs(px-pistex)<62.0){
	         if(Math.abs(py-pistey)<62.0){height[i*n+j]=pistez;};}
	       var dxwater=px-waterx;
	       var dywater=py-watery;
	       if((dxwater*dxwater+dywater*dywater)<10000){height[i*n+j]=-0.53;}
    	   var dxtown=px-(xmax-xmin)*0.7;
		   var dytown=py-(ymax-ymin)*0.7
		   if(Math.abs(dxtown)<47.0){
	         if(Math.abs(dytown)<47.0){if(height[i*n+j]<0.1){height[i*n+j]=0.1;};};}
		   append(solvertices,[
             px,py,  height[i*n+j]
             //(scale*((i+1)*8.0)/n-32)*12/8,  scale*(j*8.0/n)-n4,  height[(i+1)*n+j]
            ]);
		   
		}}
        gl.bufferData(gl.ARRAY_BUFFER, (solvertices), gl.STATIC_DRAW);
        solVertexPositionBuffer.itemSize = 3;
        solVertexPositionBuffer.numItems = n*n;
		//vertices=null;
		heightx=null;
		heighty=null;

        //pisteVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, pisteVertexPositionBuffer);
        //pistevertices = new Float32Array(3*6*npiste);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < npiste; i++) {
		   xc=7;
		   yc=7;
		   zc=0.1+pistez;//0.2;
		   var s=i*2*xc+dxmaxmin2-45.5,t=dymaxmin2;
		   append(pistevertices,[
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (pistevertices), gl.STATIC_DRAW);
        //pisteVertexPositionBuffer.itemSize = 3;
        //pisteVertexPositionBuffer.numItems = 6*npiste;

	    Math.seedrandom(seedrand);
		var xc=0,yc=0,zc=0;
		//townVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, townVertexPositionBuffer);
        //townvertices = new Float32Array(3*6*6*ntown);
		//townx=new Array(ntown);towny=new Array(ntown);townz=new Array(ntown);
		//towno1=new Array(ntown);towndx=new Array(ntown);towndz=new Array(ntown);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ntown; i++) {
		   xc=2.5;
		   yc=2.5;
		   zc=3;
		   var s=(xmax-xmin)*0.7,t=(ymax-ymin)*0.7,h=1.5;
		   s+= Math.floor( Mathrandom() * 200 - 100 ) * 0.42;
		   t+= Math.floor( Mathrandom() * 200 - 100 ) * 0.42;
		   var rot= Mathrandom();
		   var scx= Mathrandom() * Mathrandom() * Mathrandom() * Mathrandom() * 50 + 10;
		   xc*=scx/10;yc*=scx/10;			
		   zc*=(( Mathrandom() * Mathrandom() * Mathrandom() * scx ) * 8 + 8)/10;
		   towndx[i]=xc;towndz[i]=zc;
		   zc+=getterrainheight(s,t)-xc*0.1;
		   townx[i]=s;towny[i]=t;townz[i]=zc;towno1[i]=rot;
		   appendrot(townvertices,[
             //s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             //s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s,t,zc+h,
             s+xc,t-yc,zc,  s+xc,t+yc,zc,  s,t,zc+h,
             s-xc,t-yc,zc,  s+xc,t-yc,zc,  s,t,zc+h,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s,t,zc+h,
			 
             s-xc,t-yc,0,  s-xc,t-yc,zc,  s+xc,t-yc,0,
             s-xc,t-yc,zc,  s+xc,t-yc,zc,  s+xc,t-yc,0,			 
             
             s-xc,t+yc,0,  s-xc,t+yc,zc,  s+xc,t+yc,0,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t+yc,0,			 
             
			 s-xc,t-yc,0,  s-xc,t-yc,zc,  s-xc,t+yc,0,
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s-xc,t+yc,0,			 
             
			 s+xc,t-yc,0,  s+xc,t-yc,zc,  s+xc,t+yc,0,
             s+xc,t-yc,zc,  s+xc,t+yc,zc,  s+xc,t+yc,0,			 
			 
			 ],s,t,rot); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (townvertices), gl.STATIC_DRAW);
        townVertexPositionBuffer.itemSize = 3;
        townVertexPositionBuffer.numItems = 6*6*ntown;

	    Math.seedrandom(seedrand);
        //treeVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, treeVertexPositionBuffer);
        //treevertices = new Float32Array(3*3*ntree);
		xc=0;yc=0;zc=0;
   	    var h=2;
		if(treetype==0){h*=1.1;}
		if(treetype==2){h*=1.1;}
		index=0;
		for (var i=0; i < ntree; i++) {
		   zc=1;
		   var s=Mathrandom()*2*90+dxmaxmin2;
		   var t=Mathrandom()*2*90+dymaxmin2;
		   zc=getterrainheight(s,t);
		   append(treevertices,[
             s-xc,t-yc,zc,  s,t,zc+h,  s+xc,t+yc,zc	 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (treevertices), gl.STATIC_DRAW);
        treeVertexPositionBuffer.itemSize = 3;
        treeVertexPositionBuffer.numItems = 3*ntree;

		if(tsea>0 || tgmap==1){resetcarrier();resetsailships();}
		updatetower();
		testroc=1;
		}

	function reinitsolmap(map){
		if(!map){alert("wrong map "+map);return;}
		var maps=[];maps=map.split("/");
	    Math.seedrandom(seedrand);
	    irnd=0;
        //solVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, solVertexPositionBuffer);
        //var vertices = new Array(3*n*n);
		//height=new Array((n+1)*(n+1));
        seaheight=0.4;if(tsea==0){seaheight=-0.1;}
		for (var i=0; i <= n; i++) {
        for(var j=0;j<n;j++){
		   height[i*n+j]=maps[i*n+j]/8;
		}}
		for (var i=0; i <= n; i++) {
        for(var j=0;j<n;j++){
		   height[0*n+j]=-0.4;
		   height[n*n-n+j]=-0.4;
		   height[i*n+0]=-0.4;
		   height[i*n+n-1]=-0.4;
		   height[i*n+j]-=seaheight;
		   if(height[i*n+j]<-0.4){height[i*n+j]=-0.4;}
		   }
		}		

		//x=0.25*(scale*((n)*8.0)/n-n4);y=x;
		var px=0,py=0;
		index=0;
		pistez=0.1+Math.max(0,-5+5*Math.floor(height[158*n+158])/5);
		for (var i=0; i < n; i++) {
        for(var j=0;j<n;j++){
		   px=(scale*(i*8.0/n)-n4);py=scale*(j*8.0/n)-n4
    	   if(Math.abs(px-pistex)<62.0){
	         if(Math.abs(py-pistey)<62.0){height[i*n+j]=pistez;};}
	       var dxwater=px-waterx;
	       var dywater=py-watery;
	       if((dxwater*dxwater+dywater*dywater)<10000){height[i*n+j]=-0.3;}
    	   var dxtown=px-(xmax-xmin)*0.7;
		   var dytown=py-(ymax-ymin)*0.7
		   if(Math.abs(dxtown)<47.0){
	         if(Math.abs(dytown)<47.0){if(height[i*n+j]<0.1){height[i*n+j]=0.1;};};}
		   append(solvertices,[
             px,py,  height[i*n+j]
             //(scale*((i+1)*8.0)/n-32)*12/8,  scale*(j*8.0/n)-n4,  height[(i+1)*n+j]
            ]);
		   
		}}		
        gl.bufferData(gl.ARRAY_BUFFER, (solvertices), gl.STATIC_DRAW);
        solVertexPositionBuffer.itemSize = 3;
        solVertexPositionBuffer.numItems = n*n;
		//vertices=null;
		maps=null;

        //pisteVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, pisteVertexPositionBuffer);
        //pistevertices = new Float32Array(3*6*npiste);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < npiste; i++) {
		   xc=7;
		   yc=7;
		   zc=0.1+pistez;//0.2;
		   var s=i*2*xc+dxmaxmin2-45.5,t=dymaxmin2;
		   append(pistevertices,[
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (pistevertices), gl.STATIC_DRAW);
        //pisteVertexPositionBuffer.itemSize = 3;
        //pisteVertexPositionBuffer.numItems = 6*npiste;

	    Math.seedrandom(seedrand);
		var xc=0,yc=0,zc=0;
		//townVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, townVertexPositionBuffer);
        //townvertices = new Float32Array(3*6*6*ntown);
		//townx=new Array(ntown);towny=new Array(ntown);townz=new Array(ntown);
		//towno1=new Array(ntown);towndx=new Array(ntown);towndz=new Array(ntown);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ntown; i++) {
		   xc=2.5;
		   yc=2.5;
		   zc=3;
		   var s=(xmax-xmin)*0.7,t=(ymax-ymin)*0.7,h=1.5;
		   s+= Math.floor( Mathrandom() * 200 - 100 ) * 0.42;
		   t+= Math.floor( Mathrandom() * 200 - 100 ) * 0.42;
		   var rot= Mathrandom();
		   var scx= Mathrandom() * Mathrandom() * Mathrandom() * Mathrandom() * 50 + 10;
		   xc*=scx/10;yc*=scx/10;			
		   zc*=(( Mathrandom() * Mathrandom() * Mathrandom() * scx ) * 8 + 8)/10;
		   towndx[i]=xc;towndz[i]=zc;
		   zc+=getterrainheight(s,t)-xc*0.1;
		   townx[i]=s;towny[i]=t;townz[i]=zc;towno1[i]=rot;
		   appendrot(townvertices,[
             //s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             //s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s,t,zc+h,
             s+xc,t-yc,zc,  s+xc,t+yc,zc,  s,t,zc+h,
             s-xc,t-yc,zc,  s+xc,t-yc,zc,  s,t,zc+h,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s,t,zc+h,
			 
             s-xc,t-yc,0,  s-xc,t-yc,zc,  s+xc,t-yc,0,
             s-xc,t-yc,zc,  s+xc,t-yc,zc,  s+xc,t-yc,0,			 
             
             s-xc,t+yc,0,  s-xc,t+yc,zc,  s+xc,t+yc,0,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t+yc,0,			 
             
			 s-xc,t-yc,0,  s-xc,t-yc,zc,  s-xc,t+yc,0,
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s-xc,t+yc,0,			 
             
			 s+xc,t-yc,0,  s+xc,t-yc,zc,  s+xc,t+yc,0,
             s+xc,t-yc,zc,  s+xc,t+yc,zc,  s+xc,t+yc,0,			 
			 
			 ],s,t,rot); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (townvertices), gl.STATIC_DRAW);
        townVertexPositionBuffer.itemSize = 3;
        townVertexPositionBuffer.numItems = 6*6*ntown;

	    Math.seedrandom(seedrand);
        //treeVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, treeVertexPositionBuffer);
        //treevertices = new Float32Array(3*3*ntree);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ntree; i++) {
		   zc=1;
		   var h=2;
		   var s=Mathrandom()*2*90+dxmaxmin2;
		   var t=Mathrandom()*2*90+dymaxmin2;
		   zc=getterrainheight(s,t);
		   append(treevertices,[
             s-xc,t-yc,zc,  s,t,zc+h,  s+xc,t+yc,zc	 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (treevertices), gl.STATIC_DRAW);
        treeVertexPositionBuffer.itemSize = 3;
        treeVertexPositionBuffer.numItems = 3*ntree;

		if(tsea>0 || tgmap==1){resetcarrier();resetsailships();}
		testroc=1;
		}

var solmap="",icombo=0,combotext="";
function subcombo(){
tgmap=0;
solmap="";
icombo=document.getElementById('combo').selectedIndex;
combotext = document.getElementById('combo')[icombo].id ;
if (combotext=="initial"){
    reinitsol();tfocus=1;
    //document.getElementById('intext').focus();
	return;}
if (combotext=="yougo"){solmap=yougo256;}
if (combotext=="grece"){solmap=grece256;}
if (combotext=="hawai"){solmap=hawai256;}
if (combotext=="japan"){solmap=japan256;}
if (combotext=="egypt"){solmap=egypt256;}
if (combotext=="vietnam"){solmap=vietnam256;}
if(solmap!=""){tsea=1;reinitsolmap(solmap);updatetower();}
tfocus=1;
//document.getElementById('intext').focus();
if(solmap==""){subcombo2();}
}
var tgmap=0,lat00=0,lng00=0;
function subcombo2(){
var o10=o1;lat0=lat;lat=999;
subcombo20();
//var combotext = document.getElementById('combo')[document.getElementById('combo').selectedIndex].id ;
//x=0;y=0;
o1=o10;
if(lat==999){lat=lat0;return;}
if(lat00!=0 || lng00!=0){lat=lat00;lng=lng00;lat00=0;lng00=0;}
tgmap=1;tsea=0;getworldxy(zoom,lat,lng);tinitgmap=1;
nairport=0;ntower=0;treinitsol=-2;
}
var kheight=1;
function initgmap(){
        if(!solTexture2.data){return;}
		var ndata=solTexture2.datasize,r=0,g=0,b=0,h=0,ij=0;
		var kh=4,hmax=12,h0=0;
		for (var i=0; i < n; i++) {h0=0;
        for(var j=0;j<n;j++){
		   var k=parseInt(4*(parseInt(Math.min(ndata-1,i*ndata/n))*ndata+parseInt(j*ndata/n)));
		   r=solTexture2.data[k];
		   g=solTexture2.data[k+1];
		   b=solTexture2.data[k+2];
		   ij=j*n+i;
		   height2[ij]=1;
		   kheight[ij]=kh;
		   //h=seaheight+Math.min(((r+g)/2-b),2.0);
		   //if(b<(r+g)*0.7 && h>0){seaheight=Math.min(seaheight,(9*seaheight+h)/10);}
		   //else{height[j*n+i]=-4;}
		   if(b>r*1.4){height[ij]=-0.13;}//+(r*1.4-b);}
		   else{
		     h=12000*(g+g-b-r)/(30+r*r+g*g+b*b);
		     if(h<0.01){h=h0;h0=h;}else{h0=h;}
			 height[ij]=Math.max(0.01,h);
			 if(h>hmax){hmax=h;}
		   }
		}}
		for (var j=0; j < n; j++) {h0=0.01;
        for(var i=0;i<n;i++){
		     ij=j*n+i;h=height[ij];
			 if(h<0.1 && h>0){height[ij]=h0;h0=h;}
			 else if(h>0){h0=h;}
		}}
		var dij=10;
		for (var i=0; i < n; i+=2) {
        for(var j=0;j<n;j+=2){
		   if(height[j*n+i]<0){
		    for(var s=Math.max(0,i-dij);s<Math.min(n,i+dij);s++){
		     var ks=Math.abs(s-i)+1;
			 for(var t=Math.max(0,j-dij);t<Math.min(n,j+dij);t++){
			   var kt=Math.max(ks,Math.abs(t-j));
			   kheight[t*n+s]=Math.min(kh*kt/dij,kheight[t*n+s]);
			 }
			} 
		   }
		}}
        var kdh=(18*hmax-18*12+12*12*2)/(hmax*hmax+12*12);
		for (var i=0; i < n; i++) {
        for(var j=0;j<n;j++){
		   ij=j*n+i;
		   if(height[ij]>0){height[ij]*=kheight[ij]*kdh;}
		}}
}		
    function initBuffers() {
	    Math.seedrandom(seedrand);
	    irnd=0;
		if(tcar==1){z=0;}
        solVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, solVertexPositionBuffer);
        solvertices = new Float32Array(3*n*n);
		height=new Array((n+1)*(n+1));
		kheight=new Array((n+1)*(n+1));
		height1=new Array((n+1)*(n+1));
		height2=new Array((n+1)*(n+1));
		var heightx=new Array((n+1)*(n+1));
		var heighty=new Array((n+1)*(n+1));
		var w=1.0,wx=1.0,wy=1.0;
		for (var j=0; j < n; j++) {
        for(var i=0;i<n;i++){
		   if(Mathrandom()<0.2){w=Mathrandom()+0.35;}
		   wx+=(w-wx)*0.3;
		   heightx[i*n+j]=Math.cos(80*wx*(i)/nmap);
		}}
		for (var i=0; i < n; i++) {
        for(var j=0;j<n;j++){
		   if(Mathrandom()<0.2){w=Mathrandom()+0.35;}
		   wy+=(w-wy)*0.3;
		   heighty[i*n+j]=Math.cos(80*wy*(j)/nmap);
		}}
        seaheight=5.05;if(tsea==0){seaheight=0;}
        if(tgmap==0){
		for (var i=0; i <= n; i++) {
        for(var j=0;j<n;j++){
		   height[i*n+j]=5*heightx[i*n+j]*heighty[i*n+j];//(Math.cos(80*(i)/nmap)*Math.cos(80*(j)/nmap))*4.0;
		   height2[i*n+j]=1;
		}}
		var nmount=35*2;if(seaheight<0.1){nmount=35;}
		for(var i=0;i<nmount;i++){
		   var imount=n*(0.5+0.9*(Mathrandom()-0.5));
		   var jmount=n*(0.5+0.9*(Mathrandom()-0.5));
		   var hmount=14*(1+Mathrandom());
		   var dj=8;
		   for(var j=-dj;j<dj;j++){
		   for(var k=-dj;k<dj;k++){
		      var jj=parseInt(j+imount),kk=parseInt(k+jmount);
			  if(jj>0 && jj<n && kk>0 && kk<n){
			    height[jj*n+kk]+=hmount*Math.cos(Math.abs(3.1416*j*0.5/dj))*Math.cos(Math.abs(3.1416*k*0.5/dj));
			  }
		   }
		   }
		}
		}
		if(tgmap==1){
		  initgmap();
		}
		for (var i=0; i <= n; i++) {
        for(var j=0;j<n;j++){
		   var ij=i*n+j;
		   height[ij]-=seaheight;
		   if(height[ij]<-0.4){height[ij]=-0.4;}
		   height1[ij]=0;
		   }
		}   

		//x=0.25*(scale*((n)*8.0)/n-n4);y=x;
		var px=0,py=0;
		index=0;
		pistez=0.1+Math.max(0,-5+5*Math.floor(height[158*n+158])/5);
		for (var i=0; i < n; i++) {
        for(var j=0;j<n;j++){
		   px=(scale*(i*8.0/n)-n4);py=scale*(j*8.0/n)-n4
    	   if(Math.abs(px-pistex)<62.0){
	         if(Math.abs(py-pistey)<62.0){height[i*n+j]=pistez;};}
	       var dxwater=px-waterx;
	       var dywater=py-watery;
	       if((dxwater*dxwater+dywater*dywater)<10000){height[i*n+j]=-0.53;}
    	   var dxtown=px-(xmax-xmin)*0.7;
		   var dytown=py-(ymax-ymin)*0.7
		   if(Math.abs(dxtown)<47.0){
	         if(Math.abs(dytown)<47.0){if(height[i*n+j]<0.1){height[i*n+j]=0.1;};};}
		   append(solvertices,[
             px,py,  height[i*n+j]
             //(scale*((i+1)*8.0)/n-32)*12/8,  scale*(j*8.0/n)-n4,  height[(i+1)*n+j]
            ]);
		   
		}}		
        gl.bufferData(gl.ARRAY_BUFFER, (solvertices), gl.STATIC_DRAW);
        solVertexPositionBuffer.itemSize = 3;
        solVertexPositionBuffer.numItems = n*n;
		//vertices=null;
		heightx=null;
		heighty=null;

        //gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
        //solVertexPositionBuffer.itemSize = 3;
        //solVertexPositionBuffer.numItems = 24;

        solVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, solVertexTextureCoordBuffer);
        soltextureCoords = new Float32Array(2*n*n);
		index=0;
		for (var i=0; i < n; i++) {
        for(var j=0;j<n;j++){
		   append(soltextureCoords,[
             (i*8.0)/n-4,  (j)*8.0/n-4 
             //((i+1)*8.0)/n-4,  (j)*8.0/n-4
            ]);
		}}	
        gl.bufferData(gl.ARRAY_BUFFER, (soltextureCoords), gl.STATIC_DRAW);
        solVertexTextureCoordBuffer.itemSize = 2;
        solVertexTextureCoordBuffer.numItems = n*n;//24;

        solVertexIndexBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, solVertexIndexBuffer);
        nmap2=4*nmap;
		solVertexIndices = new Uint16Array(6*4*nmap*4*nmap);
		var n2=n+n,i2=0,j2=0;
		var nx=(n4)*n/(scale*8)-nmap2/2;
		var ny=(n4)*n/(scale*8)-nmap2/2;
		nx=parseInt(nx/6)*6;
		ny=parseInt(ny/6)*6;
		
		index=0;
		for (var i=(nx); i<((nx)+nmap2); i++) {i2=(i)*n;
        for(var j=ny;j<(ny+(nmap2));j+=1){j2=(j);
		   append(solVertexIndices,[
             i2+j2,  i2+j2+n, i2+j2+1, 
             i2+j2+n,  i2+j2+n+1,   i2+j2+1
            ]);
		}}
        //indices16=new Uint16Array(solVertexIndices)		
        gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, solVertexIndices , gl.STATIC_DRAW);
        solVertexIndexBuffer.itemSize = 1;
        solVertexIndexBuffer.numItems = 6*nmap2*nmap2;
		

        cloudVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, cloudVertexPositionBuffer);
        cloudvertices = new Float32Array(3*6*ncloud);
		var xc=0,yc=0,zc=0,distmax=1.2*(xmax-xmin)/5;
		index=0;
		for (var i=0; i < ncloud; i++) {
		   sc=(1+Math.random())*15;
		   xc=x-distmax+Math.random()*(distmax+distmax);
		   yc=y-distmax+Math.random()*(distmax+distmax);zc=30+Math.random()*30;
		   append(cloudvertices,[
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc,
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc			 
             //x,y-sc,z-sc,  x,y-sc,z+sc,  x,y+sc,z-sc,
             //x,y-sc,z+sc,  x,y+sc,z+sc,  x,y+sc,z-sc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (cloudvertices), gl.STATIC_DRAW);
        cloudVertexPositionBuffer.itemSize = 3;
        cloudVertexPositionBuffer.numItems = 6*ncloud;

        cloudVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, cloudVertexTextureCoordBuffer);
        cloudtextureCoords = new Array(2*6*ncloud);
		cloudscale=new Array(ncloud);
		var sc=1,sc2=1;
		index=0;
		for (var i=0; i < ncloud; i++) {
		   sc=(1+Math.random()*2)*0.5;cloudscale[i]=sc;
		   sc2=(1+Math.random()*0.5)*sc;
		   append(cloudtextureCoords,[
             -sc,-sc2,  -sc,sc2,   sc,-sc2,
			 -sc,sc2,   sc,sc2,    sc,-sc2
            // 0.0,0.0,  0.0,1.0,  1.0,0.0,
            // 0.0,1.0,  1.0,1.0,  1.0,0.0			 
            ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(cloudtextureCoords), gl.STATIC_DRAW);
        cloudVertexTextureCoordBuffer.itemSize = 2;
        cloudVertexTextureCoordBuffer.numItems = 6*ncloud;

        sunVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, sunVertexPositionBuffer);
        sunvertices = new Float32Array(3*6);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < 1; i++) {
		   xc=sunx;
		   yc=suny;
		   zc=sunz;
		   append(sunvertices,[
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc,
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (sunvertices), gl.STATIC_DRAW);
        sunVertexPositionBuffer.itemSize = 3;
        sunVertexPositionBuffer.numItems = 6;

        sunVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, sunVertexTextureCoordBuffer);
        suntextureCoords = new Float32Array(2*6);
		sc=5.5;sc2=11;
		index=0;
		for (var i=0; i < 1; i++) {
		   append(suntextureCoords,[
             -sc,-sc2,  -sc,sc2,   sc,-sc2,
			 -sc,sc2,   sc,sc2,    sc,-sc2
            ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (suntextureCoords), gl.STATIC_DRAW);
        sunVertexTextureCoordBuffer.itemSize = 2;
        sunVertexTextureCoordBuffer.numItems = 6;

        boussVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
        boussvertices = new Float32Array(3*6);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < 1; i++) {
		   xc=boussx;
		   yc=boussy;
		   zc=boussz;
		   append(boussvertices,[
             -xc,-yc,zc,  -xc,yc,zc,  xc,-yc,zc,
             -xc,yc,zc,  xc,yc,zc,  xc,-yc,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (boussvertices), gl.STATIC_DRAW);
        boussVertexPositionBuffer.itemSize = 3;
        boussVertexPositionBuffer.numItems = 6;

        boussVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
        var bousstextureCoords = new Array(2*6);
		sc=5.5;sc2=11;
		index=0;
		for (var i=0; i < 1; i++) {
		   append(bousstextureCoords,[
             0,0, 0,1, 1,0,
			 0,1, 1,1, 1,0
			 //-sc,-sc2,  -sc,sc2,   sc,-sc2,
			 //-sc,sc2,   sc,sc2,    sc,-sc2
            ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(bousstextureCoords), gl.STATIC_DRAW);
        boussVertexTextureCoordBuffer.itemSize = 2;
        boussVertexTextureCoordBuffer.numItems = 6;

        bouss2VertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, bouss2VertexTextureCoordBuffer);
        bouss2textureCoords = new Float32Array(2*6);
		index=0;
		for (var i=0; i < 1; i++) {
		   append(bouss2textureCoords,[
             0,0, 0,1, 1,0,
			 0,1, 1,1, 1,0
            ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (bouss2textureCoords), gl.STATIC_DRAW);
        bouss2VertexTextureCoordBuffer.itemSize = 2;
        bouss2VertexTextureCoordBuffer.numItems = 6;

        pisteVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, pisteVertexPositionBuffer);
        pistevertices = new Float32Array(3*6*npiste);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < npiste; i++) {
		   xc=7;
		   yc=7;
		   zc=0.1+pistez;//0.2;
		   var s=i*2*xc+dxmaxmin2-45.5,t=dymaxmin2;
		   append(pistevertices,[
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (pistevertices), gl.STATIC_DRAW);
        pisteVertexPositionBuffer.itemSize = 3;
        pisteVertexPositionBuffer.numItems = 6*npiste;

        pisteVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, pisteVertexTextureCoordBuffer);
        var pistetextureCoords = new Array(2*6*npiste);
		index=0;
		   append(pistetextureCoords,[
             0.5,0, 0.5,1, 1,0,
			 0.5,1, 1,1, 1,0
            ]);
		for (var i=2; i < npiste; i++) {
		   append(pistetextureCoords,[
             0,0, 0,1, 1/2,0,
			 0,1, 1/2,1, 1/2,0
            ]);
		}	
		   append(pistetextureCoords,[
             1,0, 1,1, 1/2,0,
			 1,1, 1/2,1, 1/2,0
            ]);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(pistetextureCoords), gl.STATIC_DRAW);
        pisteVertexTextureCoordBuffer.itemSize = 2;
        pisteVertexTextureCoordBuffer.numItems = 6*npiste;

        towerVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, towerVertexPositionBuffer);
        var ntower0=101;
		towervertices = new Float32Array(3*6*6*ntower0);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ntower0; i++) {
		   xc=2.5;
		   yc=2.5;
		   zc=3+pistez;
		   var s=i*4*xc+dxmaxmin2-20,t=dymaxmin2+20;
		   var h=0.9;if(i>0){zc*=1.25*(4+i%2)*3;xc*=3;yc*=3;}
		   append(towervertices,[
             //s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             //s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s,t,zc+h,
             s+xc,t-yc,zc,  s+xc,t+yc,zc,  s,t,zc+h,
             s-xc,t-yc,zc,  s+xc,t-yc,zc,  s,t,zc+h,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s,t,zc+h,
			 
             s-xc,t-yc,0,  s-xc,t-yc,zc,  s+xc,t-yc,0,
             s-xc,t-yc,zc,  s+xc,t-yc,zc,  s+xc,t-yc,0,			 
             
             s-xc,t+yc,0,  s-xc,t+yc,zc,  s+xc,t+yc,0,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t+yc,0,			 
             
			 s-xc,t-yc,0,  s-xc,t-yc,zc,  s-xc,t+yc,0,
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s-xc,t+yc,0,			 
             
			 s+xc,t-yc,0,  s+xc,t-yc,zc,  s+xc,t+yc,0,
             s+xc,t-yc,zc,  s+xc,t+yc,zc,  s+xc,t+yc,0,			 
			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (towervertices), gl.STATIC_DRAW);
        towerVertexPositionBuffer.itemSize = 3;
        towerVertexPositionBuffer.numItems = 6*6*4;//*ntower0;

        towerVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, towerVertexTextureCoordBuffer);
        towertexcoords = new Float32Array(2*6*6*ntower0);
		index=0;
		for (var i=0; i < ntower0; i++) {
		   var u=0.25,v=0.25;
		   append(towertexcoords,[
             u,v, u,v+0.1, u+0.1,v,
			 u,v+0.1, u+0.1,v+0.1, u+0.1,v,

             u,v, u,v+0.1, u+0.1,v,
			 u,v+0.1, u+0.1,v+0.1, u+0.1,v
			 ]);
		   var s=4,t=3,sy=2;
		   //if(i>0){t*=1.25*(4+i%2)*2;s*=2;sy*=2;}
		   if(i>0){t*=1.25*(4+i%2)*2;s*=1.8;sy*=1.8;}
		   append(towertexcoords,[
             0,0, 0,t, s,0,
			 0,t, s,t, s,0,
			 
             0,0, 0,t, s,0,
			 0,t, s,t, s,0,			 

             0,0, 0,t, sy,0,
			 0,t, sy,t, sy,0,
			 
             0,0, 0,t, sy,0,
			 0,t, sy,t, sy,0			 
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (towertexcoords), gl.STATIC_DRAW);
        towerVertexTextureCoordBuffer.itemSize = 2;
        towerVertexTextureCoordBuffer.numItems = 6*6*4;//*ntower0;
	
	    Math.seedrandom(seedrand);
        ntown=40;
		townVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, townVertexPositionBuffer);
        townvertices = new Float32Array(3*6*6*ntown);
		townx=new Array(ntown);towny=new Array(ntown);townz=new Array(ntown);
		towno1=new Array(ntown);towndx=new Array(ntown);towndz=new Array(ntown);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ntown; i++) {
		   xc=2.5;
		   yc=2.5;
		   zc=3;
		   var s=(xmax-xmin)*0.7,t=(ymax-ymin)*0.7,h=1.5;
		   s+= Math.floor( Math.random() * 200 - 100 ) * 0.42;
		   t+= Math.floor( Math.random() * 200 - 100 ) * 0.42;
		   var rot= Math.random();
		   var scx= Math.random() * Math.random() * Math.random() * Math.random() * 50 + 10;
		   xc*=scx/10;yc*=scx/10;			
		   zc*=(( Math.random() * Math.random() * Math.random() * scx ) * 8 + 8)/10;
		   towndx[i]=xc;towndz[i]=zc;
		   zc+=getterrainheight(s,t)-xc*0.1;
		   townx[i]=s;towny[i]=t;townz[i]=zc;towno1[i]=rot;
		   appendrot(townvertices,[
             //s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             //s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s,t,zc+h,
             s+xc,t-yc,zc,  s+xc,t+yc,zc,  s,t,zc+h,
             s-xc,t-yc,zc,  s+xc,t-yc,zc,  s,t,zc+h,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s,t,zc+h,
			 
             s-xc,t-yc,0,  s-xc,t-yc,zc,  s+xc,t-yc,0,
             s-xc,t-yc,zc,  s+xc,t-yc,zc,  s+xc,t-yc,0,			 
             
             s-xc,t+yc,0,  s-xc,t+yc,zc,  s+xc,t+yc,0,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t+yc,0,			 
             
			 s-xc,t-yc,0,  s-xc,t-yc,zc,  s-xc,t+yc,0,
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s-xc,t+yc,0,			 
             
			 s+xc,t-yc,0,  s+xc,t-yc,zc,  s+xc,t+yc,0,
             s+xc,t-yc,zc,  s+xc,t+yc,zc,  s+xc,t+yc,0,			 
			 
			 ],s,t,rot); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (townvertices), gl.STATIC_DRAW);
        townVertexPositionBuffer.itemSize = 3;
        townVertexPositionBuffer.numItems = 6*6*ntown;

        townVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, townVertexTextureCoordBuffer);
        var towntextureCoords = new Array(2*6*6*ntown);
		index=0;
		for (var i=0; i < ntown; i++) {
		   var u=0.25,v=0.25;
		   append(towntextureCoords,[
             u,v, u,v+0.1, u+0.1,v,
			 u,v+0.1, u+0.1,v+0.1, u+0.1,v,

             u,v, u,v+0.1, u+0.1,v,
			 u,v+0.1, u+0.1,v+0.1, u+0.1,v
			 ]);
		   var s=2*towndx[i],t=1.5*towndz[i],sy=1*towndx[i];
		   append(towntextureCoords,[
             0,0, 0,t, s,0,
			 0,t, s,t, s,0,
			 
             0,0, 0,t, s,0,
			 0,t, s,t, s,0,			 

             0,0, 0,t, sy,0,
			 0,t, sy,t, sy,0,
			 
             0,0, 0,t, sy,0,
			 0,t, sy,t, sy,0			 
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(towntextureCoords), gl.STATIC_DRAW);
        townVertexTextureCoordBuffer.itemSize = 2;
        townVertexTextureCoordBuffer.numItems = 6*6*ntown;
		
		
        waterVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, waterVertexPositionBuffer);
        watervertices = new Float32Array(3*6);
		xc=0;yc=0;zc=0;
		index=0;
		   xc=110;
		   yc=110;
		   zc=-0.2;
		   var s=waterx,t=watery;
		   append(watervertices,[
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc			 
			 ]); 	
        gl.bufferData(gl.ARRAY_BUFFER, (watervertices), gl.STATIC_DRAW);
        waterVertexPositionBuffer.itemSize = 3;
        waterVertexPositionBuffer.numItems = 6;

        waterVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, waterVertexTextureCoordBuffer);
        var watertextureCoords = new Array(2*6);
		index=0;
		var s=10,t=0;
		   append(watertextureCoords,[
             0,0, 0,s, s,0,
			 0,s, s,s, s,0
            ]);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(watertextureCoords), gl.STATIC_DRAW);
        waterVertexTextureCoordBuffer.itemSize = 2;
        waterVertexTextureCoordBuffer.numItems = 6;

        seaVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, seaVertexPositionBuffer);
        seavertices = new Float32Array(3*6);
		xc=0;yc=0;zc=0;
		index=0;
		var seascale=4.7*1.2;
		   xc=110*seascale;
		   yc=110*seascale;
		   zc=-0.3;
		   s=seax;t=seay;
		   append(seavertices,[
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc			 
			 ]); 	
        gl.bufferData(gl.ARRAY_BUFFER, (seavertices), gl.STATIC_DRAW);
        seaVertexPositionBuffer.itemSize = 3;
        seaVertexPositionBuffer.numItems = 6;

        seaVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, seaVertexTextureCoordBuffer);
        seatextureCoords = new Float32Array(2*6);
		index=0;
		s=10*seascale;if(tsea==2){s*=2}
		   append(seatextureCoords,[
             0,0, 0,s, s,0,
			 0,s, s,s, s,0
            ]);
        gl.bufferData(gl.ARRAY_BUFFER, (seatextureCoords), gl.STATIC_DRAW);
        seaVertexTextureCoordBuffer.itemSize = 2;
        seaVertexTextureCoordBuffer.numItems = 6;

	    Math.seedrandom(seedrand);
        treeVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, treeVertexPositionBuffer);
        treevertices = new Float32Array(3*3*ntree);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ntree; i++) {
		   zc=1;
		   var h=2;
		   s=Math.random()*2*90+dxmaxmin2;
		   t=Math.random()*2*90+dymaxmin2;
		   zc=getterrainheight(s,t);
		   append(treevertices,[
             s-xc,t-yc,zc,  s,t,zc+h,  s+xc,t+yc,zc	 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (treevertices), gl.STATIC_DRAW);
        treeVertexPositionBuffer.itemSize = 3;
        treeVertexPositionBuffer.numItems = 3*ntree;

        treeVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, treeVertexTextureCoordBuffer);
        var treetextureCoords = new Array(2*3*ntree);
		index=0;
		for (var i=0; i < ntree; i++) {
		   append(treetextureCoords,[
             0,0,  0.5,1,  1,0
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(treetextureCoords), gl.STATIC_DRAW);
        treeVertexTextureCoordBuffer.itemSize = 2;
        treeVertexTextureCoordBuffer.numItems = 3*ntree;

        tirVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, tirVertexPositionBuffer);
        tirvertices = new Float32Array(3*6*ntir);
        tirx = new Array(ntir);
        tiry = new Array(ntir);
        tirz = new Array(ntir);
        vtirx = new Array(ntir);
        vtiry = new Array(ntir);
        vtirz = new Array(ntir);
        tirsize = new Array(ntir);
        tirtype = new Array(ntir);
        ttir = new Array(ntir);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ntir; i++) {
		   zc=20;
		   var h=2;
		   s=i*10+x;
		   t=y;
		   xc=1;zc=-999;
		   tirx[i]=s;tiry[i]=t;tirz[i]=zc;tirsize[i]=1;ttir[i]=0;tirtype[i]=0;
		   append(tirvertices,[
             s-xc,t,zc,  s-xc,t,zc+h,  s+xc,t,zc,	 
             s-xc,t,zc+h,  s+xc,t,zc+h,  s+xc,t,zc	 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (tirvertices), gl.STATIC_DRAW);
        tirVertexPositionBuffer.itemSize = 3;
        tirVertexPositionBuffer.numItems = 6*ntir;

        tirVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, tirVertexTextureCoordBuffer);
        var tirtextureCoords = new Array(2*6*ntir);
		index=0;
		for (var i=0; i < ntir; i++) {
		   append(tirtextureCoords,[
             0,0,  0,1,  1,0,
			 0,1,  1,1,  1,0
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(tirtextureCoords), gl.STATIC_DRAW);
        tirVertexTextureCoordBuffer.itemSize = 2;
        tirVertexTextureCoordBuffer.numItems = 6*ntir;

	    Math.seedrandom(seedrand);
        starVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, starVertexPositionBuffer);
        starvertices = new Float32Array(3*3*nstar);
		xc=0;yc=0;zc=0;
		/*auxvar=0;auxvar2=999999;
		for (var j=2; j < 700; j++) {
		   xc=starxxa[j];
		   yc=staryya[j];
		   zc=starzza[j];
		   var d=Math.sqrt(xc*xc+yc*yc+zc*zc);
		   auxvar=Math.max(auxvar,d);
		   auxvar2=Math.min(auxvar2,d);
		};alert(auxvar+"  "+auxvar2);*/
        Math.seedrandom(1);
		index=0;
		for (var i=0; i < nstar; i++) {
		   var r=500;
		   var so1=Math.random()*360;
		   var so2=(Math.random()*179-89)*Math.random();
		   /*xc=r*Math.cos(degtorad(so1))*Math.cos(degtorad(so2));
		   yc=r*Math.sin(degtorad(so1))*Math.cos(degtorad(so2));
		   zc=r*Math.sin(degtorad(so2));*/
		   var j=i+2;
		   var k=2;if(j<nstars0 && nstars0==787){k=Math.pow(Math.random(),1/3)*2;};
		   if(j<nstars0-2 && nstars0!=787){
		     xc=starxxa[j];
		     yc=staryya[j];
		     zc=starzza[j];
			 var test=0;
   		     for(var jj=j+1;jj<nstars0;jj++){
			    if(Math.abs(xc-starxxa[jj])<250){
			     if(Math.abs(yc-staryya[jj])<250){
				  if(Math.abs(zc-starzza[jj])<250){
				    test=1;stardouble[j]=1;stardouble[jj]=1;};};};}
             /*var dist=Math.sqrt(xc*xc+yc*yc+zc*zc)+0.001;
             var dif=5001-dist;k=4/dif;*/
			 if(test==1){starxxa[j]+=(1+Math.random())*150;
			             staryya[j]+=(Math.random()-0.5)*200;
						 }
		   }
		   starxxa[j]*=k;staryya[j]*=k;starzza[j]*=k;//random depth
		   xc=starxxa[j]/10;
		   yc=staryya[j]/10;
		   zc=starzza[j]/10;
		   append(starvertices,[
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc	 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (starvertices), gl.STATIC_DRAW);
        starVertexPositionBuffer.itemSize = 3;
        starVertexPositionBuffer.numItems = 3*nstar;
        Math.seedrandom(seedrand);
		
        starVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, starVertexTextureCoordBuffer);
        var startextureCoords = new Array(2*3*nstar);
		index=0;
		for (var i=0; i < nstar; i++) {
		   var r=starr[i+2];//1.0+Math.random();starr[i+2]=r;
		   append(startextureCoords,[
             -r,-r,  0.0,r,  r,-r
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(startextureCoords), gl.STATIC_DRAW);
        starVertexTextureCoordBuffer.itemSize = 2;
        starVertexTextureCoordBuffer.numItems = 3*nstar;
		
        dustVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, dustVertexPositionBuffer);
        dustvertices = new Float32Array(3*3*ndust);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ndust; i++) {
		   var r=100;
		   xc=(Math.random()-0.5)*r;
		   yc=(Math.random()-0.5)*r;
		   zc=(Math.random()-0.5)*r;
		   append(dustvertices,[
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc	 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (dustvertices), gl.STATIC_DRAW);
        dustVertexPositionBuffer.itemSize = 3;
        dustVertexPositionBuffer.numItems = 3*ndust;

        dustVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, dustVertexTextureCoordBuffer);
        var dusttextureCoords = new Array(2*3*ndust);
		index=0;
		for (var i=0; i < ndust; i++) {
		   var r=(1.0+Math.random())*0.1;
		   append(dusttextureCoords,[
             -r,-r,  0.0,r,  r,-r
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(dusttextureCoords), gl.STATIC_DRAW);
        dustVertexTextureCoordBuffer.itemSize = 2;
        dustVertexTextureCoordBuffer.numItems = 3*ndust;
	
    	portVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, portVertexPositionBuffer);
        portvertices = new Float32Array(3*6);
		xc=0;yc=0;zc=0;
		index=0;
		   s=portx;t=porty;
		   xc=(xmax-xmin)/8;
		   yc=(ymax-ymin)/8;
		   zc=0.4+getterrainheight(s,t);
		   append(portvertices,[
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc			 
			 ]); 	
        gl.bufferData(gl.ARRAY_BUFFER, (portvertices), gl.STATIC_DRAW);
        portVertexPositionBuffer.itemSize = 3;
        portVertexPositionBuffer.numItems = 6;

        portVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, portVertexTextureCoordBuffer);
        var porttextureCoords = new Array(2*6);
		index=0;
		   append(porttextureCoords,[
             0,0, 0,1, 1,0,
			 0,1, 1,1, 1,0
            ]);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(porttextureCoords), gl.STATIC_DRAW);
        portVertexTextureCoordBuffer.itemSize = 2;
        portVertexTextureCoordBuffer.numItems = 6;

	    Math.seedrandom();

}
		

function addindex(tab,values){
	var ix=0,n2=n*n;
	for(var i=0;i<values.length;i++){
	   ix=parseInt(values[i]);
	   if(ix<0){ix+=n2;};
       if(ix>n2){ix-=n2;};
       tab[index]=ix;
	   index+=1;
	}
}
function addindexcloud(tab,values){
	var ix=0;
	for(var i=0;i<values.length;i++){
	   ix=values[i];
	   tab[index]=(ix);
	   index+=1;
	}
}
var x1=0,y1=0,z1=0,x2=0,y2=0,z2=0;
function rotavion(x,y,z,r){
if(tourelle==0 || tfoot==1 || tcar==1){
 x1=x*cos1+y*sin1;
 //'y1=0-x*sin1+y*cos1
 //'z1=z
 x2=x1*cos2+z*sin2;
 //'y2=y1
 y2=-x*sin1+y*cos1;
 z2=-x1*sin2+z*cos2;
}else{
 x1=x*tcos1+y*tsin1;
 //'y1=0-x*tsin1+y*tcos1
 //'z1=z
 x2=x1*tcos2+z*tsin2;
 //'y2=y1
 y2=-x*tsin1+y*tcos1;
 z2=-x1*tsin2+z*tcos2;
 }
if(x2<0.87*Math.abs(y2)/(gl.viewportWidth/gl.viewportHeight)-r){return 0;}
if(x2<0.87*Math.abs(z2)-r){return 0;}
return 1;
}
function rotavion2(xx,yy,zz,r){
        mvPushMatrix();
		//mat4.lookAt([x,y,z+0.5],[x+cos1*sin2,y+sin1*sin2,z-cos2+0.5],[0,0,1],mvMatrix);
		mat4.translate(mvMatrix, [xx,yy,zz]);
		y2=-mvMatrix[12];z2=mvMatrix[13];x2=-mvMatrix[14];
		mvPopMatrix();
if(x2<0.87*Math.abs(y2)/(gl.viewportWidth/gl.viewportHeight)-r){return 0;}
if(x2<0.87*Math.abs(z2)-r){return 0;}
return 1;
}
function setobjectdx(){
for(var i=0;i<ntank;i++){
  ptankx[i]+=nextdx;ptanky[i]+=nextdy;
}
for(var i=0;i<nsailship;i++){
  psailshipx[i]+=nextdx;psailshipy[i]+=nextdy;
}
//shipx+=nextdx;shipy+=nextdy;
shipcarrierx+=nextdx;shipcarriery+=nextdy;
px+=nextdx;py+=nextdy;
p3x+=nextdx;p3y+=nextdy;
portx+=nextdx;porty+=nextdy;
for(var i=0;i<ntower;i++){
  towerx[i]+=nextdx;towery[i]+=nextdy;
}
updatetower();
horse1lowx+=nextdx;horse1lowy+=nextdy;
horse2lowx+=nextdx;horse2lowy+=nextdy;
horse3lowx+=nextdx;horse3lowy+=nextdy;
elephant1lowx+=nextdx;elephant1lowy+=nextdy;
elephant2lowx+=nextdx;elephant2lowy+=nextdy;
elephant3lowx+=nextdx;elephant3lowy+=nextdy;
girafe1lowx+=nextdx;girafe1lowy+=nextdy;
girafe2lowx+=nextdx;girafe2lowy+=nextdy;
girafe3lowx+=nextdx;girafe3lowy+=nextdy;
zebra1lowx+=nextdx;zebra1lowy+=nextdy;
zebra2lowx+=nextdx;zebra2lowy+=nextdy;
zebra3lowx+=nextdx;zebra3lowy+=nextdy;
birdx+=nextdx;birdy+=nextdy;
bird2x+=nextdx;bird2y+=nextdy;
bird3x+=nextdx;bird3y+=nextdy;
antilope1lowx+=nextdx;antilope1lowy+=nextdy;
antilope2lowx+=nextdx;antilope2lowy+=nextdy;
antilope3lowx+=nextdx;antilope3lowy+=nextdy;
for(var i=0;i<nroc;i++){
  rocx[i]+=nextdx;rocy[i]+=nextdy;
}
}
function sign(x){if(x>=0){return 1;}else{return -1;};}
var nextdx=0,nextdy=0,worldx=0,worldy=0,treinitgmap=0,tinitgmap=0;
function reinitgmap(){treinitgmap=tframe+22000;return;
var worldx1=0,worldy1=0;
solTexture3.image.onload = function () {
	//canvastext.drawImage(solTexture3.image, -40, -40,1104,1104);
	canvastext.drawImage(solTexture3.image, 0, 0,512,512);
	handleLoadedTexture00(solTexture3);
	worldx=worldx1;worldy=worldy1;
	reinitsol();
	x+=nextdx;
	y+=nextdy;
	setobjectdx();
    setTimeout("getairports();",100);
	setTimeout("gettowers();",100);
    treinitgmap=tframe+3000;
    tskip2=0;	
    canvas2.setAttribute('width', 10);
    canvas2.setAttribute('height', 10);
	setTimeout("solTexture3.image.src=null;",300);
    }
solTexture1.image.onload = function () {
	tskip2=timer()+10000;
	canvastext.drawImage(solTexture1.image, -40, -40,1104,1104);
	handleLoadedTexture00(solTexture1);
    canvas2.setAttribute('width', 512);
    canvas2.setAttribute('height', 512);
    solTexture3.image.crossOrigin = "anonymous";
    solTexture3.image.src = getmap(zoom-2,lat,lng,512,"jpg",1);//map2jpg;
    //solTexture3.image.src = "crick1024.jpg";//map2jpg;
	setTimeout("solTexture1.image.src=null;",300);
    }
solTexture2.image.onload = function () {
    //handleLoadedTexture(solTexture2);
	canvastext.drawImage(solTexture2.image, -20, -20,552,552);
	handleLoadedTexture00(solTexture2);
	solTexture2.data=gettexturedata(solTexture2);
    solTexture2.datasize=parseInt(Math.sqrt(solTexture2.data.length/4));
    //auxvar=solTexture2.datasize;
    canvas2.setAttribute('width', 1024);
    canvas2.setAttribute('height', 1024);
    solTexture1.image.crossOrigin = "anonymous";
    solTexture1.image.src = getmap(zoom,lat,lng,552,"png",2);//map2jpg;
    //solTexture1.image.src = "crick1024.png";
	setTimeout("solTexture2.image.src=null;",300);
	}
canvas2.setAttribute('width', 512);
canvas2.setAttribute('height', 512);
var worldx0=worldx,worldy0=worldy;
//scaletexture=(n/(8*scale));
scaletexture=512/(xmax-xmin);
worldx-=nextdx*scaletexture;
worldy-=nextdy*scaletexture;
getlatlng(zoom,worldx,worldy);
worldx1=worldx;worldy1=worldy;
worldx=worldx0;worldy=worldy0;
//getworldxy(zoom,lat,lng);
//var dx=(worldx-worldx0)/scaletexture;
//alert(dx+nextdx);
solTexture2.image.crossOrigin = "anonymous";
solTexture2.image.src = getterrain(zoom,lat,lng,552,"jpg",1);//map2jpg;
//solTexture2.image.src = "crickrelief.jpg";//map2jpg;
}
function getportmap(){treinitgmap=tframe+22000;
solTexture4.image.onload = function () {
	canvastext.drawImage(solTexture4.image, -40, -40,1104,1104);
    portxok=0;
	handleLoadedTexture00(solTexture4);
    canvas2.setAttribute('width', 10);
    canvas2.setAttribute('height', 10);
    treinitgmap=tframe+3000;
	portxok=1;
	setTimeout("solTexture4.image.src=null;",300);
    }
canvas2.setAttribute('width', 1024);
canvas2.setAttribute('height', 1024);
solTexture4.image.crossOrigin = "anonymous";
solTexture4.image.src = getmap(zoom+2,portlat,portlng,552,"jpg",2);//map2jpg;
//solTexture4.image.src = "c150.jpg";
}
var nx0=0,ny0=0,tmove=0,tmove2=0,trot2=0;
function updateindex(){
      if(tframe>(treinitgmap) && tgmap==1){
        var dx=x-xmaxmin2;
		var dy=y-ymaxmin2;
		nextdx=0;nextdy=0;
		if(Math.abs(dx)>(xmax-xmin)*(0.5-0.15)){
		      //nextdx=-sign(dx)*((xmax-xmin)*(1-0.15*2)-200);
			  var nextx=xmaxmin2-cos1*((xmax-xmin)*(0.5-0.15)-400);
			  var nexty=ymaxmin2-sin1*((ymax-ymin)*(0.5-0.15)-400);
			  nextdx=nextx-x;
			  nextdy=nexty-y;
			  treinitgmap=tframe+10000;}
		if(Math.abs(dy)>(ymax-ymin)*(0.5-0.15)){
			  //nextdy=-sign(dy)*((ymax-ymin)*(1-0.15*2)-200);
			  var nextx=xmaxmin2-cos1*((xmax-xmin)*(0.5-0.15)-200);
			  var nexty=ymaxmin2-sin1*((ymax-ymin)*(0.5-0.15)-200);
			  nextdx=nextx-x;
			  nextdy=nexty-y;
			  treinitgmap=tframe+10000;}
		if(tinitgmap==1){tinitgmap=0;treinitgmap=tframe+10000;}
		if(tframe<(treinitgmap+10)){reinitgmap();};	  
	    }		  
		var n2=n+n,i2=0,j2=0;
        //n4=scale*1;
		//var xmax=0.99*(scale*(8.0*n)/n-n4), ymax=0.99*(scale*(n*8.0/n)-n4);//,  height[i*n+j],
		//var xmin=0.99*(scale*(8.0*0)/n-n4), ymin=0.99*(scale*(0*8.0/n)-n4);//,  height[i*n+j],
        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, solVertexIndexBuffer);
		nmap2=parseInt((1+Math.max(20,z-zsol)/80)*nmap);
		if(nmap2>4*nmap){nmap2=4*nmap;};if(nmap2<1){nmap2=1;};
		distmap2=nmap2*scale*0.5*8/n;
		if(tgmap==1){distmap2=(xmax-xmin)/2;}
		var nx=(x+n4)*n/(scale*8);
		var ny=(y+n4)*n/(scale*8);
		testwater=1;
		var alt=getterrainheight2(x,y);zsol=alt;//if(z>(alt+5)){zsol=0.1;};
		if(twater==1 || (zsol<-0.28 && tsea>0) || (zsol<-0.01 && tgmap==1)){
		   if(tmove2==1 || trot2==1){
		      if(tfoot==1 || landing==1){
			     soundwater();};};}
		testwater=0;
		if(tframe>tsoundwater+1000 && vplane>0.01 && tcar==1){
		  planedo2+=1.4*(1.0-Math.cos((tframe-tsoundwater-1000)*0.0055*vplane));
        }		   
		if(z<(alt+0.694) && tfoot==0 && tcar==0){
		   vmz=0;
		   if(landing==0){soundpneu();}; 
		   z=alt+0.69;landing=1;
		   if(o2<-8*tpiste){o2=-0.6*o2+Math.random()*0.5;
		     }else{if(o2<-0.002){o2=-0.001;};}
		   }else{landing=0;};
		nx-=nmap2/2;ny-=nmap2/2;
		if(tcar==0){
		 nx=parseInt(nx/6)*6;
		 ny=parseInt(ny/6)*6;
		}else{
		 nx=parseInt(nx/3)*3;
		 ny=parseInt(ny/3)*3;
        }		
		tmove=0;
		if(nx==nx0 && ny==ny0 && trot2==0){return;};
		if(nx!=nx0 || ny!=ny0){nx0=nx;ny0=ny;tmove=1;}
		var nx2=nx+nmap2/2,ny2=ny+nmap2/2,test=0,dj=4,nitem=0;
		index=0;
	if(nmap2<(2*nmap)){
	    var i0=Math.max(0,nx),i1=Math.min(n,nx+nmap2);
	    var j0=Math.max(0,ny),j1=Math.min(n,ny+nmap2);
		var d6=6;if(tcar==1){d6=7;};
		for(var i=i0; i<i1; i++) {i2=((i+n)%n)*n;test=0;dj=4;
        for(var j=j0; j<j1; j++){j2=(j+n)%n;
		   dj+=1;if(dj>=4){dj=0;
              if(rotavion(i-nx2,j-ny2,0,d6) || o2<-35){test=1;
		     }else{j+=4;dj=4;if(test==1){break;};}}		   
		   if(test==1){nitem+=1;
		    addindex(solVertexIndices,[
             i2+j2,  i2+j2+n, i2+j2+1, 
             i2+j2+n,  i2+j2+n+1,   i2+j2+1
            ]);}
		}}
	}else{
	    var i0=Math.max(0,nx),i1=Math.min(n-1,nx+nmap2-1);
	    var j0=Math.max(0,ny),j1=Math.min(n-1,ny+nmap2-1);
		var d6=6;if(tcar==1){d6=7;};
		for(var i=i0; i<i1; i+=2) {i2=((i+n)%n)*n;test=0;dj=4;
        for(var j=j0; j<j1; j+=2){j2=(j+n)%n;
		   dj+=1;if(dj>=4){dj=0;
              if(rotavion(i-nx2,j-ny2,0,d6) || o2<-35){test=1;
		     }else{j+=8;dj=4;if(test==1){break;};}}		   
		   if(test==1){nitem+=1;
		    addindex(solVertexIndices,[
             i2+j2,  i2+j2+n+n, i2+j2+2, 
             i2+j2+n+n,  i2+j2+n+n+2,   i2+j2+2
            ]);}
		}}
	}	
        gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, solVertexIndices , gl.STATIC_DRAW);
		solVertexIndexBuffer.numItems = 6*nitem;//6*nmap2*(nmap2-1);

		/*if(nx==nx0 && ny==ny0){return;};
		nx0=nx;ny0=ny;tmove=1;
		index=0;
		for (var i=nx; i<(nx+nmap2); i++) {i2=((i+n)%n)*n;
        for(var j=ny;j<(ny+(nmap2));j++){j2=(j+n)%n;
		   addindex(solVertexIndices,[
             i2+j2,  i2+j2+n, i2+j2+1, 
             i2+j2+n,  i2+j2+n+1,   i2+j2+1
            ]);
		}}
        gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, solVertexIndices , gl.STATIC_DRAW);
		solVertexIndexBuffer.numItems = 6*nmap2*(nmap2-1);
		*/
}
function updatetower(){return;
        if(tgmap==0){ntower=0;}
		//towerVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, towerVertexPositionBuffer);
        var ntower0=Math.min(101,ntower+1);
		//towervertices = new Float32Array(3*6*6*ntower0);
		var wx=eiffeltowerx,wy=eiffeltowery;
		if(Math.abs(wx-worldx)<1024){
		 if(Math.abs(wy-worldy)<1024){
		  for(var i=1;i<ntower0;i++){
		    if(Math.abs(towerwx[i-1]-wx)<2){
		     if(Math.abs(towerwy[i-1]-wy)<2){
			   towerz[i-1]=-999;
		}}}}}	   
		wx=libertystatuex;wy=libertystatuey;
		if(Math.abs(wx-worldx)<1024){
		 if(Math.abs(wy-worldy)<1024){
		  for(var i=1;i<ntower0;i++){
		    if(Math.abs(towerwx[i-1]-wx)<2){
		     if(Math.abs(towerwy[i-1]-wy)<2){
			   towerz[i-1]=-999;
		}}}}}   
		wx=christriox;wy=christrioy;
		if(Math.abs(wx-worldx)<1024){
		 if(Math.abs(wy-worldy)<1024){
		  for(var i=1;i<ntower0;i++){
		    if(Math.abs(towerwx[i-1]-wx)<2){
		     if(Math.abs(towerwy[i-1]-wy)<2){
			   towerz[i-1]=-999;
		}}}}}   
		wx=domerockx;wy=domerocky;
		if(Math.abs(wx-worldx)<1024){
		 if(Math.abs(wy-worldy)<1024){
		  for(var i=1;i<ntower0;i++){
		    if(Math.abs(towerwx[i-1]-wx)<25){
		     if(Math.abs(towerwy[i-1]-wy)<25){
			   towerz[i-1]=-999;
		}}}}}   
		var wx=gizahx,wy=gizahy;
		if(Math.abs(wx-worldx)<1024){
		 if(Math.abs(wy-worldy)<1024){
		  for(var i=1;i<ntower0;i++){
		    if(Math.abs(towerwx[i-1]-wx)<25){
		     if(Math.abs(towerwy[i-1]-wy)<25){
			   towerz[i-1]=-999;
		}}}}}	   
		wx=capitolex;wy=capitoley;
		if(Math.abs(wx-worldx)<1024){
		 if(Math.abs(wy-worldy)<1024){
		  for(var i=1;i<ntower0;i++){
		    if(Math.abs(towerwx[i-1]-wx)<25){
		     if(Math.abs(towerwy[i-1]-wy)<25){
			   towerz[i-1]=-999;
		}}}}}   
		wx=tajmahalx;wy=tajmahaly;
		if(Math.abs(wx-worldx)<1024){
		 if(Math.abs(wy-worldy)<1024){
		  for(var i=1;i<ntower0;i++){
		    if(Math.abs(towerwx[i-1]-wx)<15){
		     if(Math.abs(towerwy[i-1]-wy)<15){
			   towerz[i-1]=-999;
		}}}}}   
		wx=buddahx;wy=buddahy;
		if(Math.abs(wx-worldx)<1024){
		 if(Math.abs(wy-worldy)<1024){
		  for(var i=1;i<ntower0;i++){
		    if(Math.abs(towerwx[i-1]-wx)<15){
		     if(Math.abs(towerwy[i-1]-wy)<15){
			   towerz[i-1]=-999;
		}}}}}   
		var xc=0,yc=0,zc=0;
		index=0;
		for (var i=0; i < ntower0; i++) {
		   xc=2.5;
		   yc=2.5;
		   zc=3;
		   var s=i*4*xc+dxmaxmin2-20,t=dymaxmin2+20;
		   var h=0.9,h0=0;
		   if(i==0){zc=3+pistez;h0=pistez;}
		   else{
		      if(towertype[i-1]==1){
			    zc*=1.25*(4+i%2)*3;xc*=3;yc*=3;
			  }else if(towertype[i-1]==2){
			    zc*=0.85*(4+i%2)*3;xc*=5;yc*=2.8;
			  }else if(towertype[i-1]==3){
			    zc*=0.95*(4+i%2)*3;xc*=3;yc*=3;
			  }else{
			    zc*=0.28*(4+i%2);xc*=1.8;yc*=1.8;h=1.8;
			  }
			  s=towerx[i-1];t=towery[i-1];h0=towerz[i-1];
			  //s=x+i*10;t=y+i*10;h0=getterrainheight(s,t);
			  zc+=h0;
			  //if((parseInt((s+t)/200)%2)==1){
			  //   var xxc=xc;xc=yc;yc=xxc;}
		   }
		   append(towervertices,[
             //s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             //s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s,t,zc+h,
             s+xc,t-yc,zc,  s+xc,t+yc,zc,  s,t,zc+h,
             s-xc,t-yc,zc,  s+xc,t-yc,zc,  s,t,zc+h,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s,t,zc+h,
			 
             s-xc,t-yc,h0,  s-xc,t-yc,zc,  s+xc,t-yc,h0,
             s-xc,t-yc,zc,  s+xc,t-yc,zc,  s+xc,t-yc,h0,			 
             
             s-xc,t+yc,h0,  s-xc,t+yc,zc,  s+xc,t+yc,h0,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t+yc,h0,			 
             
			 s-xc,t-yc,h0,  s-xc,t-yc,zc,  s-xc,t+yc,h0,
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s-xc,t+yc,h0,			 
             
			 s+xc,t-yc,h0,  s+xc,t-yc,zc,  s+xc,t+yc,h0,
             s+xc,t-yc,zc,  s+xc,t+yc,zc,  s+xc,t+yc,h0,			 
			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (towervertices), gl.STATIC_DRAW);
        towerVertexPositionBuffer.itemSize = 3;
        towerVertexPositionBuffer.numItems = 6*6*ntower0;

        //towerVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, towerVertexTextureCoordBuffer);
        //towertexcoords = new Float32Array(2*6*6*ntower0);
		index=0;
		for (var i=0; i < ntower0; i++) {
		   var u=0.25,v=0.25;
		   append(towertexcoords,[
             u,v, u,v+0.1, u+0.1,v,
			 u,v+0.1, u+0.1,v+0.1, u+0.1,v,

             u,v, u,v+0.1, u+0.1,v,
			 u,v+0.1, u+0.1,v+0.1, u+0.1,v
			 ]);
		   var s=4,t=3,sy=2;
		   //if(i>0){t*=1.25*(4+i%2)*2;s*=2;sy*=2;}
		   if(i>0){
		     if(towertype[i-1]!=4){t*=1.25*(4+i%2)*2;s*=1.8;sy*=1.8;}
		     else{t*=0.5*(4+i%2);s*=1.7;sy*=1.7;}
			 var h0=Math.abs(towerz[i-1]);
			 t*=(200+h0)/(250+3.5*h0);
		   }
		   append(towertexcoords,[
             0,0, 0,t, s,0,
			 0,t, s,t, s,0,
			 
             0,0, 0,t, s,0,
			 0,t, s,t, s,0,			 

             0,0, 0,t, sy,0,
			 0,t, sy,t, sy,0,
			 
             0,0, 0,t, sy,0,
			 0,t, sy,t, sy,0			 
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (towertexcoords), gl.STATIC_DRAW);
        towerVertexTextureCoordBuffer.itemSize = 2;
        towerVertexTextureCoordBuffer.numItems = 6*6*ntower0;
	
}
var cloudsize=1,cloudsize1=1,tstorm=0,timerain=0,train0=0;
cloudsize=0.8+0.5*Math.random();
cloudsize1=cloudsize;
function updatecloud(){
        if(tspace==1){updatecloudspace();return;}
        train=0;
		if(tframe>timerain){
		      timerain=tframe+5000+Math.random()*30000;
		      if(Math.random()<0.4){train0=1;}else{train0=0;}}
        gl.bindBuffer(gl.ARRAY_BUFFER, cloudVertexPositionBuffer);
		var xc=0,yc=0,zc=0,distmax=1.2*(xmax-xmin)/5;
		var dx0=x-x0,dy0=y-y0;
		if((Math.abs(dx0)+Math.abs(dy0))<distmax){dx0=0;dy0=0;}
		index=0;
		for (var i=0; i < ncloud; i++) {
		   xc=cloudvertices[index]+dx0;
		   yc=cloudvertices[index+1]+0.0015*dtime+dy0;
		   zc=cloudvertices[index+2];
		   var test=0;
		   while(xc<(x-distmax)){xc+=distmax*1.99;test=1;};
		   while(xc>(x+distmax)){xc-=distmax*1.99;test=1;};
		   while(yc<(y-distmax)){yc+=distmax*1.99;test=1;};
		   while(yc>(y+distmax)){yc-=distmax*1.99;test=1;};
		   zsolmin=0;
		   if(test==1 || zc<zsolmin+30){zc=30+Math.random()*30+Math.max(zsolmin,zsol);}
		   if(wclouds>=20 && train0==1){
		    var dx=cloudsize*15*cloudscale[i]*wclouds/(20+wclouds); 
		    if(Math.abs(xc-x-30*cos1*cloudsize)<dx){
             if(Math.abs(yc-y-30*sin1*cloudsize)<dx){
               if(Math.abs(zc-z-3*cloudsize)<dx*10/15){
			     if(i<ncloud2){train=1;}}
             }
           };}			 
		   addindexcloud(cloudvertices,[
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc,
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (cloudvertices), gl.STATIC_DRAW);
		if(Math.random()<0.001*dtime){if(Math.random()<0.05 && tframe>tstorm){
		            if(wclouds>=20){cloudsize1=0.8+Math.random()*Math.random()*4.4*(1+wclouds/140);
					}else{cloudsize1=0.8+Math.random()*2.2;}
					if(Math.random()<(0.72-wclouds/200)){cloudsize1=0.8+Math.random()*0.5;};
					if(cloudsize1>2.5 && Math.random()<0.5){
					   cloudsize1+=1;soundthunder();
					   train0=1;
		               timerain=tframe+5000+Math.random()*30000;
					   tstorm=tframe+40000+80000*Math.random();}
					};}
		cloudsize+=(cloudsize1-cloudsize)*0.00005*dtime;
}
function updatecloudspace(){
        gl.bindBuffer(gl.ARRAY_BUFFER, cloudVertexPositionBuffer);
		var xc=0,yc=0,zc=0,sc=1,distmax=500*sc;
		index=0;
		for (var i=0; i < ncloud; i++) {
		   xc=cloudvertices[index];
		   yc=cloudvertices[index+1]+0.0015*dtime;
		   zc=cloudvertices[index+2];
		   if(zc<z-909999){zc+=999999;}
		   var test=0;
		   while(xc<(x-distmax)){xc+=distmax*1.99;test=1;};
		   while(xc>(x+distmax)){xc-=distmax*1.99;test=1;};
		   while(yc<(y-distmax)){yc+=distmax*1.99;test=1;};
		   while(yc>(y+distmax)){yc-=distmax*1.99;test=1;};
		   while(zc<(z-distmax+distmax*sin2*0.9)){zc+=distmax*1.99;test=1;};
		   while(zc>(z+distmax+distmax*sin2*0.9)){zc-=distmax*1.99;test=1;};
		   if(test==1){
     		  zsolmin=z-60*sc+(distmax-80*sc)*1.4*sin2;
		      zc=Math.random()*60*2*sc+zsolmin;}
		   var dx=3000;
		   var k=parseInt(xc/dx)+parseInt(0.8*yc/dx)+parseInt(zc/dx);
		   if((Math.abs(k)%2)!=1){zc-=999999;}
		   addindexcloud(cloudvertices,[
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc,
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (cloudvertices), gl.STATIC_DRAW);
		cloudsize=1*sc;
}
var thour=0,hour=0,sunx1=0,suny1=0,sunz1=0;
function updatesun(){
        gl.bindBuffer(gl.ARRAY_BUFFER, sunVertexPositionBuffer);
		var xc=0,yc=0,zc=0;
	    var hour0=new Date().getHours()+new Date().getMinutes()/60.0;
		hour=hour0+ thour;
		while(hour>24){hour-=24;}
		while(hour<0){hour+=24;};
    	if(hour>5 && hour<20){hour=20;thour=hour-hour0;}
		sunx=1000*Math.sin((12-hour)*3.14/24);
		suny=-1000*Math.cos((12-hour)*3.44/24);
		sunz=800*Math.cos((12-hour)*3.14/24)*Math.cos((12-hour)*3.14/24)+40;
		sunx1=sunx;suny1=suny;sunz1=sunz;
		if(tgmap==1){sunx1*=2.8;suny1*=2.8;sunz1*=2.8;}
		index=0;
		for (var i=0; i < 1; i++) {
		   xc=x+sunx1;
		   yc=y+suny1;
		   zc=sunz1;
		   addindexcloud(sunvertices,[
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc,
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (sunvertices), gl.STATIC_DRAW);
        
        gl.bindBuffer(gl.ARRAY_BUFFER, sunVertexTextureCoordBuffer);
		sc=5.5;sc2=11;if(tgmap==1){sc*=2.8;sc2*=2.8;}
		index=0;
		for (var i=0; i < 1; i++) {
		   append(suntextureCoords,[
             -sc,-sc2,  -sc,sc2,   sc,-sc2,
			 -sc,sc2,   sc,sc2,    sc,-sc2
            ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (suntextureCoords), gl.STATIC_DRAW);
}
var testtree=0,treex=[],treey=[],treez=[];
function updatetree(){
        gl.bindBuffer(gl.ARRAY_BUFFER, treeVertexPositionBuffer);
		var xc=0,yc=0,zc=0,distmax=90,test=0,h=2;
		if(treetype==0){h*=1.1;}
		if(treetype==2){h*=1.1;}
		index=0;
		for (var i=0; i < ntree; i++) {
		   xc=treevertices[index];
		   yc=treevertices[index+1];
		   zc=treevertices[index+2];
		   test=testtree;
		   while(xc<(x-distmax)){xc+=distmax*1.99999;test=1;};
		   while(xc>(x+distmax)){xc-=distmax*1.99999;test=1;};
		   while(yc<(y-distmax)){yc+=distmax*1.99999;test=1;};
		   while(yc>(y+distmax)){yc-=distmax*1.99999;test=1;};
		   if(tfoot==1){if(Math.abs(xc-x)<0.2){
		                if(Math.abs(yc-y)<0.2){
						if(zc>=0.15){tcollide=1;};};};}
		   if(test==1){testwater=1;zc=getterrainheight(xc,yc);
		     testwater=0;
			 if(zc<0.15 || zc>(40+zsolmin) || twater==1 || testpiste==1){zc=-999;}
			 else if(Math.abs(portx-xc)<(xmax-xmin)/8){
			       if(Math.abs(porty-yc)<(ymax-ymin)/8){zc=-999;}}
		     treex[i]=xc;treey[i]=yc;treez[i]=zc;
			 addindexcloud(treevertices,[
               xc,yc,zc,  xc,yc,zc+h,  xc,yc,zc			 
			   ]);}else{index+=9;}; 
		}	
        testtree=0;
		gl.bufferData(gl.ARRAY_BUFFER, (treevertices), gl.STATIC_DRAW);
}
var testdust=0,dustx=[],dusty=[],dustz=[];
function updatedust(){
        gl.bindBuffer(gl.ARRAY_BUFFER, dustVertexPositionBuffer);
		var xc=0,yc=0,zc=0,distmax=40,test=0;
		index=0;
		for (var i=0; i < ndust; i++) {
		   xc=dustvertices[index];
		   yc=dustvertices[index+1];
		   zc=dustvertices[index+2];
		   test=testdust;
		   while(xc<(x-distmax)){xc+=distmax*1.999999;test=1;};
		   while(xc>(x+distmax)){xc-=distmax*1.999999;test=1;};
		   while(yc<(y-distmax)){yc+=distmax*1.999999;test=1;};
		   while(yc>(y+distmax)){yc-=distmax*1.999999;test=1;};
		   while(zc<(z-distmax)){zc+=distmax*1.999999;test=1;};
		   while(zc>(z+distmax)){zc-=distmax*1.999999;test=1;};
		   if(test==1){
		     //dustx[i]=xc;dusty[i]=yc;dustz[i]=zc;
			 addindexcloud(dustvertices,[
               xc,yc,zc,  xc,yc,zc,  xc,yc,zc			 
			   ]);}else{index+=9;}; 
		}	
        testdust=0;
		gl.bufferData(gl.ARRAY_BUFFER, (dustvertices), gl.STATIC_DRAW);
}
function updatestar(){
        gl.bindBuffer(gl.ARRAY_BUFFER, starVertexPositionBuffer);
		var xc=0,yc=0,zc=0,j=0;
		index=0;
		for (var i=0; i < nstar; i++) {
		   var j=i+2,k=kstar*10;
		   xc=(starxxa[j]*kstar-x)/k;
		   yc=(staryya[j]*kstar-y)/k;
		   zc=(starzza[j]*kstar-z)/k;
		   if(showstar[j]==0){zc=-999999;}
		   addindexcloud(starvertices,[
               xc,yc,zc,  xc,yc,zc,  xc,yc,zc			 
			   ]);} 
		gl.bufferData(gl.ARRAY_BUFFER, (starvertices), gl.STATIC_DRAW);
}
function updatesea(){
        //while(seax>(x+110)){seax-=110;}
		//while(seax<(x-110)){seax+=110;}
        //while(seay>(y+110)){seay-=110;}
		//while(seay<(y-110)){seay+=110;}
		seax=x;seay=y;
        gl.bindBuffer(gl.ARRAY_BUFFER, seaVertexPositionBuffer);
        //seavertices = new Float32Array(3*6);
		xc=0;yc=0;zc=0;
		index=0;
		var seascale=4.7;if(z>25){seascale*=1.2*0.5*nmap2/nmap;}
	  if(tmove==1){	
		   xc=110*seascale;
		   yc=110*seascale;
		   zc=-0.3;
		   var s=seax,t=seay;
		   append(seavertices,[
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc			 
			 ]); 	
        gl.bufferData(gl.ARRAY_BUFFER, (seavertices), gl.STATIC_DRAW);
        seaVertexPositionBuffer.itemSize = 3;
        seaVertexPositionBuffer.numItems = 6;
	  }	
        gl.bindBuffer(gl.ARRAY_BUFFER, seaVertexTextureCoordBuffer);
        //var seatextureCoords = new Array(2*6);
		index=0;
		var xc=110*seascale,yc=110*seascale;
		var s=10*seascale;if(tsea==2){s*=2}
		var u=(tframe%1000000)*0.0000055+5*seascale*(seax%xc)/xc,v=5*seascale*(seay%yc)/yc;
		//var xc=dxmaxmin2*nmap2/n;
		//var yc=dymaxmin2*nmap2/n;
		//var s=xc/11;if(tsea==2){s*=2}
		//var u=(tframe%1000000)*0.0000055+(xc/22)*(seax%xc)/xc,v=(xc/22)*(seay%yc)/yc;
		   append(seatextureCoords,[
             u,v, u,v+s, u+s,v,
			 u,v+s, u+s,v+s, u+s,v
            ]);
        gl.bufferData(gl.ARRAY_BUFFER, (seatextureCoords), gl.STATIC_DRAW);
        seaVertexTextureCoordBuffer.itemSize = 2;
        seaVertexTextureCoordBuffer.numItems = 6;

}
function updateport(){
        //portVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, portVertexPositionBuffer);
        //portvertices = new Float32Array(3*6);
		var xc=0,yc=0,zc=0;
		index=0;
		   var s=portx,t=porty;
		   xc=(xmax-xmin)/8;
		   yc=(ymax-ymin)/8;
		   zc=Math.max(0.5,(z-zsol)*0.05)+portz;//getterrainheight(s,t);
		   append(portvertices,[
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc			 
			 ]); 	
        gl.bufferData(gl.ARRAY_BUFFER, (portvertices), gl.STATIC_DRAW);
        portVertexPositionBuffer.itemSize = 3;
        portVertexPositionBuffer.numItems = 6;

}
var tkeytir=0;
function tir(){
   tkeytir=tframe;
   var s=1+(Math.random()-0.5)*0.12;
   var t=1+(Math.random()-0.5)*0.12;
   var u=1+(Math.random()-0.5)*0.12;
   var v=(2.2+vplane*kspeed)*(1+(Math.random()-0.5)*0.2);
   var dx=-sin2*0.2*u-sin1*s+cos1*t,dy=-sin2*0.2*u+cos1*s+sin1*t,dz=0.2*cos2;
   var xc=x+dx*cos3-dz*cos1*sin3,yc=y+dy*cos3-dz*sin1*sin3,zc=z+dz*cos3-sin3*cos2;
   //addtir(xc,yc,zc,cos1*cos2*s*v,sin1*cos2*t*v,sin2*u*v);
   var r=0.015;
   var ss=(Math.random()-0.5)*r,tt=(Math.random()-0.5)*r,uu=(Math.random()-0.5)*r;
   addtir(xc,yc,zc,(cos1*cos2*s+ss)*v,(sin1*cos2*t+tt)*v,(sin2*u+uu)*v,0);
   s=1+(Math.random()-0.5)*0.12;
   t=1+(Math.random()-0.5)*0.12;
   u=1+(Math.random()-0.5)*0.12;
   v=(2.2+vplane*kspeed)*(1+(Math.random()-0.5)*0.2);
   dx=-sin2*0.2*u+sin1*s-cos1*t;dy=-sin2*0.2*u-cos1*s-sin1*t;dz=0.2*cos2;
   xc=x+dx*cos3-dz*cos1*sin3;yc=y+dy*cos3-dz*sin1*sin3;zc=z+dz*cos3+sin3*cos2;
   //addtir(xc,yc,zc,cos1*cos2*s*v,sin1*cos2*t*v,sin2*u*v);
   ss=(Math.random()-0.5)*r;tt=(Math.random()-0.5)*r;uu=(Math.random()-0.5)*r;
   addtir(xc,yc,zc,(cos1*cos2*s+ss)*v,(sin1*cos2*t+tt)*v,(sin2*u+uu)*v,0);
}
var ptkeytir=0;
function ptir(){
   //ptkeytir=tframe;
   var s=1+(Math.random()-0.5)*0.12;
   var t=1+(Math.random()-0.5)*0.12;
   var u=1+(Math.random()-0.5)*0.12;
   var v=(2.2+pvplane)*(1+(Math.random()-0.5)*0.2);
   var dx=-psin2*0.2*u-psin1*s+pcos1*t,dy=-psin2*0.2*u+pcos1*s+psin1*t,dz=0.2*pcos2;
   var xc=px+dx*pcos3-dz*pcos1*psin3,yc=py+dy*pcos3-dz*psin1*psin3,zc=pz+dz*pcos3-psin3*pcos2;
   //addtir(xc,yc,zc,cos1*cos2*s*v,sin1*cos2*t*v,sin2*u*v);
   var r=0.015;
   var ss=(Math.random()-0.5)*r,tt=(Math.random()-0.5)*r,uu=(Math.random()-0.5)*r;
   if(tspace==0){addtir(xc,yc,zc,(pcos1*pcos2*s+ss)*v,(psin1*pcos2*t+tt)*v,(psin2*u+uu)*v,2);}
   else{addtir(xc,yc,zc,(pcos1*pcos2*s+ss)*v,(psin1*pcos2*t+tt)*v,(psin2*u+uu)*v,2+iplane);}
   s=1+(Math.random()-0.5)*0.12;
   t=1+(Math.random()-0.5)*0.12;
   u=1+(Math.random()-0.5)*0.12;
   v=(2.2+pvplane)*(1+(Math.random()-0.5)*0.2);
   dx=-psin2*0.2*u+psin1*s-pcos1*t;dy=-psin2*0.2*u-pcos1*s-psin1*t;dz=0.2*pcos2;
   xc=px+dx*pcos3-dz*pcos1*psin3;yc=py+dy*pcos3-dz*psin1*psin3;zc=pz+dz*pcos3+psin3*pcos2;
   //addtir(xc,yc,zc,cos1*cos2*s*v,sin1*cos2*t*v,sin2*u*v);
   ss=(Math.random()-0.5)*r;tt=(Math.random()-0.5)*r;uu=(Math.random()-0.5)*r;
   if(tspace==0){addtir(xc,yc,zc,(pcos1*pcos2*s+ss)*v,(psin1*pcos2*t+tt)*v,(psin2*u+uu)*v,2);}
   else{addtir(xc,yc,zc,(pcos1*pcos2*s+ss)*v,(psin1*pcos2*t+tt)*v,(psin2*u+uu)*v,2+iplane);}
}
function p3tir(){
   p3tkeytir=tframe;
   var s=1+(Math.random()-0.5)*0.12;
   var t=1+(Math.random()-0.5)*0.12;
   var u=1+(Math.random()-0.5)*0.12;
   var v=(2.2+p3vplane)*(1+(Math.random()-0.5)*0.2);
   var dx=-p3sin2*0.2*u-p3sin1*s+p3cos1*t,dy=-p3sin2*0.2*u+p3cos1*s+p3sin1*t,dz=0.2*p3cos2;
   var xc=p3x+dx*p3cos3-dz*p3cos1*p3sin3,yc=p3y+dy*p3cos3-dz*p3sin1*p3sin3,zc=p3z+dz*p3cos3-p3sin3*p3cos2;
   //addtir(xc,yc,zc,cos1*cos2*s*v,sin1*cos2*t*v,sin2*u*v);
   var r=0.015;
   var ss=(Math.random()-0.5)*r,tt=(Math.random()-0.5)*r,uu=(Math.random()-0.5)*r;
   addtir(xc,yc,zc,(p3cos1*p3cos2*s+ss)*v,(p3sin1*p3cos2*t+tt)*v,(p3sin2*u+uu)*v,3);
   s=1+(Math.random()-0.5)*0.12;
   t=1+(Math.random()-0.5)*0.12;
   u=1+(Math.random()-0.5)*0.12;
   v=(2.2+p3vplane)*(1+(Math.random()-0.5)*0.2);
   dx=-p3sin2*0.2*u+p3sin1*s-p3cos1*t;dy=-p3sin2*0.2*u-p3cos1*s-p3sin1*t;dz=0.2*p3cos2;
   xc=p3x+dx*p3cos3-dz*p3cos1*p3sin3;yc=p3y+dy*p3cos3-dz*p3sin1*p3sin3;zc=p3z+dz*p3cos3+p3sin3*p3cos2;
   //addtir(xc,yc,zc,cos1*cos2*s*v,sin1*cos2*t*v,sin2*u*v);
   ss=(Math.random()-0.5)*r;tt=(Math.random()-0.5)*r;uu=(Math.random()-0.5)*r;
   addtir(xc,yc,zc,(p3cos1*p3cos2*s+ss)*v,(p3sin1*p3cos2*t+tt)*v,(p3sin2*u+uu)*v,3);
}
function addtir(xc,yc,zc,vx,vy,vz,type){
itir+=1;if(itir>(ntir-1)){itir=0;}
tirx[itir]=xc;tiry[itir]=yc;tirz[itir]=zc;
vtirx[itir]=vx;vtiry[itir]=vy;vtirz[itir]=vz;
ttir[itir]=tframe+6000*(1+tspace);
tirsize[itir]=1.0;
tirtype[itir]=type;
if(type==1){tirsize[itir]=3.0;ttir[itir]=tframe+18000;}
} 
var ntir2=0,tattack=0,tattack2=0,tattack3=0,tattackp3=0;
var dirtir=0,dirtirz=0;      
function updatetir(){
        gl.bindBuffer(gl.ARRAY_BUFFER, tirVertexPositionBuffer);
		var xc=0,yc=0,zc=0,h=0.2,co1=0.2*cos1,si1=0.2*sin1,vx=0,vy=0,vz=0;
		var dt=dtime*0.013,dt1=1.0-dtime*0.0001,s=1,i=0,zh=0;
		var dt2=1.0-dtime*0.00007,dt11=dt1;
		ntir2=0;dirtir=0;dirtirz=0;
		for(var i=0;i<nplane;i++){ndirtir[i]=0;ndirtirz[i]=0;}
		index=0;
		for (var ii=0; ii < ntir; ii++) {
		 i=itir+ii+1;if(i>=ntir){i-=ntir;}
		 if(tframe<ttir[i]){
		  ntir2+=1;
		  s=tirsize[i];
		  if(s<10.0){
		   dt11=dt1;if(tirtype[i]==1){dt11=dt2;}
		   if(tspace==1){dt11=1.72;}
		   vx=vtirx[i]*dt11;
		   vy=vtiry[i]*dt11;
		   vz=vtirz[i]*dt11-dt*0.00195;
		   xc=tirx[i]+vx*dt;
		   yc=tiry[i]+vy*dt;
		   zc=tirz[i]+vz*dt;
		   zh=-999;
		   
		var kvie=(1+tdogfight*2)*vrunmax/1.30;
        if(tspace==0){
		   testhorse(xc,yc,zc-0.5,2);
           testelephant(xc,yc,zc-0.5,3);
           testgirafe(xc,yc,zc-0.5,2.2);
		   testzebra(xc,yc,zc-0.5,2);
		   testantilope(xc,yc,zc-0.5,2);

		   if(tirtype[i]!=2){		   
		    if(Math.abs(xc-px)<2+tspace*4){if(Math.abs(yc-py)<2+tspace*4){
		      if(Math.abs(zc-pz)<1+tspace*3){vx=0,vy=0;vz=0;zh=-9999;
			     if(Math.random()<0.3){tattack=1;};
				 addimpact(xc,yc,zc);
				 var pvie0=pvie;pvie-=Math.random()*2*kvie;
				 if(pvie<0 && pvie0>=0){pvie-=50;};if(pvie<-150){pvie=100;};
				 if(pvie<0 && Math.random()<dtime*0.004){addsmoke(xc,yc,zc,3,0);}
			     s=15.0;ttir[i]=tframe+1000;tirsize[i]=s;};};}
		   }		 
           if(tirtype[i]!=3){		   
		    if(Math.abs(xc-p3x)<2){if(Math.abs(yc-p3y)<2){
		      if(Math.abs(zc-p3z)<1){vx=0,vy=0;vz=0;zh=-9999;
			     if(Math.random()<0.3){tattackp3=1;};
				 addimpact(xc,yc,zc);
				 var p3vie0=p3vie;p3vie-=Math.random()*2*kvie;
				 if(p3vie<0 && p3vie0>=0){p3vie-=50;};if(p3vie<-150){p3vie=100;};
				 if(p3vie<0 && Math.random()<dtime*0.004){addsmoke(xc,yc,zc,3,0);}
			     s=15.0;ttir[i]=tframe+1000;tirsize[i]=s;};};}
		   }		 
		}
		if(tspace==1){
		  for(var n=0;n<nplane;n++){
		   if(tirtype[i]==0){//!=2		   
		    if(Math.abs(xc-npx[n])<9){if(Math.abs(yc-npy[n])<9){
		      if(Math.abs(zc-npz[n])<9 && npboom[n]==0){vx=0,vy=0;vz=0;zh=-999999;
			     if(Math.random()<0.3){tattack=1;};
				 nptshoot[n]=-1;
				 addimpact(xc,yc,zc);
				 var pvie0=npvie[n];npvie[n]-=Math.random()*2*kvie;
				 if(npvie[n]<0 && pvie0>=0){npvie[n]-=5.0;};
				 if(npvie[n]<-450){npvie[n]=100;};
				 if(npvie[n]<-30){if(Math.random()<0.6){npboom[n]=tframe;}
				                   soundexplosion();soundexplode();
								   addboom(xc,yc,zc,0.5);}
				 if(npvie[n]<40 && Math.random()<dtime*0.004){addsmoke(xc,yc,zc,3,0);}
			     s=15.0;ttir[i]=tframe+1000;tirsize[i]=s;};};}
		   }}		 
		}
		   /*if(tirtype[i]!=1){
            var dx=xc-shipx,dy=yc-shipy;
	        var dxx=dx*shipco1+dy*shipsi1;
	        if(dxx>-9 && dxx<9){
	         var dyy=(-dx*shipsi1+dy*shipco1);
		     if(dyy>-2 && dyy<2){
		      if(Math.abs(zc-(shipz+1))<4){vx=0,vy=0;vz=0;zh=-9999;
			     if(Math.random()<0.3){tattack2=tframe;};
				 addimpact2(xc,yc,zc);
				 shipvie-=Math.random()*kvie;if(shipvie<-50){shipvie=-50;}
				 if(shipvie<0 && Math.random()<dtime*0.004){addsmoke(xc,yc,zc,6,1);}
			     s=15.0;ttir[i]=tframe+1000;tirsize[i]=s;};};}
		   }
		   if(tirtype[i]!=1 && (tsea>0 || tgmap==1)){
            var dx=xc-shipcarrierx,dy=yc-shipcarriery;
	        var dxx=dx*shipcarrierco1+dy*shipcarriersi1;
	        if(dxx>-24.5 && dxx<19.9){
	         var dyy=(-dx*shipcarriersi1+dy*shipcarrierco1);
		     if(dyy>-3.7 && dyy<7){
		      if(Math.abs(zc-(shipcarrierz+1))<4){vx=0,vy=0;vz=0;zh=-9999;
			     if(Math.random()<0.3){tattack3=tframe;};
				 addimpact2(xc,yc,zc);
				 shipcarriervie-=Math.random()*kvie;if(shipcarriervie<-50){shipcarriervie=-50;}
				 if(shipcarriervie<0 && Math.random()<dtime*0.004){addsmoke(xc,yc,zc,6,1);}
			     s=15.0;ttir[i]=tframe+1000;tirsize[i]=s;};};}
		   }*/
		   if(tirtype[i]!=0){
		    var disttir=Math.abs(xc-x)+Math.abs(yc-y);
			if(disttir>3 && disttir<(15+disttir*0.3)){
    		  //var disttiry=(x-xc)*vx-(y-yc)*vy;
    		  var disttiry=-(x-xc)*vy+(y-yc)*vx;
              if(disttiry>0){dirtir=1;}else{dirtir=-1;};
			  if(zc>z){dirtirz=1;}else{dirtirz=-1;}}
			  var p=tirtype[i]-2;
			  if(p>=0 && p<nplane){ndirtir[p]=dirtir;ndirtirz[p]=dirtirz;}
			if(Math.abs(xc-x)<2){if(Math.abs(yc-y)<2){
		      if(Math.abs(zc-z)<2){vx=0,vy=0;vz=0;zh=-9999;
		         xc+=cos1*cos2*5;
		         yc+=sin1*cos2*5;
		         zc+=sin2*5;
				 addimpact2(xc,yc,zc);vie-=Math.random()*10;
				 if(tirtype[i]==1){soundexplosion();}
				 if(vie<-50){vie=-21;if(pvie<50){pvie=50;};}
				 tblood=tframe;o1blood+=1;if(o1blood>1.1){o1blood=0;}
			     s=15.0;ttir[i]=tframe+1000;tirsize[i]=s;};};}
		   }
		   /*if(tsea>0 || tgmap==1){
		    for(var j=0;j<nsailship;j++){
            var dx=xc-psailshipx[j],dy=yc-psailshipy[j];
	        var dxx=dx*psailshipco1[j]+dy*psailshipsi1[j];
	        if(dxx>-5 && dxx<5){
	         var dyy=(-dx*psailshipsi1[j]+dy*psailshipco1[j]);
		     if(dyy>-1.2 && dyy<1.2){
		      if(Math.abs(zc-(psailshipz[j]+1))<4){vx=0,vy=0;vz=0;zh=-9999;
				 addimpact2(xc,yc,zc);
				 psailshipvie[j]-=3*Math.random()*kvie;
				 if(psailshipvie[j]<0 && Math.random()<dtime*0.004){addsmoke(xc,yc,zc,3,1);}
			     s=15.0;ttir[i]=tframe+1000;tirsize[i]=s;};};}
		   };}
		   if(tsea==0){
		    for(var j=0;j<ntank;j++){
            var dx=xc-ptankx[j],dy=yc-ptanky[j];
	        var dxx=dx*ptankco1[j]+dy*ptanksi1[j];
	        if(dxx>-5 && dxx<5){
	         var dyy=(-dx*ptanksi1[j]+dy*ptankco1[j]);
		     if(dyy>-1.2 && dyy<1.2){
		      if(Math.abs(zc-(ptankz[j]+1))<4){vx=0,vy=0;vz=0;zh=-9999;
				 addimpact2(xc,yc,zc);
				 ptankvie[j]-=4*Math.random()*kvie;
				 if(Math.random()<dtime*0.002){addsmoke(xc,yc,zc,3,1);}
			     s=15.0;ttir[i]=tframe+1000;tirsize[i]=s;};};}
		   };}*/
		if(tspace==0){   
		   if(zc>zh && zh>-9998 && tirtype[i]!=1){zh=getterrainheight2(xc,yc);}
           if(zc<zh-0.2){s=15.0;ttir[i]=tframe+1000;tirsize[i]=s;
		                 if(testtown){addimpact2(xc,yc,zc);};};
		}
           tirx[i]=xc;tiry[i]=yc;tirz[i]=zc;
           if(tspace==0){vtirx[i]=vx;vtiry[i]=vy;vtirz[i]=vz;}
		   }	
           co1=0.2*cos1*s;si1=0.2*sin1*s;h=0.2*s;		   
		   addindexcloud(tirvertices,[
             xc-si1,yc+co1,zc-h,  xc-si1,yc+co1,zc+h,  xc+si1,yc-co1,zc-h,
             xc-si1,yc+co1,zc+h,  xc+si1,yc-co1,zc+h,  xc+si1,yc-co1,zc-h			 
			 ]);
          }else{tirsize[i]=1.0;}	  
		}	
        gl.bufferData(gl.ARRAY_BUFFER,(tirvertices), gl.STATIC_DRAW);
        tirVertexPositionBuffer.numItems=ntir2*6;
}

var x=0,y=0,z=0,o1=0,o2=0,o3=0,vrun=1.10;
var cos1=0,sin1=0,cos2=0,sin2=0,cos3=0,sin3=0,do1=0,do2=0,do3=0; 
var px=0,py=0,pz=0,po1=0,po2=0,po3=0,pvrun=1,pvie=100;
var pcos1=0,psin1=0,pcos2=0,psin2=0,pcos3=0,psin3=0,pdo1=0,pdo2=0,pdo3=0;
var to1=0,to2=-15,tcos1=0,tsin1=0,tcos2=0,tsin2=0,tourelle=0,tourelle0=0; 
var to11=180,to21=to2,ko1=to1,ko2=to2,tradar=0;
var p3x=0,p3y=0,p3z=0,p3o1=0,p3o2=0,p3o3=0,p3vrun=1,p3vie=100;
var p3cos1=0,p3sin1=0,p3cos2=0,p3sin2=0,p3cos3=0,p3sin3=0,p3do1=0,p3do2=0,p3do3=0;
z=25;o2=-20.5;
x=xmaxmin2;y=ymaxmin2;
if(test){x=dxmaxmin2-50;y=dymaxmin2;z=0;vrun=0;
//x=waterx;y=watery;vplane=1;
}
pz=30;po2=0;px=x+100;py=y-10;
p3z=30;p3o2=0;p3x=x+90;p3y=y-20;
//y=ymax-100;x=xmax-100;
var tshadow=0,zsol=0,distshadow=0,sunzz=1000,sunco2=0,sunsi2=1,sunco1=0,sunsi1=1;
    function drawshadow() {
	    tshadow=1;
        gl.viewport(0, 0, 512,512);//620,419);
        gl.clearColor(1,1,1, 1.0);
		gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
		distshadow=300.0;
		var wx=distshadow,wy=distshadow;
		var dz=Math.sqrt(sunx*sunx+suny*suny+sunzz*sunzz);
		var dx=Math.sqrt(sunx*sunx+suny*suny);
		sunco2=dx/dz;sunsi2=sunzz/dz;
		sunco1=sunx/dz;sunsi1=suny/dz;
        //mat4.ortho(-wx,wx,-wy*sunsi2,wy*sunsi2,100.0, 100000.0, pMatrix);
        mat4.ortho(-wx,wx,-wy,wy,100.0, 100000.0, pMatrix);
		var xv=x+20*sunx,yv=y+20*suny,zv=zsol+20*sunzz;//20*sunz+51000;
		mat4.lookAt([xv,yv,zv],[x,y,zsol],[-suny,sunx,1.01],mvMatrix);
		gl.useProgram(cloudProgram);
		camx=x+4000*cos1;camy=y+4000*sin1;camz=z+80000;
		drawcloud();
        gl.useProgram(shaderProgram);
 		sunzz=sunz+2500;
		//zv=zsol+5*sunzz;
        //xv=20*sunx;yv=20*suny;zv=20*sunzz;
        mat4.lookAt([xv,yv,zv],[x,y,zsol],[1000,0,1.1],mvMatrix);
        //mat4.identity(mvMatrix);
		//mat4.translate(mvMatrix, [-x,-y,-zsol]);
        //mat4.rotate(mvMatrix, degtorad(-o1), [0, 0, 1]);
		if(tfoot==0){drawplane();}
        //mat4.lookAt([xv,yv,zv],[px,py,zsol],[1000,0,0.1],mvMatrix);
		drawplane2();
		if(tskydome2==1 || tdogfight==1){drawplane3();}
		
		tshadow=0;
	}
	
    var to22=0,zgrass=12+9,tspace=1,xv=0,yv=0,zv=0;
	var xspace=0,yspace=0,zspace=0,o1space=0,o2space=0,o3space=0;	
    function drawScene() {//o1=195;drawshadow();scrollTo(winx,winy);return;
		gl.viewport(0, 0, windx,windy);
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

        if(tsea>=3){tspace=1;}else{tspace=0;}
		x0=x;y0=y;z0=z;
		if(tspace==1){
		xspace=x;yspace=y;zspace=z;o1space=o1;o2space=o2;o3space=o3;	
		}
		
		if(tspace==1){
		  mat4.perspective(47, (cssscale/cssscaley)*gl.viewportWidth / gl.viewportHeight, 6, 180000.0, pMatrix);
		}else if((tourelle<2 || tourelle==5) && tspace==1){
		  mat4.perspective(47, (cssscale/cssscaley)*gl.viewportWidth / gl.viewportHeight, 4, 120000.0, pMatrix);
		}else if(tourelle<2 && tfoot==0){
		  mat4.perspective(47, (cssscale/cssscaley)*gl.viewportWidth / gl.viewportHeight, 1, 10000.0, pMatrix);
		}else if(plane=="spitfire"){
		  mat4.perspective(47, (cssscale/cssscaley)*gl.viewportWidth / gl.viewportHeight, 0.25, 10000.0, pMatrix);
		}else{
		  mat4.perspective(47, (cssscale/cssscaley)*gl.viewportWidth / gl.viewportHeight, 0.1, 6000.0, pMatrix);
		}
        /*if(tourelle<2 && tfoot==0){
		  mat4.perspective(47, gl.viewportWidth / gl.viewportHeight, 1, 10000.0, pMatrix);
		}else if(plane=="spitfire"){
		  mat4.perspective(47, gl.viewportWidth / gl.viewportHeight, 0.25, 10000.0, pMatrix);
		}else{
		  mat4.perspective(47, gl.viewportWidth / gl.viewportHeight, 0.1, 6000.0, pMatrix);
		}*/
		xv=x-7*cos1*cos2;yv=y-7*sin1*cos2;zv=z-7*sin2;
		var zv1=getterrainheight(xv,yv)+0.5;//0.2;
		if(zv<zv1){zv=zv1;}
		if(tfoot==1){
		   mat4.lookAt([x,y,z+0.5],[x+cos1*cos2,y+sin1*cos2,z+sin2+0.5],[0,0,1],mvMatrix);
		}else if(tcar==1 && tourelle!=0){
		   var o22=Math.max(-50,Math.min(50,o2-planedo2));
		   var co3=Math.cos(degtorad(o3+planedo3));si3=Math.sin(degtorad(o3+planedo3));
		   var co2=Math.cos(degtorad(o22));si2=Math.sin(degtorad(o22));
		   //mat4.lookAt([x,y,z+0.25],[x+cos1*cos2,y+sin1*cos2,z+sin2+0.25],[0,0,1],mvMatrix);
		   mat4.lookAt([x,y,z+0.25],[x+cos1*co2,y+sin1*co2,z+si2+0.25],[-cos1*si2-sin1*si3,-sin1*si2+cos1*si3,co2*co3],mvMatrix);
		   //mat4.lookAt([x-cos1*cos2,y-sin1*cos2,z-sin2],[x,y,z],[0,0,1],mvMatrix);
		}else if(tourelle==0){
		   var co3=Math.cos(degtorad(o3-planedo3));si3=Math.sin(degtorad(o3-planedo3));
		   //mat4.lookAt([xv,yv,zv],[x,y,z],[-cos1*sin2-sin1*si3,-sin1*sin2+cos1*si3,cos2*co3],mvMatrix);
		   mat4.lookAt([xv,yv,zv],[x,y,z],[-cos1*sin2*co3-sin1*si3,-sin1*sin2*co3+cos1*si3,cos2*co3],mvMatrix);
		   //mat4.lookAt([0,0,0],[0,0,-100],[0,1,0],mvMatrix);
           //mat4.identity(mvMatrix);
		}else{
		   var tco1=Math.cos(degtorad(to1));
           tcos1=Math.cos(degtorad(o1+to1));tsin1=Math.sin(degtorad(o1+to1));
		   to22=o2*tco1+to2;//if(to22>89.9){to22=89.9;};if(to22<-89.9){to22=-89.9;};
           tcos2=Math.cos(degtorad(to22));tsin2=Math.sin(degtorad(to22));
		   if(tourelle==1){
		   mat4.lookAt([x,y,z+0.5],[x+tcos1*tcos2,y+tsin1*tcos2,z+tsin2+0.5],[-tcos1*tsin2*cos3-tsin1*sin3*tco1,-tsin1*tsin2*cos3+tcos1*sin3*tco1,tcos2*cos3],mvMatrix);
           }else if(tspace==1){//tourelle==2
		   var co3=Math.cos(degtorad(o3-planedo3));si3=Math.sin(degtorad(o3-planedo3));
		   var co2=Math.cos(degtorad(o2-planedo2));si2=Math.sin(degtorad(o2-planedo2));
	       var dz=0.25,dx=0.01;
		   xv=x-dz*sin1*si3+dx*cos1*co2;yv=y+dz*cos1*si3+dx*sin1*co2;zv=z+dz*co3+dx*si2;
           mat4.lookAt([xv,yv,zv],[xv+tcos1*tcos2,yv+tsin1*tcos2,zv+tsin2+0.25],[-tcos1*tsin2*cos3-tsin1*sin3,-tsin1*tsin2*cos3+tcos1*sin3,tcos2*cos3],mvMatrix);
           }else{//tourelle==2
		   var co3=Math.cos(degtorad(o3-planedo3));si3=Math.sin(degtorad(o3-planedo3));
		   var co2=Math.cos(degtorad(o2-planedo2));si2=Math.sin(degtorad(o2-planedo2));
	       var dz=0.25,dx=0.01;
		   xv=x-dz*sin1*si3+dx*cos1*co2;yv=y+dz*cos1*si3+dx*sin1*co2;zv=z+dz*co3+dx*si2;
           mat4.lookAt([xv,yv,zv],[xv+tcos1*tcos2,yv+tsin1*tcos2,zv+tsin2+0.25],[-tcos1*tsin2*cos3-tsin1*sin3,-tsin1*tsin2*cos3+tcos1*sin3,tcos2*cos3],mvMatrix);
		   }
		}
		
		gl.useProgram(shaderProgram);
        if(tspace==0){drawskydome();}
		else{
		 //gl.useProgram(skyProgram);
		 drawvoielactee(voielacteeTexture);
		}
		gl.useProgram(starProgram);
		if(hour<6 || hour>18){
		   if(itime%30==3){updatestar();}
		   drawstar();}
		if(tspace==1){updatedust();drawdust();}

        if((hour<6 || hour>18)&& wclouds>99939){ 
		 //gl.useProgram(skyProgram);
		 //drawsky(skyTexture);
		 tskydome=0;
		}else{tskydome=1;} 

        gl.useProgram(cloudProgram);
		updatesun();
		drawsun();

		if(tspace==1){
		   gl.useProgram(shaderProgram);
		   distsoleilmin=999999;
		   distearthmin=999999;
		   diststarmin=999999;distskymin=999999;
		   isoleilmin=0;istarmin=0;isoleilmin1=0;
		   drawskyimage();//drawsky(skyTexture);
		   earthx=-2200;earthy=2200;earthz=0;earthr=3;isoleil=1;istar=1;
		   if(Math.max(Math.abs(earthx-x),Math.abs(earthy-y))+Math.abs(earthz-z)<15000){
		      earthr=3;drawearth(earthTexture,earthmaskTexture);}
		   soleilx=-1200;soleily=0;soleilz=0;soleilr=30;soleiltype=1;
           //soleilx=4000;z=-4000;x=0;y=4000;
		   soleildouble=0;
		   drawsoleil(soleilTexture);
		   drawsoleilstar();
           if(isoleilmin>0){
		         var do1=diro1(soleilminx-earthminx,soleilminy-earthminy);
                 do1shadowearth=do1-diro1(earthminx-x,earthminy-y);}
		   else{do1shadowearth=-9999;}		 
           distsoleilmin=Math.min(distsoleilmin,distearthmin);
           distsoleilmin=Math.min(distsoleilmin,distskymin);
		   if(distsoleilmin<5000 || distplanemin<350){kspeed=1.0}
		   else{kspeed=Math.min(10.0,distsoleilmin*5/5000);}
        }

	if(tspace==0){
    	/*if(tgmap==1){
		  gl.useProgram(shaderProgram);
		  colorr=1;colorg=1;colorb=1;colora=1;
		  drawhorizon();
		  drawairporttower();
		  draweiffeltower();
		  drawlibertystatue();
		  drawchristrio();
		  drawdomerock();
		  drawgizah();
		  drawcapitole();
		  drawtajmahal();
		  drawbuddah();
		  }*/

        gl.useProgram(solProgram);
		//colorr=earthcolorr;colorg=earthcolorg;colorb=earthcolorb;colora=1;
		drawwater();
		if(seaheight>0.1){updatesea();drawsea();}
		colorr=1;colorg=1;colorb=1;colora=1;
		
        gl.useProgram(cloudProgram);
		colorr=0.5;colorg=1;colorb=1;colora=0.42;
		drawsunmirror();
		colorr=0.3;colorg=1;colorb=1;colora=0.28;
		drawcloudmirror();
		colorr=1;colorg=1;colorb=1;colora=1;
		
        gl.useProgram(solProgram);
	    updateindex();
		mvPushMatrix();
        //mat4.translate(mvMatrix, [x,y,z]);
        //mat4.translate(mvMatrix, [0.0, 0.0, -40.0]);
		//mat4.rotate(mvMatrix, degtorad(zRot+o1), [0, 0, 1]);
        //mat4.rotate(mvMatrix, degtorad(yRot+o2), [0, 1, 0]);
        //mat4.rotate(mvMatrix, degtorad(xRot), [1, 0, 0]);
		//mat4.rotate(mvMatrix, degtorad(o1), [0, 0, -1]);
        //mat4.translate(mvMatrix, [-0.20*scale, 0.0, -0.0]);
        //mat4.rotate(mvMatrix, degtorad(o2), [0, 1, 0]);
        //mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);

        gl.bindBuffer(gl.ARRAY_BUFFER, solVertexPositionBuffer);
        gl.vertexAttribPointer(solProgram.vertexPositionAttribute, solVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

        gl.bindBuffer(gl.ARRAY_BUFFER, solVertexTextureCoordBuffer);
        gl.vertexAttribPointer(solProgram.textureCoordAttribute, solVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

        gl.activeTexture(gl.TEXTURE1);
        if(z>=zsol+zgrass || tgmap==0){
		  gl.bindTexture(gl.TEXTURE_2D, rttTexture);
        }else{
		  gl.bindTexture(gl.TEXTURE_2D, solTexture);
		}
		gl.uniform1i(solProgram.samplerUniform2, 1);
        gl.activeTexture(gl.TEXTURE2);
        if(tgmap==0){gl.bindTexture(gl.TEXTURE_2D, solTexture);
        }else{gl.bindTexture(gl.TEXTURE_2D, solTexture1);}
		gl.uniform1i(solProgram.samplerUniform, 2);

        //gl.bindBuffer(gl.ARRAY_BUFFER, solVertexColorBuffer);
        //gl.vertexAttribPointer(shaderProgram.vertexColorAttribute, solVertexColorBuffer.itemSize, gl.FLOAT, false, 0, 0);

        //setMatrixUniforms();
       // gl.drawArrays(gl.TRIANGLE_STRIP, 0, solVertexPositionBuffer.numItems);
       
        gl.disable(gl.CULL_FACE);
	    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, solVertexIndexBuffer);
		colorr=Math.min(1.8,earthcolorr*1.8);
		colorg=Math.min(1.8,earthcolorg*1.8);
		colorb=Math.min(1.8,earthcolorb*1.8);
		colora=1;
		setcolorearth();
		setcolorearth();
        setMatrixUniformssol();
		colorr=1;colorg=1;colorb=1;colora=1;
        gl.drawElements(gl.TRIANGLES, solVertexIndexBuffer.numItems, gl.UNSIGNED_SHORT, 0);

        mvPopMatrix();
        gl.activeTexture(gl.TEXTURE1);
        gl.bindTexture(gl.TEXTURE_2D, rttTexture);
		gl.uniform1i(solProgram.samplerUniform2, 1);
		drawpiste();
		drawtower();
		drawtown();
		if(tgmap==1){updateport();drawairport();}

	    gl.useProgram(treeProgram);
		updatetree();
		if(z<(37+zsolmin)){drawtree();};
		
      }

		if(tspace==1 && tourelle>0){mat4.perspective(47, (cssscale/cssscaley)*gl.viewportWidth / gl.viewportHeight, 0.3, 180000.0, pMatrix);}
		if(tspace==1 && tourelle==0){mat4.perspective(47, (cssscale/cssscaley)*gl.viewportWidth / gl.viewportHeight, 3.0, 180000.0, pMatrix);}
	  
        gl.useProgram(shaderProgram);
		//drawship();
		//if((tsea>0 || tgmap==1) && tskydome2==1){drawshipcarrier();drawsailships();}
		//if(tsea==0 && tskydome2==1){drawtanks();}
		if(vie<0 && tframe>(ttsmoke+1000)){ttsmoke=tframe;
		   var sc=0.7;
		   addsmoke(x+cos1*cos2*sc+(0.5-Math.random())/6,y+sin1*cos2*sc+(0.5-Math.random())/6,z+sin2*sc,1,0);}
		
		drawsmoke();
		drawimpact();
		if(ntir2>0){drawtir();}
		var ktir=2,dtime00=dtime;
		dtime/=ktir;
		for(var i=0;i<ktir;i++){updatetir();}
		dtime=dtime00;
		/*testcollide();
		if(tcollide==1){soundpneu();tcollide=0; 
		       if(o2<-8){o2*=-0.6;}else{if(o2<-0.02){o2=-0.01;};}
			   if(Math.abs(vplane)<0.25){x-=5*cos1;y-=5*sin1;}; 
         }*/

        gl.useProgram(cloudProgram);
		updatecloud();
		camx=x;camy=y;camz=z;
		colorr=1;colorg=1;colorb=1;colora=1;
		drawcloud();
		colorr=1;colorg=1;colorb=1;colora=1;
        gl.useProgram(shaderProgram);
        
	if(tspace==0){

		gl.useProgram(program2d);
		drawrain();
		
        gl.useProgram(shaderProgram);
        //gl.enable(gl.CULL_FACE);
		if(z<zsol+27){drawroc();}
        drawplane2();
        if(tskydome2==1){drawplane3();}	
        if(tfoot==0 && vplane>0.1 && z<zsol+5){testcrash();}
        	
    }
	    
        //if(tframe<tboom+5000){drawboom();}		
	    drawnboom();
		if(tspace==1){drawnplane2space();}
        if((tourelle==0 || tourelle>=2)&& tourelle!=5){
		     if(tfoot==0){drawplane();
		  };
		}else{if(tradar==1 && tourelle!=1){drawtradar();}}
		  
	if(tspace==1){mat4.perspective(47, (cssscale/cssscaley)*gl.viewportWidth / gl.viewportHeight, 6, 180000.0, pMatrix);}
        
	if(tspace==0){
		var lat1=lat;
		if(tgmap==0){lat1=0;}
		if(z<(67+zsol)){drawhorse1low();
		                drawhorse2low();
						drawhorse3low();
						if(tfoot==0){
						testhorse(x,y,z,8);}}
        if(z<(67+zsol) && Math.abs(lat1)<37){
		                drawelephant1low();
		                drawelephant2low();
						drawelephant3low();
						if(tfoot==0){
						testelephant(x,y,z,10);}}
        if(z<(67+zsol) && Math.abs(lat1)<37){
		                drawgirafe1low();
		                drawgirafe2low();
						drawgirafe3low();
						testgirafe(x,y,z,9);}
        if(z<(67+zsol) && Math.abs(lat1)<37){
		                drawzebra1low();
		                drawzebra2low();
						drawzebra3low();
						if(tfoot==0){
						testzebra(x,y,z,8);}}
        if(z<(67+zsol) && Math.abs(lat1)<37){
		                drawantilope1low();
		                drawantilope2low();
						drawantilope3low();
						if(tfoot==0){
						testantilope(x,y,z,8);}}				
		drawbird();
		drawbird2();
		drawbird3();
	}
		gl.useProgram(shaderProgram);
		//if(tcar==1){drawcarcockpit();}
		gl.disable(gl.CULL_FACE);
		drawbouss();
		if(vie<-31){vie=-30;}
		vie+=dtime*0.0002;if(vie>100){vie=100;}
		//if(vie<0){if(tframe<tblood+320){drawblood();};}//{vie+=dtime*0.003;};}

	}   

function subtest(){
        /*mvPushMatrix();
        mat4.identity(mvMatrix);
        mat4.rotate(mvMatrix, degtorad(o1), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(o2), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(o3), [0, 0, 1]);
        //mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);//do2
		var y20=-mvMatrix[12],z20=mvMatrix[13],x20=-mvMatrix[14];
		mat4.translate(mvMatrix, [0,-1,0]);
		var y21=-mvMatrix[12],z21=mvMatrix[13],x21=-mvMatrix[14];
		var dx=x20-x21,dy=y20-y21,dz=z20-z21;
		//var dr=0.0001+Math.sqrt(dx*dx+dy*dy+dz*dz);
		//dx/=dr;dy/=dr;dz/=dr;
		alert((dx)+"  "+(dy)+"  "+(dz));
		mvPopMatrix();*/
  soundexplosion();
  soundexplode();
  boomx=x+40*cos1*cos2;boomy=y+40*sin1*cos2;boomz=z+40*sin2;boomr=0.4;
  addboom(boomx,boomy,boomz,boomr);
  //tboom=tframe;
  
}	
var pixdata=new Uint8Array(4),tcollide=0;
/*function testcollide(){
  var ix=parseInt(windx*0.5),iy=parseInt(windy*0.5);
  gl.readPixels(ix,iy,1,1,gl.RGBA,gl.UNSIGNED_BYTE,pixdata);
  //var r=pixdata[0]/255.0,g=pixdata[1]/255.0,b=pixdata[2]/255.0
  var a=pixdata[3];
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);
        mvPushMatrix();
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0,0,-1.5]);

 		mat4.scale(mvMatrix,[0.0001,0.0001,0.0001]);
    	gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D, cloudTexture);
        gl.uniform1i(shaderProgram.samplerUniform, 0);
	
	gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, boussVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	setMatrixUniforms();
    gl.uniform4f(shaderProgram.colorUniform, 0,0,0,2/255.0);
    gl.drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
		mvPopMatrix();
	gl.disable(gl.BLEND);
  
gl.readPixels(ix,iy,1,1,gl.RGBA,gl.UNSIGNED_BYTE,pixdata);
auxvar=pixdata[3]-a;
if(pixdata[3]==a){tcollide=1;}else{tcollide=0;};
}*/
var tskydome=1,tskydome2=1;skydomeo1=Math.random()*360;
function drawskydome(){if(tskydome2==0){return;}
    gl.disable(gl.DEPTH_TEST);
	gl.activeTexture(gl.TEXTURE9);
    gl.bindTexture(gl.TEXTURE_2D,  skydomeTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 9);
        mvPushMatrix();
        //mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [x-0.5*(x-(xmin+xmax)/2),y-0.5*(y-(ymin+ymax)/2),0]);
        //mat4.rotate(mvMatrix, degtorad(-90), [1, 0, 0]);
        skydomeo1+=dtime*0.0003;if(skydomeo1>360){skydomeo1-=360;}
		mat4.rotate(mvMatrix, degtorad(-skydomeo1), [0, 0, 1]);
        //mat4.rotate(mvMatrix, degtorad(sin3*24), [1, 0, 0]);
		mat4.scale(mvMatrix,[10.2,10.2,10.2]);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, skydomeVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, skydomeVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, skydomeVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, skydomeVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.disable(gl.CULL_FACE);
	var aux=1-0.945*Math.abs(12-hour)/12;
    var aux2=1-0.93*Math.abs(12-hour)/12;
    var aux3=1-0.62*Math.abs(12-hour)/12;
    colorr=1.0*aux3;colorg=1.0*aux;colorb=1.0*aux2;colora=1.0;
	//colorr=1;colorg=1;colorb=1;colora=0;
	setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, skydomeVertexPositionBuffer.numItems);

		mvPopMatrix()
	colorr=1;colorg=1;colorb=1;colora=1;
    gl.enable(gl.DEPTH_TEST);
}
function drawvoielactee(skytexture){
        gl.bindBuffer(gl.ARRAY_BUFFER, bouss2VertexTextureCoordBuffer);
		var s0=-o1/360;
		var s1=s0+1.3/4;
		var t0=1/2-1.3/8;
		var t1=t0+1.3/4;
		index=0;
		   append(bouss2textureCoords,[
             s0,t0, s0,t1, s1,t0,
			 s0,t1, s1,t1, s1,t0
            ]);
        gl.bufferData(gl.ARRAY_BUFFER, (bouss2textureCoords), gl.STATIC_DRAW);

        gl.disable(gl.DEPTH_TEST);
        mvPushMatrix();
		//mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [x+600*cos1,y+600*sin1,z]);
		mat4.rotate(mvMatrix, degtorad(o1-90), [0, 0, 1]);
		mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
		var sc=(cssscale/cssscaley)*windx/windy;
        var sc7=265*1.2/boussy;
		mat4.scale(mvMatrix,[sc*sc7,sc7/(2),1]);
		//mat4.translate(mvMatrix, [(cssscale/cssscaley)*234*windx/windy,220,-600]);//boussx
		//mat4.translate(mvMatrix, [(cssscale/cssscaley)*234*windx/windy,220,-600]);//boussx
	gl.activeTexture(gl.TEXTURE4);
    gl.bindTexture(gl.TEXTURE_2D,  skytexture);
    gl.uniform1i(shaderProgram.samplerUniform, 4);
    
	gl.bindBuffer(gl.ARRAY_BUFFER, bouss2VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, bouss2VertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	var c=0.5;c=0.5+(1+Math.cos(degtorad(o1+140+180)))*0.32;
	colorr=c;colorg=c;colorb=c;colora=1;
	setMatrixUniforms();
	colorr=1;colorg=1;colorb=1;colora=1;
    gl.drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);

	mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
}
var nsky=0,pskyx=[],pskyy=[],pskyz=[],pskyrx=[],pskyry=[],pskytexture=[];
function addskyimage(x,y,z,scx,scy,imagesrc){
if(nsky>=40){alert("max 40 sky images reached !");return;}
var i=nsky;nsky+=1;
pskyx[i]=x;pskyy[i]=y;pskyz[i]=z;
pskytexture[i]= gl.createTexture();
pskytexture[i].image = new Image();
pskytexture[i].image.onload = function () {
    var dx=pskytexture[i].image.width;
    var dy=pskytexture[i].image.height;
    canvas2.setAttribute('width', 1024);
    canvas2.setAttribute('height', 1024);
	canvas2.width=1024;
	canvas2.height=1024;
    canvastext.clearRect (0,0,1024,1024);
	//canvastext.drawImage(pskytexture[i].image, parseInt(512-dx/2), parseInt(512-dy/2),dx,dy);
	canvastext.drawImage(pskytexture[i].image, 0,0,1024,1024);
    var imgdata=canvastext.getImageData(0,0,1024,1024),ij=0,k=1.0;
	for(var ii=0;ii<1023;ii++){//fade borders
	  var ii1024=ii*1024;
	  for(var jj=0;jj<450;jj++){
	    var ij=(ii1024+jj)*4;
		if(imgdata.data[ij+3]<128 ||
		   (imgdata.data[ij+3]+imgdata.data[ij+1]+imgdata.data[ij+2])<60){
		 imgdata.data[ij]=0;imgdata.data[ij+1]=0;imgdata.data[ij+2]=0;imgdata.data[ij+3]=0;}
		else{for(var jjj=jj;jjj<jj+60;jjj++){
		         ij=(ii1024+jjj)*4;k=((jjj-jj)/60);
		         imgdata.data[ij]=parseInt(imgdata.data[ij]*k);
				 imgdata.data[ij+1]=parseInt(imgdata.data[ij+1]*k);
				 imgdata.data[ij+2]=parseInt(imgdata.data[ij+2]*k);
				 imgdata.data[ij+3]=255;};break;}}
	  for(var jj=0;jj<450;jj++){
	    var ij=(ii1024+1023-jj)*4;
		if(imgdata.data[ij+3]<128 ||
		   (imgdata.data[ij+3]+imgdata.data[ij+1]+imgdata.data[ij+2])<60){
		 imgdata.data[ij]=0;imgdata.data[ij+1]=0;imgdata.data[ij+2]=0;imgdata.data[ij+3]=0;}
		else{for(var jjj=jj;jjj<jj+60;jjj++){
		         ij=(ii1024+1023-jjj)*4;k=((jjj-jj)/60);
		         imgdata.data[ij]=parseInt(imgdata.data[ij]*k);
				 imgdata.data[ij+1]=parseInt(imgdata.data[ij+1]*k);
				 imgdata.data[ij+2]=parseInt(imgdata.data[ij+2]*k);
				 imgdata.data[ij+3]=255;};break;}}
	}
	for(var ii=0;ii<1023;ii++){
	  //var ii1024=ii*1024;
	  for(var jj=0;jj<450;jj++){
	    var ij=(ii+jj*1024)*4;
		if(imgdata.data[ij+3]<128 ||
		   (imgdata.data[ij+3]+imgdata.data[ij+1]+imgdata.data[ij+2])<60){
		 imgdata.data[ij]=0;imgdata.data[ij+1]=0;imgdata.data[ij+2]=0;imgdata.data[ij+3]=0;}
		else{for(var jjj=jj;jjj<jj+60;jjj++){
		         ij=(ii+jjj*1024)*4;k=((jjj-jj)/60);
		         imgdata.data[ij]=parseInt(imgdata.data[ij]*k);
				 imgdata.data[ij+1]=parseInt(imgdata.data[ij+1]*k);
				 imgdata.data[ij+2]=parseInt(imgdata.data[ij+2]*k);
				 imgdata.data[ij+3]=255;};break;}}
	  for(var jj=0;jj<450;jj++){
	    var ij=(ii+(1023-jj)*1024)*4;
		if(imgdata.data[ij+3]<128 ||
		   (imgdata.data[ij+3]+imgdata.data[ij+1]+imgdata.data[ij+2])<60){
		 imgdata.data[ij]=0;imgdata.data[ij+1]=0;imgdata.data[ij+2]=0;imgdata.data[ij+3]=0;}
		else{for(var jjj=jj;jjj<jj+60;jjj++){
		         ij=(ii+(1023-jjj)*1024)*4;k=((jjj-jj)/60);
		         imgdata.data[ij]=parseInt(imgdata.data[ij]*k);
				 imgdata.data[ij+1]=parseInt(imgdata.data[ij+1]*k);
				 imgdata.data[ij+2]=parseInt(imgdata.data[ij+2]*k);
				 imgdata.data[ij+3]=255;};break;}}
	}
    canvastext.putImageData(imgdata,0,0);//comment this => no fade
	handleLoadedTexture00(pskytexture[i]);
	imgdata.data=[];
	imgdata=null;
	pskyrx[i]=scx*50*dx/1024;
	pskyry[i]=scy*50*dy/1024;
	}
pskytexture[i].image.src = imagesrc;
}
//function addskyimage(x,y,z,scx,scy,imagesrc){
//x,y,z:position,scx,scx:scale image size
var tskyimage=0;
function initskyimage(){
var s1=1,r500=1000,h500=200;
addskyimage(-90000,80000,20000,3,3,"stars/galaxie.jpg");
addskyimage(100000,14000,8000,4,4,"stars/amasglobe.jpg");
addskyimage(15000,-140000,18000,6,6,"stars/twinklestar.jpg");
addskyimage(120000,80000,-18000,8,8,"stars/nebuleuse-bleue4.jpg");
addskyimage(-110000,-80000,12000,8,8,"stars/nebuleuse-bleue3.jpg");
addskyimage(-150000,-14000,-8000,8,8,"stars/nebuleuse-bleue2.jpg");
addskyimage(100000,110000,18000,3,3,"stars/nebuleuse-bleue.jpg");
addskyimage(150000,-140000,-18000,4,4,"stars/nebuleuse-rose.jpg");
addskyimage(150000,-14000,-8000,4,4,"stars/nebuleuse-crabe.jpg");
addskyimage(14000,-14000,-8000,4,4,"stars/nebuleuse-crabe.jpg");
addskyimage(-24000,-18000,-18000,4,4,"stars/galaxie0.jpg");
addskyimage(-14000,24000,-18000,4,4,"stars/galaxie3.jpg");
addskyimage(14000,34000,18000,4,4,"stars/nebuleuse-cancer.jpg");
addskyimage(400,-4000,0,1,1,"stars/colhead.jpg");
//if(tskyimage==1){initskyimage1()}
setTimeout("initskyimage1();",15000);
}
function initskyimage1(){
var s1=1,r500=1000,h500=200;
addskyimage(0,3100,0,1,1.5,"stars/background.jpg");
addskyimage(-r500,3000,-h500,s1,s1,"stars/bottomleftspace.jpg");
addskyimage(300,3000,-h500,s1,s1,"stars/bottommiddlestar.jpg");
addskyimage(-r500,3000,1200,s1,s1,"stars/leftspacetop.jpg");
addskyimage(-1200,2900,1200,s1,s1,"stars/leftstar.jpg");
addskyimage(-800,2900,500,s1,s1,"stars/flame.jpg");
addskyimage(0,2900,-200,s1,s1,"stars/hhead.jpg");
addskyimage(0,3000,1200,s1,s1,"stars/topmiddlespace.jpg");
addskyimage(1400,3000,1300,s1,s1,"stars/spacerighttop.jpg");
addskyimage(300,2900,500,s1,s1,"stars/topspike.jpg");
}
function initskyimage2(){
	for( var i = 0; i < 10; i++ ) {
		var src;
		if (i==0) { src='background.png' ; }
		if (i==1) { src='leftstar.png' ; }
		if (i==2) { src='leftspacetop.png'; }
		if (i==3) { src= 'bigstar.png' ; }
		if (i==4) { src= 'flame.png' ; }
		if (i==5) { src= 'hhead.png' ; }
		if (i==6) { src= 'bottommiddlestar.png' ; }
		if (i==7) { src= 'bottomleftspace.png' ; }
		if (i==8) { src= 'topspike.png' ; }
		if (i==9) { src= 'topmiddlespace.png' ; }
		if (i==10) {src= 'spacerighttopbig.png' ; }

		var x,y,z,rx,ry,rz;
        if (i==0) { x=0;y=0;z=0;rx=0;ry=0;rz=0; }
		if (i==1) { x=20;y=120;z=100;rx=0;ry=0;rz=0; }
		if (i==2) { x=0;y=0;z=15;rx=0;ry=0;rz=0; }
		if (i==3) { x=130;y=110;z=60;rx=0;ry=0;rz=0; }
		if (i==4) { x=110;y=260;z=120;rx=0;ry=0;rz=0; }
		if (i==5) { x=180;y=350;z=80;rx=0;ry=0;rz=0; }
		if (i==6) { x=350;y=350;z=140;rx=0;ry=0;rz=0; }
		if (i==7) { x=0;y=250;z=40;rx=0;ry=0;rz=0; }
		if (i==8) { x=500;y=50;z=20;rx=0;ry=0;rz=0; }
		if (i==9) { x=300;y=20;z=20;rx=0;ry=0;rz=0; }
		if (i==10) { x=600;y=100;z=20;rx=0;ry=0;rz=0; }
		
		var s=2,s2=6;
		addskyimage((-200+x)*s2,3000-z*2,(200-y)*s2,s,s,"stars/"+src);
		var j=nsky-1;
	}
}
function drawskyimage(){
for(var i=0;i<nsky;i++){
  skyx=pskyx[i];skyy=pskyy[i];skyz=pskyz[i];
  skyrx=pskyrx[i];skyry=pskyry[i];colormin=0.01;
  drawsky(pskytexture[i]);
  colormin=-1;
  }
}
var soleilx=-1200,soleily=0,soleilz=0,soleilr=30,distsoleil=12000,soleildouble=0;
var distsoleilmin=1,kspeed=1,soleilminx=0,soleilminy=0,soleilminz=0,soleilminr=0;
var diststarmin=1,soleiltype=1;
function drawsoleil(soleiltexture){
setradarsoleil();
var dx=soleilx-xv,dy=soleily-yv,dz=soleilz-zv,dr=Math.sqrt(1+dx*dx+dy*dy);
var drz=Math.sqrt(1+dx*dx+dy*dy+dz*dz);
var co1=dx/dr,si1=dy/dr,co2=dr/drz,si2=dz/drz;
var r=10+(drz)/100;
var teststarmin=0;
if(diststarmin>drz && drz<10000){diststarmin=drz;teststarmin=1;isoleilmin1=istar;}
if(distsoleilmin>drz){distsoleilmin=drz;
            soleilminx=soleilx;soleilminy=soleily;soleilminz=soleilz;soleilminr=soleilr;}
var dxy=dx*cos1*cos2+dy*sin1*cos2+dz*sin2;
if(dxy>5 || tourelle==1){
skyx=soleilx+r*co1*co2;skyy=soleily+r*si1*co2;skyz=soleilz+r*si2;
skyrx=soleilr;skyry=soleilr;
var dist=distsoleil;
if(drz>dist && soleiltype!=4 && tdrawmap!=3){skyrx*=dist/(drz);skyry*=dist/(drz);}
skyblend=0;
if(drz<20000){drawsky(soleilmaskTexture);}
skyblend=1;
//if(drz>10000){gl.disable(gl.DEPTH_TEST);}
skyx=soleilx;skyy=soleily;skyz=soleilz;colormin=0.003;
if(soleildouble>=0.1){colormin=0.3;}
//if(drz>10000){colormin=0.3;}
drawsky(soleiltexture);
colormin=-1;
}
dxy=dxy/dr;//var dxy=(dx*cos1*cos2+dy*sin1*cos2+dz*sin2)/dr;
if(dxy>0.2 && teststarmin==1){istarmin=istar;}
if(dxy>0.01 && drz<soleilr*20){
   x-=vplane*cos1*cos2;y-=vplane*sin1*cos2;z-=vplane*sin2;
   x-=vplane*co1*co2;y-=vplane*si1*co2;z-=vplane*si2;
}else if(dxy<-0.01 && drz<soleilr*20){
   x-=vplane*cos1*cos2;y-=vplane*sin1*cos2;z-=vplane*sin2;
   x+=vplane*si1*co2;y-=vplane*co1*co2;z-=vplane*si2;
}
}
var earthx=-2200,earthy=2200,earthz=0,earthr=3,distearthmin=0,earthtexturemin=0;
var earthminx=0,earthminy=0,earthminz=0,earthminr=0,do1shadowearth=0;
function setcolorearth(){
var c=parseInt(Math.abs(earthx))%4;
if(isoleilmin0==1){c=1;}
if(c==0){colorr*=1.1;colorg*=0.75;colorb*=0.75;}
if(c==1 || c==2){colorr*=1;colorg*=1;colorb*=1;}
if(c==3){colorr*=0.75;colorg*=0.75;colorb*=1.1;}
}
function setcolorshadow(){
colorshadow=-2;
if(do1shadowearth<-999){return;}
while(do1shadowearth>180){do1shadowearth-=360;}
while(do1shadowearth<-180){do1shadowearth+=360;}
//if(do1shadowearth>0){colorshadow=-0.5-(180-do1shadowearth)/180}
//else{colorshadow=-0.5+(180+do1shadowearth)/180;}
if(do1shadowearth>0){colorshadow=-0.5-(1-Math.cos(degtorad(180-do1shadowearth)/2))}
else{colorshadow=-0.5+(1-Math.cos(degtorad(180+do1shadowearth)/2));}
}
function drawearth(earthtexture,earthmasktexture){
setradarearth();
var dx=earthx-xv,dy=earthy-yv,dz=earthz-zv,dr=Math.sqrt(0.1+dx*dx+dy*dy);
var drz=Math.sqrt(0.1+dx*dx+dy*dy+dz*dz);
var co1=dx/dr,si1=dy/dr,co2=dr/drz,si2=dz/drz;
var r=1+(drz)/100;
//distsoleilmin=Math.min(distsoleilmin,drz);
var distearth=drz-earthr*100;
if(distearthmin>distearth){distearthmin=distearth;isoleilmin=isoleil;isoleilmin1=isoleil;
                earthtexturemin=earthtexture;
                earthminx=earthx;earthminy=earthy;earthminz=earthz;earthminr=earthr;}
var dxy=dx*cos1*cos2+dy*sin1*cos2+dz*sin2;
if(dxy>4 || tourelle==1){
skyx=earthx+r*co1*co2;skyy=earthy+r*si1*co2;skyz=earthz+r*si2;
skyrx=earthr;skyry=earthr;
var dist=distsoleil;
if(drz>dist){skyrx*=dist/(drz);skyry*=dist/(drz);}
skyblend=0;
drawsky(earthmasktexture);
skyblend=1;colormin=0.15;
skyx=earthx;skyy=earthy;skyz=earthz;
setcolorearth();
setcolorshadow();
drawsky(earthtexture);
colormin=-1;
colorshadow=-2;
}
dxy=dxy/dr;//var dxy=(dx*cos1*cos2+dy*sin1*cos2+dz*sin2)/dr;
if(dxy>0.01 && drz<earthr*20){
   x-=vplane*cos1*cos2;y-=vplane*sin1*cos2;z-=vplane*sin2;
   x-=vplane*co1*co2;y-=vplane*si1*co2;z-=vplane*si2;
}else if(dxy<-0.01 && drz<earthr*20){
   x-=vplane*cos1*cos2;y-=vplane*sin1*cos2;z-=vplane*sin2;
   x+=vplane*si1*co2;y-=vplane*co1*co2;z-=vplane*si2;
}
}
var skyx=4000,skyy=000,skyz=000,skyrx=40,skyry=40,skyblend=1,distskymin=0;
function drawsky(texture){
    //gl.disable(gl.DEPTH_TEST);
    if(skyblend==1){gl.enable(gl.BLEND);}
    gl.blendFunc(gl.SRC_COLOR, gl.ONE);//_MINUS_SRC_ALPHA);
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	//x=0;y=0;z=0;
	var dx=skyx-xv,dy=skyy-yv,dz=skyz-zv;
	var do1=diro1(dx,dy);
	var do2=diro1(Math.sqrt(dx*dx+dy*dy),dz);
	var dist=Math.sqrt(dx*dx+dy*dy+dz*dz);
    distskymin=Math.min(distskymin,dist);
	var sc=1;if(dist>70000 && tdrawmap==0){sc=70000/dist;}
	var dxy=dx*cos1*cos2+dy*sin1*cos2+dz*sin2;
	if(dxy<1400 && dxy>140 && skyblend==1){sc=1400/(dxy);}
	if(dxy<=140 && dxy>4 && skyblend==1){sc=1400/(dxy+140);}
	if(dxy<1700 && dxy>140 && skyblend==0){sc=1700/(dxy);}//mask
	if(dxy<=140 && dxy>4 && skyblend==0){sc=1700/(dxy+140);}//mask
	if(tourelle==0){
		mat4.translate(mvMatrix, [x+(skyx-x)*sc,y+(skyy-y)*sc,z+(skyz-z)*sc]);
        mat4.rotate(mvMatrix, degtorad(-90+do1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90+do2), [1, 0, 0]);
        //mat4.rotate(mvMatrix, degtorad(90), [0, 0, 1]);
		mat4.scale(mvMatrix,[skyrx*sc,skyry*sc,1*sc]);
	}else{
		mat4.translate(mvMatrix, [x+(skyx-x)*sc,y+(skyy-y)*sc,z+(skyz-z)*sc]);
        mat4.rotate(mvMatrix, degtorad(-90+do1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90+do2), [1, 0, 0]);
        //mat4.rotate(mvMatrix, degtorad(90), [0, 0, 1]);
		mat4.scale(mvMatrix,[skyrx*sc,skyry*sc,1*sc]);
	}
	if(tdrawmap>0 && tdrawmap!=3){mat4.scale(mvMatrix,[1.8,1.8,1]);}
	gl.activeTexture(gl.TEXTURE6);
    //gl.bindTexture(gl.TEXTURE_2D,  skyTexture);
    gl.bindTexture(gl.TEXTURE_2D,  texture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	
	colorr*=1.1;colorg*=1.1;colorb*=1.1;colora=1;
    drawcarre();    
	colorr=1;colorg=1;colorb=1;colora=1;
	
	mvPopMatrix()
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
}
var skytextx=4000,skytexty=000,skytextz=000,skytextrx=40,skytextry=40;
var skytextblend=1;
var nboom=10,iboom=0,nboomx=[],nboomy=[],nboomz=[],nboomr=[],ntboom=[];
for(var i=0;i<nboom;i++){ntboom[i]=0;
    nboomx[i]=0;nboomy[i]=0;nboomz[i]=0;nboomr[i]=40;}
function addboom(px,py,pz,r){
    iboom+=1;if(iboom>=nboom){iboom=0;}
    ntboom[iboom]=tframe;
    nboomx[iboom]=px;nboomy[iboom]=py;nboomz[iboom]=pz;nboomr[iboom]=r;
}
function drawnboom(){
  for(var i=0;i<nboom;i++){
    if(tframe<ntboom[i]+5000){
	   boomx=nboomx[i];boomy=nboomy[i];boomz=nboomz[i];boomr=nboomr[i];
	   tboom=ntboom[i];drawboom();
	}
  }
}
var boomx=0,boomy=0,boomz=0,boomr=40,tboom=0;
function drawboom(){
skytextx=boomx;skytexty=boomy;skytextz=boomz;skytextrx=boomr;skytextry=boomr;
var dt=tframe-tboom,dt2=1200,dt1=dt2;
var cc=(dt1-dt)/dt2,cc2=1;//-Math.abs(Math.sin(degtorad((tframe-tboom)/10)));
var texture0=explode1Texture;
var texture1=explode3Texture;
var texture2=0;
var r=boomr*(dt+40)*1.1/(dt+200);
cc=1.2-(dt+45)/(dt+450);
if(dt>dt1){dt2=1000;dt1+=dt2;cc2=(dt1-dt)/dt2;
                                 texture2=explode4Texture;}
if(dt>dt1){return;}
skytextrx=r;skytextry=r;		   
cc=Math.max(0,Math.min(1,cc));
colorr=cc;colorg=cc;colorb=cc;
gl.disable(gl.DEPTH_TEST);
drawskytext(texture0);
if(texture2==0){
  colorr=1-cc;colorg=1-cc;colorb=1-cc;
  drawskytext(texture1);
}else{
  colorr=(1-cc)*cc2;colorg=(1-cc)*cc2;colorb=(1-cc)*cc2;
  drawskytext(texture1);
  colorr=cc2;colorg=cc2;colorb=cc2;
  drawskytext(texture2);
}
gl.enable(gl.DEPTH_TEST);
colorr=1;colorg=1;colorb=1;
}
function drawskytext(texture){
    //gl.disable(gl.DEPTH_TEST);
    if(skytextblend==1){gl.enable(gl.BLEND);}
    gl.blendFunc(gl.SRC_COLOR, gl.ONE);//_MINUS_SRC_ALPHA);
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	//x=0;y=0;z=0;
	var dx=skytextx-xv,dy=skytexty-yv,dz=skytextz-zv;
	var do1=diro1(dx,dy);
	var do2=diro1(Math.sqrt(dx*dx+dy*dy),dz);
	var dist=Math.sqrt(dx*dx+dy*dy+dz*dz);
	var sc=1;if(dist>70000 && tdrawmap==0){sc=70000/dist;}
	//var dxy=dx*cos1*cos2+dy*sin1*cos2+dz*sin2;
	//if(dxy<500 && dxy>5 && skytextblend==1){sc=700/dxy;}
	//if(dxy<600 && dxy>5 && skytextblend==0){sc=750/dxy;}//mask
	if(tourelle==0){
		mat4.translate(mvMatrix, [x+(skytextx-x)*sc,y+(skytexty-y)*sc,z+(skytextz-z)*sc]);
        mat4.rotate(mvMatrix, degtorad(-90+do1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90+do2), [1, 0, 0]);
        //mat4.rotate(mvMatrix, degtorad(90), [0, 0, 1]);
		mat4.scale(mvMatrix,[skytextrx*sc,skytextry*sc,1*sc]);
	}else{
		mat4.translate(mvMatrix, [x+(skytextx-x)*sc,y+(skytexty-y)*sc,z+(skytextz-z)*sc]);
        mat4.rotate(mvMatrix, degtorad(-90+do1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90+do2), [1, 0, 0]);
        //mat4.rotate(mvMatrix, degtorad(90), [0, 0, 1]);
		mat4.scale(mvMatrix,[skytextrx*sc,skytextry*sc,1*sc]);
	}
	if(tdrawmap>0 && tdrawmap!=3){mat4.scale(mvMatrix,[1.8,1.8,1]);}
	gl.activeTexture(gl.TEXTURE6);
    //gl.bindTexture(gl.TEXTURE_2D,  skytextTexture);
    gl.bindTexture(gl.TEXTURE_2D,  texture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	
	colorr*=1.1;colorg*=1.1;colorb*=1.1;colora=1;
    drawcarre();    
	colorr=1;colorg=1;colorb=1;colora=1;
	
	mvPopMatrix()
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
}
function drawhorizon(){
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [xmaxmin2,ymaxmin2, Math.max(0,zsol-40)-2]);
    var sc=4*(xmax-xmin)/(2*boussx);
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  solTexture3);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
    var color2=(1.0-0.37*(Math.abs(12.0-hour)-4.0)/8.0);
	colorr=color2;colorg=color2;colorb=color2;colora=1+10;
    drawcarre();    
    colorr=1;colorg=1;colorb=1;colora=1;
	mvPopMatrix();
}
var portxok=0;
function drawairporttower(){
if(nairport==0 || iairport<0){return;}
for(var i=0;i<nairport;i++){
    var portxx=airportx[i],portyy=airporty[i],portzz=airportz[i];
    var dist=Math.max(Math.abs(portxx-x),Math.abs(portyy-y))
	if(dist<(300+distmap2)){
	if(dist<120 && tpiste==1){
	   if(vplane<0.002 && vie<50){vie+=dtime*0.003};}
    mvPushMatrix();
	portzz=getterrainheight(portxx,portyy);
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [portxx,portyy,portzz+6]);
	if(tourelle==0){	
        mat4.rotate(mvMatrix, degtorad(-o1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}else{
        mat4.rotate(mvMatrix, degtorad(-o1-to1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}
    var sc=17/(2*boussx);
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  airporttowerTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	colorr=1;colorg=1;colorb=1;colora=1;
    drawcarre();    

	mvPopMatrix();
}}
}
function drawairport(){
if(nairport==0 || iairport<0 || portxok==0){return;}
        var portxx=portx-x,portyy=porty-y;
        if(Math.abs(portxx)>(300+distmap2)){return;}
        if(Math.abs(portyy)>(300+distmap2)){return;}
        mvPushMatrix();
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  solTexture4);
	gl.uniform1i(solProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, portVertexTextureCoordBuffer);
    gl.vertexAttribPointer(solProgram.textureCoordAttribute, portVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, portVertexPositionBuffer);
    gl.vertexAttribPointer(solProgram.vertexPositionAttribute, portVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniformspiste(); 
    gl.uniform1i(solProgram.type, 4);
    gl.drawArrays(gl.TRIANGLES, 0, portVertexPositionBuffer.numItems);

	mvPopMatrix();
/*    mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [portx,porty,portz+0.4]);
    //scaletexture=512/(xmax-xmin);
    var sc=((xmax-xmin)/4)/(2*boussx);
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  solTexture4);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
    drawcarre();    

	mvPopMatrix();*/
}
function draweiffeltower(){
    var xx=xmaxmin2+(eiffeltowerx-worldx)*(xmax-xmin)/512;
    if(Math.abs(xx-x)>(300+distmap2)*1.5){return;}
	var yy=ymaxmin2+(eiffeltowery-worldy)*(ymax-ymin)/512;
    if(Math.abs(yy-y)>(300+distmap2)*1.5){return;}
    mvPushMatrix();
	var zz=getterrainheight(xx,yy);
    var sc=80;
	mat4.translate(mvMatrix, [xx,yy,zz+sc*0.65]);
	sc=sc/(2*boussx);
	if(tourelle==0){	
        mat4.rotate(mvMatrix, degtorad(-o1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}else{
        mat4.rotate(mvMatrix, degtorad(-o1-to1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}
    mat4.scale(mvMatrix,[sc,sc*1.3,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  eiffeltowerTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	colorr=1;colorg=1;colorb=1;colora=1;
    drawcarre();    
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
function drawlibertystatue(){
    var xx=xmaxmin2+(libertystatuex-worldx)*(xmax-xmin)/512;
    if(Math.abs(xx-x)>(300+distmap2)){return;}
	var yy=ymaxmin2+(libertystatuey-worldy)*(ymax-ymin)/512;
    if(Math.abs(yy-y)>(300+distmap2)){return;}
    mvPushMatrix();
	var zz=getterrainheight(xx,yy);
    var sc=32.5;
	mat4.translate(mvMatrix, [xx,yy,zz+sc*0.65]);
	sc=sc/(2*boussx);
	if(tourelle==0){	
        mat4.rotate(mvMatrix, degtorad(-o1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}else{
        mat4.rotate(mvMatrix, degtorad(-o1-to1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}
    mat4.scale(mvMatrix,[sc,sc*1.3,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  libertystatueTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	colorr=1;colorg=1;colorb=1;colora=1;
    drawcarre();    
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
function drawchristrio(){
    var xx=xmaxmin2+(christriox-worldx)*(xmax-xmin)/512;
    if(Math.abs(xx-x)>(300+distmap2)){return;}
	var yy=ymaxmin2+(christrioy-worldy)*(ymax-ymin)/512;
    if(Math.abs(yy-y)>(300+distmap2)){return;}
    mvPushMatrix();
	var zz=getterrainheight(xx,yy);
    var sc=37;
	mat4.translate(mvMatrix, [xx,yy,zz+sc*0.9]);
	sc=sc/(2*boussx);
	if(tourelle==0){	
        mat4.rotate(mvMatrix, degtorad(-o1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}else{
        mat4.rotate(mvMatrix, degtorad(-o1-to1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}
    mat4.scale(mvMatrix,[sc,sc*1.8,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  christrioTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	colorr=1;colorg=1;colorb=1;colora=1;
    drawcarre();    
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
function drawdomerock(){
    var xx=xmaxmin2+(domerockx-worldx)*(xmax-xmin)/512;
    if(Math.abs(xx-x)>(300+distmap2)){return;}
	var yy=ymaxmin2+(domerocky-worldy)*(ymax-ymin)/512;
    if(Math.abs(yy-y)>(300+distmap2)){return;}
    mvPushMatrix();
	var zz=getterrainheight(xx,yy);
    var sc=37.5;
	mat4.translate(mvMatrix, [xx,yy,zz+sc*0.5]);
	sc=sc/(2*boussx);
	if(tourelle==0){	
        mat4.rotate(mvMatrix, degtorad(-o1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}else{
        mat4.rotate(mvMatrix, degtorad(-o1-to1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  domerockTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	colorr=1;colorg=1;colorb=1;colora=1;
    drawcarre();    
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
function drawgizah(){
    var xx=xmaxmin2+(gizahx-worldx)*(xmax-xmin)/512;
    if(Math.abs(xx-x)>(300+distmap2)*1.9){return;}
	var yy=ymaxmin2+(gizahy-worldy)*(ymax-ymin)/512;
    if(Math.abs(yy-y)>(300+distmap2)*1.9){return;}
    mvPushMatrix();
	var zz=getterrainheight(xx,yy);
    var sc=69;
	mat4.translate(mvMatrix, [xx,yy,zz+sc*0.5]);
	sc=sc/(2*boussx);
	if(tourelle==0){	
        mat4.rotate(mvMatrix, degtorad(-o1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}else{
        mat4.rotate(mvMatrix, degtorad(-o1-to1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  gizahTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	colorr=1;colorg=1;colorb=1;colora=1;
    drawcarre();    
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
function drawcapitole(){
    var xx=xmaxmin2+(capitolex-worldx)*(xmax-xmin)/512;
    if(Math.abs(xx-x)>(300+distmap2)*1.9){return;}
	var yy=ymaxmin2+(capitoley-worldy)*(ymax-ymin)/512;
    if(Math.abs(yy-y)>(300+distmap2)*1.9){return;}
    mvPushMatrix();
	var zz=getterrainheight(xx,yy);
    var sc=150;
	mat4.translate(mvMatrix, [xx,yy,zz+sc*0.59]);
	sc=sc/(2*boussx);
	if(tourelle==0){	
        mat4.rotate(mvMatrix, degtorad(-o1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}else{
        mat4.rotate(mvMatrix, degtorad(-o1-to1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  capitoleTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	colorr=1;colorg=1;colorb=1;colora=1;
    drawcarre();    
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
function drawtajmahal(){
    var xx=xmaxmin2+(tajmahalx-worldx)*(xmax-xmin)/512;
    if(Math.abs(xx-x)>(300+distmap2)*1.9){return;}
	var yy=ymaxmin2+(tajmahaly-worldy)*(ymax-ymin)/512;
    if(Math.abs(yy-y)>(300+distmap2)*1.9){return;}
    mvPushMatrix();
	var zz=getterrainheight(xx,yy);
    var sc=65;
	mat4.translate(mvMatrix, [xx,yy,zz+sc*0.5]);
	sc=sc/(2*boussx);
	if(tourelle==0){	
        mat4.rotate(mvMatrix, degtorad(-o1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}else{
        mat4.rotate(mvMatrix, degtorad(-o1-to1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  tajmahalTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	colorr=1;colorg=1;colorb=1;colora=1;
    drawcarre();    
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
function drawbuddah(){
    var xx=xmaxmin2+(buddahx-worldx)*(xmax-xmin)/512;
    if(Math.abs(xx-x)>(300+distmap2)*1.9){return;}
	var yy=ymaxmin2+(buddahy-worldy)*(ymax-ymin)/512;
    if(Math.abs(yy-y)>(300+distmap2)*1.9){return;}
    mvPushMatrix();
	var zz=getterrainheight(xx,yy);
    var sc=55;
	mat4.translate(mvMatrix, [xx,yy,zz+sc*0.42]);
	sc=sc/(2*boussx);
	if(tourelle==0){	
        mat4.rotate(mvMatrix, degtorad(-o1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}else{
        mat4.rotate(mvMatrix, degtorad(-o1-to1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  buddahTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	colorr=1;colorg=1;colorb=1;colora=1;
    drawcarre();    
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
var cloudx0=x,cloudy0=y,cloudz0=z;
function drawcloud(){
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    if(tshadow==0){gl.blendFunc(gl.SRC_ALPHA, gl.ONE);//_MINUS_SRC_ALPHA);
    }else{gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
    }    
    mvPushMatrix();
	//if(tspace==1){mat4.translate(mvMatrix, [cloudx0,cloudy0,cloudz0]);}
		//vec3.set(cameraPosition,[x,y,z]);
	    //mat4.identity(rotMatrix);
        //mat4.translate(rotMatrix, [x,y,z]);
        //mat4.rotate(rotMatrix, degtorad(o1), [0, 0, 1]);
        //mat4.translate(rotMatrix, [-x,-y,-z]);
		//mat4.translate(mvMatrix, [x,y,z]);
        //mat4.rotate(mvMatrix, degtorad(-90), [1, 0, 0]);
        //
        //mat4.rotate(mvMatrix, degtorad(sin3*24), [1, 0, 0]);
		//mat4.scale(mvMatrix,[40.2,40.2,80.2]);
	gl.activeTexture(gl.TEXTURE3);
    if(tshadow==0){gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
    }else{gl.bindTexture(gl.TEXTURE_2D,  cloudblackTexture);}
	gl.uniform1i(cloudProgram.samplerUniform, 3);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, cloudVertexTextureCoordBuffer);
    gl.vertexAttribPointer(cloudProgram.textureCoordAttribute, cloudVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, cloudVertexPositionBuffer);
    gl.vertexAttribPointer(cloudProgram.vertexPositionAttribute, cloudVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	setcloudMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, 6*ncloud2);//cloudVertexPositionBuffer.numItems);

		mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
}
function drawsun(){
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE);//_MINUS_SRC_ALPHA);
        mvPushMatrix();
		camx=x;camy=y;camz=z;
		//mat4.translate(mvMatrix, [500,0,100]);
	    //mat4.identity(rotMatrix);
        //mat4.translate(rotMatrix, [x,y,z]);
        //mat4.rotate(rotMatrix, degtorad(o1), [0, 0, 1]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  sunTexture);
    gl.uniform1i(cloudProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, sunVertexTextureCoordBuffer);
    gl.vertexAttribPointer(cloudProgram.textureCoordAttribute, sunVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, sunVertexPositionBuffer);
    gl.vertexAttribPointer(cloudProgram.vertexPositionAttribute, sunVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	setsunMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, sunVertexPositionBuffer.numItems);

	mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
}
function drawsunmirror(){
    mvPushMatrix();
    mat4.translate(mvMatrix, [0,0,-z]);
    mat4.scale(mvMatrix,[1,1,-1]);
	drawsun();
	mvPopMatrix();
}
function drawcloudmirror(){
    mvPushMatrix();
    mat4.translate(mvMatrix, [0,0,-z]);
    mat4.scale(mvMatrix,[1,1,-1]);
	drawcloud();
	mvPopMatrix();
}
var vie=100,tblood=0,o1blood=0;
function drawblood(){
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.ONE_MINUS_SRC_COLOR, gl.SRC_COLOR);
        mvPushMatrix();
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0,0,-110]);
 		if(o1blood<0.5){mat4.scale(mvMatrix,[windx/windy,1,1]);;
		 }else{mat4.scale(mvMatrix,[-windx/windy,1,1]);} 
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  bloodTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
	//colorr=1;colorg=1;colorb=1;colora=0.999;
    drawcarre();

		mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
	colorr=1.0;colorg=1.0;colorb=1.0;colora=1.0;
}
var train=0,train1=0,train2=0,timerain1=0,timerain2=0;
var texscalex1=1,texscaley1=1,textdx1=0,textdy1=0;
var texscalex2=1,texscaley2=1,textdx2=0,textdy2=0;
function drawrain(){
    if(train==0 && train1==0 && train2==0){stopsoundrain();return;}
	soundrain();
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.ONE_MINUS_SRC_COLOR, gl.ONE);
	gl.activeTexture(gl.TEXTURE10);
    gl.bindTexture(gl.TEXTURE_2D,  rainTexture);
    gl.uniform1i(program2d.samplerUniform, 10);
	var kvplane=(0.5+1.5*vplane);if(kvplane<0.5){kvplane=0.5;}
	dx2d=0;dy2d=0.2;
	texscalex=texscalex1;texscaley=texscaley1;
	textdx=textdx1;textdy=textdy1;
	if(tframe>timerain1){
	  train1=train;
      if(tframe>timerain2){
	    timerain1=tframe+(Math.random()+2)*800/kvplane;		
	  }else{timerain1=timerain2+(Math.random()+2)*600/kvplane;}
	  texscalex=0.75*windx/windy;texscaley=0.85;
	  textdx=Math.random();textdy=Math.random();
	}else{texscalex-=kvplane*dtime/7000;
	      texscaley-=kvplane*dtime/7000;}
    if(texscalex<0.1){texscalex=0.1;}
    if(texscaley<0.1){texscaley=0.1;}
    var c=(1.4-texscaley);
    colorr=c;colorg=c;colorb=c;colora=1;
	texscalex1=texscalex;texscaley1=texscaley;
	textdx1=textdx;textdy1=textdy;
	texscaley*=(1+Math.abs(dy2d));
	if(train1==1){drawcarre2D();}

	texscalex=texscalex2;texscaley=texscaley2;
	textdx=textdx2;textdy=textdy2;
	if(tframe>timerain2){
	  train2=train;
      if(tframe>timerain1){
	    timerain2=tframe+(Math.random()+2)*800/kvplane;	
	  }else{timerain2=timerain1+(Math.random()+2)*600/kvplane;}
	  texscalex=0.75*windx/windy;texscaley=0.85;
	  textdx=Math.random();textdy=Math.random();
	}else{texscalex-=kvplane*dtime/7000;
	      texscaley-=kvplane*dtime/7000;}
    if(texscalex<0.1){texscalex=0.1;}
    if(texscaley<0.1){texscaley=0.1;}
    c=(1.4-texscaley);
    colorr=c;colorg=c;colorb=c;colora=1;
	texscalex2=texscalex;texscaley2=texscaley;
	textdx2=textdx;textdy2=textdy;
	texscaley*=(1+Math.abs(dy2d));
	if(train2==1){drawcarre2D();}

	colorr=1;colorg=1;colorb=1;colora=1;
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
}
function drawbouss(){
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
        mvPushMatrix();
		mat4.identity(mvMatrix);
		//windx=canvas.width;
		//windy=canvas.height;
		//mat4.translate(mvMatrix, [230*windx/windy,-220,-600]);//boussx
		mat4.translate(mvMatrix, [(cssscale/cssscaley)*234*windx/windy,220,-600]);//boussx
		//mat4.translate(mvMatrix, [234*windx/windy,220,-600]);//boussx
		if(tourelle==0){mat4.rotate(mvMatrix, degtorad(90-o1), [0, 0, 1]);
	    }else{mat4.rotate(mvMatrix, degtorad(90-o1-to1), [0, 0, 1]);}
		//mat4.identity(rotMatrix);
        //mat4.translate(rotMatrix, [x,y,z]);
        //mat4.rotate(rotMatrix, degtorad(o1), [0, 0, 1]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  boussTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    drawcarre();

		mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
	if(tspace==1){drawbouss2();}
}
function drawbouss2(){
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    //gl.enable(gl.BLEND);
    //gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
        mvPushMatrix();
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [(cssscale/cssscaley)*(234*windx/windy-68),220,-600]);//boussx
		mat4.scale(mvMatrix,[0.62,0.62,0.62]);
		mat4.rotate(mvMatrix, degtorad(-o3), [0, 0, 1]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  compas0Texture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
	colorr=0.34;
    drawcarre();

		mvPopMatrix();
        mvPushMatrix();
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [(cssscale/cssscaley)*(234*windx/windy-68),220,-600]);//boussx
		mat4.rotate(mvMatrix, degtorad(-o3), [0, 0, 1]);
		mat4.scale(mvMatrix,[0.61,0.61*cos2,0.61]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  compas1Texture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    colorr=1;colorg=0.7-0.3*sin2;colorb=1;
	drawcarre();
	colorr=1;colorg=1;colorb=1;

		mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
}
function drawbouss20(){
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
        mvPushMatrix();
		mat4.identity(mvMatrix);
		//windx=canvas.width;
		//windy=canvas.height;
		//mat4.translate(mvMatrix, [230*windx/windy,-220,-600]);//boussx
		mat4.translate(mvMatrix, [(cssscale/cssscaley)*(234*windx/windy-68),220,-600]);//boussx
		//mat4.translate(mvMatrix, [234*windx/windy,220,-600]);//boussx
		mat4.scale(mvMatrix,[0.7,(0.25+0.75*cos2)*0.7,0.7]);
		mat4.rotate(mvMatrix, degtorad(-o3), [0, 0, 1]);
		//mat4.identity(rotMatrix);
        //mat4.translate(rotMatrix, [x,y,z]);
        //mat4.rotate(rotMatrix, degtorad(o1), [0, 0, 1]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  boussTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    drawcarre();

		mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
}
var tcrash=0;
function testcrash(){
if(tframe<tcrash+2000){return;}
if(tcollide==1){
      soundcrash();
	  tcrash=timer()+1000;
      return;}
var r=0.4;
var xx=x+0.7*cos1,yy=y+0.7*sin1;
for(var i=0;i<ntree;i++){
  if(Math.abs(treex[i]-xx)<r){
   if(Math.abs(treey[i]-yy)<r){
     if(Math.abs(treez[i]+1-z)<2){
      soundcrash();
	  tcrash=timer();
}}}}
}
var o3volant=0;
function drawcarcockpit(){
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
        mvPushMatrix();
		mat4.identity(mvMatrix);
		//windx=canvas.width;
		//windy=canvas.height;
		//mat4.translate(mvMatrix, [230*windx/windy,-220,-600]);//boussx
		mat4.translate(mvMatrix, [20,-17+Math.min(20,Math.max(-20,planedo2*0.7)),-60]);
		//mat4.translate(mvMatrix, [234*windx/windy,220,-600]);//boussx
		//mat4.rotate(mvMatrix, degtorad(planedo2), [1, 0, 0]);
		mat4.rotate(mvMatrix, degtorad(-planedo3), [0, 0, 1]);
	    //mat4.identity(rotMatrix);
        //mat4.translate(rotMatrix, [x,y,z]);
        //mat4.rotate(rotMatrix, degtorad(o1), [0, 0, 1]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  carTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    mat4.scale(mvMatrix,[2,1.4,1]);
    colorr=1;colorg=1;colorb=1;colora=1+20;
    drawcarre();
    colorr=1;colorg=1;colorb=1;colora=1;

    mvPushMatrix();
	mat4.translate(mvMatrix, [-17.65,-5.8,0.005]);
    mat4.scale(mvMatrix,[0.07,0.10,1]);
	drawrpm();
	mvPopMatrix();

    mvPushMatrix();
	mat4.translate(mvMatrix, [-20.05,-13.5,0.01]);
    mat4.scale(mvMatrix,[0.26,0.427,1]);
	mat4.rotate(mvMatrix, degtorad(o3volant), [0, 0, 1]);
    drawvolant();
	mvPopMatrix();
	
	mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
}
function drawvolant(){
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  volantTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    colorr=1;colorg=1;colorb=1;colora=1+20;
    drawcarre();
    colorr=1;colorg=1;colorb=1;colora=1;
}
function drawrpm(){
    mvPushMatrix();
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  rpmTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
	drawcarre();
    
    gl.bindTexture(gl.TEXTURE_2D,  arrowTexture);
	var o3rpm=130-(vrun+0.7*vplane)*105*(0.8+1.3)/(0.8+vrunmax);
	if(o3rpm<-130){o3rpm=-130;};
	mat4.rotate(mvMatrix, degtorad(o3rpm), [0, 0, 1]);
 	//mat4.scale(mvMatrix,[0.065,0.059,0.067]);
    mat4.scale(mvMatrix,[0.8,0.8,0.8]);
	drawcarre();
	mvPopMatrix();
}
function testhorse(px,py,pz,r0){
var r=r0;if(tcar==1){r*=0.28;}
 if(Math.abs(px-horse1lowx)<r){
  if(Math.abs(py-horse1lowy)<r){
   if(Math.abs(pz-horse1lowz)<r){
     soundhorse();return 1;
 }}}
 if(Math.abs(px-horse2lowx)<r){
  if(Math.abs(py-horse2lowy)<r){
   if(Math.abs(pz-horse2lowz)<r){
     soundhorse();return 1;
 }}}
 if(Math.abs(px-horse3lowx)<r){
  if(Math.abs(py-horse3lowy)<r){
   if(Math.abs(pz-horse3lowz)<r){
     soundhorse();return 1;
 }}}
 return 0;
}
var thorse1low=0,o2horse1low=0,o1horse1low=0,o3horse1low=0,tmovehorse1low=1,tframehorse1low=0,vhorse1low=1;
var horse1lowx=x+8,horse1lowy=y,horse1lowz=0,horse1lowo1=0,horse1lowo2=0;
var horse1lowo10=0,horse1lowv=2,horse1lowco1=1,horse1lowsi1=0;
function drawhorse1low(){
   var distmax=365,test=0;
   while(horse1lowx<(x-distmax)){horse1lowx+=1.99*distmax;test=1;}
   while(horse1lowx>(x+distmax)){horse1lowx-=1.99*distmax;test=1;}
   while(horse1lowy<(y-distmax)){horse1lowy+=1.99*distmax;test=1;}
   while(horse1lowy>(y+distmax)){horse1lowy-=1.99*distmax;test=1;}
   var co1=Math.cos(degtorad(horse1lowo1)),si1=Math.sin(degtorad(horse1lowo1));
   horse1lowco1=co1;horse1lowsi1=si1;
   var horsex0=horse1lowx,horsey0=horse1lowy,horsez0=horse1lowz;
   var h0=getterrainheight1(horse1lowx,horse1lowy);
   horse1lowx+=horse1lowv*co1*dtime*0.0012;
   horse1lowy+=horse1lowv*si1*dtime*0.0012;
   var h1=getterrainheight1(horse1lowx,horse1lowy);
   horse1lowz=h1;
   if(h0<-0.3){return;}
   if(h0>0.001 && h1<-0.001){horse1lowx=horsex0;
	                horse1lowy=horsey0;
					horse1lowz=horsez0;  
	                horse1lowo1+=20+Math.random()*40;
			       }
   if(Math.random()<0.0001*dtime){
        horse1lowo10+=(Math.random()-0.5)*100;}
   var doo1=horse1lowo10-horse1lowo1;
   while(horse1lowo1>180){horse1lowo1-=360;}
   while(horse1lowo1<-180){horse1lowo1+=360;}
   while(doo1>180){doo1-=360;}
   while(doo1<-180){doo1+=360;}
   if(doo1>8){horse1lowo1+=dtime*0.05;}
   if(doo1<-8){horse1lowo1-=dtime*0.05;}   
   tmovehorse1low=(1+vhorse1low*0.3);//-0.3*Math.cos((dx+dy)*0.1));
   horse1lowv=1.8;
   if(tgmap==0){
     if(Math.abs(x-horse1lowx)>(distmap2)){return;}
     if(Math.abs(y-horse1lowy)>(distmap2)){return;}
   }
   if(rotavion(horse1lowx-x,horse1lowy-y,horse1lowz-z,2)<=0){return;}
	if(x2>0){
       tmovehorse1low=(1+vhorse1low*0.15);//-0.3*Math.cos((dx+dy)*0.1+8*degtorad(o1)))/1.1;
	   }
	horse1lowo2=Math.atan(h1-h0)*radtodeg/2;
	tframehorse1low+=dtime*(tmovehorse1low*0.6+0.3);
    o2horse1low=0.8*Math.sin(tframehorse1low*0.0065)*tmovehorse1low;
    o2horse1low+=0.22*(Math.sin(tframehorse1low*0.0016)-0.4);
    var nvertices=horselowVertexPositionBuffer.numItems;
	if(o2horse1low>0){   
	 for(var i=0;i<nvertices*3;i++){
	    horselowVertexPositions[i]=horselowidleVertexPositions[i]
		    +o2horse1low*horselowrun1VertexPositions[i];}
    }else{	
	 for(var i=0;i<nvertices*3;i++){
	    horselowVertexPositions[i]=horselowidleVertexPositions[i]
		    -o2horse1low*horselowrun2VertexPositions[i];}
    }
	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  horse00Texture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		
		mvPushMatrix();
		mat4.translate(mvMatrix, [horse1lowx,horse1lowy,horse1lowz+0.1]);
		mat4.rotate(mvMatrix,degtorad(horse1lowo1+90), [0, 0, 1]);
    	mat4.rotate(mvMatrix,degtorad(-horse1lowo2-2.5+5.5*o2horse1low), [1, 0, 0]);
    	mat4.scale(mvMatrix,[0.0125,0.0125,0.0125]);
    	//mat4.scale(mvMatrix,[0.0087,0.0087,0.0087]);

    gl.bindBuffer(gl.ARRAY_BUFFER, horselowVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, horselowVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, horselowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, (horselowVertexPositions), gl.STATIC_DRAW);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, horselowVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, horselowVertexPositionBuffer.numItems);

	mvPopMatrix();
}
var thorse2low=0,o2horse2low=0,o1horse2low=0,o3horse2low=0,tmovehorse2low=1,tframehorse2low=0,vhorse2low=1;
var horse2lowx=x+8,horse2lowy=y,horse2lowz=0,horse2lowo1=0,horse2lowo2=0;
var horse2lowo10=0,horse2lowv=2,horse2lowco1=1,horse2lowsi1=0;
function drawhorse2low(){
   var dx=horse1lowx-horse2lowx;
   var dy=horse1lowy-horse2lowy;
   var dist=Math.sqrt(dx*dx+dy*dy);
   if(dist>70){horse2lowx=horse1lowx-50*dx/dist;
               horse2lowy=horse1lowy-50*dy/dist;}
   var co1=Math.cos(degtorad(horse2lowo1)),si1=Math.sin(degtorad(horse2lowo1));
   horse2lowco1=co1;horse2lowsi1=si1;
   var horsex0=horse2lowx,horsey0=horse2lowy,horsez0=horse2lowz;
   var h0=getterrainheight1(horse2lowx,horse2lowy);
   horse2lowx+=horse2lowv*co1*dtime*0.0012;
   horse2lowy+=horse2lowv*si1*dtime*0.0012;
   var h1=getterrainheight1(horse2lowx,horse2lowy);
   horse2lowz=h1;
   if(h0<-0.3){return;}
   if(h0>0.001 && h1<-0.001){horse2lowx=horsex0;
	                horse2lowy=horsey0;
					horse2lowz=horsez0;  
	                horse2lowo1+=20+Math.random()*40;
			       }
   if(Math.random()<0.0002*dtime){
      horse2lowo10=diro1(dx,dy)+(Math.random()-0.5)*10;}
   var doo1=horse2lowo10-horse2lowo1;
   while(horse2lowo1>180){horse2lowo1-=360;}
   while(horse2lowo1<-180){horse2lowo1+=360;}
   while(doo1>180){doo1-=360;}
   while(doo1<-180){doo1+=360;}
   if(doo1>8){horse2lowo1+=dtime*0.05;}
   if(doo1<-8){horse2lowo1-=dtime*0.05;}   
   tmovehorse2low=(1+vhorse2low*0.3);//-0.3*Math.cos((dx+dy)*0.1));
   if(dist>15){horse2lowv=2.25;}
   if(dist<5){horse2lowv=1.8;}
   if(tgmap==0){
     if(Math.abs(x-horse2lowx)>(distmap2)){return;}
     if(Math.abs(y-horse2lowy)>(distmap2)){return;}
   }
   if(rotavion(horse2lowx-x,horse2lowy-y,horse2lowz-z,2)<=0){return;}
	if(x2>0){
       tmovehorse2low=(1+vhorse2low*0.15);//-0.3*Math.cos((dx+dy)*0.1+8*degtorad(o1)))/1.1;
	   }
	horse2lowo2=Math.atan(h1-h0)*radtodeg/2;
	tframehorse2low+=dtime*(tmovehorse2low*0.6+0.3);
    o2horse2low=0.8*Math.sin(tframehorse2low*0.0065)*tmovehorse2low;
    o2horse2low+=0.22*(Math.sin(tframehorse2low*0.0016)-0.4);
    var nvertices=horselowVertexPositionBuffer.numItems;
	if(o2horse2low>0){   
	 for(var i=0;i<nvertices*3;i++){
	    horselowVertexPositions[i]=horselowidleVertexPositions[i]
		    +o2horse2low*horselowrun1VertexPositions[i];}
    }else{	
	 for(var i=0;i<nvertices*3;i++){
	    horselowVertexPositions[i]=horselowidleVertexPositions[i]
		    -o2horse2low*horselowrun2VertexPositions[i];}
    }
	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  horse00Texture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		
		mvPushMatrix();
		mat4.translate(mvMatrix, [horse2lowx,horse2lowy,horse2lowz+0.1]);
		mat4.rotate(mvMatrix,degtorad(horse2lowo1+90), [0, 0, 1]);
    	mat4.rotate(mvMatrix,degtorad(-horse2lowo2-2.5+5.5*o2horse2low), [1, 0, 0]);
    	mat4.scale(mvMatrix,[0.011,0.011,0.011]);
    	//mat4.scale(mvMatrix,[0.0087,0.0087,0.0087]);

    gl.bindBuffer(gl.ARRAY_BUFFER, horselowVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, horselowVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, horselowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, (horselowVertexPositions), gl.STATIC_DRAW);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, horselowVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    colorr=0.82;colorg=0.82;colorb=0.82;colora=1;
	setMatrixUniforms(); 
    colorr=1;colorg=1;colorb=1;colora=1;
    gl.drawArrays(gl.TRIANGLES, 0, horselowVertexPositionBuffer.numItems);

	mvPopMatrix();
}
var thorse3low=0,o2horse3low=0,o1horse3low=0,o3horse3low=0,tmovehorse3low=1,tframehorse3low=0,vhorse3low=1;
var horse3lowx=x+8,horse3lowy=y,horse3lowz=0,horse3lowo1=0,horse3lowo2=0;
var horse3lowo10=0,horse3lowv=2,horse3lowco1=1,horse3lowsi1=0;
function drawhorse3low(){
   var dx=horse1lowx-horse3lowx;
   var dy=horse1lowy-horse3lowy;
   var dist=Math.sqrt(dx*dx+dy*dy);
   if(dist>70){horse3lowx=horse1lowx-50*dx/dist;
               horse3lowy=horse1lowy-50*dy/dist;}
   var co1=Math.cos(degtorad(horse3lowo1)),si1=Math.sin(degtorad(horse3lowo1));
   horse3lowco1=co1;horse3lowsi1=si1;
   var horsex0=horse3lowx,horsey0=horse3lowy,horsez0=horse3lowz;
   var h0=getterrainheight1(horse3lowx,horse3lowy);
   horse3lowx+=horse3lowv*co1*dtime*0.0012;
   horse3lowy+=horse3lowv*si1*dtime*0.0012;
   var h1=getterrainheight1(horse3lowx,horse3lowy);
   horse3lowz=h1;
   if(h0<-0.3){return;}
   if(h0>0.001 && h1<-0.001){horse3lowx=horsex0;
	                horse3lowy=horsey0;
					horse3lowz=horsez0;  
	                horse3lowo1+=20+Math.random()*40;
			       }
   if(Math.random()<0.0002*dtime){
      horse3lowo10=diro1(dx,dy)+(Math.random()-0.5)*10;}
   var doo1=horse3lowo10-horse3lowo1;
   while(horse3lowo1>180){horse3lowo1-=360;}
   while(horse3lowo1<-180){horse3lowo1+=360;}
   while(doo1>180){doo1-=360;}
   while(doo1<-180){doo1+=360;}
   if(doo1>8){horse3lowo1+=dtime*0.05;}
   if(doo1<-8){horse3lowo1-=dtime*0.05;}   
   tmovehorse3low=(1+vhorse3low*0.3);//-0.3*Math.cos((dx+dy)*0.1));
   if(dist>19){horse3lowv=2.27;}
   if(dist<4){horse3lowv=1.8;}
   if(tgmap==0){
     if(Math.abs(x-horse3lowx)>(distmap2)){return;}
     if(Math.abs(y-horse3lowy)>(distmap2)){return;}
   }
   if(rotavion(horse3lowx-x,horse3lowy-y,horse3lowz-z,2)<=0){return;}
	if(x2>0){
       tmovehorse3low=(1+vhorse3low*0.15);//-0.3*Math.cos((dx+dy)*0.1+8*degtorad(o1)))/1.1;
	   }
	horse3lowo2=Math.atan(h1-h0)*radtodeg/2;
	tframehorse3low+=dtime*(tmovehorse3low*0.6+0.3);
    o2horse3low=0.8*Math.sin(tframehorse3low*0.0065)*tmovehorse3low;
    o2horse3low+=0.22*(Math.sin(tframehorse3low*0.0016)-0.4);
    var nvertices=horselowVertexPositionBuffer.numItems;
	if(o2horse3low>0){   
	 for(var i=0;i<nvertices*3;i++){
	    horselowVertexPositions[i]=horselowidleVertexPositions[i]
		    +o2horse3low*horselowrun1VertexPositions[i];}
    }else{	
	 for(var i=0;i<nvertices*3;i++){
	    horselowVertexPositions[i]=horselowidleVertexPositions[i]
		    -o2horse3low*horselowrun2VertexPositions[i];}
    }
	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  horse00Texture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		
		mvPushMatrix();
		mat4.translate(mvMatrix, [horse3lowx,horse3lowy,horse3lowz+0.1]);
		mat4.rotate(mvMatrix,degtorad(horse3lowo1+90), [0, 0, 1]);
    	mat4.rotate(mvMatrix,degtorad(-horse3lowo2-2.5+5.5*o2horse3low), [1, 0, 0]);
    	mat4.scale(mvMatrix,[0.0085,0.0085,0.0085]);

    gl.bindBuffer(gl.ARRAY_BUFFER, horselowVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, horselowVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, horselowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, (horselowVertexPositions), gl.STATIC_DRAW);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, horselowVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    colorr=1.4;colorg=1.4;colorb=1;colora=1;
    setMatrixUniforms(); 
    colorr=1;colorg=1;colorb=1;colora=1;
    gl.drawArrays(gl.TRIANGLES, 0, horselowVertexPositionBuffer.numItems);

	mvPopMatrix();
}
function testantilope(px,py,pz,r0){
var r=r0;if(tcar==1){r*=0.28;}
 if(Math.abs(px-antilope1lowx)<r){
  if(Math.abs(py-antilope1lowy)<r){
   if(Math.abs(pz-antilope1lowz)<r){
     soundantilope();return 1;
 }}}
 if(Math.abs(px-antilope2lowx)<r){
  if(Math.abs(py-antilope2lowy)<r){
   if(Math.abs(pz-antilope2lowz)<r){
     soundantilope();return 1;
 }}}
 if(Math.abs(px-antilope3lowx)<r){
  if(Math.abs(py-antilope3lowy)<r){
   if(Math.abs(pz-antilope3lowz)<r){
     soundantilope();return 1;
 }}}
 return 0;
}
var tantilope1low=0,o2antilope1low=0,o1antilope1low=0,o3antilope1low=0,tmoveantilope1low=1,tframeantilope1low=0,vantilope1low=1;
var antilope1lowx=x+8,antilope1lowy=y,antilope1lowz=0,antilope1lowo1=0,antilope1lowo2=0;
var antilope1lowo10=0,antilope1lowv=2,antilope1lowco1=1,antilope1lowsi1=0;
function drawantilope1low(){
   var distmax=365,test=0;
   while(antilope1lowx<(x-distmax)){antilope1lowx+=1.99*distmax;test=1;}
   while(antilope1lowx>(x+distmax)){antilope1lowx-=1.99*distmax;test=1;}
   while(antilope1lowy<(y-distmax)){antilope1lowy+=1.99*distmax;test=1;}
   while(antilope1lowy>(y+distmax)){antilope1lowy-=1.99*distmax;test=1;}
   var co1=Math.cos(degtorad(antilope1lowo1)),si1=Math.sin(degtorad(antilope1lowo1));
   antilope1lowco1=co1;antilope1lowsi1=si1;
   var antilopex0=antilope1lowx,antilopey0=antilope1lowy,antilopez0=antilope1lowz;
   var h0=getterrainheight1(antilope1lowx,antilope1lowy);
   antilope1lowx+=antilope1lowv*co1*dtime*0.0012;
   antilope1lowy+=antilope1lowv*si1*dtime*0.0012;
   var h1=getterrainheight1(antilope1lowx,antilope1lowy);
   antilope1lowz=h1;
   if(h0<-0.3){return;}
   if(h0>0.001 && h1<-0.001){antilope1lowx=antilopex0;
	                antilope1lowy=antilopey0;
					antilope1lowz=antilopez0;  
	                antilope1lowo1+=20+Math.random()*40;
			       }
   if(Math.random()<0.0001*dtime){
        antilope1lowo10+=(Math.random()-0.5)*100;}
   var doo1=antilope1lowo10-antilope1lowo1;
   while(antilope1lowo1>180){antilope1lowo1-=360;}
   while(antilope1lowo1<-180){antilope1lowo1+=360;}
   while(doo1>180){doo1-=360;}
   while(doo1<-180){doo1+=360;}
   if(doo1>8){antilope1lowo1+=dtime*0.05;}
   if(doo1<-8){antilope1lowo1-=dtime*0.05;}   
   tmoveantilope1low=(1+vantilope1low*0.3);//-0.3*Math.cos((dx+dy)*0.1));
   antilope1lowv=1.8;
   if(tgmap==0){
     if(Math.abs(x-antilope1lowx)>(distmap2)){return;}
     if(Math.abs(y-antilope1lowy)>(distmap2)){return;}
   }
   if(rotavion(antilope1lowx-x,antilope1lowy-y,antilope1lowz-z,2)<=0){return;}
	if(x2>0){
       tmoveantilope1low=(1+vantilope1low*0.15);//-0.3*Math.cos((dx+dy)*0.1+8*degtorad(o1)))/1.1;
	   }
	antilope1lowo2=Math.atan(h1-h0)*radtodeg/2;
	tframeantilope1low+=dtime*(tmoveantilope1low*0.6+0.3);
    o2antilope1low=0.8*Math.sin(tframeantilope1low*0.0065)*tmoveantilope1low;
    o2antilope1low+=0.22*(Math.sin(tframeantilope1low*0.0016)-0.4);
    var nvertices=antilopelowVertexPositionBuffer.numItems;
	if(o2antilope1low>0){   
	 for(var i=0;i<nvertices*3;i++){
	    antilopelowVertexPositions[i]=antilopelowidleVertexPositions[i]
		    +o2antilope1low*antilopelowrun1VertexPositions[i];}
    }else{	
	 for(var i=0;i<nvertices*3;i++){
	    antilopelowVertexPositions[i]=antilopelowidleVertexPositions[i]
		    -o2antilope1low*antilopelowrun2VertexPositions[i];}
    }
	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  antilope00Texture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		
		mvPushMatrix();
		mat4.translate(mvMatrix, [antilope1lowx,antilope1lowy,antilope1lowz+0.1]);
		mat4.rotate(mvMatrix,degtorad(antilope1lowo1+90), [0, 0, 1]);
    	mat4.rotate(mvMatrix,degtorad(-antilope1lowo2-2.5+5.5*o2antilope1low), [1, 0, 0]);
    	mat4.scale(mvMatrix,[0.0135,0.0135,0.0135]);
    	//mat4.scale(mvMatrix,[0.0087,0.0087,0.0087]);

    gl.bindBuffer(gl.ARRAY_BUFFER, antilopelowVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, antilopelowVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, antilopelowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, (antilopelowVertexPositions), gl.STATIC_DRAW);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, antilopelowVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, antilopelowVertexPositionBuffer.numItems);

	mvPopMatrix();
}
var tantilope2low=0,o2antilope2low=0,o1antilope2low=0,o3antilope2low=0,tmoveantilope2low=1,tframeantilope2low=0,vantilope2low=1;
var antilope2lowx=x+8,antilope2lowy=y,antilope2lowz=0,antilope2lowo1=0,antilope2lowo2=0;
var antilope2lowo10=0,antilope2lowv=2,antilope2lowco1=1,antilope2lowsi1=0;
function drawantilope2low(){
   var dx=antilope1lowx-antilope2lowx;
   var dy=antilope1lowy-antilope2lowy;
   var dist=Math.sqrt(dx*dx+dy*dy);
   if(dist>70){antilope2lowx=antilope1lowx-50*dx/dist;
               antilope2lowy=antilope1lowy-50*dy/dist;}
   var co1=Math.cos(degtorad(antilope2lowo1)),si1=Math.sin(degtorad(antilope2lowo1));
   antilope2lowco1=co1;antilope2lowsi1=si1;
   var antilopex0=antilope2lowx,antilopey0=antilope2lowy,antilopez0=antilope2lowz;
   var h0=getterrainheight1(antilope2lowx,antilope2lowy);
   antilope2lowx+=antilope2lowv*co1*dtime*0.0012;
   antilope2lowy+=antilope2lowv*si1*dtime*0.0012;
   var h1=getterrainheight1(antilope2lowx,antilope2lowy);
   antilope2lowz=h1;
   if(h0<-0.3){return;}
   if(h0>0.001 && h1<-0.001){antilope2lowx=antilopex0;
	                antilope2lowy=antilopey0;
					antilope2lowz=antilopez0;  
	                antilope2lowo1+=20+Math.random()*40;
			       }
   if(Math.random()<0.0002*dtime){
      antilope2lowo10=diro1(dx,dy)+(Math.random()-0.5)*10;}
   var doo1=antilope2lowo10-antilope2lowo1;
   while(antilope2lowo1>180){antilope2lowo1-=360;}
   while(antilope2lowo1<-180){antilope2lowo1+=360;}
   while(doo1>180){doo1-=360;}
   while(doo1<-180){doo1+=360;}
   if(doo1>8){antilope2lowo1+=dtime*0.05;}
   if(doo1<-8){antilope2lowo1-=dtime*0.05;}   
   tmoveantilope2low=(1+vantilope2low*0.3);//-0.3*Math.cos((dx+dy)*0.1));
   if(dist>15){antilope2lowv=2.25;}
   if(dist<5){antilope2lowv=1.8;}
   if(tgmap==0){
     if(Math.abs(x-antilope2lowx)>(distmap2)){return;}
     if(Math.abs(y-antilope2lowy)>(distmap2)){return;}
   }
   if(rotavion(antilope2lowx-x,antilope2lowy-y,antilope2lowz-z,2)<=0){return;}
	if(x2>0){
       tmoveantilope2low=(1+vantilope2low*0.15);//-0.3*Math.cos((dx+dy)*0.1+8*degtorad(o1)))/1.1;
	   }
	antilope2lowo2=Math.atan(h1-h0)*radtodeg/2;
	tframeantilope2low+=dtime*(tmoveantilope2low*0.6+0.3);
    o2antilope2low=0.8*Math.sin(tframeantilope2low*0.0065)*tmoveantilope2low;
    o2antilope2low+=0.22*(Math.sin(tframeantilope2low*0.0016)-0.4);
    var nvertices=antilopelowVertexPositionBuffer.numItems;
	if(o2antilope2low>0){   
	 for(var i=0;i<nvertices*3;i++){
	    antilopelowVertexPositions[i]=antilopelowidleVertexPositions[i]
		    +o2antilope2low*antilopelowrun1VertexPositions[i];}
    }else{	
	 for(var i=0;i<nvertices*3;i++){
	    antilopelowVertexPositions[i]=antilopelowidleVertexPositions[i]
		    -o2antilope2low*antilopelowrun2VertexPositions[i];}
    }
	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  antilope00Texture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		
		mvPushMatrix();
		mat4.translate(mvMatrix, [antilope2lowx,antilope2lowy,antilope2lowz+0.1]);
		mat4.rotate(mvMatrix,degtorad(antilope2lowo1+90), [0, 0, 1]);
    	mat4.rotate(mvMatrix,degtorad(-antilope2lowo2-2.5+5.5*o2antilope2low), [1, 0, 0]);
    	mat4.scale(mvMatrix,[0.012,0.012,0.012]);
    	//mat4.scale(mvMatrix,[0.0087,0.0087,0.0087]);

    gl.bindBuffer(gl.ARRAY_BUFFER, antilopelowVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, antilopelowVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, antilopelowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, (antilopelowVertexPositions), gl.STATIC_DRAW);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, antilopelowVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    colorr=0.82;colorg=0.82;colorb=0.82;colora=1;
	setMatrixUniforms(); 
    colorr=1;colorg=1;colorb=1;colora=1;
    gl.drawArrays(gl.TRIANGLES, 0, antilopelowVertexPositionBuffer.numItems);

	mvPopMatrix();
}
var tantilope3low=0,o2antilope3low=0,o1antilope3low=0,o3antilope3low=0,tmoveantilope3low=1,tframeantilope3low=0,vantilope3low=1;
var antilope3lowx=x+8,antilope3lowy=y,antilope3lowz=0,antilope3lowo1=0,antilope3lowo2=0;
var antilope3lowo10=0,antilope3lowv=2,antilope3lowco1=1,antilope3lowsi1=0;
function drawantilope3low(){
   var dx=antilope1lowx-antilope3lowx;
   var dy=antilope1lowy-antilope3lowy;
   var dist=Math.sqrt(dx*dx+dy*dy);
   if(dist>70){antilope3lowx=antilope1lowx-50*dx/dist;
               antilope3lowy=antilope1lowy-50*dy/dist;}
   var co1=Math.cos(degtorad(antilope3lowo1)),si1=Math.sin(degtorad(antilope3lowo1));
   antilope3lowco1=co1;antilope3lowsi1=si1;
   var antilopex0=antilope3lowx,antilopey0=antilope3lowy,antilopez0=antilope3lowz;
   var h0=getterrainheight1(antilope3lowx,antilope3lowy);
   antilope3lowx+=antilope3lowv*co1*dtime*0.0012;
   antilope3lowy+=antilope3lowv*si1*dtime*0.0012;
   var h1=getterrainheight1(antilope3lowx,antilope3lowy);
   antilope3lowz=h1;
   if(h0<-0.3){return;}
   if(h0>0.001 && h1<-0.001){antilope3lowx=antilopex0;
	                antilope3lowy=antilopey0;
					antilope3lowz=antilopez0;  
	                antilope3lowo1+=20+Math.random()*40;
			       }
   if(Math.random()<0.0002*dtime){
      antilope3lowo10=diro1(dx,dy)+(Math.random()-0.5)*10;}
   var doo1=antilope3lowo10-antilope3lowo1;
   while(antilope3lowo1>180){antilope3lowo1-=360;}
   while(antilope3lowo1<-180){antilope3lowo1+=360;}
   while(doo1>180){doo1-=360;}
   while(doo1<-180){doo1+=360;}
   if(doo1>8){antilope3lowo1+=dtime*0.05;}
   if(doo1<-8){antilope3lowo1-=dtime*0.05;}   
   tmoveantilope3low=(1+vantilope3low*0.3);//-0.3*Math.cos((dx+dy)*0.1));
   if(dist>19){antilope3lowv=2.27;}
   if(dist<4){antilope3lowv=1.8;}
   if(tgmap==0){
     if(Math.abs(x-antilope3lowx)>(distmap2)){return;}
     if(Math.abs(y-antilope3lowy)>(distmap2)){return;}
   }
   if(rotavion(antilope3lowx-x,antilope3lowy-y,antilope3lowz-z,2)<=0){return;}
	if(x2>0){
       tmoveantilope3low=(1+vantilope3low*0.15);//-0.3*Math.cos((dx+dy)*0.1+8*degtorad(o1)))/1.1;
	   }
	antilope3lowo2=Math.atan(h1-h0)*radtodeg/2;
	tframeantilope3low+=dtime*(tmoveantilope3low*0.6+0.3);
    o2antilope3low=0.8*Math.sin(tframeantilope3low*0.0065)*tmoveantilope3low;
    o2antilope3low+=0.22*(Math.sin(tframeantilope3low*0.0016)-0.4);
    var nvertices=antilopelowVertexPositionBuffer.numItems;
	if(o2antilope3low>0){   
	 for(var i=0;i<nvertices*3;i++){
	    antilopelowVertexPositions[i]=antilopelowidleVertexPositions[i]
		    +o2antilope3low*antilopelowrun1VertexPositions[i];}
    }else{	
	 for(var i=0;i<nvertices*3;i++){
	    antilopelowVertexPositions[i]=antilopelowidleVertexPositions[i]
		    -o2antilope3low*antilopelowrun2VertexPositions[i];}
    }
	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  antilope00Texture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		
		mvPushMatrix();
		mat4.translate(mvMatrix, [antilope3lowx,antilope3lowy,antilope3lowz+0.1]);
		mat4.rotate(mvMatrix,degtorad(antilope3lowo1+90), [0, 0, 1]);
    	mat4.rotate(mvMatrix,degtorad(-antilope3lowo2-2.5+5.5*o2antilope3low), [1, 0, 0]);
    	mat4.scale(mvMatrix,[0.0095,0.0095,0.0095]);

    gl.bindBuffer(gl.ARRAY_BUFFER, antilopelowVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, antilopelowVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, antilopelowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, (antilopelowVertexPositions), gl.STATIC_DRAW);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, antilopelowVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    colorr=1.4;colorg=1.4;colorb=1;colora=1;
    setMatrixUniforms(); 
    colorr=1;colorg=1;colorb=1;colora=1;
    gl.drawArrays(gl.TRIANGLES, 0, antilopelowVertexPositionBuffer.numItems);

	mvPopMatrix();
}
function testzebra(px,py,pz,r0){
var r=r0;if(tcar==1){r*=0.28;}
 if(Math.abs(px-zebra1lowx)<r){
  if(Math.abs(py-zebra1lowy)<r){
   if(Math.abs(pz-zebra1lowz)<r){
     soundzebra();return 1;
 }}}
 if(Math.abs(px-zebra2lowx)<r){
  if(Math.abs(py-zebra2lowy)<r){
   if(Math.abs(pz-zebra2lowz)<r){
     soundzebra();return 1;
 }}}
 if(Math.abs(px-zebra3lowx)<r){
  if(Math.abs(py-zebra3lowy)<r){
   if(Math.abs(pz-zebra3lowz)<r){
     soundzebra();return 1;
 }}}
 return 0;
}
var tzebra1low=0,o2zebra1low=0,o1zebra1low=0,o3zebra1low=0,tmovezebra1low=1,tframezebra1low=0,vzebra1low=1;
var zebra1lowx=x+8,zebra1lowy=y,zebra1lowz=0,zebra1lowo1=0,zebra1lowo2=0;
var zebra1lowo10=0,zebra1lowv=2,zebra1lowco1=1,zebra1lowsi1=0;
function drawzebra1low(){
   var distmax=365,test=0;
   while(zebra1lowx<(x-distmax)){zebra1lowx+=1.99*distmax;test=1;}
   while(zebra1lowx>(x+distmax)){zebra1lowx-=1.99*distmax;test=1;}
   while(zebra1lowy<(y-distmax)){zebra1lowy+=1.99*distmax;test=1;}
   while(zebra1lowy>(y+distmax)){zebra1lowy-=1.99*distmax;test=1;}
   var co1=Math.cos(degtorad(zebra1lowo1)),si1=Math.sin(degtorad(zebra1lowo1));
   zebra1lowco1=co1;zebra1lowsi1=si1;
   var zebrax0=zebra1lowx,zebray0=zebra1lowy,zebraz0=zebra1lowz;
   var h0=getterrainheight1(zebra1lowx,zebra1lowy);
   zebra1lowx+=zebra1lowv*co1*dtime*0.0012;
   zebra1lowy+=zebra1lowv*si1*dtime*0.0012;
   var h1=getterrainheight1(zebra1lowx,zebra1lowy);
   zebra1lowz=h1;
   if(h0<-0.3){return;}
   if(h0>0.001 && h1<-0.001){zebra1lowx=zebrax0;
	                zebra1lowy=zebray0;
					zebra1lowz=zebraz0;  
	                zebra1lowo1+=20+Math.random()*40;
			       }
   if(Math.random()<0.0001*dtime){
        zebra1lowo10+=(Math.random()-0.5)*100;}
   var doo1=zebra1lowo10-zebra1lowo1;
   while(zebra1lowo1>180){zebra1lowo1-=360;}
   while(zebra1lowo1<-180){zebra1lowo1+=360;}
   while(doo1>180){doo1-=360;}
   while(doo1<-180){doo1+=360;}
   if(doo1>8){zebra1lowo1+=dtime*0.05;}
   if(doo1<-8){zebra1lowo1-=dtime*0.05;}   
   tmovezebra1low=(1+vzebra1low*0.3);//-0.3*Math.cos((dx+dy)*0.1));
   zebra1lowv=1.8;
   if(tgmap==0){
     if(Math.abs(x-zebra1lowx)>(distmap2)){return;}
     if(Math.abs(y-zebra1lowy)>(distmap2)){return;}
   }
   if(rotavion(zebra1lowx-x,zebra1lowy-y,zebra1lowz-z,2)<=0){return;}
	if(x2>0){
       tmovezebra1low=(1+vzebra1low*0.15);//-0.3*Math.cos((dx+dy)*0.1+8*degtorad(o1)))/1.1;
	   }
	zebra1lowo2=Math.atan(h1-h0)*radtodeg/2;
	tframezebra1low+=dtime*(tmovezebra1low*0.6+0.3);
    o2zebra1low=0.8*Math.sin(tframezebra1low*0.0065)*tmovezebra1low;
    o2zebra1low+=0.22*(Math.sin(tframezebra1low*0.0016)-0.4);
    var nvertices=horselowVertexPositionBuffer.numItems;
	if(o2zebra1low>0){   
	 for(var i=0;i<nvertices*3;i++){
	    horselowVertexPositions[i]=horselowidleVertexPositions[i]
		    +o2zebra1low*horselowrun1VertexPositions[i];}
    }else{	
	 for(var i=0;i<nvertices*3;i++){
	    horselowVertexPositions[i]=horselowidleVertexPositions[i]
		    -o2zebra1low*horselowrun2VertexPositions[i];}
    }
	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  zebra00Texture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		
		mvPushMatrix();
		mat4.translate(mvMatrix, [zebra1lowx,zebra1lowy,zebra1lowz+0.1]);
		mat4.rotate(mvMatrix,degtorad(zebra1lowo1+90), [0, 0, 1]);
    	mat4.rotate(mvMatrix,degtorad(-zebra1lowo2-2.5+5.5*o2zebra1low), [1, 0, 0]);
    	mat4.scale(mvMatrix,[0.0123,0.0123,0.0125]);
    	//mat4.scale(mvMatrix,[0.0087,0.0087,0.0087]);

    gl.bindBuffer(gl.ARRAY_BUFFER, horselowVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, horselowVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, horselowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, (horselowVertexPositions), gl.STATIC_DRAW);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, horselowVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    //colorr=0.95;colorg=0.95;colorb=0.95;colora=1;
	setMatrixUniforms(); 
    //colorr=1;colorg=1;colorb=1;colora=1;
    gl.drawArrays(gl.TRIANGLES, 0, horselowVertexPositionBuffer.numItems);

	mvPopMatrix();
}
var tzebra2low=0,o2zebra2low=0,o1zebra2low=0,o3zebra2low=0,tmovezebra2low=1,tframezebra2low=0,vzebra2low=1;
var zebra2lowx=x+8,zebra2lowy=y,zebra2lowz=0,zebra2lowo1=0,zebra2lowo2=0;
var zebra2lowo10=0,zebra2lowv=2,zebra2lowco1=1,zebra2lowsi1=0;
function drawzebra2low(){
   var dx=zebra1lowx-zebra2lowx;
   var dy=zebra1lowy-zebra2lowy;
   var dist=Math.sqrt(dx*dx+dy*dy);
   if(dist>70){zebra2lowx=zebra1lowx-50*dx/dist;
               zebra2lowy=zebra1lowy-50*dy/dist;}
   var co1=Math.cos(degtorad(zebra2lowo1)),si1=Math.sin(degtorad(zebra2lowo1));
   zebra2lowco1=co1;zebra2lowsi1=si1;
   var zebrax0=zebra2lowx,zebray0=zebra2lowy,zebraz0=zebra2lowz;
   var h0=getterrainheight1(zebra2lowx,zebra2lowy);
   zebra2lowx+=zebra2lowv*co1*dtime*0.0012;
   zebra2lowy+=zebra2lowv*si1*dtime*0.0012;
   var h1=getterrainheight1(zebra2lowx,zebra2lowy);
   zebra2lowz=h1;
   if(h0<-0.3){return;}
   if(h0>0.001 && h1<-0.001){zebra2lowx=zebrax0;
	                zebra2lowy=zebray0;
					zebra2lowz=zebraz0;  
	                zebra2lowo1+=20+Math.random()*40;
			       }
   if(Math.random()<0.0002*dtime){
      zebra2lowo10=diro1(dx,dy)+(Math.random()-0.5)*10;}
   var doo1=zebra2lowo10-zebra2lowo1;
   while(zebra2lowo1>180){zebra2lowo1-=360;}
   while(zebra2lowo1<-180){zebra2lowo1+=360;}
   while(doo1>180){doo1-=360;}
   while(doo1<-180){doo1+=360;}
   if(doo1>8){zebra2lowo1+=dtime*0.05;}
   if(doo1<-8){zebra2lowo1-=dtime*0.05;}   
   tmovezebra2low=(1+vzebra2low*0.3);//-0.3*Math.cos((dx+dy)*0.1));
   if(dist>15){zebra2lowv=2.25;}
   if(dist<5){zebra2lowv=1.8;}
   if(tgmap==0){
     if(Math.abs(x-zebra2lowx)>(distmap2)){return;}
     if(Math.abs(y-zebra2lowy)>(distmap2)){return;}
   }
   if(rotavion(zebra2lowx-x,zebra2lowy-y,zebra2lowz-z,2)<=0){return;}
	if(x2>0){
       tmovezebra2low=(1+vzebra2low*0.15);//-0.3*Math.cos((dx+dy)*0.1+8*degtorad(o1)))/1.1;
	   }
	zebra2lowo2=Math.atan(h1-h0)*radtodeg/2;
	tframezebra2low+=dtime*(tmovezebra2low*0.6+0.3);
    o2zebra2low=0.8*Math.sin(tframezebra2low*0.0065)*tmovezebra2low;
    o2zebra2low+=0.22*(Math.sin(tframezebra2low*0.0016)-0.4);
    var nvertices=horselowVertexPositionBuffer.numItems;
	if(o2zebra2low>0){   
	 for(var i=0;i<nvertices*3;i++){
	    horselowVertexPositions[i]=horselowidleVertexPositions[i]
		    +o2zebra2low*horselowrun1VertexPositions[i];}
    }else{	
	 for(var i=0;i<nvertices*3;i++){
	    horselowVertexPositions[i]=horselowidleVertexPositions[i]
		    -o2zebra2low*horselowrun2VertexPositions[i];}
    }
	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  zebra00Texture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		
		mvPushMatrix();
		mat4.translate(mvMatrix, [zebra2lowx,zebra2lowy,zebra2lowz+0.1]);
		mat4.rotate(mvMatrix,degtorad(zebra2lowo1+90), [0, 0, 1]);
    	mat4.rotate(mvMatrix,degtorad(-zebra2lowo2-2.5+5.5*o2zebra2low), [1, 0, 0]);
    	mat4.scale(mvMatrix,[0.0108,0.0108,0.011]);
    	//mat4.scale(mvMatrix,[0.0087,0.0087,0.0087]);

    gl.bindBuffer(gl.ARRAY_BUFFER, horselowVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, horselowVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, horselowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, (horselowVertexPositions), gl.STATIC_DRAW);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, horselowVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    colorr=0.9;colorg=0.9;colorb=0.9;colora=1;
	setMatrixUniforms(); 
    colorr=1;colorg=1;colorb=1;colora=1;
    gl.drawArrays(gl.TRIANGLES, 0, horselowVertexPositionBuffer.numItems);

	mvPopMatrix();
}
var tzebra3low=0,o2zebra3low=0,o1zebra3low=0,o3zebra3low=0,tmovezebra3low=1,tframezebra3low=0,vzebra3low=1;
var zebra3lowx=x+8,zebra3lowy=y,zebra3lowz=0,zebra3lowo1=0,zebra3lowo2=0;
var zebra3lowo10=0,zebra3lowv=2,zebra3lowco1=1,zebra3lowsi1=0;
function drawzebra3low(){
   var dx=zebra1lowx-zebra3lowx;
   var dy=zebra1lowy-zebra3lowy;
   var dist=Math.sqrt(dx*dx+dy*dy);
   if(dist>70){zebra3lowx=zebra1lowx-50*dx/dist;
               zebra3lowy=zebra1lowy-50*dy/dist;}
   var co1=Math.cos(degtorad(zebra3lowo1)),si1=Math.sin(degtorad(zebra3lowo1));
   zebra3lowco1=co1;zebra3lowsi1=si1;
   var zebrax0=zebra3lowx,zebray0=zebra3lowy,zebraz0=zebra3lowz;
   var h0=getterrainheight1(zebra3lowx,zebra3lowy);
   zebra3lowx+=zebra3lowv*co1*dtime*0.0012;
   zebra3lowy+=zebra3lowv*si1*dtime*0.0012;
   var h1=getterrainheight1(zebra3lowx,zebra3lowy);
   zebra3lowz=h1;
   if(h0<-0.3){return;}
   if(h0>0.001 && h1<-0.001){zebra3lowx=zebrax0;
	                zebra3lowy=zebray0;
					zebra3lowz=zebraz0;  
	                zebra3lowo1+=20+Math.random()*40;
			       }
   if(Math.random()<0.0002*dtime){
      zebra3lowo10=diro1(dx,dy)+(Math.random()-0.5)*10;}
   var doo1=zebra3lowo10-zebra3lowo1;
   while(zebra3lowo1>180){zebra3lowo1-=360;}
   while(zebra3lowo1<-180){zebra3lowo1+=360;}
   while(doo1>180){doo1-=360;}
   while(doo1<-180){doo1+=360;}
   if(doo1>8){zebra3lowo1+=dtime*0.05;}
   if(doo1<-8){zebra3lowo1-=dtime*0.05;}   
   tmovezebra3low=(1+vzebra3low*0.3);//-0.3*Math.cos((dx+dy)*0.1));
   if(dist>19){zebra3lowv=2.27;}
   if(dist<4){zebra3lowv=1.8;}
   if(tgmap==0){
     if(Math.abs(x-zebra3lowx)>(distmap2)){return;}
     if(Math.abs(y-zebra3lowy)>(distmap2)){return;}
   }
   if(rotavion(zebra3lowx-x,zebra3lowy-y,zebra3lowz-z,2)<=0){return;}
	if(x2>0){
       tmovezebra3low=(1+vzebra3low*0.15);//-0.3*Math.cos((dx+dy)*0.1+8*degtorad(o1)))/1.1;
	   }
	zebra3lowo2=Math.atan(h1-h0)*radtodeg/2;
	tframezebra3low+=dtime*(tmovezebra3low*0.6+0.3);
    o2zebra3low=0.8*Math.sin(tframezebra3low*0.0065)*tmovezebra3low;
    o2zebra3low+=0.22*(Math.sin(tframezebra3low*0.0016)-0.4);
    var nvertices=horselowVertexPositionBuffer.numItems;
	if(o2zebra3low>0){   
	 for(var i=0;i<nvertices*3;i++){
	    horselowVertexPositions[i]=horselowidleVertexPositions[i]
		    +o2zebra3low*horselowrun1VertexPositions[i];}
    }else{	
	 for(var i=0;i<nvertices*3;i++){
	    horselowVertexPositions[i]=horselowidleVertexPositions[i]
		    -o2zebra3low*horselowrun2VertexPositions[i];}
    }
	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  zebra00Texture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		
		mvPushMatrix();
		mat4.translate(mvMatrix, [zebra3lowx,zebra3lowy,zebra3lowz+0.1]);
		mat4.rotate(mvMatrix,degtorad(zebra3lowo1+90), [0, 0, 1]);
    	mat4.rotate(mvMatrix,degtorad(-zebra3lowo2-2.5+5.5*o2zebra3low), [1, 0, 0]);
    	mat4.scale(mvMatrix,[0.0084,0.0084,0.0085]);

    gl.bindBuffer(gl.ARRAY_BUFFER, horselowVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, horselowVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, horselowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, (horselowVertexPositions), gl.STATIC_DRAW);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, horselowVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    colorr=1.35;colorg=1.35;colorb=1;colora=1;
    setMatrixUniforms(); 
    colorr=1;colorg=1;colorb=1;colora=1;
    gl.drawArrays(gl.TRIANGLES, 0, horselowVertexPositionBuffer.numItems);

	mvPopMatrix();
}
function testgirafe(px,py,pz,r0){
var r=r0;if(tcar==1){r*=0.28;}
 if(Math.abs(px-girafe1lowx)<r){
  if(Math.abs(py-girafe1lowy)<r){
   if(Math.abs(pz-girafe1lowz)<r){
     soundgirafe();return 1;
 }}}
 if(Math.abs(px-girafe2lowx)<r){
  if(Math.abs(py-girafe2lowy)<r){
   if(Math.abs(pz-girafe2lowz)<r){
     soundgirafe();return 1;
 }}}
 if(Math.abs(px-girafe3lowx)<r){
  if(Math.abs(py-girafe3lowy)<r){
   if(Math.abs(pz-girafe3lowz)<r){
     soundgirafe();return 1;
 }}}
 return 0;
}
var tgirafe1low=0,o2girafe1low=0,o1girafe1low=0,o3girafe1low=0,tmovegirafe1low=1,tframegirafe1low=0,vgirafe1low=1;
var girafe1lowx=x+8,girafe1lowy=y,girafe1lowz=0,girafe1lowo1=0,girafe1lowo2=0;
var girafe1lowo10=0,girafe1lowv=2,girafe1lowco1=1,girafe1lowsi1=0;
function drawgirafe1low(){
   var distmax=365,test=0;
   while(girafe1lowx<(x-distmax)){girafe1lowx+=1.99*distmax;test=1;}
   while(girafe1lowx>(x+distmax)){girafe1lowx-=1.99*distmax;test=1;}
   while(girafe1lowy<(y-distmax)){girafe1lowy+=1.99*distmax;test=1;}
   while(girafe1lowy>(y+distmax)){girafe1lowy-=1.99*distmax;test=1;}
   var co1=Math.cos(degtorad(girafe1lowo1)),si1=Math.sin(degtorad(girafe1lowo1));
   girafe1lowco1=co1;girafe1lowsi1=si1;
   var girafex0=girafe1lowx,girafey0=girafe1lowy,girafez0=girafe1lowz;
   var h0=getterrainheight1(girafe1lowx,girafe1lowy);
   girafe1lowx+=girafe1lowv*co1*dtime*0.0012;
   girafe1lowy+=girafe1lowv*si1*dtime*0.0012;
   var h1=getterrainheight1(girafe1lowx,girafe1lowy);
   girafe1lowz=h1;
   if(h0<-0.3){return;}
   if(h0>0.001 && h1<-0.001){girafe1lowx=girafex0;
	                girafe1lowy=girafey0;
					girafe1lowz=girafez0;  
	                girafe1lowo1+=20+Math.random()*40;
			       }
   if(Math.random()<0.0001*dtime){
        girafe1lowo10+=(Math.random()-0.5)*100;}
   var doo1=girafe1lowo10-girafe1lowo1;
   while(girafe1lowo1>180){girafe1lowo1-=360;}
   while(girafe1lowo1<-180){girafe1lowo1+=360;}
   while(doo1>180){doo1-=360;}
   while(doo1<-180){doo1+=360;}
   if(doo1>8){girafe1lowo1+=dtime*0.05;}
   if(doo1<-8){girafe1lowo1-=dtime*0.05;}   
   tmovegirafe1low=(1+vgirafe1low*0.3);//-0.3*Math.cos((dx+dy)*0.1));
   girafe1lowv=1.8;
   if(tgmap==0){
     if(Math.abs(x-girafe1lowx)>(distmap2)){return;}
     if(Math.abs(y-girafe1lowy)>(distmap2)){return;}
   }
   if(rotavion(girafe1lowx-x,girafe1lowy-y,girafe1lowz-z,2)<=0){return;}
	if(x2>0){
       tmovegirafe1low=(1+vgirafe1low*0.15);//-0.3*Math.cos((dx+dy)*0.1+8*degtorad(o1)))/1.1;
	   }
	girafe1lowo2=Math.atan(h1-h0)*radtodeg/2;
	tframegirafe1low+=dtime*(tmovegirafe1low*0.6+0.3);
    o2girafe1low=0.8*Math.sin(tframegirafe1low*0.0065)*tmovegirafe1low;
    o2girafe1low+=0.22*(Math.sin(tframegirafe1low*0.0016)-0.4);
    var nvertices=girafelowVertexPositionBuffer.numItems;
	if(o2girafe1low>0){   
	 for(var i=0;i<nvertices*3;i++){
	    girafelowVertexPositions[i]=girafelowidleVertexPositions[i]
		    +o2girafe1low*girafelowrun1VertexPositions[i];}
    }else{	
	 for(var i=0;i<nvertices*3;i++){
	    girafelowVertexPositions[i]=girafelowidleVertexPositions[i]
		    -o2girafe1low*girafelowrun2VertexPositions[i];}
    }
	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  girafe00Texture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		
		mvPushMatrix();
		mat4.translate(mvMatrix, [girafe1lowx,girafe1lowy,girafe1lowz+0.1]);
		mat4.rotate(mvMatrix,degtorad(girafe1lowo1+90), [0, 0, 1]);
    	mat4.rotate(mvMatrix,degtorad(-girafe1lowo2-2.5+5.5*o2girafe1low), [1, 0, 0]);
    	mat4.scale(mvMatrix,[0.022,0.022,0.022]);
    	//mat4.scale(mvMatrix,[0.0087,0.0087,0.0087]);

    gl.bindBuffer(gl.ARRAY_BUFFER, girafelowVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, girafelowVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, girafelowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, (girafelowVertexPositions), gl.STATIC_DRAW);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, girafelowVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, girafelowVertexPositionBuffer.numItems);

	mvPopMatrix();
}
var tgirafe2low=0,o2girafe2low=0,o1girafe2low=0,o3girafe2low=0,tmovegirafe2low=1,tframegirafe2low=0,vgirafe2low=1;
var girafe2lowx=x+8,girafe2lowy=y,girafe2lowz=0,girafe2lowo1=0,girafe2lowo2=0;
var girafe2lowo10=0,girafe2lowv=2,girafe2lowco1=1,girafe2lowsi1=0;
function drawgirafe2low(){
   var dx=girafe1lowx-girafe2lowx;
   var dy=girafe1lowy-girafe2lowy;
   var dist=Math.sqrt(dx*dx+dy*dy);
   if(dist>70){girafe2lowx=girafe1lowx-50*dx/dist;
               girafe2lowy=girafe1lowy-50*dy/dist;}
   var co1=Math.cos(degtorad(girafe2lowo1)),si1=Math.sin(degtorad(girafe2lowo1));
   girafe2lowco1=co1;girafe2lowsi1=si1;
   var girafex0=girafe2lowx,girafey0=girafe2lowy,girafez0=girafe2lowz;
   var h0=getterrainheight1(girafe2lowx,girafe2lowy);
   girafe2lowx+=girafe2lowv*co1*dtime*0.0012;
   girafe2lowy+=girafe2lowv*si1*dtime*0.0012;
   var h1=getterrainheight1(girafe2lowx,girafe2lowy);
   girafe2lowz=h1;
   if(h0<-0.3){return;}
   if(h0>0.001 && h1<-0.001){girafe2lowx=girafex0;
	                girafe2lowy=girafey0;
					girafe2lowz=girafez0;  
	                girafe2lowo1+=20+Math.random()*40;
			       }
   if(Math.random()<0.0002*dtime){
      girafe2lowo10=diro1(dx,dy)+(Math.random()-0.5)*10;}
   var doo1=girafe2lowo10-girafe2lowo1;
   while(girafe2lowo1>180){girafe2lowo1-=360;}
   while(girafe2lowo1<-180){girafe2lowo1+=360;}
   while(doo1>180){doo1-=360;}
   while(doo1<-180){doo1+=360;}
   if(doo1>8){girafe2lowo1+=dtime*0.05;}
   if(doo1<-8){girafe2lowo1-=dtime*0.05;}   
   tmovegirafe2low=(1+vgirafe2low*0.3);//-0.3*Math.cos((dx+dy)*0.1));
   if(dist>15){girafe2lowv=2.25;}
   if(dist<5){girafe2lowv=1.8;}
   if(tgmap==0){
     if(Math.abs(x-girafe2lowx)>(distmap2)){return;}
     if(Math.abs(y-girafe2lowy)>(distmap2)){return;}
   }
   if(rotavion(girafe2lowx-x,girafe2lowy-y,girafe2lowz-z,2)<=0){return;}
	if(x2>0){
       tmovegirafe2low=(1+vgirafe2low*0.15);//-0.3*Math.cos((dx+dy)*0.1+8*degtorad(o1)))/1.1;
	   }
	girafe2lowo2=Math.atan(h1-h0)*radtodeg/2;
	tframegirafe2low+=dtime*(tmovegirafe2low*0.6+0.3);
    o2girafe2low=0.8*Math.sin(tframegirafe2low*0.0065)*tmovegirafe2low;
    o2girafe2low+=0.22*(Math.sin(tframegirafe2low*0.0016)-0.4);
    var nvertices=girafelowVertexPositionBuffer.numItems;
	if(o2girafe2low>0){   
	 for(var i=0;i<nvertices*3;i++){
	    girafelowVertexPositions[i]=girafelowidleVertexPositions[i]
		    +o2girafe2low*girafelowrun1VertexPositions[i];}
    }else{	
	 for(var i=0;i<nvertices*3;i++){
	    girafelowVertexPositions[i]=girafelowidleVertexPositions[i]
		    -o2girafe2low*girafelowrun2VertexPositions[i];}
    }
	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  girafe00Texture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		
		mvPushMatrix();
		mat4.translate(mvMatrix, [girafe2lowx,girafe2lowy,girafe2lowz+0.1]);
		mat4.rotate(mvMatrix,degtorad(girafe2lowo1+90), [0, 0, 1]);
    	mat4.rotate(mvMatrix,degtorad(-girafe2lowo2-2.5+5.5*o2girafe2low), [1, 0, 0]);
    	mat4.scale(mvMatrix,[0.020,0.020,0.020]);
    	//mat4.scale(mvMatrix,[0.0087,0.0087,0.0087]);

    gl.bindBuffer(gl.ARRAY_BUFFER, girafelowVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, girafelowVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, girafelowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, (girafelowVertexPositions), gl.STATIC_DRAW);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, girafelowVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    colorr=0.82;colorg=0.82;colorb=0.82;colora=1;
	setMatrixUniforms(); 
    colorr=1;colorg=1;colorb=1;colora=1;
    gl.drawArrays(gl.TRIANGLES, 0, girafelowVertexPositionBuffer.numItems);

	mvPopMatrix();
}
var tgirafe3low=0,o2girafe3low=0,o1girafe3low=0,o3girafe3low=0,tmovegirafe3low=1,tframegirafe3low=0,vgirafe3low=1;
var girafe3lowx=x+8,girafe3lowy=y,girafe3lowz=0,girafe3lowo1=0,girafe3lowo2=0;
var girafe3lowo10=0,girafe3lowv=2,girafe3lowco1=1,girafe3lowsi1=0;
function drawgirafe3low(){
   var dx=girafe1lowx-girafe3lowx;
   var dy=girafe1lowy-girafe3lowy;
   var dist=Math.sqrt(dx*dx+dy*dy);
   if(dist>70){girafe3lowx=girafe1lowx-50*dx/dist;
               girafe3lowy=girafe1lowy-50*dy/dist;}
   var co1=Math.cos(degtorad(girafe3lowo1)),si1=Math.sin(degtorad(girafe3lowo1));
   girafe3lowco1=co1;girafe3lowsi1=si1;
   var girafex0=girafe3lowx,girafey0=girafe3lowy,girafez0=girafe3lowz;
   var h0=getterrainheight1(girafe3lowx,girafe3lowy);
   girafe3lowx+=girafe3lowv*co1*dtime*0.0012;
   girafe3lowy+=girafe3lowv*si1*dtime*0.0012;
   var h1=getterrainheight1(girafe3lowx,girafe3lowy);
   girafe3lowz=h1;
   if(h0<-0.3){return;}
   if(h0>0.001 && h1<-0.001){girafe3lowx=girafex0;
	                girafe3lowy=girafey0;
					girafe3lowz=girafez0;  
	                girafe3lowo1+=20+Math.random()*40;
			       }
   if(Math.random()<0.0002*dtime){
      girafe3lowo10=diro1(dx,dy)+(Math.random()-0.5)*10;}
   var doo1=girafe3lowo10-girafe3lowo1;
   while(girafe3lowo1>180){girafe3lowo1-=360;}
   while(girafe3lowo1<-180){girafe3lowo1+=360;}
   while(doo1>180){doo1-=360;}
   while(doo1<-180){doo1+=360;}
   if(doo1>8){girafe3lowo1+=dtime*0.05;}
   if(doo1<-8){girafe3lowo1-=dtime*0.05;}   
   tmovegirafe3low=(1+vgirafe3low*0.3);//-0.3*Math.cos((dx+dy)*0.1));
   if(dist>19){girafe3lowv=2.27;}
   if(dist<4){girafe3lowv=1.8;}
   if(tgmap==0){
     if(Math.abs(x-girafe3lowx)>(distmap2)){return;}
     if(Math.abs(y-girafe3lowy)>(distmap2)){return;}
   }
   if(rotavion(girafe3lowx-x,girafe3lowy-y,girafe3lowz-z,2)<=0){return;}
	if(x2>0){
       tmovegirafe3low=(1+vgirafe3low*0.15);//-0.3*Math.cos((dx+dy)*0.1+8*degtorad(o1)))/1.1;
	   }
	girafe3lowo2=Math.atan(h1-h0)*radtodeg/2;
	tframegirafe3low+=dtime*(tmovegirafe3low*0.6+0.3);
    o2girafe3low=0.8*Math.sin(tframegirafe3low*0.0065)*tmovegirafe3low;
    o2girafe3low+=0.22*(Math.sin(tframegirafe3low*0.0016)-0.4);
    var nvertices=girafelowVertexPositionBuffer.numItems;
	if(o2girafe3low>0){   
	 for(var i=0;i<nvertices*3;i++){
	    girafelowVertexPositions[i]=girafelowidleVertexPositions[i]
		    +o2girafe3low*girafelowrun1VertexPositions[i];}
    }else{	
	 for(var i=0;i<nvertices*3;i++){
	    girafelowVertexPositions[i]=girafelowidleVertexPositions[i]
		    -o2girafe3low*girafelowrun2VertexPositions[i];}
    }
	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  girafe00Texture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		
		mvPushMatrix();
		mat4.translate(mvMatrix, [girafe3lowx,girafe3lowy,girafe3lowz+0.1]);
		mat4.rotate(mvMatrix,degtorad(girafe3lowo1+90), [0, 0, 1]);
    	mat4.rotate(mvMatrix,degtorad(-girafe3lowo2-2.5+5.5*o2girafe3low), [1, 0, 0]);
    	mat4.scale(mvMatrix,[0.0155,0.0155,0.0155]);

    gl.bindBuffer(gl.ARRAY_BUFFER, girafelowVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, girafelowVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, girafelowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, (girafelowVertexPositions), gl.STATIC_DRAW);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, girafelowVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    colorr=1.4;colorg=1.4;colorb=1;colora=1;
    setMatrixUniforms(); 
    colorr=1;colorg=1;colorb=1;colora=1;
    gl.drawArrays(gl.TRIANGLES, 0, girafelowVertexPositionBuffer.numItems);

	mvPopMatrix();
}
function testelephant(px,py,pz,r0){
var r=r0;if(tcar==1){r*=0.28;}
 if(Math.abs(px-elephant1lowx)<r){
  if(Math.abs(py-elephant1lowy)<r){
   if(Math.abs(pz-elephant1lowz)<r){
     soundelephant();return 1;
 }}}
 if(Math.abs(px-elephant2lowx)<r){
  if(Math.abs(py-elephant2lowy)<r){
   if(Math.abs(pz-elephant2lowz)<r){
     soundelephant();return 1;
 }}}
 if(Math.abs(px-elephant3lowx)<r){
  if(Math.abs(py-elephant3lowy)<r){
   if(Math.abs(pz-elephant3lowz)<r){
     soundelephant();return 1;
 }}}
 return 0;
}
var telephant1low=0,o2elephant1low=0,o1elephant1low=0,o3elephant1low=0,tmoveelephant1low=1,tframeelephant1low=0,velephant1low=1;
var elephant1lowx=x+8,elephant1lowy=y,elephant1lowz=0,elephant1lowo1=0,elephant1lowo2=0;
var elephant1lowo10=0,elephant1lowv=1,elephant1lowco1=1,elephant1lowsi1=0;
function drawelephant1low(){
   var distmax=365,test=0;
   while(elephant1lowx<(x-distmax)){elephant1lowx+=1.99*distmax;test=1;}
   while(elephant1lowx>(x+distmax)){elephant1lowx-=1.99*distmax;test=1;}
   while(elephant1lowy<(y-distmax)){elephant1lowy+=1.99*distmax;test=1;}
   while(elephant1lowy>(y+distmax)){elephant1lowy-=1.99*distmax;test=1;}
   var co1=Math.cos(degtorad(elephant1lowo1)),si1=Math.sin(degtorad(elephant1lowo1));
   elephant1lowco1=co1;elephant1lowsi1=si1;
   var elephantx0=elephant1lowx,elephanty0=elephant1lowy,elephantz0=elephant1lowz;
   var h0=getterrainheight1(elephant1lowx,elephant1lowy);
   elephant1lowx+=elephant1lowv*co1*dtime*0.0012;
   elephant1lowy+=elephant1lowv*si1*dtime*0.0012;
   var h1=getterrainheight1(elephant1lowx,elephant1lowy);
   elephant1lowz=h1;
   if(h0<-0.3){return;}
   if(h0>0.001 && h1<-0.001){elephant1lowx=elephantx0;
	                elephant1lowy=elephanty0;
					elephant1lowz=elephantz0;  
	                elephant1lowo1+=20+Math.random()*40;
			       }
   if(Math.random()<0.0001*dtime){
        elephant1lowo10+=(Math.random()-0.5)*100;}
   var doo1=elephant1lowo10-elephant1lowo1;
   while(elephant1lowo1>180){elephant1lowo1-=360;}
   while(elephant1lowo1<-180){elephant1lowo1+=360;}
   while(doo1>180){doo1-=360;}
   while(doo1<-180){doo1+=360;}
   if(doo1>8){elephant1lowo1+=dtime*0.05;}
   if(doo1<-8){elephant1lowo1-=dtime*0.05;}   
   tmoveelephant1low=(1+velephant1low*0.3);//-0.3*Math.cos((dx+dy)*0.1));
   elephant1lowv=0.9;
   if(tgmap==0){
     if(Math.abs(x-elephant1lowx)>(distmap2)){return;}
     if(Math.abs(y-elephant1lowy)>(distmap2)){return;}
   }
   if(rotavion(elephant1lowx-x,elephant1lowy-y,elephant1lowz-z,2)<=0){return;}
	if(x2>0){
       tmoveelephant1low=(1+velephant1low*0.15);//-0.3*Math.cos((dx+dy)*0.1+8*degtorad(o1)))/1.1;
	   }
	elephant1lowo2=Math.atan(h1-h0)*radtodeg/2;
	tframeelephant1low+=0.5*dtime*(tmoveelephant1low*0.6+0.3);
    o2elephant1low=0.8*Math.sin(tframeelephant1low*0.0065)*tmoveelephant1low;
    o2elephant1low+=0.22*(Math.sin(tframeelephant1low*0.0016)-0.4);
    var nvertices=elephantlowVertexPositionBuffer.numItems;
	if(o2elephant1low>0){   
	 for(var i=0;i<nvertices*3;i++){
	    elephantlowVertexPositions[i]=elephantlowidleVertexPositions[i]
		    +o2elephant1low*elephantlowrun1VertexPositions[i];}
    }else{	
	 for(var i=0;i<nvertices*3;i++){
	    elephantlowVertexPositions[i]=elephantlowidleVertexPositions[i]
		    -o2elephant1low*elephantlowrun2VertexPositions[i];}
    }
	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  elephant00Texture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		
		mvPushMatrix();
		mat4.translate(mvMatrix, [elephant1lowx,elephant1lowy,elephant1lowz+0.1]);
		mat4.rotate(mvMatrix,degtorad(elephant1lowo1+90), [0, 0, 1]);
    	mat4.rotate(mvMatrix,degtorad(-elephant1lowo2-2.5+5.5*o2elephant1low), [1, 0, 0]);
    	mat4.scale(mvMatrix,[0.018,0.018,0.018]);
    	//mat4.scale(mvMatrix,[0.0087,0.0087,0.0087]);

    gl.bindBuffer(gl.ARRAY_BUFFER, elephantlowVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, elephantlowVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, elephantlowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, (elephantlowVertexPositions), gl.STATIC_DRAW);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, elephantlowVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, elephantlowVertexPositionBuffer.numItems);

	mvPopMatrix();
}
var telephant2low=0,o2elephant2low=0,o1elephant2low=0,o3elephant2low=0,tmoveelephant2low=1,tframeelephant2low=0,velephant2low=1;
var elephant2lowx=x+8,elephant2lowy=y,elephant2lowz=0,elephant2lowo1=0,elephant2lowo2=0;
var elephant2lowo10=0,elephant2lowv=1,elephant2lowco1=1,elephant2lowsi1=0;
function drawelephant2low(){
   var dx=elephant1lowx-elephant2lowx;
   var dy=elephant1lowy-elephant2lowy;
   var dist=Math.sqrt(dx*dx+dy*dy);
   if(dist>70){elephant2lowx=elephant1lowx-50*dx/dist;
               elephant2lowy=elephant1lowy-50*dy/dist;}
   var co1=Math.cos(degtorad(elephant2lowo1)),si1=Math.sin(degtorad(elephant2lowo1));
   elephant2lowco1=co1;elephant2lowsi1=si1;
   var elephantx0=elephant2lowx,elephanty0=elephant2lowy,elephantz0=elephant2lowz;
   var h0=getterrainheight1(elephant2lowx,elephant2lowy);
   elephant2lowx+=elephant2lowv*co1*dtime*0.0012;
   elephant2lowy+=elephant2lowv*si1*dtime*0.0012;
   var h1=getterrainheight1(elephant2lowx,elephant2lowy);
   elephant2lowz=h1;
   if(h0<-0.3){return;}
   if(h0>0.001 && h1<-0.001){elephant2lowx=elephantx0;
	                elephant2lowy=elephanty0;
					elephant2lowz=elephantz0;  
	                elephant2lowo1+=20+Math.random()*40;
			       }
   if(Math.random()<0.0002*dtime){
      elephant2lowo10=diro1(dx,dy)+(Math.random()-0.5)*10;}
   var doo1=elephant2lowo10-elephant2lowo1;
   while(elephant2lowo1>180){elephant2lowo1-=360;}
   while(elephant2lowo1<-180){elephant2lowo1+=360;}
   while(doo1>180){doo1-=360;}
   while(doo1<-180){doo1+=360;}
   if(doo1>8){elephant2lowo1+=dtime*0.05;}
   if(doo1<-8){elephant2lowo1-=dtime*0.05;}   
   tmoveelephant2low=(1+velephant2low*0.3);//-0.3*Math.cos((dx+dy)*0.1));
   if(dist>15){elephant2lowv=1.125;}
   if(dist<5){elephant2lowv=0.9;}
   if(tgmap==0){
     if(Math.abs(x-elephant2lowx)>(distmap2)){return;}
     if(Math.abs(y-elephant2lowy)>(distmap2)){return;}
   }
   if(rotavion(elephant2lowx-x,elephant2lowy-y,elephant2lowz-z,2)<=0){return;}
	if(x2>0){
       tmoveelephant2low=(1+velephant2low*0.15);//-0.3*Math.cos((dx+dy)*0.1+8*degtorad(o1)))/1.1;
	   }
	elephant2lowo2=Math.atan(h1-h0)*radtodeg/2;
	tframeelephant2low+=0.5*dtime*(tmoveelephant2low*0.6+0.3);
    o2elephant2low=0.8*Math.sin(tframeelephant2low*0.0065)*tmoveelephant2low;
    o2elephant2low+=0.22*(Math.sin(tframeelephant2low*0.0016)-0.4);
    var nvertices=elephantlowVertexPositionBuffer.numItems;
	if(o2elephant2low>0){   
	 for(var i=0;i<nvertices*3;i++){
	    elephantlowVertexPositions[i]=elephantlowidleVertexPositions[i]
		    +o2elephant2low*elephantlowrun1VertexPositions[i];}
    }else{	
	 for(var i=0;i<nvertices*3;i++){
	    elephantlowVertexPositions[i]=elephantlowidleVertexPositions[i]
		    -o2elephant2low*elephantlowrun2VertexPositions[i];}
    }
	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  elephant00Texture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		
		mvPushMatrix();
		mat4.translate(mvMatrix, [elephant2lowx,elephant2lowy,elephant2lowz+0.1]);
		mat4.rotate(mvMatrix,degtorad(elephant2lowo1+90), [0, 0, 1]);
    	mat4.rotate(mvMatrix,degtorad(-elephant2lowo2-2.5+5.5*o2elephant2low), [1, 0, 0]);
    	mat4.scale(mvMatrix,[0.016,0.016,0.016]);
    	//mat4.scale(mvMatrix,[0.0087,0.0087,0.0087]);

    gl.bindBuffer(gl.ARRAY_BUFFER, elephantlowVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, elephantlowVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, elephantlowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, (elephantlowVertexPositions), gl.STATIC_DRAW);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, elephantlowVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    colorr=0.82;colorg=0.82;colorb=0.82;colora=1;
	setMatrixUniforms(); 
    colorr=1;colorg=1;colorb=1;colora=1;
    gl.drawArrays(gl.TRIANGLES, 0, elephantlowVertexPositionBuffer.numItems);

	mvPopMatrix();
}
var telephant3low=0,o2elephant3low=0,o1elephant3low=0,o3elephant3low=0,tmoveelephant3low=1,tframeelephant3low=0,velephant3low=1;
var elephant3lowx=x+8,elephant3lowy=y,elephant3lowz=0,elephant3lowo1=0,elephant3lowo2=0;
var elephant3lowo10=0,elephant3lowv=1,elephant3lowco1=1,elephant3lowsi1=0;
function drawelephant3low(){
   var dx=elephant1lowx-elephant3lowx;
   var dy=elephant1lowy-elephant3lowy;
   var dist=Math.sqrt(dx*dx+dy*dy);
   if(dist>70){elephant3lowx=elephant1lowx-50*dx/dist;
               elephant3lowy=elephant1lowy-50*dy/dist;}
   var co1=Math.cos(degtorad(elephant3lowo1)),si1=Math.sin(degtorad(elephant3lowo1));
   elephant3lowco1=co1;elephant3lowsi1=si1;
   var elephantx0=elephant3lowx,elephanty0=elephant3lowy,elephantz0=elephant3lowz;
   var h0=getterrainheight1(elephant3lowx,elephant3lowy);
   elephant3lowx+=elephant3lowv*co1*dtime*0.0012;
   elephant3lowy+=elephant3lowv*si1*dtime*0.0012;
   var h1=getterrainheight1(elephant3lowx,elephant3lowy);
   elephant3lowz=h1;
   if(h0<-0.3){return;}
   if(h0>0.001 && h1<-0.001){elephant3lowx=elephantx0;
	                elephant3lowy=elephanty0;
					elephant3lowz=elephantz0;  
	                elephant3lowo1+=20+Math.random()*40;
			       }
   if(Math.random()<0.0002*dtime){
      elephant3lowo10=diro1(dx,dy)+(Math.random()-0.5)*10;}
   var doo1=elephant3lowo10-elephant3lowo1;
   while(elephant3lowo1>180){elephant3lowo1-=360;}
   while(elephant3lowo1<-180){elephant3lowo1+=360;}
   while(doo1>180){doo1-=360;}
   while(doo1<-180){doo1+=360;}
   if(doo1>8){elephant3lowo1+=dtime*0.05;}
   if(doo1<-8){elephant3lowo1-=dtime*0.05;}   
   tmoveelephant3low=(1+velephant3low*0.3);//-0.3*Math.cos((dx+dy)*0.1));
   if(dist>19){elephant3lowv=1.14;}
   if(dist<4){elephant3lowv=0.9;}
   if(tgmap==0){
     if(Math.abs(x-elephant3lowx)>(distmap2)){return;}
     if(Math.abs(y-elephant3lowy)>(distmap2)){return;}
   }
   if(rotavion(elephant3lowx-x,elephant3lowy-y,elephant3lowz-z,2)<=0){return;}
	if(x2>0){
       tmoveelephant3low=(1+velephant3low*0.15);//-0.3*Math.cos((dx+dy)*0.1+8*degtorad(o1)))/1.1;
	   }
	elephant3lowo2=Math.atan(h1-h0)*radtodeg/2;
	tframeelephant3low+=0.5*dtime*(tmoveelephant3low*0.6+0.3);
    o2elephant3low=0.8*Math.sin(tframeelephant3low*0.0065)*tmoveelephant3low;
    o2elephant3low+=0.22*(Math.sin(tframeelephant3low*0.0016)-0.4);
    var nvertices=elephantlowVertexPositionBuffer.numItems;
	if(o2elephant3low>0){   
	 for(var i=0;i<nvertices*3;i++){
	    elephantlowVertexPositions[i]=elephantlowidleVertexPositions[i]
		    +o2elephant3low*elephantlowrun1VertexPositions[i];}
    }else{	
	 for(var i=0;i<nvertices*3;i++){
	    elephantlowVertexPositions[i]=elephantlowidleVertexPositions[i]
		    -o2elephant3low*elephantlowrun2VertexPositions[i];}
    }
	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  elephant00Texture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		
		mvPushMatrix();
		mat4.translate(mvMatrix, [elephant3lowx,elephant3lowy,elephant3lowz+0.1]);
		mat4.rotate(mvMatrix,degtorad(elephant3lowo1+90), [0, 0, 1]);
    	mat4.rotate(mvMatrix,degtorad(-elephant3lowo2-2.5+5.5*o2elephant3low), [1, 0, 0]);
    	mat4.scale(mvMatrix,[0.013,0.013,0.013]);

    gl.bindBuffer(gl.ARRAY_BUFFER, elephantlowVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, elephantlowVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, elephantlowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, (elephantlowVertexPositions), gl.STATIC_DRAW);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, elephantlowVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    colorr=1.4;colorg=1.4;colorb=1;colora=1;
    setMatrixUniforms(); 
    colorr=1;colorg=1;colorb=1;colora=1;
    gl.drawArrays(gl.TRIANGLES, 0, elephantlowVertexPositionBuffer.numItems);

	mvPopMatrix();
}
var tbird=0,o2bird=0,o1bird=0,o3bird=0,tmovebird=1,tframebird=0,vbird=0;
var birdx=x+8,birdy=y,birdz=0,birdo1=0,birdo2=0;
var birdo10=0,birdv=1,birdco1=1,birdsi1=0;
function drawbird(){
   var distmax=100,test=0;
   while(birdx<(x-distmax)){birdx+=1.99*distmax;test=1;}
   while(birdx>(x+distmax)){birdx-=1.99*distmax;test=1;}
   while(birdy<(y-distmax)){birdy+=1.99*distmax;test=1;}
   while(birdy>(y+distmax)){birdy-=1.99*distmax;test=1;}
   if(test==1){//birdo10=diro1(x+40*cos1-birdx,y+40*sin1-birdy);
               //birdo1=birdo10;}
               birdo1=o1+180+(Math.random()-0.5)*34;
               birdx=x-0.95*(distmax)*Math.cos(degtorad(birdo1));
			   birdy=y-0.95*(distmax)*Math.sin(degtorad(birdo1));
			  }
   var co1=Math.cos(degtorad(birdo1)),si1=Math.sin(degtorad(birdo1));
   birdco1=co1;birdsi1=si1;
   //birdx=x+3*cos1;birdy=y+3*sin1;
   birdx+=birdv*co1*dtime*0.0019;
   birdy+=birdv*si1*dtime*0.0019;
   if(Math.random()<0.0002*dtime){birdo10=diro1(x+40*cos1-birdx,y+40*sin1-birdy)+(Math.random()-0.5)*40;}
   var doo1=birdo10-birdo1;
   while(birdo1>180){birdo1-=360;}
   while(birdo1<-180){birdo1+=360;}
   while(doo1>180){doo1-=360;}
   while(doo1<-180){doo1+=360;}
   if(doo1>8){birdo1+=dtime*0.05;}
   if(doo1<-8){birdo1-=dtime*0.05;}   
   tmovebird=1;birdv=1;
   //if(Math.abs(birdx-x)>(distmap2)){return;}
   //if(Math.abs(birdy-y)>(distmap2)){return;}
   if(rotavion(birdx-x,birdy-y,birdz-z,1)<=0){return;}
	if(x2>0){
       tmovebird=(1-0.3*Math.cos((birdx+birdy)*0.1+8*degtorad(o1)))/1.1;
       birdv=tmovebird*1.2;}
	var h0=getterrainheight(birdx,birdy);
	var h1=getterrainheight(birdx+co1,birdy+si1);
	birdo2=Math.atan(h1-h0)*radtodeg/2;
	birdz=Math.max(h0+5,birdz+((z+z+h0+30)/3-birdz)*0.0001*dtime);
    tframebird+=dtime*(tmovebird*0.6+0.3);
    o2bird=0.8*(Math.sin(tframebird*0.0065)+0.6)*tmovebird;
    o2bird+=0.22*(Math.sin(tframebird*0.0016)+0.6);
    var nvertices=birdVertexPositionBuffer.numItems;
    for(var i=0;i<nvertices*3;i++){
	    birdVertexPositions[i]=birdidleVertexPositions[i]
		    +o2bird*birdattackVertexPositions[i];}
	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  birdTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		
		mvPushMatrix();
		mat4.translate(mvMatrix, [birdx,birdy,birdz]);
		mat4.rotate(mvMatrix,degtorad(birdo1+90), [0, 0, 1]);
    	mat4.rotate(mvMatrix,degtorad(-birdo2), [1, 0, 0]);
    	mat4.scale(mvMatrix,[0.0048,0.0048,0.0048]);

    gl.bindBuffer(gl.ARRAY_BUFFER, birdVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, birdVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, birdVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, (birdVertexPositions), gl.STATIC_DRAW);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, birdVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    colorr=0.9;colorg=0.9;colorb=0.9;colora=1;
	setMatrixUniforms(); 
	colorr=1;colorg=1;colorb=1;colora=1;
    gl.drawArrays(gl.TRIANGLES, 0, birdVertexPositionBuffer.numItems);
		mvPopMatrix();
}
var tbird2=0,o2bird2=0,o1bird2=0,o3bird2=0,tmovebird2=1,tframebird2=0,vbird2=0;
var bird2x=x+8,bird2y=y,bird2z=0,bird2o1=0,bird2o2=0;
var bird2o10=0,bird2v=1.2,bird2co1=1,bird2si1=0;
function drawbird2(){
   //bird2x=horsex;bird2y=horsey;bird2z=horsez;
   //bird2o1=horseo1;   
   var dx=birdx-bird2x;
   var dy=birdy-bird2y;
   var dist=Math.sqrt(dx*dx+dy*dy);
   if(dist>30){bird2x=birdx-20*dx/dist;
               bird2y=birdy-20*dy/dist;}
   bird2v=1.2;if(dist<3){bird2v=1;}
   var co1=Math.cos(degtorad(bird2o1)),si1=Math.sin(degtorad(bird2o1));
   bird2co1=co1;bird2si1=si1;
   //bird2x=x+3*cos1;bird2y=y+3*sin1;
   bird2x+=bird2v*co1*dtime*0.0019;
   bird2y+=bird2v*si1*dtime*0.0019;
   if(Math.random()<0.0008*dtime){bird2o10=diro1(birdx-bird2x,birdy-bird2y);}
   var doo1=bird2o10-bird2o1;
   while(bird2o1>180){bird2o1-=360;}
   while(bird2o1<-180){bird2o1+=360;}
   while(doo1>180){doo1-=360;}
   while(doo1<-180){doo1+=360;}
   if(doo1>8){bird2o1+=dtime*0.05;}
   if(doo1<-8){bird2o1-=dtime*0.05;}   
   tmovebird2=1;bird2v=1.2;
   //if(Math.abs(bird2x-x)>(distmap2)){return;}
   //if(Math.abs(bird2y-y)>(distmap2)){return;}
   if(rotavion(bird2x-x,bird2y-y,bird2z-z,1)<=0){return;}
	if(x2>0){
       tmovebird2=(1-0.3*Math.cos((bird2x+bird2y)*0.1+8*degtorad(o1)))/1.1;
       bird2v=tmovebird2*1.4;}
	var h0=getterrainheight(bird2x,bird2y);
	var h1=getterrainheight(bird2x+co1,bird2y+si1);
	bird2o2=Math.atan(h1-h0)*radtodeg/2;
	bird2z=Math.max(h0+5,bird2z+((z+z+h0+32)/3-bird2z)*0.0001*dtime);
    tframebird2+=dtime*(tmovebird2*0.6+0.3);
    o2bird2=0.8*(Math.sin(tframebird2*0.0065)+0.6)*tmovebird2;
    o2bird2+=0.22*(Math.sin(tframebird2*0.0016)+0.6);
    var nvertices=birdVertexPositionBuffer.numItems;
    for(var i=0;i<nvertices*3;i++){
	    birdVertexPositions[i]=birdidleVertexPositions[i]
		    +o2bird2*birdattackVertexPositions[i];}
	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  birdTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		
		mvPushMatrix();
		mat4.translate(mvMatrix, [bird2x,bird2y,bird2z]);
		mat4.rotate(mvMatrix,degtorad(bird2o1+90), [0, 0, 1]);
    	mat4.rotate(mvMatrix,degtorad(-bird2o2), [1, 0, 0]);
    	mat4.scale(mvMatrix,[0.0048,0.0048,0.0048]);

    gl.bindBuffer(gl.ARRAY_BUFFER, birdVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, birdVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, birdVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, (birdVertexPositions), gl.STATIC_DRAW);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, birdVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    colorr=0.85;colorg=0.85;colorb=0.85;colora=1;
	setMatrixUniforms(); 
	colorr=1;colorg=1;colorb=1;colora=1;
    gl.drawArrays(gl.TRIANGLES, 0, birdVertexPositionBuffer.numItems);
		mvPopMatrix();
}
var tbird3=0,o2bird3=0,o1bird3=0,o3bird3=0,tmovebird3=1,tframebird3=0,vbird3=0;
var bird3x=x+8,bird3y=y,bird3z=0,bird3o1=0,bird3o2=0;
var bird3o10=0,bird3v=1.15,bird3co1=1,bird3si1=0;
function drawbird3(){
   var dx=birdx-bird3x;
   var dy=birdy-bird3y;
   var dist=Math.sqrt(dx*dx+dy*dy);
   if(dist>30){bird3x=birdx-20*dx/dist;
               bird3y=birdy-20*dy/dist;}
   bird3v=1.2;if(dist<4){bird3v=1;}
   var co1=Math.cos(degtorad(bird3o1)),si1=Math.sin(degtorad(bird3o1));
   bird3co1=co1;bird3si1=si1;
   //bird3x=x+3*cos1;bird3y=y+3*sin1;
   bird3x+=bird3v*co1*dtime*0.0019;
   bird3y+=bird3v*si1*dtime*0.0019;
   if(Math.random()<0.0008*dtime){bird3o10=diro1(birdx-bird3x,birdy-bird3y);}
   var doo1=bird3o10-bird3o1;
   while(bird3o1>180){bird3o1-=360;}
   while(bird3o1<-180){bird3o1+=360;}
   while(doo1>180){doo1-=360;}
   while(doo1<-180){doo1+=360;}
   if(doo1>8){bird3o1+=dtime*0.05;}
   if(doo1<-8){bird3o1-=dtime*0.05;}   
   tmovebird3=1;bird3v=1.2;
   //if(Math.abs(bird3x-x)>(distmap2)){return;}
   //if(Math.abs(bird3y-y)>(distmap2)){return;}
   if(rotavion(bird3x-x,bird3y-y,bird3z-z,1)<=0){return;}
	if(x2>0){
       tmovebird3=(1-0.3*Math.cos((bird3x+bird3y)*0.1+8*degtorad(o1)))/1.1;
       bird3v=tmovebird3*1.4;}
	var h0=getterrainheight(bird3x,bird3y);
	var h1=getterrainheight(bird3x+co1,bird3y+si1);
	bird3o2=Math.atan(h1-h0)*radtodeg/2;
	bird3z=Math.max(h0+5,bird3z+((z+z+h0+28)/3-bird3z)*0.0001*dtime);
    tframebird3+=dtime*(tmovebird3*0.6+0.3);
    o2bird3=0.8*(Math.sin(tframebird3*0.0065)+0.6)*tmovebird3;
    o2bird3+=0.22*(Math.sin(tframebird3*0.0016)+0.6);
    var nvertices=birdVertexPositionBuffer.numItems;
    for(var i=0;i<nvertices*3;i++){
	    birdVertexPositions[i]=birdidleVertexPositions[i]
		    +o2bird3*birdattackVertexPositions[i];}
	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  birdTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		
		mvPushMatrix();
		mat4.translate(mvMatrix, [bird3x,bird3y,bird3z]);
		mat4.rotate(mvMatrix,degtorad(bird3o1+90), [0, 0, 1]);
    	mat4.rotate(mvMatrix,degtorad(-bird3o2), [1, 0, 0]);
    	mat4.scale(mvMatrix,[0.0048,0.0048,0.0048]);

    gl.bindBuffer(gl.ARRAY_BUFFER, birdVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, birdVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, birdVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, (birdVertexPositions), gl.STATIC_DRAW);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, birdVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    colorr=0.95;colorg=0.95;colorb=0.95;colora=1;
	setMatrixUniforms(); 
	colorr=1;colorg=1;colorb=1;colora=1; 
    gl.drawArrays(gl.TRIANGLES, 0, birdVertexPositionBuffer.numItems);
		mvPopMatrix();
}
var tdrawmap=0,twaitkey=0;//,waitkey=0;
function submap(){
tdrawmap+=1;
if(tdrawmap>2+tspace){tdrawmap=0;waitkey=0;return;}
drawmap();//if(tdrawmap>=0){tdrawmap=0;
  //alert(srtmfiles[0]+" "+srtmfiles[1]+" "+srtmfiles[2]+" "+srtmfiles[3]);
  //}
waitkey=vk_m;
}
function subwaitkey(){
if(tframe<(twaitkey+250)){return;}
twaitkey=tframe;
if(keys[waitkey]){tdrawmap+=1;//if(tgmap==0){tdrawmap=4;};
                  if(tdrawmap>2+tspace){tdrawmap=0;waitkey=0;resetkeys();}else{drawmap();};
				  }
if(keys[vk_space]){resetkeys();waitkey=0;tdrawmap=0;}
if(keys[vk_return]){resetkeys();waitkey=0;tdrawmap=0;}
if(keys[vk_escape]){resetkeys();waitkey=0;tdrawmap=0;}
//document.getElementById('intext').focus();
}
function printmsg(msg){
  document.getElementById('intext0').value=msg;}
function drawmap(){
clearinfomsg();
if(tspace==1){drawstarmap();return;}
printmsg("lat="+lat+"   lng="+lng+"  "+srtmfile);
if(tgmap==1 && tdrawmap==0){drawgmap();return;}
if(tgmap==1 && tdrawmap==2){drawgmap();return;}
if(tgmap==1 && tdrawmap==3){drawgmap();return;}
gl.viewport(0, 0, windx,windy);
gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
//mat4.perspective(47, gl.viewportWidth / gl.viewportHeight, 1, 10000.0, pMatrix);
mat4.perspective(47, (cssscale/cssscaley)*gl.viewportWidth / gl.viewportHeight, 1, 10000.0, pMatrix);
gl.useProgram(shaderProgram);
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  waterTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
	gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, boussVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);
    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    mvPushMatrix();
	for(var i=0;i<n;i+=4){
	  for(var j=0;j<n;j+=4){	
    	mat4.identity(mvMatrix);
		var ix=(i-n/2),iy=(j-n/2);
		mat4.translate(mvMatrix, [ix*1.2,iy,-350]);
 		mat4.scale(mvMatrix,[0.07,0.07,0.07]);
		//mat4.identity(rotMatrix);
        //mat4.translate(rotMatrix, [x,y,z]);
        //mat4.rotate(rotMatrix, degtorad(o1), [0, 0, 1]);
	    /*var px=xmin+(xmax-xmin)*i/n,py=ymin+(ymax-ymin)*j/n;
	    var nx=(px+n4)*n/(scale*8);
	    var ny=(py+n4)*n/(scale*8);*/
		var ixy=i*n+j;
		//if(ixy<0){ixy=0};if(ixy>(n*n)){ixy=n*n;}
		var h=height[ixy];
        colorr=0;colorb=0;colorg=0.5+0.5*h/40;
		if(h>160){colorg=2.5;colorb=0.75*(h-160)/h;colorr=colorb;}
		if(tgmap==1 && height2[ixy]<0){colorb=0.7;colorg=0.2;} 
		if((tsea>0 || tgmap==1)&& h<-0.11){colorb=0.5;colorg=0;}
		if(tsea==0 && h<-0.5){colorb=0.5;colorg=0;}
	    setMatrixUniforms();
        gl.drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
      }
	}
    mat4.identity(mvMatrix);
	var i=0.97*n*(x-xmin)/(xmax-xmin);
	var j=0.97*n*(y-ymin)/(ymax-ymin);
	var ix=(i-n/2),iy=(j-n/2);
	mat4.translate(mvMatrix, [ix*1.2,iy,-350]);
 	mat4.scale(mvMatrix,[0.05,0.05,0.05]);
	colorr=0;colorb=0;colorg=0;
	drawcarre()
	mvPopMatrix();
	colorr=1;colorb=1;colorg=1;
    gl.enable(gl.DEPTH_TEST);
}
function drawgmap(){
gl.viewport(0, 0, windx,windy);
gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
//mat4.perspective(47, gl.viewportWidth / gl.viewportHeight, 1, 10000.0, pMatrix);
mat4.perspective(47, (cssscale/cssscaley)*gl.viewportWidth / gl.viewportHeight, 1, 10000.0, pMatrix);
gl.useProgram(shaderProgram);
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
	gl.activeTexture(gl.TEXTURE0);
    if(tdrawmap==0){gl.bindTexture(gl.TEXTURE_2D,  solTexture2);
    }else if(tdrawmap==2){gl.bindTexture(gl.TEXTURE_2D,  solTexture3);
	}else{gl.bindTexture(gl.TEXTURE_2D,  solTexture4);}
	gl.uniform1i(shaderProgram.samplerUniform, 0);
	gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, boussVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);
    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    mvPushMatrix();
    	mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0,0,-350]);
		var sc=n/(2*boussx);
 		mat4.scale(mvMatrix,[1.2*sc,sc,1]);
	    setMatrixUniforms();
        gl.drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
    mat4.identity(mvMatrix);
	//x=(xmin+xmax)/2;y=(ymin+ymax)/2;
	//var i=xtoi(x);//0.97*n*(x-xmin)/(xmax-xmin);
	//var j=xtoi(y);//0.97*n*(y-ymin)/(ymax-ymin);
	var i=n*(x-xmin)/(xmax-xmin);
	var j=n*(y-ymin)/(ymax-ymin);
	var ix=(i-n/2),iy=(j-n/2);
	if(tdrawmap==2){ix/=4;iy/=4;}
	mat4.translate(mvMatrix, [ix*1.2,iy,-350]);
 	mat4.scale(mvMatrix,[0.05,0.05,0.05]);
	colorr=1;colorb=0;colorg=0;
	if(tdrawmap!=3){drawcarre();}
	mvPopMatrix();
	colorr=1;colorb=1;colorg=1;
    gl.enable(gl.DEPTH_TEST);
}
function drawstarmap(){
gl.viewport(0, 0, windx,windy);
gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
//mat4.perspective(47, gl.viewportWidth / gl.viewportHeight, 1, 10000.0, pMatrix);
mat4.perspective(47, (cssscale/cssscaley)*gl.viewportWidth / gl.viewportHeight, 30, 1000000.0, pMatrix);
    //gl.disable(gl.DEPTH_TEST);
		var k=0.6;
		if(tdrawmap==2){k=0.3;}
		if(tdrawmap==3){k=0.15;}
		mat4.lookAt([x,y-40,z+4000*k],[x,y,z],[0,1,0],mvMatrix);
		gl.useProgram(starProgram);
		var sin200=sin2,zv00=zv;
		sin2=-1;rstar=5;
		drawstar();
	gl.useProgram(shaderProgram);
	/*gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,waterTexture);
	gl.uniform1i(shaderProgram.samplerUniform, 0);
	mvPushMatrix();
	mat4.translate(mvMatrix, [x,y,z]);
    //mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
 	mat4.scale(mvMatrix,[0.4,0.4,0.4]);
	colorr=1;colorb=0.3;colorg=0.3;colora=1;
	drawcarre();
	colorr=1;colorg=1;colorb=1;colora=1;
	mvPopMatrix();*/
    gl.enable(gl.DEPTH_TEST);
	mat4.lookAt([x,y-0.1,z+9800],[x,y,z],[0,1,0],mvMatrix);
	var tourelle00=tourelle;tourelle=0;
	mat4.translate(mvMatrix, [x,y,z]);
	mat4.rotate(mvMatrix,degtorad(o1), [0, 0, 1]);
	if(cos2<0){mat4.rotate(mvMatrix,degtorad(180), [0, 0, 1]);}
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,alphajetTexture);
	gl.uniform1i(shaderProgram.samplerUniform, 0);
	drawalphajetobj();
	tourelle=tourelle00;
		rstar=1;sin2=sin200;
		if(tspace==1){
		   zv=zv+4000*kstar*10*k;
		   mat4.lookAt([xv,yv-10,zv],[xv,yv,zv00],[0,1,0],mvMatrix);
		   gl.useProgram(shaderProgram);
		   drawskyimage();//drawsky(skyTexture);
		   if(tdrawmap==3 || tdrawmap==2){
		    earthx=-2200;earthy=2200;earthz=0;earthr=3;
		    earthr=3;drawearth(earthTexture,earthmaskTexture);
		    soleilx=-1200;soleily=0;soleilz=0;soleilr=30;soleiltype=1;
            //soleilx=4000;z=-4000;x=0;y=4000;
		    drawsoleil(soleilTexture);
		    drawsoleilstar();
            if(tinfo2==1 && tinfo==1){printinfomsg2();}
			}
        }
		zv=zv00;
}
function drawcarre(){
	gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, boussVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
}
function drawcarre2D(){
	//gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
    //gl.vertexAttribPointer(program2D.textureCoordAttribute, boussVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(program2d.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	setMatrixUniforms2D();
    gl.drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
}
function drawcarresky(){
	gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
    gl.vertexAttribPointer(skyProgram.textureCoordAttribute, boussVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(skyProgram.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	setskyMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
}
var o3radar=0,tviseur=0;
function drawcockpit(){
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);//replaced by shader alpha_test
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
        mvPushMatrix();
		/*mat4.translate(mvMatrix, [x,y,z]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);*/
		mat4.translate(mvMatrix, [-0.66,0.0,0]);
        mat4.rotate(mvMatrix, degtorad(90), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(-10), [1, 0, 0]);
        //mat4.rotate(mvMatrix, degtorad(o2), [0, 1, 0]);
        //mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);

 		mat4.scale(mvMatrix,[0.0073,0.0073,0.0073]);
    	gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D,  compasTexture);
        gl.uniform1i(shaderProgram.samplerUniform, 0);
		mvPushMatrix();
		//mat4.translate(mvMatrix, [-16.1,9.2-2.5*sin2,-1]);
		mat4.translate(mvMatrix, [-16.1,9.2,-1]);
		mat4.rotate(mvMatrix, degtorad(-o3), [0, 0, 1]);
		if(sin2>0){mat4.translate(mvMatrix, [0,-2.5*Math.sqrt(sin2),0]);}else{
		           mat4.translate(mvMatrix, [0,2.5*Math.sqrt(-sin2),0]);}
		mat4.scale(mvMatrix,[0.07,0.14,0.1]);
		drawcarre();
		mvPopMatrix();
        gl.bindTexture(gl.TEXTURE_2D,  cockpitTexture);
		drawcarre();
		mvPushMatrix();
		mat4.translate(mvMatrix, [-8.6,9.2,1]);
		var o3alt=(z-0.7)*36,o3alt2=o3alt/13;
		mat4.rotate(mvMatrix, degtorad(-o3alt), [0, 0, 1]);
 		mat4.scale(mvMatrix,[0.067,0.065,0.067]);
        gl.bindTexture(gl.TEXTURE_2D,  arrowTexture);
		drawcarre();
		mat4.rotate(mvMatrix, degtorad(o3alt-o3alt2), [0, 0, 1]);
		mat4.scale(mvMatrix,[1,0.6,1]);
		drawcarre();
		mvPopMatrix();
		mvPushMatrix();
		mat4.translate(mvMatrix, [-22.35,9.2,1]);
		var o3speed=(vplane)*190*0.9/vcruise;if(o3speed>340){o3speed=340;}
		mat4.rotate(mvMatrix, degtorad(-o3speed), [0, 0, 1]);
 		mat4.scale(mvMatrix,[0.067,0.062,0.067]);
		drawcarre();
		mvPopMatrix();
		mvPushMatrix();
		mat4.translate(mvMatrix, [-8.6,2.3,1]);
		var o3speedz=(vplanez)*590;
		if(o3speedz>80){o3speedz=80;}
		if(o3speedz<-80){o3speedz=-80;}
		mat4.rotate(mvMatrix, degtorad(-o3speedz+90), [0, 0, 1]);
 		mat4.scale(mvMatrix,[0.062,0.062,0.067]);
		drawcarre();
		mvPopMatrix();
		mvPushMatrix();
		mat4.translate(mvMatrix, [-2.1,2.3,1]);
		var o3rpm=130-(vrun+0.4*vplane)*100*(0.8+1.3)/(0.8+vrunmax);
		if(o3rpm<-130){o3rpm=-130;};
		mat4.rotate(mvMatrix, degtorad(o3rpm), [0, 0, 1]);
 		mat4.scale(mvMatrix,[0.065,0.059,0.067]);
		drawcarre();
		mvPopMatrix();

		mvPushMatrix();
		mat4.translate(mvMatrix, [-2.1,9.23,1]);
		var o3azimut=90-o1;
		mat4.rotate(mvMatrix, degtorad(o3azimut), [0, 0, 1]);
 		mat4.scale(mvMatrix,[0.069,0.069,0.067]);
        gl.bindTexture(gl.TEXTURE_2D,  azimutTexture);
		drawcarre();
		mvPopMatrix();
        if(tviseur==1){
		mvPushMatrix();
		mat4.translate(mvMatrix, [0.56,32.85,1]);
 		mat4.scale(mvMatrix,[0.12,0.12,0.12]);
        gl.bindTexture(gl.TEXTURE_2D,  viseurTexture);
		colorr=1;colorg=1;colorb=1;colora=0.8;
		drawcarre();
		colorr=1;colorg=1;colorb=1;colora=1;
		mvPopMatrix();
        }		
		
		drawradar();
		mvPopMatrix();
        gl.enable(gl.DEPTH_TEST);
        gl.disable(gl.BLEND);
}
function drawradar(){
    	mvPushMatrix();
		mat4.translate(mvMatrix, [23.43,6.7,1]);
		o3radar=tframe*0.060;
		mat4.rotate(mvMatrix, degtorad(o3radar), [0, 0, 1]);
 		mat4.scale(mvMatrix,[0.137,0.137,0.137]);
    	gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D,  radarTexture);
        gl.uniform1i(shaderProgram.samplerUniform, 0);
		drawcarre();
		mvPopMatrix();
	if(tspace==1){
	    iradarsoleil=0;
		if(tframe<tradarsoleil+5000 && dxradarsoleil*0.015<5.4){
		mvPushMatrix();
		mat4.translate(mvMatrix, [23.43,6.7,1]);
		mat4.rotate(mvMatrix, degtorad(90-o1+o1radarsoleil), [0, 0, 1]);
 		mat4.translate(mvMatrix, [dxradarsoleil*0.015,0,0]);
		var sc=0.01*(tradarsoleil+7400-tframe)/7400;
		mat4.scale(mvMatrix,[sc,sc,sc]);
        gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
		drawcarre();
		mvPopMatrix();
		}
		if(tframe<tradarsoleil2+5000 && dxradarsoleil2*0.015<5.4){
		mvPushMatrix();
		mat4.translate(mvMatrix, [23.43,6.7,1]);
		mat4.rotate(mvMatrix, degtorad(90-o1+o1radarsoleil2), [0, 0, 1]);
 		mat4.translate(mvMatrix, [dxradarsoleil2*0.015,0,0]);
		var sc=0.01*(tradarsoleil2+7400-tframe)/7400;
		mat4.scale(mvMatrix,[sc,sc,sc]);
        gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
		drawcarre();
		mvPopMatrix();
		}
	    iradarearth=0;
		if(tframe<tradarearth+5000 && dxradarearth*0.015<5.4){
		mvPushMatrix();
		mat4.translate(mvMatrix, [23.43,6.7,1]);
		mat4.rotate(mvMatrix, degtorad(90-o1+o1radarearth), [0, 0, 1]);
 		mat4.translate(mvMatrix, [dxradarearth*0.015,0,0]);
		var sc=0.005*(tradarearth+7400-tframe)/7400;
		mat4.scale(mvMatrix,[sc,sc,sc]);
        gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
		drawcarre();
		mvPopMatrix();
		}
		if(tframe<tradarearth2+5000 && dxradarearth2*0.015<5.4){
		mvPushMatrix();
		mat4.translate(mvMatrix, [23.43,6.7,1]);
		mat4.rotate(mvMatrix, degtorad(90-o1+o1radarearth2), [0, 0, 1]);
 		mat4.translate(mvMatrix, [dxradarearth2*0.015,0,0]);
		var sc=0.005*(tradarearth2+7400-tframe)/7400;
		mat4.scale(mvMatrix,[sc,sc,sc]);
        gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
		drawcarre();
		mvPopMatrix();
		}
	}
		if(tframe<tradarpiste+5000 && dxradarpiste*0.015<5.4){
		mvPushMatrix();
		mat4.translate(mvMatrix, [23.43,6.7,1]);
		mat4.rotate(mvMatrix, degtorad(90-o1+o1radarpiste), [0, 0, 1]);
 		mat4.translate(mvMatrix, [dxradarpiste*0.015,0,0]);
		var sc=0.01*(tradarpiste+7400-tframe)/7400;
		mat4.scale(mvMatrix,[sc,sc,sc]);
        gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
		drawcarre();
		mvPopMatrix();
		}
		if(tframe<tradarwater+5000 && dxradarwater*0.015<5.4){
		mvPushMatrix();
		mat4.translate(mvMatrix, [23.43,6.7,1]);
		mat4.rotate(mvMatrix, degtorad(90-o1+o1radarwater), [0, 0, 1]);
 		mat4.translate(mvMatrix, [dxradarwater*0.015,0,0]);
		var sc=0.01*(tradarwater+7400-tframe)/7400;
		mat4.scale(mvMatrix,[sc,sc,sc]);
        gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
		drawcarre();
		mvPopMatrix();
		}
		if(tframe<tradartown+5000 && dxradartown*0.015<5.4){
		mvPushMatrix();
		mat4.translate(mvMatrix, [23.43,6.7,1]);
		mat4.rotate(mvMatrix, degtorad(90-o1+o1radartown), [0, 0, 1]);
 		mat4.translate(mvMatrix, [dxradartown*0.015,0,0]);
		var sc=0.01*(tradartown+7400-tframe)/7400;
		mat4.scale(mvMatrix,[sc,sc,sc]);
        gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
		drawcarre();
		mvPopMatrix();
		}
	if(tspace==0){
		if(tframe<tradarplane2+5000 && dxradarplane2*0.015<5.4){
		mvPushMatrix();
		mat4.translate(mvMatrix, [23.43,6.7,1]);
		mat4.rotate(mvMatrix, degtorad(90-o1+o1radarplane2), [0, 0, 1]);
 		mat4.translate(mvMatrix, [dxradarplane2*0.015,0,0]);
		var sc=0.007*(tradarplane2+7400-tframe)/7400;
		mat4.scale(mvMatrix,[sc,sc,sc]);
        gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
		colorr=1;colorg=0;colorb=0;colora=1;
		drawcarre();
		colorr=1;colorg=1;colorb=1;colora=1;
		mvPopMatrix();
		}
	}else{
	  for(var i=0;i<nplane;i++){
        dxradarplane2=ndxradarplane2[i];o1radarplane2=no1radarplane2[i];
		tradarplane2=ntradarplane2[i];
		if(tframe<tradarplane2+5000 && dxradarplane2*0.015<5.4){
		mvPushMatrix();
		mat4.translate(mvMatrix, [23.43,6.7,1]);
		mat4.rotate(mvMatrix, degtorad(90-o1+o1radarplane2), [0, 0, 1]);
 		mat4.translate(mvMatrix, [dxradarplane2*0.015,0,0]);
		var sc=0.007*(tradarplane2+7400-tframe)/7400;
		if(tframe<tradardist){sc*=1.5;}
		mat4.scale(mvMatrix,[sc,sc,sc]);
        gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
		colorr=1;colorg=0;colorb=0;colora=1;
		var dz=npz[i]-z;dxy=20+Math.max(Math.abs(npx[i]-x),Math.abs(npy[i]-y));
		if(dz<0){colorr=Math.max(0.2,Math.min(1,1+2*dz/dxy));
		         colorb=0;
		}else{colorr=1;
  	          colorg=Math.max(0,Math.min(0.8,0.8*2*dz/dxy));}
		drawcarre();
		colorr=1;colorg=1;colorb=1;colora=1;
		mvPopMatrix();
		}
	  }
	}
		if(tskydome2==1){
		if(tframe<tradarplane3+5000 && dxradarplane3*0.015<5.4){
		mvPushMatrix();
		mat4.translate(mvMatrix, [23.43,6.7,1]);
		mat4.rotate(mvMatrix, degtorad(90-o1+o1radarplane3), [0, 0, 1]);
 		mat4.translate(mvMatrix, [dxradarplane3*0.015,0,0]);
		var sc=0.007*(tradarplane3+7400-tframe)/7400;
		mat4.scale(mvMatrix,[sc,sc,sc]);
        gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
		drawcarre();
		mvPopMatrix();
		};}
		if(tframe<tradarcarrier+5000 && dxradarcarrier*0.015<5.4){
		mvPushMatrix();
		mat4.translate(mvMatrix, [23.43,6.7,1]);
		mat4.rotate(mvMatrix, degtorad(90-o1+o1radarcarrier), [0, 0, 1]);
 		mat4.translate(mvMatrix, [dxradarcarrier*0.015,0,0]);
		var sc=0.01*(tradarcarrier+7400-tframe)/7400;
		mat4.scale(mvMatrix,[sc,sc,sc]);
        gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
		drawcarre();
		mvPopMatrix();
		}
}
var o3helice=0;
function drawhelice(){
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_COLOR, gl.ONE);//_MINUS_SRC_COLOR);
		mvPushMatrix();
		mat4.translate(mvMatrix, [-2,-0.165,0]);
        mat4.rotate(mvMatrix, degtorad(90), [0, 1, 0]);
		o3helice+=(vrun+vplane+0.14)*dtime*0.7;if(o3helice>1000){o3helice-=1000;};
		mat4.rotate(mvMatrix, degtorad(o3helice), [0, 0, 1]);
 		var sc=0.0125*Math.sqrt(windx/windy);
		mat4.scale(mvMatrix,[sc,sc,sc]);
 		//mat4.scale(mvMatrix,[0.0160,0.0160,0.0160]);
    	gl.activeTexture(gl.TEXTURE5);
        gl.bindTexture(gl.TEXTURE_2D,  heliceTexture);
        gl.uniform1i(shaderProgram.samplerUniform, 5);
		colorr=0.77;colorg=0.77;colorb=0.77;colora=0.77;
		drawcarre();
		colorr=1;colorg=1;colorb=1;colora=1;
		mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
}
var planedo3=0,planedo2=0;
function drawplane(){
if(tourelle!=499){
   if(tourelle==5){return;}
   if(plane=="spitfire"){drawspitfire();return;}
   if(plane=="zero"){drawzero();return;}
   if(plane=="spaceship"){drawspaceship();return;}
   if(plane=="alphajet"){drawalphajet();return;}
}else if(tcar==1){return;}

        mvPushMatrix();
    if(tshadow==0){  
	   if(tourelle==0){	
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0.0, 0.0, -7.0]);
        mat4.rotate(mvMatrix, degtorad(-90), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(-sin2*24*cos2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(sin3*24), [1, 0, 0]);
		planedo3=sin3*24;
	  }else if(tspace==1){
		var co3=Math.cos(degtorad(o3-planedo3));si3=Math.sin(degtorad(o3-planedo3));
		var co2=Math.cos(degtorad(o2-planedo2));si2=Math.sin(degtorad(o2-planedo2));
	    var dz=0.25,dx=0.01;
		xv=x-dz*sin1*si3+dx*cos1*co2;yv=y+dz*cos1*si3+dx*sin1*co2;zv=z+dz*co3+dx*si2;
        mat4.lookAt([xv-x,yv-y,zv-z],[xv-x+tcos1*tcos2,yv-y+tsin1*tcos2,zv-z+tsin2+0.25],[-tcos1*tsin2*cos3-tsin1*sin3,-tsin1*tsin2*cos3+tcos1*sin3,tcos2*cos3],mvMatrix);
		//mat4.translate(mvMatrix, [x,y,z]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2-sin2*4*cos2), [0, 0, 1]);
        //mat4.rotate(mvMatrix, degtorad(o3+sin3*7), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
		planedo3=sin3*7*1.4;planedo2=-(sin2+2)*1.4*cos2;
		//planedo3=sin3*7*1.1;planedo2=-(sin2+2)*1.1*cos2;
	  }else{
		mat4.translate(mvMatrix, [x0,y0,z0]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2-sin2*4*cos2), [0, 0, 1]);
        //mat4.rotate(mvMatrix, degtorad(o3+sin3*7), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
		planedo3=sin3*7*1.4;planedo2=-(sin2+2)*1.4*cos2;
      }	  
	}else{
	    var dx=Math.sqrt(sunx*sunx+suny*suny+sunzz*sunzz);
		var dz=Math.max(0.0,z-zsol-3)*10;
		//var kz=distshadow*0.5;//*0.705
    	//mat4.translate(mvMatrix,[x-1.0*kz*sunx/dz,y-1.0*kz*suny/dz,z]);
    	//mat4.translate(mvMatrix,[x+0.25*(1+cos1)*kz-dz*sunx/dx,y+0.25*(1+sin1)*kz-dz*suny/dx,z]);
    	///mat4.translate(mvMatrix,[x+0.25*(1+0.5)*kz-dz*sunx/dx,y+0.25*(1+0.5)*kz-dz*suny/dx,z]);
    	mat4.translate(mvMatrix,[x-dz*sunx/dx,y-dz*suny/dx,z]);
		//mat4.rotate(mvMatrix, degtorad(180), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
    }	
	if(tourelle==3 && tshadow==0){drawhelice();}
	mvPushMatrix();
	gl.activeTexture(gl.TEXTURE4);
    if(tshadow==0){gl.bindTexture(gl.TEXTURE_2D,  objTexture);
		if(tourelle==0){mat4.scale(mvMatrix,[0.02,0.02,0.02]);}else{
		    var sc=0.019;mat4.scale(mvMatrix,[sc,sc,sc]);}
	}else{
 		mat4.scale(mvMatrix,[0.03,0.03,0.03]);
                   gl.disable(gl.DEPTH_TEST);
	               gl.bindTexture(gl.TEXTURE_2D,  cloudblackTexture);}
    gl.uniform1i(shaderProgram.samplerUniform, 4);
    
   if(tshadow==0 && tourelle!=4){
	gl.bindBuffer(gl.ARRAY_BUFFER, worldVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, worldVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, worldVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, worldVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, worldVertexPositionBuffer.numItems);
   }else if(tshadow!=0){
    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, world2VertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, world2VertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, world2VertexPositionBuffer.numItems);
   }   
	mvPopMatrix();
	if(tourelle>=2 && tshadow==0){
	   if(tourelle==4){mat4.translate(mvMatrix, [-0.05,-0.05,0]);}
	   drawcockpit();}

		mvPopMatrix();
    if(tshadow==1){gl.enable(gl.DEPTH_TEST);};

}
function drawspitfire(){
        mvPushMatrix();
    if(tshadow==0){  
	   if(tourelle==0){	
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0.0, 0.3, -7.0]);
        mat4.rotate(mvMatrix, degtorad(-90), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(-sin2*24*cos2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(sin3*24), [1, 0, 0]);
		planedo3=sin3*24;
	  }else{
		mat4.translate(mvMatrix, [x,y,z]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2-sin2*4*cos2), [0, 0, 1]);
        //mat4.rotate(mvMatrix, degtorad(o3+sin3*7), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
		planedo3=sin3*7*1.4;planedo2=-(sin2+2)*1.4*cos2;
      }	  
	}else{
	    var dx=Math.sqrt(sunx*sunx+suny*suny+sunzz*sunzz);
		var dz=Math.max(0.0,z-zsol-3)*10;
		//var kz=distshadow*0.5;//*0.705
    	//mat4.translate(mvMatrix,[x-1.0*kz*sunx/dz,y-1.0*kz*suny/dz,z]);
    	//mat4.translate(mvMatrix,[x+0.25*(1+cos1)*kz-dz*sunx/dx,y+0.25*(1+sin1)*kz-dz*suny/dx,z]);
    	///mat4.translate(mvMatrix,[x+0.25*(1+0.5)*kz-dz*sunx/dx,y+0.25*(1+0.5)*kz-dz*suny/dx,z]);
    	mat4.translate(mvMatrix,[x-dz*sunx/dx,y-dz*suny/dx,z]);
		//mat4.rotate(mvMatrix, degtorad(180), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
    }	
	if(tourelle==3 && tshadow==0){drawhelice();}
	mvPushMatrix();
	mat4.translate(mvMatrix, [-0.26*cos2+0.05, -0.044, 0.0]);
    mat4.rotate(mvMatrix, degtorad(-90), [1, 0, 0]);
	gl.activeTexture(gl.TEXTURE4);
    if(tshadow==0){gl.bindTexture(gl.TEXTURE_2D,  spitfireTexture);
		if(tourelle==0){mat4.scale(mvMatrix,[0.021,0.0259,0.021]);}else{
		    var sc=0.020;mat4.scale(mvMatrix,[sc,0.0209,sc]);}
	}else{
 		mat4.scale(mvMatrix,[0.03,0.03,0.03]);
                   gl.disable(gl.DEPTH_TEST);
	               gl.bindTexture(gl.TEXTURE_2D,  cloudblackTexture);}
    gl.uniform1i(shaderProgram.samplerUniform, 4);
    
   if(tshadow==0){
    if(tourelle==0 || Math.abs(to1)>100 || to2<-25){
    gl.bindBuffer(gl.ARRAY_BUFFER, spitfireVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, spitfireVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, spitfireVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, spitfireVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, spitfireVertexPositionBuffer.numItems);
	}else{
    gl.bindBuffer(gl.ARRAY_BUFFER, spitfirecockpitVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, spitfirecockpitVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, spitfirecockpitVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, spitfirecockpitVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, spitfirecockpitVertexPositionBuffer.numItems);
	}
   }else{
    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, world2VertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, world2VertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, world2VertexPositionBuffer.numItems);
   }   
	mvPopMatrix();
	if(tourelle>=2 && tshadow==0){drawcockpit();}

		mvPopMatrix();
    if(tshadow==1){gl.enable(gl.DEPTH_TEST);};

}
function drawzero(){
        mvPushMatrix();
    if(tshadow==0){  
	   if(tourelle==0){	
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0.0, 0.21, -7.0]);
        mat4.rotate(mvMatrix, degtorad(-90), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(-sin2*24*cos2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(sin3*24), [1, 0, 0]);
		planedo3=sin3*24;
	  }else{
		mat4.translate(mvMatrix, [x,y,z]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2-sin2*4*cos2), [0, 0, 1]);
        //mat4.rotate(mvMatrix, degtorad(o3+sin3*7), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
		//planedo3=sin3*7*1.4;planedo2=-(sin2+2)*1.4*cos2;
		planedo3=sin3*7*1.1;planedo2=-(sin2+2)*1.1*cos2;
      }	  
	}else{
	    var dx=Math.sqrt(sunx*sunx+suny*suny+sunzz*sunzz);
		var dz=Math.max(0.0,z-zsol-3)*10;
		//var kz=distshadow*0.5;//*0.705
    	//mat4.translate(mvMatrix,[x-1.0*kz*sunx/dz,y-1.0*kz*suny/dz,z]);
    	//mat4.translate(mvMatrix,[x+0.25*(1+cos1)*kz-dz*sunx/dx,y+0.25*(1+sin1)*kz-dz*suny/dx,z]);
    	///mat4.translate(mvMatrix,[x+0.25*(1+0.5)*kz-dz*sunx/dx,y+0.25*(1+0.5)*kz-dz*suny/dx,z]);
    	mat4.translate(mvMatrix,[x-dz*sunx/dx,y-dz*suny/dx,z]);
		//mat4.rotate(mvMatrix, degtorad(180), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
    }	
	if(tourelle==3 && tshadow==0){drawhelice();}
	mvPushMatrix();
	mat4.translate(mvMatrix, [0.31*cos2-0.60, -0.17, 0.0]);
    mat4.rotate(mvMatrix, degtorad(-90), [1, 0, 0]);
	gl.activeTexture(gl.TEXTURE4);
    if(tshadow==0){gl.bindTexture(gl.TEXTURE_2D,  zeroTexture);
		if(tourelle==0){mat4.scale(mvMatrix,[0.021,0.023,0.021]);}else{
		    var sc=0.0205;mat4.scale(mvMatrix,[sc,0.0185,sc]);}
	}else{
 		mat4.scale(mvMatrix,[0.03,0.03,0.03]);
                   gl.disable(gl.DEPTH_TEST);
	               gl.bindTexture(gl.TEXTURE_2D,  cloudblackTexture);}
    gl.uniform1i(shaderProgram.samplerUniform, 4);
    
   if(tshadow==0){
    if(tourelle==0 || Math.abs(to1)>100 || to2<-25){
    gl.bindBuffer(gl.ARRAY_BUFFER, zeroVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, zeroVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, zeroVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, zeroVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, zeroVertexPositionBuffer.numItems);
	}else{
    gl.bindBuffer(gl.ARRAY_BUFFER, zerocockpitVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, zerocockpitVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, zerocockpitVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, zerocockpitVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, zerocockpitVertexPositionBuffer.numItems);
	}
   }else{
    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, world2VertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, world2VertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, world2VertexPositionBuffer.numItems);
   }   
	mvPopMatrix();
	if(tourelle>=2 && tshadow==0){drawcockpit();}

		mvPopMatrix();
    if(tshadow==1){gl.enable(gl.DEPTH_TEST);};

}
function drawspaceship(){
        var o2save=o2,tcos2save=tcos2,tsin2save=tsin2;
		var cos2save=cos2,sin2save=sin2,co2=cos2,si2=sin2;
        mvPushMatrix();
    if(tshadow==0){  
	   if(tourelle==0){	
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0.0, 0.18, -7.0]);
        mat4.rotate(mvMatrix, degtorad(90), [0, 1, 0]);
        //mat4.rotate(mvMatrix, degtorad(180), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(sin2*24*cos2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(-sin3*24), [1, 0, 0]);
		planedo3=sin3*24;
	  }else if(tspace==1){
	       var k=1.0;
		   if(o2>90){o2=180-o2;cos2=Math.cos(degtorad(o2));}
		   if(o2<-90){o2=-180-o2;cos2=Math.cos(degtorad(o2));}
	       if(o2>0){k=(0.9+cos2)/1.9;o2*=k;}
	       if(o2<0){k=-(0.9+cos2)/1.9;o2*=k;}
		   cos2=Math.cos(degtorad(o2));
		   sin2=Math.sin(degtorad(o2));
		   var tco1=Math.cos(degtorad(to1));
		   var to22=o2*tco1+to2;//if(to22>89){to22=88;};if(to22<-89){to22=-88;};
           tcos2=Math.cos(degtorad(to22));tsin2=Math.sin(degtorad(to22));
		var co3=Math.cos(Math.abs(degtorad(o3-planedo3))),si3=Math.sin(degtorad(o3-planedo3));
		co2=Math.cos(degtorad(o2-planedo2));si2=Math.sin(degtorad(o2-planedo2));
	    var dz=0.25,dx=0.01;
		xv=x-dz*sin1*si3+dx*cos1*co2;yv=y+dz*cos1*si3+dx*sin1*co2;zv=z+dz*co3+dx*si2;
        mat4.lookAt([xv-x,yv-y,zv-z],[xv-x+tcos1*tcos2,yv-y+tsin1*tcos2,zv-z+tsin2+0.25],[-tcos1*tsin2*cos3-tsin1*sin3,-tsin1*tsin2*cos3+tcos1*sin3,tcos2*cos3],mvMatrix);
		//mat4.translate(mvMatrix, [x,y,z]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2-sin2*4*cos2), [0, 0, 1]);
        //mat4.rotate(mvMatrix, degtorad(o3+sin3*7), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
		//planedo3=sin3*7*1.4;planedo2=-(sin2+2)*1.4*cos2;
		planedo3=sin3*7*1.1;planedo2=-(sin2+2)*1.1*cos2;
	  }else{
		mat4.translate(mvMatrix, [x,y,z]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2-sin2*4*cos2), [0, 0, 1]);
        //mat4.rotate(mvMatrix, degtorad(o3+sin3*7), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
		//planedo3=sin3*7*1.4;planedo2=-(sin2+2)*1.4*cos2;
		planedo3=sin3*7*1.1;planedo2=-(sin2+2)*1.1*cos2;
      }	  
	}else{
	    var dx=Math.sqrt(sunx*sunx+suny*suny+sunzz*sunzz);
		var dz=Math.max(0.0,z-zsol-3)*10;
		//var kz=distshadow*0.5;//*0.705
    	//mat4.translate(mvMatrix,[x-1.0*kz*sunx/dz,y-1.0*kz*suny/dz,z]);
    	//mat4.translate(mvMatrix,[x+0.25*(1+cos1)*kz-dz*sunx/dx,y+0.25*(1+sin1)*kz-dz*suny/dx,z]);
    	///mat4.translate(mvMatrix,[x+0.25*(1+0.5)*kz-dz*sunx/dx,y+0.25*(1+0.5)*kz-dz*suny/dx,z]);
    	mat4.translate(mvMatrix,[x-dz*sunx/dx,y-dz*suny/dx,z]);
		//mat4.rotate(mvMatrix, degtorad(180), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
    }	
	if(tourelle==3 && tshadow==0){tourelle=4;}//drawhelice();}
	mvPushMatrix();
	mat4.translate(mvMatrix, [0.28*cos2-0.58, -0.34, 0.0]);
    mat4.rotate(mvMatrix, degtorad(-90), [1, 0, 0]);
    //mat4.rotate(mvMatrix, degtorad(90), [0, 1, 0]);
	gl.activeTexture(gl.TEXTURE4);
    if(tshadow==0){
	    if(tourelle==0){gl.bindTexture(gl.TEXTURE_2D,  fighterTexture);}
		else{gl.bindTexture(gl.TEXTURE_2D,  f14Texture);}
		if(tourelle==0){mat4.scale(mvMatrix,[0.0225,0.0225,0.0225]);}else{
		    mat4.translate(mvMatrix, [-si2*0.0255,0,0.1]);
		    var sc=0.0205;mat4.scale(mvMatrix,[-sc,-0.0205,0.0317]);}
	}else{
 		mat4.scale(mvMatrix,[0.03,0.03,0.03]);
                   gl.disable(gl.DEPTH_TEST);
	               gl.bindTexture(gl.TEXTURE_2D,  cloudblackTexture);}
    gl.uniform1i(shaderProgram.samplerUniform, 4);
    
   if(tshadow==0){
    if(tourelle==0 || Math.abs(to1)>100 || to2<-43){
	drawfighterobj();
	}else if(tourelle!=4){
    gl.bindBuffer(gl.ARRAY_BUFFER, f14cockpitVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, f14cockpitVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, f14cockpitVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, f14cockpitVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, f14cockpitVertexPositionBuffer.numItems);
	}
   }else{
    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, world2VertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, world2VertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, world2VertexPositionBuffer.numItems);
   }   
	mvPopMatrix();
    o2=o2save;tcos2=tcos2save;tsin2=tsin2save;
	cos2=cos2save;sin2=sin2save;
	if(tourelle>=2 && tshadow==0){drawcockpit();}
	else if(tradar==1){drawtradar();}

		mvPopMatrix();
    if(tshadow==1){gl.enable(gl.DEPTH_TEST);};
    o2=o2save;tcos2=tcos2save;tsin2=tsin2save;
	cos2=cos2save;sin2=sin2save;
}
function drawalphajet(){
        var o2save=o2,tcos2save=tcos2,tsin2save=tsin2;
		var cos2save=cos2,sin2save=sin2,co2=cos2,si2=sin2;
        mvPushMatrix();
    if(tshadow==0){  
	   if(tourelle==0){	
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0.0, 0.18, -7.0]);
        mat4.rotate(mvMatrix, degtorad(90), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(sin2*24*cos2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(-sin3*24), [1, 0, 0]);
		planedo3=sin3*24;
	  }else if(tspace==1){
	       var k=1.0;
		   if(o2>90){o2=180-o2;cos2=Math.cos(degtorad(o2));}
		   if(o2<-90){o2=-180-o2;cos2=Math.cos(degtorad(o2));}
	       if(o2>0){k=(0.9+cos2)/1.9;o2*=k;}
	       if(o2<0){k=-(0.9+cos2)/1.9;o2*=k;}
		   cos2=Math.cos(degtorad(o2));
		   sin2=Math.sin(degtorad(o2));
		   var tco1=Math.cos(degtorad(to1));
		   var to22=o2*tco1+to2;//if(to22>89){to22=88;};if(to22<-89){to22=-88;};
           tcos2=Math.cos(degtorad(to22));tsin2=Math.sin(degtorad(to22));
		var co3=Math.cos(Math.abs(degtorad(o3-planedo3))),si3=Math.sin(degtorad(o3-planedo3));
		var co2=Math.cos(degtorad(o2-planedo2)),si2=Math.sin(degtorad(o2-planedo2));
	    var dz=0.25,dx=0.01;
		xv=x-dz*sin1*si3+dx*cos1*co2;yv=y+dz*cos1*si3+dx*sin1*co2;zv=z+dz*co3+dx*si2;
        mat4.lookAt([xv-x,yv-y,zv-z],[xv-x+tcos1*tcos2,yv-y+tsin1*tcos2,zv-z+tsin2+0.25],[-tcos1*tsin2*cos3-tsin1*sin3,-tsin1*tsin2*cos3+tcos1*sin3,tcos2*cos3],mvMatrix);
		//mat4.translate(mvMatrix, [x,y,z]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2-sin2*4*cos2), [0, 0, 1]);
        //mat4.rotate(mvMatrix, degtorad(o3+sin3*7), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
		//planedo3=sin3*7*1.4;planedo2=-(sin2+2)*1.4*cos2;
		planedo3=sin3*7*1.1;planedo2=-(sin2+2)*1.1*cos2;
	  }else{
		mat4.translate(mvMatrix, [x,y,z]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2-sin2*4*cos2), [0, 0, 1]);
        //mat4.rotate(mvMatrix, degtorad(o3+sin3*7), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
		//planedo3=sin3*7*1.4;planedo2=-(sin2+2)*1.4*cos2;
		planedo3=sin3*7*1.1;planedo2=-(sin2+2)*1.1*cos2;
      }	  
	}else{
	    var dx=Math.sqrt(sunx*sunx+suny*suny+sunzz*sunzz);
		var dz=Math.max(0.0,z-zsol-3)*10;
		//var kz=distshadow*0.5;//*0.705
    	//mat4.translate(mvMatrix,[x-1.0*kz*sunx/dz,y-1.0*kz*suny/dz,z]);
    	//mat4.translate(mvMatrix,[x+0.25*(1+cos1)*kz-dz*sunx/dx,y+0.25*(1+sin1)*kz-dz*suny/dx,z]);
    	///mat4.translate(mvMatrix,[x+0.25*(1+0.5)*kz-dz*sunx/dx,y+0.25*(1+0.5)*kz-dz*suny/dx,z]);
    	mat4.translate(mvMatrix,[x-dz*sunx/dx,y-dz*suny/dx,z]);
		//mat4.rotate(mvMatrix, degtorad(180), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
    }	
	if(tourelle==3 && tshadow==0){tourelle=4;}//drawhelice();}
	mvPushMatrix();
	mat4.translate(mvMatrix, [0.28*cos2-0.58, -0.34, 0.0]);
    mat4.rotate(mvMatrix, degtorad(-90), [1, 0, 0]);
    //mat4.rotate(mvMatrix, degtorad(90), [0, 1, 0]);
	gl.activeTexture(gl.TEXTURE4);
    if(tshadow==0){gl.bindTexture(gl.TEXTURE_2D,  alphajetTexture);
		if(tourelle==0){mat4.scale(mvMatrix,[0.021,0.023,0.021]);}else{
		    var sc=0.0205;mat4.scale(mvMatrix,[-sc,-0.018,0.0292]);}
	}else{
 		mat4.scale(mvMatrix,[0.03,0.03,0.03]);
                   gl.disable(gl.DEPTH_TEST);
	               gl.bindTexture(gl.TEXTURE_2D,  cloudblackTexture);}
    gl.uniform1i(shaderProgram.samplerUniform, 4);
    
   if(tshadow==0){
    if(tourelle==0 || Math.abs(to1)>100 || to2<-43){
	drawalphajetobj();
	}else if(tourelle!=4){
    gl.bindBuffer(gl.ARRAY_BUFFER, alphajetcockpitVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, alphajetcockpitVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, alphajetcockpitVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, alphajetcockpitVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, alphajetcockpitVertexPositionBuffer.numItems);
	}
   }else{
    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, world2VertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, world2VertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, world2VertexPositionBuffer.numItems);
   }   
	mvPopMatrix();
    o2=o2save;tcos2=tcos2save;tsin2=tsin2save;
	cos2=cos2save;sin2=sin2save;
	if(tourelle>=2 && tshadow==0){drawcockpit();}
	else if(tradar==1){drawtradar();}

		mvPopMatrix();
    if(tshadow==1){gl.enable(gl.DEPTH_TEST);};
    o2=o2save;tcos2=tcos2save;tsin2=tsin2save;
	cos2=cos2save;sin2=sin2save;
}
function drawtradar(){
	mvPushMatrix();
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [-0.4, -3.0, -7.0]);
        //mat4.rotate(mvMatrix, degtorad(-90), [0, 1, 0]);
 		mat4.scale(mvMatrix,[0.091,0.091,0.091]);
        gl.disable(gl.DEPTH_TEST);
        gl.enable(gl.BLEND);//replaced by shader alpha_test
        gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
	    drawradar();
        gl.enable(gl.DEPTH_TEST);
        gl.disable(gl.BLEND);
	mvPopMatrix();
}
function drawalphajetobj(){
    gl.bindBuffer(gl.ARRAY_BUFFER, alphajetVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, alphajetVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, alphajetVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, alphajetVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, alphajetVertexPositionBuffer.numItems);
}
function drawspaceshipobj(){
    gl.bindBuffer(gl.ARRAY_BUFFER, spaceshipVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, spaceshipVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, spaceshipVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, spaceshipVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, spaceshipVertexPositionBuffer.numItems);
}
function drawfighterobj(){
    gl.bindBuffer(gl.ARRAY_BUFFER, fighterVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, fighterVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, fighterVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, fighterVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, fighterVertexPositionBuffer.numItems);
}
var tradarplane2=0,o1radarplane2=0,dxradarplane2=0;
function drawplane2(){//if(tdogfight==1){drawzero2();return;}
        mvPushMatrix();
	if(tshadow==0){	
        var dxplane2=Math.abs(x-px),dyplane2=Math.abs(y-py);
		dxradarplane2=Math.sqrt(dxplane2*dxplane2+dyplane2*dyplane2);
		dxradarplane2=radardist(dxradarplane2);
		if(dxradarplane2*0.015>5.4){mvPopMatrix();return;}
		o1radarplane2=diro1(px-x,py-y);
		if(Math.cos(degtorad(o1radarplane2-o1-o3radar-30+90))>0.8){
		   tradarplane2=tframe;
		}
        if(rotavion(px-x,py-y,pz-z,5)==0){mvPopMatrix();return;}
        //mat4.identity(mvMatrix);
		//mat4.rotate(mvMatrix,degtorad(-o1),[0,0,1]);
		mat4.translate(mvMatrix, [px,py,pz]);
        mat4.rotate(mvMatrix, degtorad(180+po1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-po2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(po3), [1, 0, 0]);
	}else{
	    var dx=Math.sqrt(sunx*sunx+suny*suny+sunzz*sunzz);
		var dz=Math.max(0.0,pz-zsol-3)*10;
		var kz=distshadow*0.5;//*0.705;
    	mat4.translate(mvMatrix,[px+0.25*(1+0.5)*kz-dz*sunx/dx,py+0.25*(1+0.5)*kz-dz*suny/dx,pz]);
    	//mat4.translate(mvMatrix,[px,py,pz]);
		//mat4.rotate(mvMatrix, degtorad(180), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(180+po1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-po2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(po3), [1, 0, 0]);
    }	
	gl.activeTexture(gl.TEXTURE0);
    if(tshadow==0){gl.bindTexture(gl.TEXTURE_2D,  objTexture2);
		mat4.scale(mvMatrix,[0.02,0.02,0.02]);
	}else{
 		mat4.scale(mvMatrix,[0.03,0.03,0.03]);
                   gl.disable(gl.DEPTH_TEST);
	               gl.bindTexture(gl.TEXTURE_2D,  cloudblackTexture);}
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
   if(tshadow==0){	
    gl.bindBuffer(gl.ARRAY_BUFFER, worldVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, worldVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, worldVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, worldVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, worldVertexPositionBuffer.numItems);
   }else{
    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, world2VertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, world2VertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, world2VertexPositionBuffer.numItems);
   }   
		
		mvPopMatrix();
    if(tshadow==1){gl.enable(gl.DEPTH_TEST);};
}
function drawplane2space(){//if(tdogfight==1){drawzero2();return;}
        if(pboom!=0 && tframe>pboom+2000){return;}
        mvPushMatrix();
        var dxplane2=Math.abs(x-px),dyplane2=Math.abs(y-py);
		dxradarplane2=Math.sqrt(dxplane2*dxplane2+dyplane2*dyplane2);
		var dzz=radardistspace(Math.abs(z-pz)+dxradarplane2/2);
		dxradarplane2=radardistspace(dxradarplane2);
		if(dxradarplane2*0.015>5.4){mvPopMatrix();return;}
		if(dzz*0.015>5.4){mvPopMatrix();return;}
		o1radarplane2=diro1(px-x,py-y);
		if(Math.cos(degtorad(o1radarplane2-o1-o3radar-30+90))>0.8){
		   tradarplane2=tframe;
		}
        if(rotavion(px-x,py-y,pz-z,5)==0){mvPopMatrix();return;}
        //mat4.identity(mvMatrix);
		//mat4.rotate(mvMatrix,degtorad(-o1),[0,0,1]);
		mat4.translate(mvMatrix, [px,py,pz]);
        mat4.rotate(mvMatrix, degtorad(90+po1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90-po2), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-po3), [0, 0, 1]);
	
	gl.activeTexture(gl.TEXTURE0);//px=x+280;py=y;pz=z;po1=10;po2=30;po3=40;
    gl.bindTexture(gl.TEXTURE_2D,  spaceshipTexture);
	mat4.scale(mvMatrix,[0.06,0.06,0.06]);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
		drawspaceshipobj();
		mvPopMatrix();
}
function drawzero2(){
        mvPushMatrix();
	if(tshadow==0){	
        var dxplane2=Math.abs(x-px),dyplane2=Math.abs(y-py);
		dxradarplane2=Math.sqrt(dxplane2*dxplane2+dyplane2*dyplane2);
		dxradarplane2=radardist(dxradarplane2);
		if(dxradarplane2*0.015>5.4){mvPopMatrix();return;}
		o1radarplane2=diro1(px-x,py-y);
		if(Math.cos(degtorad(o1radarplane2-o1-o3radar-30+90))>0.8){
		   tradarplane2=tframe;
		}
        if(rotavion(px-x,py-y,pz-z,5)==0){mvPopMatrix();return;}
        //mat4.identity(mvMatrix);
		//mat4.rotate(mvMatrix,degtorad(-o1),[0,0,1]);
		mat4.translate(mvMatrix, [px,py,pz]);
        mat4.rotate(mvMatrix, degtorad(180+po1), [0, 0, 1]);
        //mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
		mat4.rotate(mvMatrix, degtorad(po2), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(po3), [1, 0, 0]);
	}else{
	    var dx=Math.sqrt(sunx*sunx+suny*suny+sunzz*sunzz);
		var dz=Math.max(0.0,pz-zsol-3)*10;
		var kz=distshadow*0.5;//*0.705;
    	mat4.translate(mvMatrix,[px+0.25*(1+0.5)*kz-dz*sunx/dx,py+0.25*(1+0.5)*kz-dz*suny/dx,pz]);
    	//mat4.translate(mvMatrix,[px,py,pz]);
		//mat4.rotate(mvMatrix, degtorad(180), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(180+po1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-po2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(po3), [1, 0, 0]);
    }	
	gl.activeTexture(gl.TEXTURE0);
    if(tshadow==0){gl.bindTexture(gl.TEXTURE_2D,  zeroTexture);
		mat4.scale(mvMatrix,[0.02,0.02,0.02]);
	}else{
 		mat4.scale(mvMatrix,[0.03,0.03,0.03]);
                   gl.disable(gl.DEPTH_TEST);
	               gl.bindTexture(gl.TEXTURE_2D,  cloudblackTexture);}
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
   if(tshadow==0){	
    gl.bindBuffer(gl.ARRAY_BUFFER, zeroVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, worldVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, zeroVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, worldVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, zeroVertexPositionBuffer.numItems);
   }else{
    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, world2VertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, world2VertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, world2VertexPositionBuffer.numItems);
   }   
		
		mvPopMatrix();
    if(tshadow==1){gl.enable(gl.DEPTH_TEST);};
}
var tradarplane3=0,o1radarplane3=0,dxradarplane3=0;
function drawplane3(){//if(tdogfight==1){drawzero3();return;}
        mvPushMatrix();
	if(tshadow==0){	
        var dxplane3=Math.abs(x-p3x),dyplane3=Math.abs(y-p3y);
		dxradarplane3=Math.sqrt(dxplane3*dxplane3+dyplane3*dyplane3);
		dxradarplane3=radardist(dxradarplane3);
		if(dxradarplane3*0.015>5.4){mvPopMatrix();return;}
		o1radarplane3=diro1(p3x-x,p3y-y);
		if(Math.cos(degtorad(o1radarplane3-o1-o3radar-30+90))>0.8){
		   tradarplane3=tframe;
		}
        if(rotavion(p3x-x,p3y-y,p3z-z,5)==0){mvPopMatrix();return;}
        //mat4.identity(mvMatrix);
		//mat4.rotate(mvMatrix,degtorad(-o1),[0,0,1]);
		mat4.translate(mvMatrix, [p3x,p3y,p3z]);
        mat4.rotate(mvMatrix, degtorad(180+p3o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-p3o2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(p3o3), [1, 0, 0]);
	}else{
	    var dx=Math.sqrt(sunx*sunx+suny*suny+sunzz*sunzz);
		var dz=Math.max(0.0,p3z-zsol-3)*10;
		var kz=distshadow*0.5;//*0.705;
    	mat4.translate(mvMatrix,[p3x+0.25*(1+0.5)*kz-dz*sunx/dx,p3y+0.25*(1+0.5)*kz-dz*suny/dx,p3z]);
    	//mat4.translate(mvMatrix,[p3x,p3y,p3z]);
		//mat4.rotate(mvMatrix, degtorad(180), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(180+p3o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-p3o2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(p3o3), [1, 0, 0]);
    }	
	gl.activeTexture(gl.TEXTURE0);
    if(tshadow==0){gl.bindTexture(gl.TEXTURE_2D,  objTexture);
		mat4.scale(mvMatrix,[0.02,0.02,0.02]);
	}else{
 		mat4.scale(mvMatrix,[0.03,0.03,0.03]);
                   gl.disable(gl.DEPTH_TEST);
	               gl.bindTexture(gl.TEXTURE_2D,  cloudblackTexture);}
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
   if(tshadow==0){	
    gl.bindBuffer(gl.ARRAY_BUFFER, worldVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, worldVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, worldVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, worldVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    colorb=0.05;
    setMatrixUniforms(); 
	colorb=1;
    gl.drawArrays(gl.TRIANGLES, 0, worldVertexPositionBuffer.numItems);
   }else{
    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, world2VertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, world2VertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	setMatrixUniforms();
	gl.drawArrays(gl.TRIANGLES, 0, world2VertexPositionBuffer.numItems);
   }   
		
		mvPopMatrix();
    if(tshadow==1){gl.enable(gl.DEPTH_TEST);};
}
function drawzero3(){
        mvPushMatrix();
	if(tshadow==0){	
        var dxplane3=Math.abs(x-p3x),dyplane3=Math.abs(y-p3y);
		dxradarplane3=Math.sqrt(dxplane3*dxplane3+dyplane3*dyplane3);
		dxradarplane3=radardist(dxradarplane3);
		if(dxradarplane3*0.015>5.4){mvPopMatrix();return;}
		o1radarplane3=diro1(p3x-x,p3y-y);
		if(Math.cos(degtorad(o1radarplane3-o1-o3radar-30+90))>0.8){
		   tradarplane3=tframe;
		}
        if(rotavion(p3x-x,p3y-y,p3z-z,5)==0){mvPopMatrix();return;}
        //mat4.identity(mvMatrix);
		//mat4.rotate(mvMatrix,degtorad(-o1),[0,0,1]);
		mat4.translate(mvMatrix, [p3x,p3y,p3z]);
        mat4.rotate(mvMatrix, degtorad(180+p3o1), [0, 0, 1]);
        //mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(p3o2), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(p3o3), [1, 0, 0]);
	}else{
	    var dx=Math.sqrt(sunx*sunx+suny*suny+sunzz*sunzz);
		var dz=Math.max(0.0,p3z-zsol-3)*10;
		var kz=distshadow*0.5;//*0.705;
    	mat4.translate(mvMatrix,[p3x+0.25*(1+0.5)*kz-dz*sunx/dx,p3y+0.25*(1+0.5)*kz-dz*suny/dx,p3z]);
    	//mat4.translate(mvMatrix,[p3x,p3y,p3z]);
		//mat4.rotate(mvMatrix, degtorad(180), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(180+p3o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-p3o2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(p3o3), [1, 0, 0]);
    }	
	gl.activeTexture(gl.TEXTURE0);
    if(tshadow==0){gl.bindTexture(gl.TEXTURE_2D,  zeroTexture);
		mat4.scale(mvMatrix,[0.02,0.02,0.02]);
	}else{
 		mat4.scale(mvMatrix,[0.03,0.03,0.03]);
                   gl.disable(gl.DEPTH_TEST);
	               gl.bindTexture(gl.TEXTURE_2D,  cloudblackTexture);}
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
   if(tshadow==0){	
    gl.bindBuffer(gl.ARRAY_BUFFER, zeroVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, worldVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, zeroVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, worldVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    //colorb=0.05;
    setMatrixUniforms(); 
	//colorb=1;
    gl.drawArrays(gl.TRIANGLES, 0, zeroVertexPositionBuffer.numItems);
   }else{
    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, world2VertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, world2VertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	setMatrixUniforms();
	gl.drawArrays(gl.TRIANGLES, 0, world2VertexPositionBuffer.numItems);
   }   
		
		mvPopMatrix();
    if(tshadow==1){gl.enable(gl.DEPTH_TEST);};
}

var tpiste=0,tradarpiste=0,o1radarpiste=0,dxradarpiste=0;
var tradardist=0;
function radardist(dx){return 1000*dx/(1000+dx);}
function radardistspace(dx){
if(dx<400){tradardist=tframe+2000;}
if(tframe<tradardist){return 1000*dx/(1500+dx);}
return 1000*dx/(20000+dx);}
function drawpiste(){
	tpiste=0;
	if(tgmap==1){
	  var h=getterrainheight(x,y);
	  if(Math.abs(h-getterrainheight(x+2,y))<0.1){
	   if(Math.abs(h-getterrainheight(x,y+2))<0.1){
	     tpiste=1;}}
	}
    var dxpiste=Math.abs(x-pistex),dypiste=Math.abs(y-pistey);
	var dxmax=distmap2;
		dxradarpiste=Math.sqrt(dxpiste*dxpiste+dypiste*dypiste);
		dxradarpiste=radardist(dxradarpiste);
		if(dxradarpiste*0.015>5.4){return;}
		o1radarpiste=diro1(pistex-x,pistey-y);
		if(Math.cos(degtorad(o1radarpiste-o1-o3radar-30+90))>0.8){
		   tradarpiste=tframe;
		}
        if(dxpiste>dxmax){return;}
        if(dypiste>dxmax){return;}
		if(x>(pistex+45.5-98) && x<(pistex+45.5)){
       	  if(dypiste<7){tpiste=1;if(vplane<0.002 && vie<50){vie+=dtime*0.003};};}
        mvPushMatrix();
        //mat4.identity(mvMatrix);
		//mat4.rotate(mvMatrix,degtorad(-o1),[0,0,1]);
		/*mat4.translate(mvMatrix, [px,py,pz]);
        mat4.rotate(mvMatrix, degtorad(180+po1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-po2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(po3), [1, 0, 0]);
		mat4.scale(mvMatrix,[0.02,0.02,0.02]);*/
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  pisteTexture);
    gl.uniform1i(solProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, pisteVertexTextureCoordBuffer);
    gl.vertexAttribPointer(solProgram.textureCoordAttribute, pisteVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, pisteVertexPositionBuffer);
    gl.vertexAttribPointer(solProgram.vertexPositionAttribute, pisteVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniformspiste(); 
    gl.drawArrays(gl.TRIANGLES, 0, pisteVertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
var tradarwater=0,o1radarwater=0,dxradarwater=0;
var seax=0,seay=0,seaz=0;
function drawsea(){
        mvPushMatrix();
		//mat4.translate(mvMatrix, [seax,seay,seaz]);
        //mat4.rotate(mvMatrix, degtorad(90+o1), [0, 0, 1]);
		//mat4.translate(mvMatrix, [-seax,-seay,-seaz]);
	gl.activeTexture(gl.TEXTURE0);
    if(tsea==1){gl.bindTexture(gl.TEXTURE_2D,  waterTexture);
    }else{gl.bindTexture(gl.TEXTURE_2D,  seaTexture);}
	gl.uniform1i(solProgram.samplerUniform, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, seaVertexTextureCoordBuffer);
    gl.vertexAttribPointer(solProgram.textureCoordAttribute, seaVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, seaVertexPositionBuffer);
    gl.vertexAttribPointer(solProgram.vertexPositionAttribute, seaVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniformssea(); 
    gl.drawArrays(gl.TRIANGLES, 0, seaVertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
function drawwater(){
        var waterxx=waterx-x,wateryy=watery-y;x-dxmaxmin2
		if(waterxx<-dxmaxmin2){waterxx+=xmax-xmin;}
		if(waterxx>dxmaxmin2){waterxx-=xmax-xmin;}
		if(wateryy<-dymaxmin2){wateryy+=ymax-ymin;}
		if(wateryy>dymaxmin2){wateryy-=ymax-ymin;}
    //var dxwater=Math.abs(x-waterx),dywater=Math.abs(y-watery);
      var dxwater=shipx-x,dywater=shipy-y;		
		dxradarwater=Math.sqrt(dxwater*dxwater+dywater*dywater);
		dxradarwater=radardist(dxradarwater);
		if(dxradarwater*0.015>5.4){return;}
		o1radarwater=diro1(dxwater,dywater);
		if(Math.cos(degtorad(o1radarwater-o1-o3radar-30+90))>0.8){
		   tradarwater=tframe;
		}
        if(Math.abs(waterxx)>(-80+distmap2)){return;}
        if(Math.abs(wateryy)>(-80+distmap2)){return;}
        mvPushMatrix();
	gl.activeTexture(gl.TEXTURE0);
    if(tsea<2){gl.bindTexture(gl.TEXTURE_2D,  waterTexture);
    }else{gl.bindTexture(gl.TEXTURE_2D,  seaTexture);}
	gl.uniform1i(solProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, waterVertexTextureCoordBuffer);
    gl.vertexAttribPointer(solProgram.textureCoordAttribute, waterVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, waterVertexPositionBuffer);
    gl.vertexAttribPointer(solProgram.vertexPositionAttribute, waterVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniformspiste(); 
    gl.drawArrays(gl.TRIANGLES, 0, waterVertexPositionBuffer.numItems);

	mvPopMatrix();
}
var shipx=waterx,shipy=watery+(Math.random()-0.5)*50,shipz=0;
var shipo1=Math.random()*80,shipco1=1,shipsi1=0;
var tshipo1=0,tshipo2=0,tshiptir=0,shipvie=100;
function tirship(){
var v=(2.92)*(1+(Math.random()-0.5)*0.2);
var vx=v*Math.cos(degtorad(tshipo1))*Math.cos(degtorad(tshipo2));
var vy=v*Math.sin(degtorad(tshipo1))*Math.cos(degtorad(tshipo2));
var vz=v*Math.sin(degtorad(tshipo2));
addtir(shipx,shipy,shipz+3,vx,vy,vz,1);
}
function drawship(){
    if(shipvie<100){shipvie+=Math.random()*dtime*0.0004;};
	if(shipvie<-100){shipvie=-99;}
	shipco1=Math.cos(degtorad(shipo1));
	shipsi1=Math.sin(degtorad(shipo1));
    shipx+=dtime*0.0015*shipco1;
    shipy+=dtime*0.0015*shipsi1;
	var distship2=((shipx-waterx)*(shipx-waterx)+(shipy-watery)*(shipy-watery));
	if(distship2>95*95){
	  var do1=shipo1-diro1(waterx-shipx,watery-shipy);
	  while(do1<-180){do1+=360;};
	  while(do1>180){do1-=360;};
	  if(Math.abs(do1)>35){shipo1+=0.02*dtime*(1+Math.random());};
	}
	    var dx=x-shipx,dy=y-shipy;
        if(Math.abs(dx)>(distmap2)){return;}
        if(Math.abs(dy)>(distmap2)){return;}
     	if(shipvie<0 && Math.random()<dtime*0.0025){addsmoke(shipx,shipy,shipz+1.4,3.5,1);}
		if(tframe<tattack2+120000){
		   var distxy=Math.sqrt(dx*dx+dy*dy);
		   dx+=vplane*cos1*distxy/80;dy+=vplane*sin1*distxy/80;
		   var do1=tshipo1-diro1(dx,dy)+(Math.random()-0.5)*5;
		   var do2=tshipo2-diro1(distxy,z-(shipz+3))+(Math.random()-0.5)*5;
		   do1+=dirtir*3;
		   while(do1<-180){do1+=360;};
	       while(do1>180){do1-=360;};
		   while(do2<-180){do2+=360;};
	       while(do2>180){do2-=360;};
		   var v=1+Math.random()*0.5;
		   if(do1>0){tshipo1-=dtime*0.03*v;}else{tshipo1+=dtime*0.03*v;}
		   if(do2>0){tshipo2-=dtime*0.03*v;}else{tshipo2+=dtime*0.03*v;}
		   if(tshipo2>80){tshipo2=80;}
		   if(tshipo2<-80){tshipo2=-80;}
		   if(tframe>(tshiptir+500) && distxy<240){tshiptir=tframe;
		          if(Math.abs(do1)<40 && Math.abs(do2)<40){tirship();};};
		}
		if(rotavion(shipx-x,shipy-y,shipz-z,12)){
		mvPushMatrix();
		mat4.translate(mvMatrix, [shipx,shipy,shipz]);
        mat4.rotate(mvMatrix, degtorad(shipo1), [0, 0, 1]);
		mat4.scale(mvMatrix,[0.065,0.065,0.065]);
 	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  shipTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, shipVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, shipVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, shipVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, shipVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, shipVertexPositionBuffer.numItems);
		
		mvPopMatrix();
	}
}
var shipcarrierx=(Math.random())*1000;
var shipcarriery=0.7*ymax+Math.random()*300,shipcarrierz=0;
var shipcarriero1=Math.random()*40-20,shipcarrierco1=1,shipcarriersi1=0;
var tshipcarriero1=0,tshipcarriero2=0,tshipcarriertir=0,shipcarriervie=100;
function tirshipcarrier(){
var v=(2.2)*(1+(Math.random()-0.5)*0.2);
var vx=v*Math.cos(degtorad(tshipcarriero1))*Math.cos(degtorad(tshipcarriero2));
var vy=v*Math.sin(degtorad(tshipcarriero1))*Math.cos(degtorad(tshipcarriero2));
var vz=v*Math.sin(degtorad(tshipcarriero2));
addtir(shipcarrierx,shipcarriery,shipcarrierz+3,vx,vy,vz,1);
}
var tcarrier=0,tradarcarrier=0,o1radarcarrier=0,dxradarcarrier=0;
function resetcarrier(){
  if(Math.abs(shipcarrierx-x)>700){shipcarrierx=x+400*Math.random();}
  if(Math.abs(shipcarriery-y)>700){shipcarriery=y+400*Math.random();}
  shipcarrierco1=Math.cos(degtorad(shipcarriero1));
  shipcarriersi1=Math.sin(degtorad(shipcarriero1));
  for(var i=0;i<250;i++){
	if(getterrainheight(shipcarrierx+20*shipcarrierco1-9*shipcarriersi1,shipcarriery+20*shipcarriersi1+9*shipcarrierco1)<0){break;}
	if(getterrainheight(shipcarrierx+20*shipcarrierco1+9*shipcarriersi1,shipcarriery+20*shipcarriersi1-9*shipcarrierco1)<0){break;}     
    shipcarrierx+=40*(shipcarrierco1+Math.random());
	shipcarriery+=40*shipcarriersi1;
	if(shipcarrierx>xmax-200){shipcarrierx-=(xmax-xmin-400);}
	if(shipcarrierx<xmin+200){shipcarrierx+=(xmax-xmin-400);}
	if(shipcarriery>ymax-200){shipcarriery-=(ymax-ymin-400);}
	if(shipcarriery<ymin+200){shipcarriery+=(ymax-ymin-400);}
  }
}
var shipcarrierturn=0;
function moveshipcarrier(){
    if(shipcarriervie<100){shipcarriervie+=Math.random()*dtime*0.0004;};
    if(shipcarriervie<-100){shipcarriervie=-99;}
	shipcarrierco1=Math.cos(degtorad(shipcarriero1));
	shipcarriersi1=Math.sin(degtorad(shipcarriero1));
    shipcarrierx+=dtime*0.0015*shipcarrierco1;
    shipcarriery+=dtime*0.0015*shipcarriersi1;
	shipcarrierz=getterrainheight(shipcarrierx,shipcarriery);
	if(landing==0){tcarrier=0;}
	if(tcarrier==1){
      x+=dtime*0.0015*shipcarrierco1;
      y+=dtime*0.0015*shipcarriersi1;
	  if(vplane<0.002 && vie<50){vie+=dtime*0.003}
	}
    var do1=0;
	var dh1=getterrainheight(shipcarrierx+20*shipcarrierco1-9*shipcarriersi1,shipcarriery+20*shipcarriersi1+9*shipcarrierco1);
    var dh2=getterrainheight(shipcarrierx+20*shipcarrierco1+9*shipcarriersi1,shipcarriery+20*shipcarriersi1-9*shipcarrierco1);
	if(dh1>0){
      if(shipcarrierturn<340){
	   do1=-0.01*dtime*(1+Math.random());
	   shipcarrierturn-=do1;}
    }else{
	  shipcarrierturn=0;
	  if(dh2>0){do1=0.01*dtime*(1+Math.random());}
    }
    if(tgmap==0){
	 if(shipcarrierx<(xmin+200) || shipcarrierx>(xmax-200)){do1=-0.01*dtime*(1+Math.random());}
     if(shipcarriery<(ymin+200) || shipcarriery>(ymax-200)){do1=-0.01*dtime*(1+Math.random());}
	}
	if(Math.abs(do1)>0.0001){
	  shipcarriero1+=do1;
	  if(tcarrier==1){o1+=do1;var si1=Math.sin(degtorad(do1));
	                  var dx=x-shipcarrierx,dy=y-shipcarriery;
		              x+=-dy*si1;y+=dx*si1;}
	}
	tcarrier=0;
}
function drawshipcarrier(){
    if(shipcarrierz>0){tradarcarrier=0;return;}
    var dxcarrier=shipcarrierx-x,dycarrier=shipcarriery-y;		
	dxradarcarrier=Math.sqrt(dxcarrier*dxcarrier+dycarrier*dycarrier);
	dxradarcarrier=radardist(dxradarcarrier);
	if(dxradarcarrier*0.015>5.4){return;}
	o1radarcarrier=diro1(dxcarrier,dycarrier);
	if(Math.cos(degtorad(o1radarcarrier-o1-o3radar-30+90))>0.8){
	   tradarcarrier=tframe;
	}
	    var dx=x-shipcarrierx,dy=y-shipcarriery;
        if(Math.abs(dx)>(distmap2)){return;}
        if(Math.abs(dy)>(distmap2)){return;}
     	if(shipcarriervie<0 && Math.random()<dtime*0.0025){addsmoke(shipcarrierx,shipcarriery,shipcarrierz+1.4,3.5,1);}
		if(tframe<tattack3+120000){
		   var distxy=Math.sqrt(dx*dx+dy*dy);
		   dx+=vplane*cos1*distxy/80;dy+=vplane*sin1*distxy/80;
		   var do1=tshipcarriero1-diro1(dx,dy)+(Math.random()-0.5)*5;
		   var do2=tshipcarriero2-diro1(distxy,z-(shipcarrierz+3))+(Math.random()-0.5)*5;
		   while(do1<-180){do1+=360;};
	       while(do1>180){do1-=360;};
		   while(do2<-180){do2+=360;};
	       while(do2>180){do2-=360;};
		   var v=1+Math.random()*0.5;
		   if(do1>0){tshipcarriero1-=dtime*0.03*v;}else{tshipcarriero1+=dtime*0.03*v;}
		   if(do2>0){tshipcarriero2-=dtime*0.03*v;}else{tshipcarriero2+=dtime*0.03*v;}
		   if(tshipcarriero2>80){tshipcarriero2=80;}
		   if(tshipcarriero2<-80){tshipcarriero2=-80;}
		   if(tframe>(tshipcarriertir+500) && distxy<240){tshipcarriertir=tframe;
		          if(Math.abs(do1)<40 && Math.abs(do2)<40){tirshipcarrier();};};
		}
		mvPushMatrix();
		mat4.translate(mvMatrix, [shipcarrierx,shipcarriery,shipcarrierz]);
        mat4.rotate(mvMatrix, degtorad(shipcarriero1), [0, 0, 1]);
		mat4.translate(mvMatrix, [0,1,0]);
		mat4.scale(mvMatrix,[0.17,0.17,0.17]);
 	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  shipcarrierTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, shipcarrierVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, shipcarrierVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, shipcarrierVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, shipcarrierVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
	setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, shipcarrierVertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
var nsailship=5;
var psailshipx=new Array(nsailship);
var psailshipy=new Array(nsailship),psailshipz=new Array(nsailship);
var psailshipo1=new Array(nsailship),psailshipco1=new Array(nsailship),psailshipsi1=new Array(nsailship);
var tpsailshipo1=new Array(nsailship),psailshipvie=new Array(nsailship);
function getpsailship(i){
   sailshipx=psailshipx[i]; 
   sailshipy=psailshipy[i]; 
   sailshipz=psailshipz[i]; 
   sailshipo1=psailshipo1[i]; 
   sailshipco1=psailshipco1[i]; 
   sailshipsi1=psailshipsi1[i]; 
   tsailshipo1=tpsailshipo1[i]; 
   sailshipvie=psailshipvie[i];
}	 
function setpsailship(i){
   psailshipx[i]=sailshipx; 
   psailshipy[i]=sailshipy; 
   psailshipz[i]=sailshipz; 
   psailshipo1[i]=sailshipo1; 
   psailshipco1[i]=sailshipco1; 
   psailshipsi1[i]=sailshipsi1; 
   tpsailshipo1[i]=tsailshipo1; 
   psailshipvie[i]=sailshipvie;
}
function resetsailships(){
  for(var i=0;i<nsailship;i++){
     getpsailship(i);
	 resetsailship();
	 setpsailship(i);}
}
function movesailships(){
  for(var i=0;i<nsailship;i++){
	 getpsailship(i);
	 movesailship();
	 setpsailship(i);}
}
function drawsailships(){
  for(var i=0;i<nsailship;i++){
	 getpsailship(i);
	 movesailship();
	 drawsailship();
	 setpsailship(i);}
}
var sailshipx=(Math.random())*1000;
var sailshipy=0.7*ymax+Math.random()*300,sailshipz=0;
var sailshipo1=Math.random()*40-20,sailshipco1=1,sailshipsi1=0;
var tsailshipo1=0,sailshipvie=100;
for(var i=0;i<nsailship;i++){
    sailshipx+=50*Math.random();
	sailshipy+=50*Math.random();setpsailship(i);}
function resetsailship(){
  if(Math.abs(sailshipx-x)>300){sailshipx=x+100*Math.random();}
  if(Math.abs(sailshipy-y)>300){sailshipy=y+100*Math.random();}
  sailshipco1=Math.cos(degtorad(sailshipo1));
  sailshipsi1=Math.sin(degtorad(sailshipo1));
  for(var i=0;i<250;i++){
	if(getterrainheight(sailshipx+10*sailshipco1-5*sailshipsi1,sailshipy+10*sailshipsi1+5*sailshipco1)<0){break;}
	if(getterrainheight(sailshipx+10*sailshipco1+5*sailshipsi1,sailshipy+10*sailshipsi1-5*sailshipco1)<0){break;}     
    sailshipx+=40*sailshipco1;
	sailshipy+=40*sailshipsi1;
	if(sailshipx>xmax-200){sailshipx-=(xmax-xmin-400);}
	if(sailshipx<xmin+200){sailshipx+=(xmax-xmin-400);}
	if(sailshipy>ymax-200){sailshipy-=(ymax-ymin-400);}
	if(sailshipy<ymin+200){sailshipy+=(ymax-ymin-400);}
  }
}
function movesailship(){
    if(sailshipvie<100){sailshipvie+=Math.random()*dtime*0.0004;};
    if(sailshipvie<-100){sailshipvie=-99;}
	var distmax=700;
	var dx0=x-x0,dy0=y-y0;
	if((Math.abs(dx0)+Math.abs(dy0))>distmax){
	    sailshipx+=dx0;sailshipy+=dy0;}
	while(sailshipx<(x-distmax)){sailshipx+=1.9999*distmax;}
	while(sailshipx>(x+distmax)){sailshipx-=1.9999*distmax;}
	while(sailshipy<(y-distmax)){sailshipy+=1.9999*distmax;}
	while(sailshipy>(y+distmax)){sailshipy-=1.9999*distmax;}	
	sailshipco1=Math.cos(degtorad(sailshipo1));
	sailshipsi1=Math.sin(degtorad(sailshipo1));
    sailshipx+=dtime*0.001*sailshipco1;
    sailshipy+=dtime*0.001*sailshipsi1;
	sailshipz=getterrainheight(sailshipx,sailshipy);
    var do1=0;
	var dh1=getterrainheight(sailshipx+10*sailshipco1-5*sailshipsi1,sailshipy+10*sailshipsi1+5*sailshipco1);
    var dh2=getterrainheight(sailshipx+10*sailshipco1+5*sailshipsi1,sailshipy+10*sailshipsi1-5*sailshipco1);
	if(dh1>0){
	  do1=-0.01*dtime*(1+Math.random());
    }else{
	  if(dh2>0){do1=0.01*dtime*(1+Math.random());}
    }
    if(sailshipx<(xmin+100) || sailshipx>(xmax-100)){sailshipo1=diro1(pistex-sailshipx,pistey-sailshipy);}
    if(sailshipy<(ymin+100) || sailshipy>(ymax-100)){sailshipo1=diro1(pistex-sailshipx,pistey-sailshipy);}
	if(Math.abs(do1)>0.0001){
	  sailshipo1+=do1;
	}
}
function drawsailship(){
        if(sailshipz>=0){return;}
	    var dx=x-sailshipx,dy=y-sailshipy;	  
        if(Math.abs(dx)>(distmap2)){return;}
        if(Math.abs(dy)>(distmap2)){return;}
		if(getterrainheight(sailshipx,sailshipy)>0){
		   if(sailshipx>xmin && sailshipx<xmax && sailshipy>ymin && sailshipy<ymax){
		      return;};}
     	if(sailshipvie<0 && Math.random()<dtime*0.0025){addsmoke(sailshipx,sailshipy,sailshipz+1.4,3.5,1);}
		if(rotavion(sailshipx-x,sailshipy-y,sailshipz-z,12)){
		mvPushMatrix();
		mat4.translate(mvMatrix, [sailshipx,sailshipy,sailshipz-0.1]);
        mat4.rotate(mvMatrix, degtorad(sailshipo1), [0, 0, 1]);
		mat4.scale(mvMatrix,[0.05,0.05,0.05]);
 	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  sailshipTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, sailshipVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, sailshipVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, sailshipVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, sailshipVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, sailshipVertexPositionBuffer.numItems);
		
		mvPopMatrix();
		}
}
var ntank=4;
var ptankx=new Array(ntank);
var ptanky=new Array(ntank),ptankz=new Array(ntank);
var ptanko1=new Array(ntank),ptankco1=new Array(ntank),ptanksi1=new Array(ntank);
var tptanko1=new Array(ntank),ptankvie=new Array(ntank);
function getptank(i){
   tankx=ptankx[i]; 
   tanky=ptanky[i]; 
   tankz=ptankz[i]; 
   tanko1=ptanko1[i]; 
   tankco1=ptankco1[i]; 
   tanksi1=ptanksi1[i]; 
   ttanko1=tptanko1[i]; 
   tankvie=ptankvie[i];
}	 
function setptank(i){
   ptankx[i]=tankx; 
   ptanky[i]=tanky; 
   ptankz[i]=tankz; 
   ptanko1[i]=tanko1; 
   ptankco1[i]=tankco1; 
   ptanksi1[i]=tanksi1; 
   tptanko1[i]=ttanko1; 
   ptankvie[i]=tankvie;
}
function resettanks(){
  for(var i=0;i<ntank;i++){
     getptank(i);
	 resettank();
	 setptank(i);}
}
function movetanks(){
  for(var i=0;i<ntank;i++){
	 getptank(i);
	 movetank();
	 setptank(i);}
}
function drawtanks(){
  for(var i=0;i<ntank;i++){
	 getptank(i);
	 movetank();
	 drawtank();
	 setptank(i);}
}
var tankx=(Math.random())*1000;
var tanky=0.7*ymax+Math.random()*300,tankz=0;
var tanko1=Math.random()*40-20,tankco1=1,tanksi1=0;
var ttanko1=0,tankvie=100;
for(var i=0;i<ntank;i++){
    tankx+=50*Math.random();
	tanky+=50*Math.random();setptank(i);}
function resettank(){
  if(Math.abs(tankx-x)>300){tankx=x+100*Math.random();}
  if(Math.abs(tanky-y)>300){tanky=y+100*Math.random();}
  tankco1=Math.cos(degtorad(tanko1));
  tanksi1=Math.sin(degtorad(tanko1));
  for(var i=0;i<250;i++){
	if(getterrainheight(tankx+10*tankco1-5*tanksi1,tanky+10*tanksi1+5*tankco1)>0){break;}
	if(getterrainheight(tankx+10*tankco1+5*tanksi1,tanky+10*tanksi1-5*tankco1)>0){break;}     
    tankx+=40*tankco1;
	tanky+=40*tanksi1;
	if(tankx>xmax-200){tankx-=(xmax-xmin-400);}
	if(tankx<xmin+200){tankx+=(xmax-xmin-400);}
	if(tanky>ymax-200){tanky-=(ymax-ymin-400);}
	if(tanky<ymin+200){tanky+=(ymax-ymin-400);}
  }
}
function movetank(){
    if(tankvie<100){tankvie+=Math.random()*dtime*0.0001;};
    if(tankvie<-200){tankvie=-199;}
	var distmax=700-100;
	while(tankx<(x-distmax)){tankx+=1.9999*distmax;tankvie=100;}
	while(tankx>(x+distmax)){tankx-=1.9999*distmax;tankvie=100;}
	while(tanky<(y-distmax)){tanky+=1.9999*distmax;tankvie=100;}
	while(tanky>(y+distmax)){tanky-=1.9999*distmax;tankvie=100;}	
	tankco1=Math.cos(degtorad(tanko1));
	tanksi1=Math.sin(degtorad(tanko1));
    var tankv=Math.max(0,(tankvie+20)*1.1/(10+Math.abs(tankvie+20)))
	tankx+=dtime*0.002*tankco1*tankv;
    tanky+=dtime*0.002*tanksi1*tankv;
	var do1=0,z0=-0.11+0.05;
	var dh0=getterrainheight(tankx+5*tankco1,tanky+5*tanksi1);
	if(dh0<z0){
	 var dh1=getterrainheight(tankx+5*tankco1-3*tanksi1,tanky+5*tanksi1+3*tankco1);
     var dh2=getterrainheight(tankx+5*tankco1+3*tanksi1,tanky+5*tanksi1-3*tankco1);
	 if(dh1<z0 && dh2>z0){
	  do1=-0.01*dtime*(1+Math.random());
     }else if(dh2<z0 && dh1>z0){do1=0.01*dtime*(1+Math.random());
     }else if(getterrainheight(tankx-3*tanksi1,tanky+3*tankco1)>z0){
          do1=0.01*dtime*(1+Math.random());
     }else if(getterrainheight(tankx+3*tanksi1,tanky-3*tankco1)>z0){
          do1=-0.01*dtime*(1+Math.random());
    }}else{	
    if(tgmap==0 || nairport==0 || iairport<0){
	 if(tankx<(xmin+220) || tankx>(xmax-220)){tanko1=diro1(pistex-tankx,pistey-tanky);}
     if(tanky<(ymin+220) || tanky>(ymax-220)){tanko1=diro1(pistex-tankx,pistey-tanky);}
	}else{
	 if(tankx<(xmin+220) || tankx>(xmax-220)){tanko1=diro1(portx-tankx,porty-tanky);}
     else if(tanky<(ymin+220) || tanky>(ymax-220)){tanko1=diro1(portx-tankx,porty-tanky);}
	 else if(Math.random()<dtime*0.00005){tanko1=diro1((portx+x)/2-tankx,(porty+y)/2-tanky);}
	}}
	if(Math.abs(do1)>0.0001){
	  tanko1+=do1;
	}
}
function drawtank(){
	    var dx=x-tankx,dy=y-tanky;	  
        if(Math.abs(dx)>(100+distmap2)){return;}
        if(Math.abs(dy)>(100+distmap2)){return;}
        tankz=getterrainheight1(tankx,tanky);
		if(tankz<-0.11+0.05){
		   //if(tankx>xmin && tankx<xmax && tanky>ymin && tanky<ymax){
		      return;};//}
     	if(tankvie<0 && Math.random()<dtime*0.0025){addsmoke(tankx,tanky,tankz+1.4,3.5,1);}
		if(rotavion(tankx-x,tanky-y,tankz-z,12)){
		mvPushMatrix();
		mat4.translate(mvMatrix, [tankx,tanky,tankz-0.1]);
        mat4.rotate(mvMatrix, degtorad(90+tanko1), [0, 0, 1]);
		mat4.scale(mvMatrix,[0.03,0.03,0.03]);
 	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  tankTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, tankVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, tankVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, tankVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, tankVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, tankVertexPositionBuffer.numItems);
		
		mvPopMatrix();
		}
}
function drawtower(){
        //if(Math.abs(x-dxmaxmin2)>(distmap2)){return;}
        //if(Math.abs(y-dymaxmin2)>(distmap2)){return;}
        mvPushMatrix();
	gl.activeTexture(gl.TEXTURE0);
    if(hour>6 && hour<18){gl.bindTexture(gl.TEXTURE_2D,  towerTexture);
    }else{gl.bindTexture(gl.TEXTURE_2D,  towernightTexture);}
	gl.uniform1i(solProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, towerVertexTextureCoordBuffer);
    gl.vertexAttribPointer(solProgram.textureCoordAttribute, towerVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, towerVertexPositionBuffer);
    gl.vertexAttribPointer(solProgram.vertexPositionAttribute, towerVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniformspiste(); 
    gl.uniform1i(solProgram.type, 5);
    gl.drawArrays(gl.TRIANGLES, 0, towerVertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
var tradartown=0,o1radartown=0,dxradartown=0;
var townxx=(xmax-xmin)*0.7;
var townyy=(ymax-ymin)*0.7;
function getheighttown(px,py){
if(Math.abs(townxx-px)>90){return -1;}
if(Math.abs(townyy-py)>90){return -1;}
var h=-1;
for(var i=0;i<ntown;i++){
   if(Math.abs(townx[i]-px)<towndx[i]){
     if(Math.abs(towny[i]-py)<towndx[i]){
	   if(h<townz[i]){h=townz[i];};
	 }
   }
}
return h;
}
function drawtown(){
    //var townxx=(xmax-xmin)*0.7,townyy=(ymax-ymin)*0.7;
    var dxtown=Math.abs(x-townxx),dytown=Math.abs(y-townyy);
		dxradartown=Math.sqrt(dxtown*dxtown+dytown*dytown);
		dxradartown=radardist(dxradartown);
		if(dxradartown*0.015>5.4){return;}
		o1radartown=diro1(townxx-x,townyy-y);
		if(Math.cos(degtorad(o1radartown-o1-o3radar-30+90))>0.8){
		   tradartown=tframe;
		}
        if(Math.abs(x-townxx)>(-40+distmap2)){return;}
        if(Math.abs(y-townyy)>(-40+distmap2)){return;}
        mvPushMatrix();
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  towerTexture);
    gl.uniform1i(solProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, townVertexTextureCoordBuffer);
    gl.vertexAttribPointer(solProgram.textureCoordAttribute, townVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, townVertexPositionBuffer);
    gl.vertexAttribPointer(solProgram.vertexPositionAttribute, townVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniformstown(); 
    gl.drawArrays(gl.TRIANGLES, 0, townVertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
var nroc=70,rocx=new Array(nroc),rocy=new Array(nroc),rocz=new Array(nroc);
var roco1=new Array(nroc),roco2=new Array(nroc),roco3=new Array(nroc);
var rocscale=new Array(nroc),roch=new Array(nroc);
function initroc(){
for(var i=0;i<nroc;i++){
   rocx[i]=-999+Math.random()*400;rocy[i]=-999+Math.random()*400;rocz[i]=0.15;
   roco1[i]=Math.random()*360;roco2[i]=Math.random()*360;roco3[i]=Math.random()*360;
   rocscale[i]=0.17+0.2*Math.random();
   roch[i]=2.7*rocscale[i]*(-0.35+0.5*Math.random());
   }
}
initroc(); 
var testroc=0;  
function drawroc(){
 	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  rocTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, rocVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, rocVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, rocVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, rocVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms(); 
var distmax=70;
for(var i=0;i<nroc;i++){		
		var test=testroc;
		while(rocx[i]<(x-distmax)){rocx[i]+=distmax*1.99999;test=1;};
		while(rocx[i]>(x+distmax)){rocx[i]-=distmax*1.99999;test=1;};
		while(rocy[i]<(y-distmax)){rocy[i]+=distmax*1.99999;test=1;};
		while(rocy[i]>(y+distmax)){rocy[i]-=distmax*1.99999;test=1;};
		var d=rocscale[i]*1.8+Math.min(roch[i]*0.8,0);
		if(Math.abs(rocx[i]-x)<d){
		   if(Math.abs(rocy[i]-y)<d){
		      if(rocz[i]>=0.015){tcollide=1;};};}
		if(test==1){rocz[i]=getterrainheight(rocx[i],rocy[i]);
		  if(rocz[i]<-0.1 || rocz[i]>40+zsolmin){rocz[i]=-999;}
		  else if(Math.abs(portx-rocx[i])<(xmax-xmin)/8){
			       if(Math.abs(porty-rocy[i])<(ymax-ymin)/8){rocz[i]=-999;}}
          if(Math.abs(townxx-rocx[i])<90){
           if(Math.abs(townyy-rocy[i])<90){rocz[i]=-999;};}
       	  if(Math.abs(rocy[i]-pistey)<14){
   		   if(rocx[i]>(pistex+45.5-98-7) && rocx[i]<(pistex+45.5+7)){
              rocz[i]=-999;};}
		}
		var r=3*rocscale[i];	  
    	if(rocz[i]>0.015 && rotavion(rocx[i]-x,rocy[i]-y,rocz[i]-z,r)){  
		mvPushMatrix();
		if(tshadow==0){mat4.translate(mvMatrix, [rocx[i],rocy[i],rocz[i]+roch[i]]);
        }else{mat4.translate(mvMatrix, [rocx[i],rocy[i],zsol]);}
		mat4.rotate(mvMatrix, degtorad(roco1[i]), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(roco2[i]), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(roco3[i]), [1, 0, 0]);
		var sc=rocscale[i]*0.015;
		mat4.scale(mvMatrix,[sc,sc,sc]);
    
    gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, mvMatrix);
    gl.drawArrays(gl.TRIANGLES, 0, rocVertexPositionBuffer.numItems);
		
		mvPopMatrix();
    }
 }
 testroc=0;
}
var treetype=0,treetypez=0,ttreetype=0;
function drawtree(){
if(Math.abs(treetypez-zsol)>20 || tframe>ttreetype){
 treetypez=zsol;ttreetype=tframe+4000;
 if(zsol>(60+4*(50-Math.abs(lat))) || Math.abs(lat)>65){treetype=1;}//pine
 else if(zsol>4*(20-Math.abs(lat))){treetype=0;}//chene
 else{treetype=2;}//tropical
}
        mvPushMatrix();
	gl.activeTexture(gl.TEXTURE5);
    if(treetype==1){gl.bindTexture(gl.TEXTURE_2D,  treeTexture);
    }else if(treetype==0){gl.bindTexture(gl.TEXTURE_2D,  tree2Texture);
    }else{gl.bindTexture(gl.TEXTURE_2D,  tree3Texture);}
	gl.uniform1i(treeProgram.samplerUniform, 5);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, treeVertexTextureCoordBuffer);
    gl.vertexAttribPointer(treeProgram.textureCoordAttribute, treeVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, treeVertexPositionBuffer);
    gl.vertexAttribPointer(treeProgram.vertexPositionAttribute, treeVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniformstree(); 
    gl.drawArrays(gl.TRIANGLES, 0, treeVertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
var diststar=40000,kstar=30;
var tradarsoleil=0,o1radarsoleil=0,dxradarsoleil=0;
var tradarsoleil2=0,o1radarsoleil2=0,dxradarsoleil2=0,iradarsoleil=0;
function setradarsoleil(){
	  var dx=soleilx-x,dy=soleily-y;
	  var dxy=Math.sqrt(dx*dx+dy*dy);
	  var dzz=Math.abs(soleilz-z)+dxy/2;
	  dxy=radardistspace(dxy);
	  dzz=radardistspace(dzz);
	  if(dxy*0.015<5.4 && dzz*0.015<5.4){
	    if(iradarsoleil==0){
		  iradarsoleil+=1;
		  dxradarsoleil=dxy;
		  o1radarsoleil=diro1(soleilx-x,soleily-y);
		  if(Math.cos(degtorad(o1radarsoleil-o1-o3radar-30+90))>0.8){
		     tradarsoleil=tframe;
		  }
		}else if(iradarsoleil==1){
		  iradarsoleil+=1;
		  dxradarsoleil2=dxy;
		  o1radarsoleil2=diro1(soleilx-x,soleily-y);
		  if(Math.cos(degtorad(o1radarsoleil2-o1-o3radar-30+90))>0.8){
		     tradarsoleil2=tframe;
		  }
		} 
	  }
}
var tradarearth=0,o1radarearth=0,dxradarearth=0;
var tradarearth2=0,o1radarearth2=0,dxradarearth2=0,iradarearth=0;
function setradarearth(){
	  var dx=earthx-x,dy=earthy-y;
	  var dxy=Math.sqrt(dx*dx+dy*dy);
	  var dzz=Math.abs(earthz-z)+dxy/2;
	  dxy=radardistspace(dxy);
	  dzz=radardistspace(dzz);
	  if(dxy*0.015<5.4 && dzz*0.015<5.4){
	    if(iradarearth==0){
		  iradarearth+=1;
		  dxradarearth=dxy;
		  o1radarearth=diro1(earthx-x,earthy-y);
		  if(Math.cos(degtorad(o1radarearth-o1-o3radar-30+90))>0.8){
		     tradarearth=tframe;
		  }
		}else if(iradarearth==1){
		  iradarearth+=1;
		  dxradarearth2=dxy;
		  o1radarearth2=diro1(earthx-x,earthy-y);
		  if(Math.cos(degtorad(o1radarearth2-o1-o3radar-30+90))>0.8){
		     tradarearth2=tframe;
		  }
		} 
	  }
}
var isoleil=0,isoleilmin=0,istar=0,istarmin=0;
var iinfo=0,ninfo=20,testinfo=1;xinfo=[],yinfo=[],textinfo=[];
function drawsoleilstar(){
var dist=diststar,j=0;
iinfo=0,testinfo=tinfo2;
for(var i=2;i<nstar+2;i++){
  showstar[i]=1;
  if(startype[i]==4){dist=diststar*4;}
  else{dist=diststar;}
  if(Math.abs(starxxa[i]*kstar-x0)<dist){
   if(Math.abs(staryya[i]*kstar-y0)<dist){
    if(Math.abs(starzza[i]*kstar-z0)<dist){
	  showstar[i]=0;
	  soleilx=starxxa[i]*kstar;
	  soleily=staryya[i]*kstar;
	  soleilz=starzza[i]*kstar;
	  soleilr=20*starr[i];
	  soleildouble=stardouble[i];
	  if(Math.max(Math.abs(soleilx-x),Math.abs(soleily-y))+Math.abs(soleilz-z)<22000 && soleildouble==0){
	    isoleil=i;
		var do1=parseInt(Math.abs(soleilx*999))%360;
		var co1=Math.cos(degtorad(do1),si1=Math.sin(degtorad(do1)));
		var r=(parseInt(Math.abs(soleily*999))%150+100)*soleilr;
		var kr=(parseInt(Math.abs(soleilx*999))%100+100)/100;
		var p=(parseInt(Math.abs(soleilx*999))%14);
        earthx=soleilx+r*co1;earthy=soleily+r*si1;earthz=soleilz;earthr=3;
        if(p==0){earthr=kr*4;drawearth(earthTexture,earthmaskTexture);}
        if(p==1){earthr=kr*2.5;drawearth(moonTexture,earthmaskTexture);}
        if(p==2){earthr=kr*7;drawearth(jupiterTexture,earthmaskTexture);}
        if(p==3){earthr=kr*3;drawearth(venusTexture,earthmaskTexture);}
        if(p==4){earthr=kr*3;drawearth(mercureTexture,earthmaskTexture);}
        if(p==5){earthr=kr*6;drawearth(neptunTexture,earthmaskTexture);}
        if(p==6){earthr=kr*7;drawearth(saturnTexture,saturnmaskTexture);}
        if(p==7){earthr=kr*3;drawearth(ioTexture,earthmaskTexture);}
        if(p==8){earthr=kr*4;drawearth(planetTexture,earthmaskTexture);}
        if(p==9){earthr=kr*4;drawearth(planet2Texture,earthmaskTexture);}
        if(p==10){earthr=kr*4;drawearth(planet3Texture,earthmaskTexture);}
        if(p==11){earthr=kr*3;drawearth(europaTexture,earthmaskTexture);}
        if(p==12){earthr=kr*4;drawearth(marsTexture,earthmaskTexture);}
        if(p==13){earthr=kr*3;drawearth(plutoTexture,earthmaskTexture);}
	  }
	  var s=parseInt(Math.abs(soleily*1000))%6;
	  if(i<nstars0){s=startype[i];}
	  istar=i;soleiltype=s;
	  if(s==0){drawsoleil(soleilTexture);}
	  if(s==1){drawsoleil(soleilTexture);}
	  if(s==2){drawsoleil(soleilbrightTexture);}
	  if(s==3){drawsoleil(soleilwhiteTexture);}
	  if(s==4){drawsoleil(soleilblueTexture);}
	  if(s==5){drawsoleil(soleilredTexture);}
	  if(iinfo<ninfo && testinfo==1){
	     if(rotavion2(soleilx,soleily,soleilz,0)){
		      if(x2>8000 && x2<958000){
			     var ix=windx0*0.5-windx0*0.5*y2/x2;
			     var iy=windy0*0.5-windx0*0.5*z2/x2;
				 if(iinfo>0){
				   for(var ii=1;ii<=iinfo;ii++){
				    if(Math.abs(ix-xinfo[ii])<90){
					  if(Math.abs(iy-yinfo[ii])<24){ix=-9999;break;}}}}
				 if(ix>5){iinfo+=1;xinfo[iinfo]=ix;yinfo[iinfo]=iy;
				          textinfo[iinfo]=starname2[istar];
				}}}}
	  j+=1;if(j>70){break;}
  }}}
}
if(j<12 && diststar<70000){diststar+=2000;}
if(j<20 && diststar<40000){diststar+=2000;}
if(j>28 && diststar>10000){diststar-=2000;}
}
function drawstar(){
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE);
        mvPushMatrix();
		mat4.translate(mvMatrix, [x,y,z]);
        if(tdrawmap>0){mat4.scale(mvMatrix,[1,1,0.1]);}
		
    gl.bindBuffer(gl.ARRAY_BUFFER, starVertexTextureCoordBuffer);
    gl.vertexAttribPointer(starProgram.textureCoordAttribute, starVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, starVertexPositionBuffer);
    gl.vertexAttribPointer(starProgram.vertexPositionAttribute, starVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    if(tspace==0){colora=Math.abs(12-hour)/20;}
	setMatrixUniformsstar();
    colora=1;	
    gl.drawArrays(gl.TRIANGLES, 0, starVertexPositionBuffer.numItems);
		
		mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
}
function drawdust(){
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE);
        mvPushMatrix();
		mat4.translate(mvMatrix, [0,0,0]);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, dustVertexTextureCoordBuffer);
    gl.vertexAttribPointer(starProgram.textureCoordAttribute, dustVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, dustVertexPositionBuffer);
    gl.vertexAttribPointer(starProgram.vertexPositionAttribute, dustVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    colora=Math.abs(12-hour)/20;
	setMatrixUniformsstar();
    colora=1;	
    gl.drawArrays(gl.TRIANGLES, 0, dustVertexPositionBuffer.numItems);
		
		mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
}
function drawtir(){
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_COLOR, gl.ONE_MINUS_SRC_COLOR);
        mvPushMatrix();
		//mat4.scale(mvMatrix,[0.1,0.1,0.1]);
	gl.activeTexture(gl.TEXTURE7);
    gl.bindTexture(gl.TEXTURE_2D,  tirTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 7);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, tirVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, tirVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, tirVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, tirVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.uniform4f(shaderProgram.colorUniform,0.7,0.57,0.57,0.0);
    gl.drawArrays(gl.TRIANGLES, 0, tirVertexPositionBuffer.numItems);
		
		mvPopMatrix();
	gl.disable(gl.BLEND);
    gl.enable(gl.DEPTH_TEST);
}
var nimpact=14,nimpact2=4,iimpact=0;
var impactx=new Array(nimpact),impacty=new Array(nimpact),impactz=new Array(nimpact);
var timpact=new Array(nimpact);
function addimpact(px,py,pz){
iimpact+=1;if(iimpact>=nimpact || iimpact>=nimpact2){iimpact=0;}
impactx[iimpact]=px;
impacty[iimpact]=py;
impactz[iimpact]=pz;
timpact[iimpact]=tframe;
}
function addimpact2(px,py,pz){
iimpact+=1;if(iimpact>=nimpact){iimpact=0;}
impactx[iimpact]=px;
impacty[iimpact]=py;
impactz[iimpact]=pz;
timpact[iimpact]=tframe;
}
function drawimpact(){
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.ONE_MINUS_SRC_COLOR, gl.SRC_COLOR);
	gl.activeTexture(gl.TEXTURE8);
    gl.bindTexture(gl.TEXTURE_2D,  impactTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 8);
    for(var i=0;i<nimpact;i++){ 
      if(tframe<(timpact[i]+3500)){	
        mvPushMatrix();
		mat4.translate(mvMatrix, [impactx[i],impacty[i],impactz[i]]);
        mat4.rotate(mvMatrix, degtorad(o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90+o2), [0, 1, 0]);
		var sc=(1.0+(tframe-timpact[i])/300);if(sc>3){sc=3+(sc-3)*0.2;};
		sc*=0.022*(1+tspace*2);
		mat4.scale(mvMatrix,[sc,sc,sc]);
		drawcarre();
		mvPopMatrix();
	  };	
	};	
	gl.disable(gl.BLEND);
    gl.enable(gl.DEPTH_TEST);
}
var nsmoke=100,ismoke=0;
var smokex=new Array(nsmoke),smokey=new Array(nsmoke),smokez=new Array(nsmoke);
var tsmoke=new Array(nsmoke),vsmoke=new Array(nsmoke),sizesmoke=new Array(nsmoke);
var typesmoke=new Array(nsmoke),ttsmoke=0;
function addsmoke(px,py,pz,size,type){
if(Math.abs(px-x)>900){return;}
if(Math.abs(py-y)>900){return;}
if(Math.abs(pz-z)>900){return;}
ismoke+=1;if(ismoke>=nsmoke){ismoke=0;}
smokex[ismoke]=px;
smokey[ismoke]=py;
smokez[ismoke]=pz;
tsmoke[ismoke]=tframe;
vsmoke[ismoke]=vplane;
sizesmoke[ismoke]=size;
typesmoke[ismoke]=type;
}
function drawsmoke(){
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE);//_MINUS_SRC_ALPHA);
	gl.activeTexture(gl.TEXTURE3);
    gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 3);
    for(var i=0;i<nsmoke;i++){ 
      if(tframe<(tsmoke[i]+5000+(sizesmoke[i]-1)*1700)){	
        mvPushMatrix();
		var dt=dtime;if(dt>120){dt=120;}
		if(sizesmoke[i]<2){
		 var dv=vsmoke[i]*dt*0.0125;
		 vsmoke[i]-=vplane*dt*0.00048;
		 smokez[i]+=dv*sin2;
		 smokex[i]+=dv*cos1*cos2;
		 smokey[i]+=dv*sin1*cos2;
		 smokez[i]+=dt*0.0001*(2+Math.random());
		}
		if(typesmoke[i]==1){smokez[i]+=dt*0.0005*(2+Math.random());}
		mat4.translate(mvMatrix, [smokex[i],smokey[i],smokez[i]]);
        mat4.rotate(mvMatrix, degtorad(o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90+o2), [0, 1, 0]);
		var sc=((1+vplane*1.8)*(0.3+tframe-tsmoke[i])/500);if(sc>3){sc=3+(sc-3)*0.2;};
		sc*=0.0020*sizesmoke[i]*(1+tspace*2);
		mat4.scale(mvMatrix,[sc,sc,sc]);
		drawcarre();
		mvPopMatrix();
	  };	
	};	
	gl.disable(gl.BLEND);
    gl.enable(gl.DEPTH_TEST);
}
    var tframe=0,tframe0=0,tfps=30,fps=10,dtime=1,tmsg=0,clearr,clearg,clearb,tskip=0;
	var ttimeout=0,testloop=0,tskip2=0,tsrtm=0,itime=0;
	function tick(tt) {
        //requestAnimFrame(tick);
        if(tclose==0 && testloop==0 && ttimeout==0){testloop=1;requestAnimationFrame(tick);
        }else{testloop=0;};
		if(tgamesave==1){if(keys[vk_escape]){tgamesave=0;subquit();}}
		else if(waitkey==0){if(tframe>tcrash+250){testkeys();}
		}else if(waitkey>1){subwaitkey();}
		if(tframe>treinitsol && treinitsol>1){treinitsol=0;reinitsol();}
		itime+=1;if(itime>1000){itime=0;}
		tskip=0;
		if(tgamesave>=1){tskip=1;}
		if(waitkey>=1){tskip=1;}
		if(tframe<tskip2){tskip=1;}
		if(tspace==0){
		 if(x<xmin){x+=xmax-xmin;px+=xmax-xmin;p3x+=xmax-xmin;nmap2*=2;tskip=1;};
		 if(x>xmax){x-=xmax-xmin;px-=xmax-xmin;p3x-=xmax-xmin;nmap2*=2;tskip=1;};
		 if(y<ymin){y+=ymax-ymin;py+=ymax-ymin;p3y+=ymax-ymin;nmap2*=2;tskip=1;};
		 if(y>ymax){y-=ymax-ymin;py-=ymax-ymin;p3y-=ymax-ymin;nmap2*=2;tskip=1;};
		}
		//if(tskip==0 && tframe>tsrtm){tsrtm=tframe+3000;testloadsrtm();}
		var aux=1-0.45*Math.abs(12-hour)/12;
   	    var aux2=1-0.3*Math.abs(12-hour)/12;
   	    var aux3=1-0.2*Math.abs(12-hour)/12;
        if(hour<6 || hour>18){		
		//  var aux4=Math.abs(12-hour)/3000;
        //  gl.clearColor(aux4,aux4,aux4, 1.0);
		//}else{gl.clearColor(0,0,0, 1.0);};
		}else{//gl.clearColor(0,0,0, 1.0);
		if(tskip==0 && tspace==0){drawrttshadow();};
		}
		//if(waitkey!=0){drawrttshadow();}
        if(tskydome2==0){gl.clearColor(0.70*aux3, 0.70*aux, 1.0*aux2, 1.0);
        }else if(tspace==1){gl.clearColor(0, 0, 0, 1.0);
        }else{gl.clearColor(0.38, 0.38, 0.38, 1.0);}
        clearr=0.70*aux3;clearg=0.70*aux;clearb=1.0*aux2;
        if(tskip==0){drawScene();}
		if(tgamesave==1){scrollTo(0,4000);}
		else if(waitkey!=1){
		 if(tdrawmap>=0 || waitkey==0){scrollTo(winx,winy);}
		 else{scrollTo(0,100);}
		}
		tframe0=tframe;
		tframe=timer();
		dtime=tframe-tframe0;
		if(dtime>1000){dtime=1000;}
		tfps+=(tframe-tframe0-tfps)*0.2;
		if(tfps<1){tfps=1;}
		if(tfps>1000){tfps=1000;}
		fps=1000/tfps;
		var dt=(tframe0+25-tframe);
		if(dt<10){dt=10};
		tcollide=0;
		if(tclose==0 && ttimeout){timeouttick=setTimeout("tick(0);",dt);
           }else{
		   //if(tclose==0){requestAnimationFrame(tick);};
           if(tclose==0 && testloop==0){testloop=1;requestAnimFrame(tick);
		     }else{testloop=0;};}
		//if(tclose==0){timeouttick=setTimeout("tick(0);",dt);}
        //if(tclose==0){requestAnimationFrame(tick);};
        //if(tclose==0){requestAnimFrame(tick);};
    }

	
	var twebglstart2=0,canvas2,canvastext;	
    function webGLStart() {
        canvas = document.getElementById("canvas");
        submsg("initgl");
		initGL(canvas);
		if(!gl){return;}
        canvas2=document.createElement('canvas');
        canvas2.setAttribute('width', 1024);
        canvas2.setAttribute('height', 1024);
        canvastext=canvas2.getContext("2d");
		initShaders();
		submsg("initmodels");
        loadWorld();
		submsg("inittextures");
        initTexture();
		initskyimage();
		twebglstart2=timer();
		setTimeout("webGLStart2();",500);
		}
	function webGLStart2(){
	    /*if(timer()<(twebglstart2+40000)){
		  if(!solTexture2.data){
		     setTimeout("webGLStart2();",500);return;}
		  if(!solTexture2.datasize){
		     setTimeout("webGLStart2();",500);return;}
		  if(solTexture2.datasize<200){
		     setTimeout("webGLStart2();",500);return;}
		}else{alert("soltexture2.data not loaded !");}
        */
		tgmap=0;icombo=0;
		submsg("initbuffers");
		initBuffers();
		
        gl.clearColor(0.70, 0.70, 1.0, 1.0);
        gl.enable(gl.DEPTH_TEST);

        tkey=timer();tdisplay=timer()+5000;
        testkeys();
		if(tsea>0 || tgmap==1){resetcarrier();resetsailships();}
		//if(fullscreen==1){fullscreen=0;sizescreen();}
		fullscreen-=1;sizescreen();
        setTimeout("tick(0);",1000);
		setTimeout("deletejsfilelist();",5000);
		//setTimeout("startradio();",1200);
        //setTimeout("alert(solTexture.image.width);",10000);
		//if(tclose==0){requestAnimationFrame(tick);};
        //if(tclose==0){requestAnimFrame(tick);};
   }

var keys=new Array(256),keys0=new Array(256),tkeys=new Array(256),tkey=0;
var pkeys=new Array(256);
function resetkeys(){
 for(var i=0;i<256;i++){keys[i]=0;keys0[i]=0;tkeys[i]=0;}
}
resetkeys();
function keydown(e){
var key=eval(e.which || e.keyCode)
var t=timer();
if(key>0 && key<256){keys[key]=1;tkeys[key]=t;if(keys0[key]==0){keys0[key]=1;}}
//if(tkey>(t-40000)){tkey=t;}else{tkey=t;}//testkeys();}
}
function keyup(e){
var key=eval(e.which || e.keyCode)
if(key>0 && key<256){keys[key]=0;keys0[key]=0;}
var t=timer();
//for(var i=16;i<=40;i++){if(tkeys[i]<(t-40000)){keys[i]=0;keys0[i]=0;tkeys[i]=t;};}
i=vk_left;if(tkeys[i]<(t-10000)){keys[i]=0;keys0[i]=0;tkeys[i]=t;}
i=vk_right;if(tkeys[i]<(t-10000)){keys[i]=0;keys0[i]=0;tkeys[i]=t;}
}
var tdogfight=0;
function subdogfight(){//px=x+17;py=y;pz=z;p3x=x+15;p3y=y;p3z=z;
if(tdogfight==0){if(confirm("start dogfight ?")){tdogfight=1;
   px=Math.max(x-120,Math.min(x+120,px));
   py=Math.max(y-120,Math.min(y+120,py));
   pz=Math.max(z-15,Math.min(z+15,pz));
   p3x=Math.max(px-5,Math.min(px+5,p3x));
   p3y=Math.max(py-5,Math.min(py+5,p3y));
   p3z=pz;
   pvie=Math.max(50,pvie);p3vie=Math.max(50,p3vie);
   for(var i=0;i<nplane;i++){if(npvie[i]>0){npvie[i]=100;}}
   }
}else{if(confirm("stop dogfight ?")){tdogfight=0;p3vie=100;};}
}
function subtskyimage(){
//if(confirm("init test sky images ?")){
//   if(tskyimage==0){initskyimage1();tskyimage=1;}}
}
function subhelp(){
var crlf=String.fromCharCode(13)+String.fromCharCode(10);
var msg="H => help  / P => pause"+crlf;
msg+="esc => quit+save   /   3 => fullscreen"+crlf;
msg+="arrows keys ,1,2 => rotate"+crlf;
msg+="pageup/pagedown or ctrl+arrows or B/N => motor"+crlf;
msg+="T => tourelle view  /  shift+T => change timehour"+crlf;
msg+="V => plane/tourelle/cockpit view"+crlf;
msg+="Shift + arrow key => rotate cockpit view"+crlf;
msg+="C => number of clouds  /  shift+L => link URL"+crlf;
msg+="space => shoot"+crlf;
msg+="F => fighter/alphajet"+crlf;
msg+="S => settimeout/requestanim mode"+crlf;
//msg+="R => radio message  /  W => water/ground/space"+crlf;
msg+="W => water/ground/space orbit"+crlf;
msg+="M/shift+M => map   /   A => viseur"+crlf;
msg+="shift+S => save/delete game cookie"+crlf;
//msg+="K => foot/plane/car"+crlf;
//msg+="shift+Y => skydome(on/off)"+crlf;
//msg+="shift+G => flyto geolocation"+crlf;
msg+="D => start/stop dogfight"+crlf;
msg+="4 => cssscale   /  shift => handbrake"+crlf;
msg+="I => star info  "+crlf;// /  shift+I => add sky test images"+crlf;
msg+="R => radar"+crlf;
msg+="joystick and gamepad supported";
var vrun00=vrun;vplane00=vplane;
vrun=0;vplane*=0.3;setvolume();
alert(msg);
vrun=vrun00;vplane=vplane00;setvolume();	 
document.getElementById('intext').focus();
}
var vplane=0,dmx=0,dmy=0,dmz=0,vplanez=0,tclock=0,tvie=0,tvie0=0,tsea=0;
var plane="c150",vrunmax=1.30;
var searchtxt="",parms=[],iparm=0;
function addparm(parm){
   searchtxt+=(parseInt(parm*1000)/1000)+"&";
}
function initparms(){
  if(Math.random()<0.5){tsea=1;if(Math.random()<0.5){tsea=2;};}
  tsea=3;o1=90;x=0;y=0;z=0;o2=0;
  plane="spaceship";//"alphajet";
  vrunmax=2.5;tvolume=-1;
  windy=windymax;
  windx=Math.min(windxmax,windymax*620/430);
  var hash0=document.location.search;//parent.location.hash;
  if(hash0.indexOf("reset",0)>=0 || hash0.indexOf("nocook",0)>=0){hash0="";
  }else{readcookie();}
  seedrand=parseInt(timer());
  pz=30;po2=0;px=x+100;py=y-10;
  p3z=30;p3o2=0;p3x=x+90;p3y=y-20;
  var hash0=document.location.search;//parent.location.hash;
  getparms(hash0);
  lat00=0;lng00=0;
  tgmap=0;icombo=0;
  /*if(tgmap==1){lat00=lat;lng00=lng;}
  if(flytoname){
	  document.getElementById('combo')[1].text=flytoname;}
  if(icombo){document.getElementById('combo').selectedIndex=icombo;
               setTimeout("subcombo();lat00=0;lng00=0;",3000);}
  */
  var hour0=new Date().getHours()+new Date().getMinutes()/60.0;
  hour=2.0;thour=hour-hour0;
  tourelle=0;fullscreen=1;
  }
function evaln(n){if(isNaN(eval(n))){return 0;}else{return eval(n);};}
function getparms(hash){
  if(hash!=""){parms=[];parms=hash.split("&");
    tsea=evaln(parms[0].substr(1,parms[0].length-1));
    var i=1,n=parms.length-1;
	x=evaln(parms[i]);i+=1;if(i>=n){return;}
    y=evaln(parms[i]);i+=1;if(i>=n){return;}
	z=evaln(parms[i]);i+=1;if(i>=n){return;}
	o1=evaln(parms[i]);i+=1;if(i>=n){return;}
    o2=evaln(parms[i]);i+=1;if(i>=n){return;}
	o3=evaln(parms[i]);i+=1;if(i>=n){return;}
	vplane=evaln(parms[i]);i+=1;if(i>=n){return;}
    vrun=evaln(parms[i]);i+=1;if(i>=n){return;}
	vrunmax=evaln(parms[i]);i+=1;if(i>=n){return;}
	tourelle=evaln(parms[i]);i+=1;if(i>=n){return;}
	seedrand=evaln(parms[i]);i+=1;if(i>=n){return;}
	px=evaln(parms[i]);i+=1;if(i>=n){return;}
    py=evaln(parms[i]);i+=1;if(i>=n){return;}
	pz=evaln(parms[i]);i+=1;if(i>=n){return;}
	po1=evaln(parms[i]);i+=1;if(i>=n){return;}
    po2=evaln(parms[i]);i+=1;if(i>=n){return;}
	po3=evaln(parms[i]);i+=1;if(i>=n){return;}
	pvplane=evaln(parms[i]);i+=1;if(i>=n){return;}
    pvrun=evaln(parms[i]);i+=1;if(i>=n){return;}
	shipx=evaln(parms[i]);i+=1;if(i>=n){return;}
    shipy=evaln(parms[i]);i+=1;if(i>=n){return;}
	shipz=evaln(parms[i]);i+=1;if(i>=n){return;}
	shipo1=evaln(parms[i]);i+=1;if(i>=n){return;}
	shipcarrierx=evaln(parms[i]);i+=1;if(i>=n){return;}
    shipcarriery=evaln(parms[i]);i+=1;if(i>=n){return;}
	shipcarrierz=evaln(parms[i]);i+=1;if(i>=n){return;}
	shipcarriero1=evaln(parms[i]);i+=1;if(i>=n){return;}
	plane=parms[i];i+=1;if(i>=n){return;}
	p3x=evaln(parms[i]);i+=1;if(i>=n){return;}
    p3y=evaln(parms[i]);i+=1;if(i>=n){return;}
	p3z=evaln(parms[i]);i+=1;if(i>=n){return;}
	p3o1=evaln(parms[i]);i+=1;if(i>=n){return;}
    p3o2=evaln(parms[i]);i+=1;if(i>=n){return;}
	p3o3=evaln(parms[i]);i+=1;if(i>=n){return;}
	p3vplane=evaln(parms[i]);i+=1;if(i>=n){return;}
    p3vrun=evaln(parms[i]);i+=1;if(i>=n){return;}
    icombo=evaln(parms[i]);
	i+=1;if(i>=n){return;}
    fullscreen=evaln(parms[i]);i+=1;if(i>=n){return;}
    tskydome2=evaln(parms[i]);i+=1;if(i>=n){return;}
	lat=evaln(parms[i]);i+=1;if(i>=n){return;}
    lng=evaln(parms[i]);i+=1;if(i>=n){return;}
	tgmap=evaln(parms[i]);i+=1;if(i>=n){return;}
    cssscale=evaln(parms[i]);i+=1;if(i>=n){return;}
    cssscaley=evaln(parms[i]);i+=1;if(i>=n){return;}
    flytolat=evaln(parms[i]);i+=1;if(i>=n){return;}
    flytolng=evaln(parms[i]);i+=1;if(i>=n){return;}
	flytoname=parms[i];i+=1;if(i>=n){return;}
    tcar=evaln(parms[i]);i+=1;if(i>=n){return;}
    tinfo=evaln(parms[i]);i+=1;if(i>=n){return;}
    tradar=evaln(parms[i]);i+=1;if(i>=n){return;}
    for(var j=0;j<10;j++){npboom0[j]=evaln(parms[i]);i+=1;if(i>=n){return;}}
    ncloud2=evaln(parms[i]);i+=1;if(i>=n){return;}
	//if(icombo){document.getElementById('combo').selectedIndex=icombo;
    //           setTimeout("subcombo();",3000);}
	}
}
function setlink(){
  tclose=1;
  alert("copy the adress bar to link to this place later");
  setsearchtxt();
  document.location.search=searchtxt;  
}
function setsearchtxt(){
x=xspace;y=yspace;z=zspace;o1=o1space;o2=o2space;o3=o3space;tsea=3;tspace=1;
for(var i=0;i<10;i++){npboom0[i]=0;if(npboom[i]!=0){npboom0[i]=1;}}
  searchtxt="";
  addparm(tsea);
  addparm(x);
  addparm(y);
  addparm(z);
  addparm(o1);
  addparm(o2);
  addparm(o3);
  addparm(vplane);
  addparm(vrun);
  addparm(vrunmax);
  addparm(tourelle);
  addparm(seedrand);
  addparm(px);
  addparm(py);
  addparm(pz);
  addparm(po1);
  addparm(po2);
  addparm(po3);
  addparm(pvplane);
  addparm(pvrun);
  addparm(shipx);
  addparm(shipy);
  addparm(shipz);
  addparm(shipo1);
  addparm(shipcarrierx);
  addparm(shipcarriery);
  addparm(shipcarrierz);
  addparm(shipcarriero1);
  searchtxt+=plane+"&";
  addparm(p3x);
  addparm(p3y);
  addparm(p3z);
  addparm(p3o1);
  addparm(p3o2);
  addparm(p3o3);
  addparm(p3vplane);
  addparm(p3vrun);
  addparm(icombo);
  addparm(fullscreen);
  addparm(tskydome2);
  addparm(lat);
  addparm(lng);
  addparm(tgmap);
  addparm(cssscale);
  addparm(cssscaley);
  addparm(flytolat);
  addparm(flytolng);
  searchtxt+=flytoname+"&";
  addparm(tcar);
  addparm(tinfo);
  addparm(tradar);
  for(var i=0;i<10;i++){addparm(npboom0[i]);}
  addparm(ncloud2);
}
function readcookie(){
var mycookie=document.cookie+";";
//alert("mycookie="+mycookie);
var pref="mywebglflightspacechung=";
var i=mycookie.indexOf(pref,0);
if(i<0){return;}
i+=pref.length;
var j=mycookie.indexOf(";",i);
if(j<i){return;}
var mycookie=mycookie.substring(i,j);
//alert(mycookie);
var hash0="?"+mycookie;getparms(hash0);
}
function savecookie(){
var mycookie="";
var cookie0=document.cookie;
setsearchtxt();
mycookie+=searchtxt;
//alert(mycookie);  
var pref="mywebglflightspacechung=";
mycookie =pref+mycookie+"; expires=Fri, 3 Aug 2100 20:47:11 UTC; path=/";
if(mycookie.length>(3900-cookie0.length)){alert("could not save, cookie too long");return;}
document.cookie=mycookie;
}
function deletecookie(){
var pref="mywebglflightspacechung=";
document.cookie =pref+";expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/";
}
function subcookie(){
  if(confirm("save game cookie ?")){savecookie();alert("cookie saved");
  }else if(confirm("delete gamesave cookie ?")){
           deletecookie();alert("cookie deleted");}
}
function subloadsave(){
tgamesave=1;
gamereturndata=null;
gameprefix="mywebglflightspace";
var name="interstellar space ";
if(isoleilmin1>0){name=starname2[isoleilmin1]+" , "+startext[isoleilmin1];}
setsearchtxt();
initgamesave(name,searchtxt);
loopgamesave();
}
var tfocus=1,tdisplay=0,x0=0,y0=0,z0=0,tfoot=0,tcar=0,vzz=0;
var o10=0,o20=0,o30=0,o100=0,o200=0,o300=0,tsizescreen=0;
var tscroll=0,tscale=0,tscale0=0,tgaz=0,vcruise=0.8;
var o2sol=0,o3sol=0,vplane0=0,vmx=0,vmy=0,vmz=0;
var vmx2=0,vmy2=0,vmz2=0,vmxyz0=0;
var tinfo=1,tinfomsg=0,tinfo2=0;
function testkeys() {
testspeak();
if(tskip==0){x0=x;y0=y;z0=z;}
if(tsizescreen<(tframe-2000)){tsizescreen=tframe;
if(winwidth!=window.innerWidth || winheight!=window.innerHeight){
    winwidth=window.innerWidth;
	winheight=window.innerHeight;
	fullscreen-=1;sizescreen();
	}
}
if(tmsg<(tframe-150)){tmsg=tframe;
 var xx=Math.round(x),yy=Math.round(y),zz=Math.round(z),oo1=Math.round(o1),vv=Math.round(vplane*2000)/10;
 var pp=Math.round(vrun*1000)/10,oo2=Math.round(o2),ff=Math.round(fps),oo3=Math.round(o3);
 var msg="x="+xx+"  y="+yy+"  z="+zz+"  v="+vv+"  prop="+pp;
 if(test<=1){msg+="  o1="+oo1+" o2="+oo2+" o3="+oo3;};
 msg+=" fps="+ff;
 if(Math.abs(tvie0-vie)>0.001){tvie0=vie;if(vie!=100){tvie=tframe;};}
 if(tframe<(tvie+5000)){msg+=" vie="+parseInt(vie);}
 if(ttimeout){msg+=" timeout";}
 if(tframe<tdisplay+10000){msg+=" clouds="+parseInt(wclouds*100)/100;}
 if(auxvar!=null){msg+=" aux="+auxvar;}
 if(auxvar2!=null){msg+=" aux2="+auxvar2;}
 if(auxtext!=""){msg+=" auxt="+auxtext;}
 if(tcar==1){msg+=" car";}
 if(tfoot==1){msg+=" foot";}else if(tourelle==1){msg+=" tourelle";}
 if(tframe<treinitgmap+17000){msg+=" ntower="+ntower;}
 if(tframe<tradio+14000){msg=radiotxt.substr(0,parseInt((tframe-tradio)/110));tmsg=tframe-120;
    if(tframe>tradio+11000){if(Math.cos((tframe-tradio)*0.004)>0.59){msg="";};};}
 document.getElementById('intext0').value=msg;
 if(tfocus){document.getElementById('intext').focus();}
 setvolume();
 }
if(tclock<tframe-5000){tclock=tframe;var hh=parseInt(hour),mn=parseInt((hour-hh)*60);
 if(mn<10){mn="0"+mn;};
 document.getElementById('clock').value=hh+":"+mn;
 }
if(tframe>timejoy){timejoy=tframe+80;testjoystick();
}
//timer0=timer1;timer1=timer();
//if (tkey>(timer1-300000)){
	tgaz=0;
	var dt=dtime;//timer1-timer0;
	if(dt>300){dt=300;}
	o10=o1;o20=o2;o30=o3;
	if(tfoot==1){z=zsol+0.27;vplane=0;landing=1;tpiste=1;vrun=0;o3=0;
     if(tcollide==1){x-=dt*0.008*cos1;y-=dt*0.008*sin1;tcollide=0;}
	 if (keys[37] || joyx<-0.5) {o1+=dt*0.07;if(o1>180){o1-=360;o10-=360;};}
     if (keys[39] || joyx>0.5) {o1-=dt*0.07;if(o1<-180){o1+=360;o10+=360;};}	  
     if (keys[38] || joyy<-0.5) {x+=dt*0.004*cos1;y+=dt*0.004*sin1;o2-=0.003*dt*o2;}
     if (keys[40] || joyy>0.5) {x-=dt*0.004*cos1;y-=dt*0.004*sin1;o2-=0.003*dt*o2;}	  
     if (keys[vk_page_up] || joyz>0.5) {o2+=dt*0.04;}
     if (keys[vk_page_down] || joyz<-0.5) {o2-=dt*0.04;}	  
	}
	var h0=zsol,h1=zsol,h2=zsol,dx=0.7,dy=0.5;
	o2sol=0.04;o3sol=0;
	if(tcar==1){
	  h1=getterrainheight2(x+dx*cos1-dy*sin1,y+dx*sin1+dy*cos1);
	  h2=getterrainheight2(x+dx*cos1+dy*sin1,y+dx*sin1-dy*cos1);
	  //h0=getterrainheight2(x,y);
	  //zsol=h0;
	  o2sol=Math.max(-40,Math.min(40,diro1(dx,(h1+h2)*0.5-h0)));
	  o3sol=Math.max(-50,Math.min(50,diro1(dy+dy,h2-h1)));
	}
	if(tcar==1){
	   vzz-=dt*0.0006;if(vzz<-1){vzz=-1;}
	   z+=(vzz-0.03)*dt*0.003;
	   if(z<zsol+0.70){if(vplane>0.003){
	                     if(o2<(o2sol-(0.05+vplane)/(0.003+vplane))){
						    soundpneu();}}
					   o2=o2sol-0.01;
                       cos2=Math.cos(degtorad(o2));
                       sin2=Math.sin(degtorad(o2));
					   landing=1;vzz=0;z=zsol+0.69;
	   }else{landing=0;}
	   z=Math.max(zsol+0.69,z);
	}
    if(tcar==1){	
     if(tcollide==1){x-=dt*0.008*cos1;y-=dt*0.008*sin1;tcollide=0;}
	 if(landing==1){
      if(o3volant>0.1){o3volant=Math.max(0,o3volant-dt*0.05);}
	  if(o3volant<-0.1){o3volant=Math.min(0,o3volant+dt*0.05);}
	  if (keys[37] || joyx<-0.5) {o3volant+=dt*0.18;if(o3volant>64){o3volant=64;};}
      if (keys[39] || joyx>0.5) {o3volant-=dt*0.18;if(o3volant<-64){o3volant=-64;};}
	  if(Math.abs(o3volant)>0.1){
	        o1+=dt*0.0008*o3volant*vplane/(0.05+Math.abs(vplane));
	        if(o1>360){o1-=360;o10-=360;}
			if(o1<-360){o1+=360;o10+=360;}
	  }
      if (keys[38] || joyy<-0.5) {x+=dt*0.002*cos1;y+=dt*0.002*sin1;if(vplane<0){vplane=0;}}
      if (keys[40] || joyy>0.5) {x-=dt*0.002*cos1;y-=dt*0.002*sin1;}	  
	  if(Math.abs(vplane0*vplane0-vplane*vplane)>0.00002*dt){
    	 soundpneu();}
      planedo2=diro1(50,(vplane0-vplane)*dt);
	  if(planedo2>0){planedo2*=1.8;}
	  vplane0=vplane;
      var vmxyz=vmx*vmx+vmy*vmy+vmz*vmz;
      if(Math.abs(vmxyz0-vmxyz)>0.00002*dt){
         soundpneu();}
	  vmxyz0=vmxyz;		 
	 }
	 if (keys[38]) {vrun+=dt*0.0009;tgaz=1;};
     if (keys[40]) {vrun-=dt*0.0009;if(vrun<0){vrun=0;};};
		 //if (keys[33] || keys[vk_n] || button[1]) {vrun+=dt*0.0003;tgaz=1;};
     //if (keys[34] || keys[vk_b] || button[2]) {vrun-=dt*0.0003;if(vrun<0){vrun=0;};};
	 //if(tgaz==0){if(vrun>1.50){vrun=1.50;};}
	}
    //left=37,up=38,right=39,down=40,pageup=33,pagedown=34,m=77,esc=27,h=72,shift=16
    //p=80,T=84,V=86,b=66,n=78,ctrl=17,l=76,space=32,c=67,w=87,f=70,s=83,r=82
    if(keys[vk_3]){keys[vk_3]=0;sizescreen();}
	if (keys[vk_4]){subcssscale();resetkeys();} 
    //if (keys[vk_g] && keys[vk_shift]) {keys[vk_g]=0;geolocate();}
    //if (keys[vk_y] && keys[vk_shift]) {keys[vk_y]=0;tskydome2+=1;if(tskydome2>1){tskydome2=0;};}
    /*if (keys[vk_k]) {keys[vk_k]=0;
	                 if(tfoot==0){
					   if(tcar==0){tcar=1;tourelle=4;}
					   else{tcar=0;tfoot=1;}
					 }else{tcar=0;tfoot=0;}}  
    */
	tfoot=0;tcar=0;
	if(keys[vk_9]){subtest();resetkeys();}
	if(keys[vk_r]){tradar+=1;if(tradar>1){tradar=0;};sleep(200);resetkeys();}
	if(keys[vk_i]){if(keys[vk_shift]==0){
	                  if(tinfo2==0 && tinfo==0){tinfo=1;tinfomsg=0;}
	                  else{tinfo2=0;tinfo=0;};sleep(200);resetkeys();
				   }else{subtskyimage();resetkeys();}
	               }
	if(tspace==1){
	 if(tinfo==1 && tframe>tinfomsg+1000){
	   tinfo2=1;
	   tinfomsg=tframe;if(istarmin>0){
	     if(starname2[istarmin]!=""){
		    tinfo2=0;
			printinfomsg(starname2[istarmin]+" , "+startext[istarmin]);}}
	   }
	 else if(tinfo==0 && tinfomsg>1){tinfomsg=0;printinfomsg("");}  
     if(tinfo2==1 && tinfo==1){printinfomsg2();}
	 else{if(tinfo2==1){printinfomsg("");};tinfo2=0;}	
	}else{clearinfomsg();}
	if (keys[vk_a] || b(5)) {keys[vk_a]=0;tviseur+=1;if(tviseur>1){tviseur=0;};}
    if (keys[vk_m]) {keys[vk_m]=0;//tdrawmap=0;
       //if(keys[vk_shift]){tdrawmap=-2;map.setCenter(new nogoogle.maps.LatLng(lat,lng));}
	   submap();resetkeys();}
	if (keys[76] && keys[vk_shift]) {keys[76]=0;tclose=1;setlink();return;};
	if (keys[vk_w]) {keys[vk_w]=0;
	               if(tspace==0 || distearthmin<100){
				     tsea+=1;if(tsea>3){tsea=0;};
					 if(tspace==1){tsea=parseInt(Math.random()*2.99);}
					 if(tsea!=3 && tspace==1){
					    x=(x-earthx)/4;y=(y-earthy)/4;z=30;o2=0;tspace=0;}
	                 if(tspace==0){reinitsol();}
				     if(tsea==3){tspace=1;
				      x=xspace;y=yspace;z=zspace;o1=o1space;o2=o2space;o3=o3space;
				      x0=xspace;y0=yspace;z0=zspace;o10=o1space;o20=o2space;o30=o3space;
                      earthr=0;vplane=0;vrun=Math.min(1.2,vrun);
					  tskip2=tframe+500;					  
				     }else{tspace=0;
					       if(earthtexturemin){getearthcolor(earthtexturemin);}}
				   }}
				   //document.location.search=tsea+"&"+x+"&"+y+"&"+z+"&"+o1+"&"+o2+"&"+o3+"&"+vplane+"&"+vrun+"&"+vie+"&"+plane+"&"+tourelle+"&"+vrunmax;}
	if (keys[82]){tairport=0;}
	if (keys[82] || testairport()==1) {keys[82]=0;subradio();}
	if (keys[83] && keys[vk_shift]==0) {keys[83]=0;ttimeout+=1;if(ttimeout>1){ttimeout=0;};}
	if (keys[83] && keys[vk_shift]) {keys[83]=0;keys[vk_shift]=0;subcookie();}
	if (keys[vk_f] || b(6)) {keys[70]=0;var vrunmax0=vrunmax;
	   if(plane=="alphajet"){plane="spaceship";vrunmax=2.5;tvolume=-1;
	   }else{plane="alphajet";vrunmax=2.5;tvolume=-1;}
	   //plane="alphajet";vrunmax=2.5;tvolume=-1;
	   vrun*=vrunmax/vrunmax0;}
	if (keys[vk_c]) {keys[vk_c]=0;tdisplay=tframe;
	                 if(ncloud2<1){ncloud2=ncloud;}
	                 else{ncloud2-=15;if(ncloud2<0){ncloud2=0;}};}
	if (keys[vk_space] || button[3] || button[7]) {if(tframe>(tkeytir+80)){soundshoot();tir();};}
	if (keys[vk_v] || b(8)) {keys[86]=0;tourelle+=1;if(tourelle>5){tourelle=0;};
	               if(tourelle==0){ko1=to1;ko2=to2;};
				   if(tourelle==1){tourelle=2;to1=to11;to2=to21;};
				   if(tourelle==2){to11=to1;to21=to2;to1=ko1;to2=ko2;};
				   if(tcar==1){tourelle=4;};}
	if (keys[84] && keys[16]) {thour+=2.1;if(thour>24){thour-=24;};
	    var hour0=new Date().getHours()+new Date().getMinutes()/60.0;
		hour=hour0+thour;
		while(hour>=24){hour-=24;}
		while(hour<0){hour+=24;}
		if(hour>6.5 && hour<20){hour=20;thour=hour-hour0;updatesun();}
	    alert("timehour = "+hour);keys[84]=0;keys[16]=0;}
	
	if(tcar==0 &&((keys[84] && keys[16]==0)|| b(4))){keys[84]=0;nx0=-9999;
	   if(tourelle==1){tourelle=tourelle0;}else{tourelle0=tourelle;tourelle=1;};
	   	           if(tourelle==0){to11=to1;to21=to2;};
				   if(tourelle==1){if(tourelle0>=2){ko1=to1;ko2=to2;};
				                   to1=to11;to2=to21;};
				   if(tourelle>=2){to11=to1;to21=to2;to1=ko1;to2=ko2;};
                   }
	if (keys[vk_d]){subdogfight();resetkeys();}
	if (keys[72]) {subhelp();keys[72]=0;}
	if (keys[80]) {subhelp();keys[80]=0;}
	if (keys[27]) {tclose=1;keys[27]=0;setTimeout("subquit();",1000);return;}
  var tkeyupdown=0;
  if(tfoot==0){
   if(tcar==0){
   tgaz=0;
   //if(keys[vk_control]==0){
    if(tourelle==0 || keys[vk_shift]==0){
	 if(tspace==0){
	  if ((keys[vk_down] || joyy>0.5)&& Math.abs(vplane)>0.2*cos3) {
	         var dt2=(0.8+vplane/2)*dt;if(vplane>2){dt2=1.8*dt;}
	 		 o2+=dt2*0.015*cos3;o1+=dt2*0.015*sin3;}
      if (keys[vk_up] || joyy<-0.5) {o2-=dt*0.015*cos3;o1-=dt*0.015*sin3;}
	 }else{ 
	  if (keys[vk_down] || joyy>0.5){
	           if(Math.abs(o2)>9960){subkeydown(dt);}
               else{o2+=dt*0.0175*cos3;o1+=dt*0.0175*sin3*cos2;
	                o3-=dt*0.0175*sin3*Math.abs(sin2);}
               //else{o2+=dt*0.0175*cos3;o1+=dt*0.0175*sin3;
	           //     o3-=dt*0.0175*sin3*Math.abs(sin2);}
									 tkeyupdown=1;}
      if (keys[vk_up] || joyy<-0.5) {
	           if(Math.abs(o2)>9960){subkeyup(dt);}
               else{o2-=dt*0.0175*cos3;o1-=dt*0.0175*sin3*cos2;
	                o3+=dt*0.0175*sin3*Math.abs(sin2);}
               //else{o2-=dt*0.0175*cos3;o1-=dt*0.0175*sin3;
	           //     o3+=dt*0.0175*sin3*Math.abs(sin2);}
	                                 tkeyupdown=1;}
     }
	 if (keys[vk_left] || joyx<-0.35) {o3+=dt*0.025;if(o3>180){o3-=360;o30-=360;};if(landing){o1+=dt*0.006;};}
     if (keys[vk_right] || joyx>0.35) {o3-=dt*0.025;if(o3<-180){o3+=360;o30+=360;};if(landing){o1-=dt*0.006;};}
     if (joyx<-0.75) {o3+=dt*0.019;if(o3>180){o3-=360;o30-=360;};if(landing){o1+=dt*0.006;};}
     if (joyx>0.75) {o3-=dt*0.019;if(o3<-180){o3+=360;o30+=360;};if(landing){o1-=dt*0.006;};}
	 if(tourelle==0 || tourelle>1){
	   if (keys[vk_1] || joyr<-0.5) {o2-=dt*0.0028*sin3;o1+=dt*0.0028*cos3;}
       if (keys[vk_2] || joyr>0.5) {o2+=dt*0.0028*sin3;o1-=dt*0.0028*cos3;}
       if(tourelle>1){	   
	    if (button[13]) {to2+=dt*0.035;if(to2>89){to2=89;};}
        if (button[14]) {to2-=dt*0.035;if(to2<-89){to2=-89;};}
        if (button[15]) {to1+=dt*0.039;if(to1>180){to1-=360;};}
        if (button[16]) {to1-=dt*0.039;if(to1<-180){to1+=360;};}
	   }
	 }else{
	   if (joyz<-0.5) {to2+=dt*0.035;if(to2>89){to2=89;};}
       if (joyz>0.5) {to2-=dt*0.035;if(to2<-89){to2=-89;};}
       if (joyr<-0.5) {to1+=dt*0.039;if(to1>180){to1-=360;};}
       if (joyr>0.5) {to1-=dt*0.039;if(to1<-180){to1+=360;};}
     }	 
	}else{
	 if (keys[38] || joyy<-0.5) {to2+=dt*0.035;if(to2>89){to2=89;};}
     if (keys[40] || joyy>0.5) {to2-=dt*0.035;if(to2<-89){to2=-89;};}
     if (keys[vk_left] || joyx<-0.5) {to1+=dt*0.039;if(to1>180){to1-=360;};}
     if (keys[vk_right] || joyx>0.5) {to1-=dt*0.039;if(to1<-180){to1+=360;};}
	}
  //}else{
  //  if (keys[38] || keys[vk_right]) {vrun+=dt*0.0003;tgaz=1;};
  //  if (keys[40] || keys[vk_left]) {vrun-=dt*0.0003;if(vrun<0){vrun=0;};};
  //}
  }  
	if(tcar==0){
	 if (keys[33] || keys[vk_n] || button[1]) {vrun+=dt*0.0003;tgaz=1;};
     if (keys[34] || keys[vk_b] || button[2]) {vrun-=dt*0.0003;if(vrun<0){vrun=0;};};
	 if(tgaz==0){if(vrun>vrunmax){vrun=vrunmax;};
	 }else{if(vrun>vrunmax+0.3){vrun=vrunmax+0.3;}}
	}else{
	 if (keys[33] || keys[vk_n] || button[1]) {vrun+=dt*0.0009;tgaz=1;};
     if (keys[34] || keys[vk_b] || button[2]) {vrun-=dt*0.0009;if(vrun<0){vrun=0;};
	                                           vplane-=0.0014*dt*(vplane+0.07);
											   if(vplane<0){vplane=0;};}
	 if(tgaz==0){if(vrun>vrunmax){vrun=vrunmax;};
	 }else{if(vrun>vrunmax+0.2){vrun=vrunmax+0.2;}}
	}
	//var air=(5000-z)/(5000+z);if(air<0){air=0;};
	var air=(4000-z)/(4000+z);if(air<0){air=0;};if(tspace==1){air=1;}
	//vplane+=0.4*((vrun-vplane)*0.0013*0.8*air*dt-dt*(air*0.0003*vplane+sin2*0.004));
	var kair=vrunmax/1.3;
	var vrun2=1;
	if(vrunmax<2.01){
	   vrun2=vrun*((3-1.4*vplane/kair)/2)*3*air*air/(2+air*air);
	}else{
	   vrun2=vrun*((3-1.4*vplane/kair)/2)*3*air*air*((2+kair)/3)/(2+air*air*kair);
	}
	if(tcar==1){
	   var kv=1;
       if(landing==0){kv=0;}
       vplane+=(kv*(vrun)*0.00082*dt-dt*(kv*0.003*vplane+(sin2+0.01)*0.0020));	
       if(landing==1 && Math.abs(vplane)<0.01){vplane=0;}	   
	}else if(tspace==0){
	  //vplane+=0.8*((vrun2)*0.0003*air*dt-dt*(air*0.0003*vplane+(sin2+0.03)*0.0024));
	  vplane+=0.8*((vrun2)*0.0003*air*dt-dt*(air*0.0003*vplane+(sin2+0.01)*0.0020));
	}else{
	  vplane+=0.8*((vrun2)*0.0003*air*dt-dt*(air*0.0003*vplane+(sin2+0.01)*0.0));
	}	
	if(vplane>4.5){vplane=4.5;}//max vv=900
	if(vplane<-0.5){vplane=-0.5;}//min vv=-100
    if(tcar==1 || (tspace==1 && Math.abs(sin3)<0.7)){vcruise=2;}
	else{
	 vcruise=0.8;
	 if(plane=="spitfire"){vcruise=0.85;}
	 else if(plane=="zero"){vcruise=0.84;}
	 else if(plane=="spaceship"){vcruise=1.5;}
	 else if(plane=="alphajet"){vcruise=1.5;}
	 if(tspace==1){
	  if(sin3>0 && tkeyupdown==0){o1+=(sin3-0.6)*3.33*dt*0.010*cos2;
	            o2-=Math.abs(Math.sin(degtorad((o3-40))))*dt*0.0015*cos2;
	  }else if(tkeyupdown==0){o1+=(sin3+0.6)*3.33*dt*0.010*cos2;
	       o2-=Math.abs(Math.sin(degtorad((o3+40))))*dt*0.0015*cos2;
	  }
	 }else{
	  if(sin3>0){o1+=(sin3)*dt*0.010*cos2;
	            o2-=Math.abs(Math.sin(degtorad((o3))))*dt*0.0015*cos2;
	  }else{o1+=(sin3)*dt*0.010*cos2;
	       o2-=Math.abs(Math.sin(degtorad((o3))))*dt*0.0015*cos2;
	  }
     }	 
	 //o2-=Math.abs(Math.sin(degtorad(0.7*o3)))*dt*0.0015;
	}
	if(landing==0 && tspace==0){
	 if(tcar==0){
	  if(cos3>0){o2+=(vplane*air-vcruise)*air*cos2*cos3*dt*0.004;}
	      else{o2+=(vplane*air+vcruise)*air*cos2*cos3*dt*0.004;}
	 }else{o2+=(vplane*air-vcruise)*cos2*dt*0.004;
	 }
	}
	if(tspace==0){
	 if(o3>0.1){o3-=dt*0.001;}
	 else if(o3<-0.1){o3+=dt*0.001;}
	 //else if(landing==1){o3=0;}
	}
	if(tspace==1){
	  //if(o2>0.1){o2-=dt*0.0003;}
	  //else if(o2<-0.1){o2+=dt*0.0003;}
	  landing=0;zsol=z-100;
	}
	if(landing==1){
	  if(o2<o2sol-0.02){o2=o2sol-0.01;do2=0;};
	  if(tpiste==1 && vplane<0.07){o2=0;do2=0;sin2=0;}
	  if(o2>o2sol+0.1 &&(vplane<0.05 || tcar==1)){o2=Math.max(o2sol,o2-dt*0.0005);};
	  if(keys[34]){vplane-=0.00145*dt*(vplane+sign(vplane)*0.003);};
	  vplane-=0.00063*dt*(vplane+sign(vplane)*0.003);o3=o3sol;if(vplane<0.01 &&(vplane>(-0.01) || tcar==0)){vplane=0.00001;}
	  } 
	var dt1=(dt*0.002);
	if(dt1>0.8){dt1=0.8;}
	do3+=(o3-o30)-dt1*do3;
	do2+=(o2-o20)-dt1*do2;
	do1+=(o1-o10)-dt1*do1;
	o1+=do1*dt*0.001;
	o2+=do2*dt*0.0025;
	o3+=do3*dt*0.0025;
	if(Math.abs(o3)<0.8){o3+=Math.cos(timer()*0.0015)*0.2*(0.8-Math.abs(o3));};
	vplanez=vplane*sin2;
	if(tcar==0 && tspace==0){
	 if(Math.abs(vplane)<0.2 && landing==0 && z>zsol+0.6){z-=(0.2-Math.abs(vplane))*dt*0.013/3;vplanez-=(0.2-vplane)/3;
	                                       o2-=dt*0.004*cos2};
	 if(o2>35){if(cos3>0){o1-=90*sin3*dt*0.004*sin2;o3-=90*sin3*dt*0.004*sin2;}else{
	                     o1+=90*sin3*dt*0.004*sin2;o3+=90*sin3*dt*0.004*sin2;};}
	 if(o2<-35){if(cos3>0){o1-=90*sin3*dt*0.004*sin2;o3+=90*sin3*dt*0.004*sin2;}else{
	                     o1+=90*sin3*dt*0.004*sin2;o3-=90*sin3*dt*0.004*sin2;};}
    }						 
  }//tfoot==0
    //if(o2>85){o2=84;o1=180+o1;o3=o3+180;};
    //if(o2>85){o2=84;o1=180+o1;o3=180+o3;do1=0;do2=0;do3=0;};
    //if(o2<-85){o2=-84;o1=180+o1;o3=180+o3;do1=0;do2=0;do3=0;};
    if(o2>179.9){o2=180-o2;o1=180+o1;o3=180+o3;do2=-do2;};
    if(o2<-179.9){o2=-180-o2;o1=180+o1;o3=180+o3;do2=-do2;};
	if(Math.abs(sin2)>0.99){var dt3=Math.min(1.0,dt*0.003);
	                        o1-=o3*sign(sin2)*dt3;o3-=o3*dt3;}
	while(o2>180){o2-=360;} 
	while(o2<-180){o2+=360;}
	while(o1>180){o1-=360;} 
	while(o1<-180){o1+=360;}
	while(o3>180){o3-=360;}
	while(o3<-180){o3+=360;}
    cos1=Math.cos(degtorad(o1));sin1=Math.sin(degtorad(o1));
    cos2=Math.cos(degtorad(o2));sin2=Math.sin(degtorad(o2));
    cos3=Math.cos(degtorad(o3));sin3=Math.sin(degtorad(o3));
	dmx=cos1*cos2;dmy=sin1*cos2;dmz=sin2;

	var v=0.013*vplane;
	if(tcar==0){
	 if(tspace==1){v*=kspeed;}
	 vmx2=v*cos1*cos2;
	 vmy2=v*sin1*cos2;
	 vmz2=v*sin2;
	 vmx=vmx2;vmy=vmy2;vmz=vmz2;
	 x+=vmx*dt;
	 y+=vmy*dt;
	 z+=vmz*dt;
	}else{
	 vmx2=v*cos1*cos2;
	 vmy2=v*sin1*cos2;
	 vmz2=v*sin2;
	 var kv=Math.min(1,dt*0.0005);
	 if(keys[vk_shift] && landing==1){
			  vmx2*=0.2;vmy2*=0.2;vmz2*=0.2;}
	 vmx+=(vmx2-vmx)*kv;
	 vmy+=(vmy2-vmy)*kv;
	 vmz+=(vmz2-vmz)*kv;
	 x+=vmx*dt;
	 y+=vmy*dt;
	 z+=vmz*dt;
     v=vmx*cos1*cos2+vmy*sin1*cos2+vmz*sin2;
	 vplane=v/0.013;
     planedo3=diro1(0.05,vmx*sin1*cos2-vmy*cos1*cos2);	 
	}
    tmove2=0;trot2=0;
	if(Math.abs(x-x0)+Math.abs(y-y0)+Math.abs(z-z0)>0.0001*dt){tmove2=1;}
	if(Math.abs(o1-o100)+Math.abs(o2-o200)>10.0001){
	   o100=o1;o200=o2;trot2=1;tmove2=1;}
	if(tgmap==0 || tframe>treinitgmap+2000){
     if(Math.abs(o1-o10)+Math.abs(o2-o20)>dt*0.014){tscroll+=dtime;}
     else if(Math.abs(o3-o30)>dt*0.014){tscroll+=dtime;}
     else{tscroll=0;}
     if(tscroll>300){tscroll=500;if(fps<10){tscale=1;}}
	 else{tscale=0;}
	 //if(tframe<treinitgmap-3000){
	 //   if(tscale==1){tscale=0;tscale0=0;subscale(1);}
	 //}
     if(tscale!=tscale0 && tframe>treinitgmap-300){tscale0=tscale;
	   treinitgmap=tframe+300;
       if(tscale==1){subscale(1.5);}else{subscale(1);}}
    }	   
    /*if (Math.abs(o2)>=50 && Math.abs(o2)<84.01){
       o1=diro1(dmx,dmy);
       o2=diro1(Math.sqrt(dmx*dmx+dmy*dmy),dmz);
       var aux=1.0/Math.max(0.5,Math.sqrt(dmx*dmx+dmy*dmy+dmz*dmz));
       dmx*=aux;dmy*=aux;dmz*=aux;
       cos1=Math.cos(degtorad(o1));sin1=Math.sin(degtorad(o1));
       cos2=Math.cos(degtorad(o2));sin2=Math.sin(degtorad(o2));
       cos3=Math.cos(degtorad(o3));sin3=Math.sin(degtorad(o3));
	   //dmx=cos1*cos2;dmy=sin1*cos2;dmz=sin2;
    } */
    if(tspace==0){	
	  moveplane2(dt);
	  if(tskydome2==1 || tdogfight==1){moveplane3(dt);}
	}//else{moveplane2space(dt);}
	//if(tsea>0 || tgmap==1){moveshipcarrier();}
	//if(tclose==0){timeoutkey=setTimeout("testkeys();",40);}
//}
}
function subkeydown(dt){
        mvPushMatrix();
        mat4.identity(mvMatrix);
        //mat4.rotate(mvMatrix, degtorad(o1), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(o2), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(o3), [0, 0, 1]);
		var y20=-mvMatrix[12],z20=mvMatrix[13],x20=-mvMatrix[14];
		mat4.translate(mvMatrix, [0,-1,0]);
		var y21=-mvMatrix[12],z21=mvMatrix[13],x21=-mvMatrix[14];
		var dx=x20-x21,dy=y20-y21,dz=z20-z21;
		//var dr=0.0001+Math.sqrt(dx*dx+dy*dy+dz*dz);
		//dx/=dr;dy/=dr;dz/=dr;
		//alert((dx)+"  "+(dy)+"  "+(dz));
		mvPopMatrix();
        o2+=dt*0.015*(dz*cos2-dx*sin2);o1+=dt*0.015*dy;
 //o2+=dtime*0.015*cos3;o1+=dtime*0.015*sin3;
 o3-=dt*0.015*sin3*Math.abs(sin2);
}
function subkeydown22(dt){if(o2>0){subkeydown1(dt);}else{subkeydown2(dt);}}
function subkeydown1(dt){
  var do2=45;if(o2>45){do2=90;}
  var o22=o2-do2;
  var co2=Math.cos(degtorad(o22));
  var si2=Math.sin(degtorad(o22));
 o22+=dt*0.015*cos3;o1+=dt*0.015*sin3;
 o3-=dt*0.015*sin3*Math.abs(si2);
 o2=o22+do2;
}
function subkeydown2(dt){
  var do2=45;if(o2<-45){do2=90;}
  var o22=o2+do2;
  var co2=Math.cos(degtorad(o22));
  var si2=Math.sin(degtorad(o22));
 o22+=dt*0.015*cos3;o1+=dt*0.015*sin3;
 o3-=dt*0.015*sin3*Math.abs(si2);
 o2=o22-do2;
}
function subkeyup(dt){subkeydown(-dt);
}
function xtoi(px){return (px+n4)*n/(scale*8);}
function itox(ix){return ix*(scale*8)/n+n4;}
var twater=0,testwater=0,testpiste=0;
var kscalex=n/(scale*8);
function getterrainheight(px,py){if(tspace==1){return z-100;}
    twater=0;
    testpiste=0;
	if(Math.abs(px-pistex)<59.0){
	  if(Math.abs(py-pistey)<59.0){testpiste=1;return pistez;};}
	var dxwater=px-waterx;
	var dywater=py-watery;
	if((dxwater*dxwater+dywater*dywater)<9000){return -0.3;}
	var nx=(px+n4)*kscalex;//n/(scale*8);
	var ny=(py+n4)*kscalex;//n/(scale*8);
	if(nx<=0 || nx>=n || ny<=0 || ny>=n){return 0.01;}
	//while(nx<0){nx+=n};
	//while(ny<0){ny+=n;};
	var i=parseInt(nx),j=parseInt(ny);
	var dx=nx-i,dy=ny-j;
	while(i<0){i+=n;}
	while(i>=n){i-=n;}
	while(j<0){j+=n;}
	while(j>=n){j-=n;}
	var i1=i+1,j1=j+1;
	while(i1<0){i1+=n;}
	while(i1>=n){i1-=n;}
	while(j1<0){j1+=n;}
	while(j1>=n){j1-=n;}
	var ij=i*n+j;
	if(testwater==1){
	 if(i<(n-1) && j<(n-1)){
	  if(height2[ij]<0 || height2[ij+1]<0){twater=1;}
	  if(height2[ij+n]<0 || height2[ij+n+1]<0){twater=1;}
	 
	  if(i>1 && j>1){
	   if(height2[ij-1]<0 || height2[ij-1+n]<0){twater=1;}
	   if(height2[ij+1-n]<0){twater=1;}
	   if(height2[ij-n]<0 || height2[ij-n-1]<0){twater=1;}
	  }
	 }
	}
	//return height[parseInt(nx)*n+parseInt(ny)];
if(dx<=(1.0-dy)){ 
    var z00=height[i*n+j];
    var z10=height[i1*n+j];
    var z01=height[i*n+j1];
    return ( dx*(z10-z00) +dy*(z01-z00) +z00)+0.05;
}else{
    var z10=height[i1*n+j];
    var z01=height[i*n+j1];
    var z11=height[i1*n+j1];
    return ( (1-dx)*(z01-z11) +(1-dy)*(z10-z11) +z11 )+0.05;
	}
}
function getterrainheight1(px,py){if(tspace==1){return z-100;}
testpiste=0;
if(tgmap==1){	
	if(Math.abs(px-portx)<(xmax-xmin)/8 && nairport>0){
	  if(Math.abs(py-porty)<(ymax-ymin)/8){
	    testpiste=1;
		return Math.max(portz+0.5,getterrainheight(px,py));};}
}
return getterrainheight(px,py);
}
var testtown=0;	
function getterrainheight2(px,py){if(tspace==1){return z-100;}
	var h=getheighttown(px,py);
	if(h>0){testtown=1;return h;}
	testtown=0;
    if(Math.abs(px-shipx)<9){if(Math.abs(py-shipy)<9){
       var dx=px-shipx,dy=py-shipy;
	   var dxx=dx*shipco1+dy*shipsi1;
	   if(Math.abs(dxx)<9){
	      var dyy=Math.abs(-dx*shipsi1+dy*shipco1);
		  if(dyy<2){if(dxx<5 && dxx>-3){return 4;}else{return 3;};};
	   }
	};}
	if(tsea>0 || tgmap==1){
    if(Math.abs(px-shipcarrierx)<27){if(Math.abs(py-shipcarriery)<27){
       var dx=px-shipcarrierx,dy=py-shipcarriery;
	   var dxx=dx*shipcarrierco1+dy*shipcarriersi1;
	   if(dxx>-24.5 && dxx<19.9){
	      var dyy=(-dx*shipcarriersi1+dy*shipcarrierco1);
		  if(dyy>-3.7 && dyy<7){if(dxx>-2.4 && dxx<6.7 && dyy<-0.2){return 3.7;}else{tpiste=1;tcarrier=1;return 2.15;};};
	   }
	};}
	}
	return getterrainheight1(px,py);
}
var nplane=7,nplanemax=10;
var npx=[],npy=[],npz=[],npo1=[],npo2=[],npo3=[],npvrun=[],npvie=[];
var npcos1=[],npsin1=[],npcos2=[],npsin2=[],npcos3=[],npsin3=[],npdo1=[],npdo2=[],npdo3=[];
var ntpo1=[],ntpo2=[],npkeys=[],nptshoot=[],npkdo1=[],npisoleil=[];
var npvplane=[],npdmx=[],npdmy=[],npdmz=[],nptsmoke=[];
var ndxradarplane2=[],no1radarplane2=[],ntradarplane2=[],npboom=[];
var ndirtir=[],ndirtirz=[],nptkeytir=[];
for(i=0;i<nplanemax;i++){npkeys[i]=[];}
function saveplane(i){
npx[i]=px;npy[i]=py;npz[i]=pz;npo1[i]=po1;npo2[i]=po2;npo3[i]=po3;npvrun[i]=pvrun;npvie[i]=pvie;
npcos1[i]=pcos1;npsin1[i]=psin1;npcos2[i]=pcos2;npsin2[i]=psin2;npcos3[i]=pcos3;npsin3[i]=psin3;npdo1[i]=pdo1;npdo2[i]=pdo2;npdo3[i]=pdo3;
ntpo1[i]=tpo1;ntpo2[i]=tpo2;nptshoot[i]=ptshoot;npkdo1[i]=pkdo1;npisoleil[i]=pisoleil;
npvplane[i]=pvplane;npdmx[i]=pdmx;npdmy[i]=pdmy;npdmz[i]=pdmz;nptsmoke[i]=ptsmoke;
ndxradarplane2[i]=dxradarplane2;no1radarplane2[i]=o1radarplane2;ntradarplane2[i]=tradarplane2;
for(j=32;j<42;j++){npkeys[i][j]=pkeys[j];}
npboom[i]=pboom;ndirtir[i]=dirtir;ndirtirz[i]=dirtirz;nptkeytir[i]=ptkeytir;
}
function loadplane(i){
px=npx[i];py=npy[i];pz=npz[i];po1=npo1[i];po2=npo2[i];po3=npo3[i];pvrun=npvrun[i];pvie=npvie[i];
pcos1=npcos1[i];psin1=npsin1[i];pcos2=npcos2[i];psin2=npsin2[i];pcos3=npcos3[i];psin3=npsin3[i];pdo1=npdo1[i];pdo2=npdo2[i];pdo3=npdo3[i];
tpo1=ntpo1[i];tpo2=ntpo2[i];ptshoot=nptshoot[i];pkdo1=npkdo1[i];pisoleil=npisoleil[i];
pvplane=npvplane[i];pdmx=npdmx[i];pdmy=npdmy[i];pdmz=npdmz[i];ptsmoke=nptsmoke[i];
dxradarplane2=ndxradarplane2[i];o1radarplane2=no1radarplane2[i];tradarplane2=ntradarplane2[i];
for(j=32;j<42;j++){pkeys[j]=npkeys[i][j];}
pboom=npboom[i];dirtir=ndirtir[i];dirtirz=ndirtirz[i];ptkeytir=nptkeytir[i];
}
var tinitnplane=0,npboom0=[];
for(var i=0;i<Math.max(10,nplanemax);i++){npboom0[i]=0;}
function drawnplane2space(){
if(tinitnplane==0){tinitnplane=1;pisoleil=isoleilmin;
  moveplane2space(dtime);pvie=100;
  for(var i=0;i<nplanemax;i++){saveplane(i);npx[i]+=i*60;npboom[i]=npboom0[i];}
  return;
}
distplanemin=999999,iplane=0;
for(var i=0;i<nplane;i++){
  loadplane(i);
  if(i==0){pxtarget=0;
     if(tdogfight==1 && npvie[0]>0 && isoleilmin==0){pxtarget=x-60*cos1;pytarget=y-60*sin1;pztarget=z;}}
  else if(npboom[i-1]==0){pxtarget=npx[i-1]-60*npcos1[i-1];
       pytarget=npy[i-1]-60*npsin1[i-1];
	   pztarget=npz[i-1];}
  else{pxtarget=x-60*cos1;pytarget=y-60*sin1;pztarget=z;}
  iplane=i;  
  moveplane2space(dtime);
  drawplane2space();
  saveplane(i);
}
}
var tpo1=0,tpo2=0;
var pvplane=0,pdmx=0,pdmy=0,pdmz=0,ptsmoke=0;
function moveplane2(dt){
    if(pvie<100){pvie+=Math.random()*dtime*0.0004;};
	if(pvie>-300*tdogfight && pvie<30 && tframe>ptsmoke){
	    ptsmoke=tframe+200+Math.random()*350;
	    addsmoke(px,py,pz,1.5,0);}
	if(tdogfight==1){pvie=-pvie;}
	var pdx=0,pdy=0,pdz=0,pdo1=0,pdo2=0,pdist=1000;
	if(pvie<0){pdx=x-px;pdy=y-py;pdz=z-pz;
	   pdist=pdx*pcos1*pcos2+pdy*psin1*pcos2+pdz*psin2;
	   pdo1=-pdx*psin1+pdy*pcos1;
	   pdo2=pdz;
	   if(pdist>2 && pdist<100 && Math.abs(pdo1)<pdist/6 && Math.abs(pdo2)<pdist/6){pkeys[32]=1;}
	}
	var po10=po1,po20=po2,po30=po3;
	var distmax=900;
	while(px<(x-distmax)){px+=1.9999*distmax;}
	while(px>(x+distmax)){px-=1.9999*distmax;}
	while(py<(y-distmax)){py+=1.9999*distmax;}
	while(py>(y+distmax)){py-=1.9999*distmax;}
	var alt=getterrainheight2(px+40*pcos1,py+40*psin1);
	var alt0=getterrainheight(px+5*pcos1,py+5*psin1);
	if(pz<(alt0+1)){pz=alt0+1.1;if(po2<-1.1){po2=-1.0;};};
	var t=timer();
	if (t>tpo1 && alt>(pz-5)){
	   tpo1=t+Math.random()*7000;tattack=0;
	   var alt1=getterrainheight(px+40*pcos1-15*psin1,px+40*psin1+15*psin1);
	   var alt2=getterrainheight(px+40*pcos1+15*psin1,px+40*psin1-15*psin1);
	   if(alt1<alt2){pkeys[37]=1;pkeys[39]=0;}else{pkeys[37]=0;pkeys[39]=1;};
	}
	pz-=alt0;
	if(pvie>0 || (pdist*0.4)<Math.abs(pdo1)){
	 if(pvie<0 && Math.random()*20<0.001*dt){tattack=1;}
	 if(pkeys[37] || pkeys[39]){tattack=0;}
	 if(tattack){tattack=0;
	   tpo1=t+Math.random()*20000;
	   if(Math.random()>0.5){pkeys[37]=1;pkeys[39]=0;}else{pkeys[37]=0;pkeys[39]=1;};
	 }
	}else{
	 pkeys[37]=0;pkeys[39]=0;tattack=1;
     pdo1+=dirtir*Math.abs(pdist)*0.3;
	 if(pdo1>(pdist/4)){pkeys[37]=1;pkeys[39]=0;tattack=0;tpo1=t+2;}
	 if(pdo1<(-pdist/4)){pkeys[37]=0;pkeys[39]=1;tattack=0;tpo1=t+2;}
	 if(tattack){tattack=0;
	   tpo1=t+Math.random()*20000;
	   if(Math.random()>0.5){pkeys[37]=1;pkeys[39]=0;}else{pkeys[37]=0;pkeys[39]=1;};
	 }
    }
	if (t>tpo1){if(Math.random()<0.001*dt){if(Math.random()<1/40){//40sec
	   tpo1=t+Math.random()*20000;
	   if(Math.random()>0.5){pkeys[37]=1;pkeys[39]=0;}else{pkeys[37]=0;pkeys[39]=1;};
	}}else{pkeys[37]=0;pkeys[39]=0;
	      if(po3<-2){pkeys[37]=1;};if(po3>2){pkeys[39]=1;};};
	}
	if(pvie<0 && pdist>Math.abs(pdo1/2)){
	 if(pdo2>(pdist/7)){pkeys[38]=0;pkeys[40]=1;tattack=0;tpo2=t+2;}
	 if(pdo2<(-pdist/5)){pkeys[38]=1;pkeys[40]=0;tattack=0;tpo2=t+2;}
	}
    var h=0;if(tdogfight==1){h=Math.max(0,z-30-alt0);}
	if (t>tpo2){if(Math.random()<0.001*dt){if(Math.random()<1/40){//40sec
	   tpo2=t+Math.random()*10000;
	   if(Math.random()>0.5){pkeys[40]=1;pkeys[38]=0;}else{pkeys[40]=0;pkeys[38]=1;};
	}}else{pkeys[40]=0;pkeys[38]=0;
	     if(pvie>0){
		  if(pz<18){pkeys[40]=1;};if(pz>40+h){pkeys[38]=1;};
		 }else{
		  if(pz<5.5){pkeys[40]=1;};if(pz>90+h){pkeys[38]=1;};
		 };
	 }
	}
	if(tdogfight==0){if(pvplane<0.65){pvrun=1.3;}else{pvrun=1.0;};
	}else{if(pvplane<0.90){pvrun=1.5;}else{pvrun=1.2;};}
	if(pvie>0 || pdist<Math.abs(pdo1/4)){
	  if(pz>40+h || pvplane<0.5){pkeys[40]=0;pkeys[38]=1;if(pz>45.01+h){pz=45+h;};}
	  if(pz<18){pkeys[40]=1;pkeys[38]=0;if(pz<15){pz=15.01;};}
	}else{
	  if(pz>90+h || pvplane<0.5){pkeys[40]=0;pkeys[38]=1;if(pz>95.01+h){pz=95+h;};}
	  if(pz<5.5){pkeys[40]=1;pkeys[38]=0;if(pz<4){pz=4.01;};}
	}
	pz+=alt0;
	tattack=0;
    //left=37,up=38,right=39,down=40,pageup=33,pagedown=34,m=77,esc=27,h=72,shift=16
    //p=80,T=84
    if (pkeys[40]) {po2+=dt*0.015*pcos3;if(po2>89){po2=89;};po1+=dt*0.015*psin3;}
    if (pkeys[38]) {po2-=dt*0.015*pcos3;if(po2<-89){po2=-89;};po1-=dt*0.015*psin3;}
    if (pkeys[37]) {po3+=dt*0.019;if(po3>180){po3-=360;po30-=360;};}
    if (pkeys[39]) {po3-=dt*0.019;if(po3<-180){po3+=360;po30+=360;};}
	if (pkeys[33] || pkeys[16]) {pvrun+=dt*0.0003;if(pvrun>1.3){pvrun=1.3;};};
    if (pkeys[34]) {pvrun-=dt*0.0003;if(pvrun<0){pvrun=0;};};
	if (pkeys[32]) {pkeys[32]=0;if(tframe>(ptkeytir+80)){soundshoot();ptir();};}
	if(pvie>0 || pdist<(-Math.abs(pdo1/3))){
	 if(po3<-35.01){po3=-35;}
	 if(po3>35.01){po3=35;}
    }else{
	 if(po3<-45.01){po3=-45;}
	 if(po3>45.01){po3=45;}
	}
	if(po2<-18.01){po2=-18;}
	if(po2>10.01){po2=10;}
	//var pair=10000.0/(10000+z);
	////vplane+=0.4*((vrun-vplane)*0.0013*0.8*air*dt-dt*(air*0.0003*vplane+sin2*0.004));
	//pvplane+=0.7*((pvrun)*0.0003*pair*dt-dt*(pair*0.0003*pvplane+psin2*0.0024));
	var pair=(4000-pz)/(4000+pz);if(pair<0){pair=0;};
	//vplane+=0.4*((vrun-vplane)*0.0013*0.8*air*dt-dt*(air*0.0003*vplane+sin2*0.004));
	var pvrun2=pvrun*((3-1.4*pvplane)/2)*3*pair*pair/(2+pair*pair);
	if(pdist>50 && pvie<0){if(pvrun2<1.5 && pdist>Math.abs(pdo1/2)){pvrun2=1.5;};}
	//pvplane+=0.8*((pvrun2)*0.0003*pair*dt-dt*(pair*0.0003*pvplane+(psin2+0.03)*0.0024));
	pvplane+=0.8*((pvrun2)*0.0003*pair*dt-dt*(pair*0.0003*pvplane+(psin2+0.01)*0.0020));
	if(pvplane>4){pvplane=4;}//max vv=800
	//var pair=50000.0/(50000+pz);
	//pvplane+=0.4*((pvrun-pvplane)*0.0013*0.8*pair*dt-dt*(pair*0.0003*pvplane+psin2*0.004));
    var pvdt=dt*0.013*pvplane;var pvcruise=0.8;
	po1+=psin3*dt*0.010;
	po2-=Math.abs(Math.sin(degtorad(0.7*po3)))*dt*0.0015;
	po2+=(pvplane*pair-pvcruise)*pair*pcos2*pcos3*dt*0.01;
	if(po3>0.1){po3-=dt*0.001;};
	if(po3<-0.1){po3+=dt*0.001;};
	var dt1=(dt*0.002);
	if(dt1>0.8){dt1=0.8;}
	pdo3+=(po3-po30)-dt1*pdo3;
	pdo2+=(po2-po20)-dt1*pdo2;
	pdo1+=(po1-po10)-dt1*pdo1;
	if(pdo1<-20){pdo1=-20;}
	if(pdo1>20){pdo1=20;}
	if((po1-po10)*psin3<0){po3-=po3*dt*0.0015;
	   if(po3>0){pkeys[37]=0;}else{pkeys[39]=0;};}
	po1+=pdo1*dt*0.001;
	po2+=pdo2*dt*0.0025;
	po3+=pdo3*dt*0.0025;
	if(Math.abs(po3)<1.6){po3+=Math.cos(timer()*0.0015)*0.2*(1.6-Math.abs(po3));};
	px+=pvdt*pcos1*pcos2;
	py+=pvdt*psin1*pcos2;
	pz+=pvdt*psin2;
    if(po2>85){po2=84-(po2-85);po1=180+po1;po3=180+po3;};
    if(po2<-85){po2=-84-(po2+85);po1=180+po1;po3=180+po3;};
	if(po1>180){po1-=360;} 
	if(po1<-180){po1+=360;}
	if(po3>180){po3-=360;}
	if(po3<-180){po3+=360;}
    pcos1=Math.cos(degtorad(po1));psin1=Math.sin(degtorad(po1));
    pcos2=Math.cos(degtorad(po2));psin2=Math.sin(degtorad(po2));
    pcos3=Math.cos(degtorad(po3));psin3=Math.sin(degtorad(po3));
	pdmx=pcos1*pcos2;pdmy=psin1*pcos2;pdmz=psin2;
	if(tdogfight==1){pvie=-pvie;}
}
var distplanemin=0,pxtarget=0,pytarget=0,pztarget=0,ptshoot=0,pkdo1=1,pisoleil=0;
var pboom=0;	
function moveplane2space(dt){
    if(pisoleil!=isoleilmin){pboom=0;}
	else if(pboom!=0){return;}
	//pxtarget=x-60*cos1;pytarget=y-60*sin1;pztarget=z;
    if(pvie<100){pvie+=Math.random()*dtime*0.0001;};
    if(pvie<100 && pvie>0){pvie+=Math.random()*dtime*0.0002;};
	if(pvie<-300){pvie=-300;}
    if(pvie<30 && tframe>ptsmoke){
	    ptsmoke=tframe+200+Math.random()*350;
	    addsmoke(px,py,pz,1.5,0);}
	var pdx=0,pdy=0,pdz=0,pdoo1=0,pdoo2=0,pdist=1000,pvie0=pvie,pwar=0;
	if(tdogfight==1){pvie=-pvie;}
	pdx=x-px;pdy=y-py;pdz=z-pz;
	var dist0=Math.sqrt(pdx*pdx+pdy*pdy+pdz*pdz);
	if((pvie<30 || (pvie<99 && pxtarget!=0))&& pvie0>0){
	   pdist=pdx*pcos1*pcos2+pdy*psin1*pcos2+pdz*psin2;
	   if(pdist>vplane*5+10){
	       pdx=x+vplane*5*dmx-px;pdy=y+vplane*5*dmy-py;pdz=z+vplane*5*dmz-pz;
     	   pdist=pdx*pcos1*pcos2+pdy*psin1*pcos2+pdz*psin2;
		  }
	   pdo1=-pdx*psin1+pdy*pcos1;
	   pdo2=pdz;pwar=1;
	   var pdist6=Math.max(3,pdist/5.5);
	   if(pdist>2 && pdist<200 && Math.abs(pdo1)<pdist6 && Math.abs(pdo2)<pdist6){pkeys[32]=1;ptshoot=tframe+8000;}
	}else if(pxtarget!=0){pdx=pxtarget-px;pdy=pytarget-py;pdz=pztarget-pz;
	   pdist=pdx*pcos1*pcos2+pdy*psin1*pcos2+pdz*psin2;
	   pdo1=-pdx*psin1+pdy*pcos1;
	   pdo2=pdz;pvie=-Math.abs(pvie);
	}else{pvie=Math.abs(pvie);}
	var dist=Math.sqrt(pdx*pdx+pdy*pdy+pdz*pdz);
	var distxy=Math.max(Math.abs(pdx),Math.abs(pdy));
	distplanemin=Math.min(dist0,distplanemin);
	var po10=po1,po20=po2,po30=po3;
	var distmax=1900,test=0;
	var distplane=dist;
  if(dist0>1900){
	if(pxtarget!=0){
	 while(px<(pxtarget-distmax)){px+=1.9999*distmax;test=1;}
	 while(px>(pxtarget+distmax)){px-=1.9999*distmax;test=1;}
	 while(py<(pytarget-distmax)){py+=1.9999*distmax;test=1;}
	 while(py>(pytarget+distmax)){py-=1.9999*distmax;test=1;}
	 while(pz<(pztarget-distmax)){pz+=1.9999*distmax;test=1;}
	 while(pz>(pztarget+distmax)){pz-=1.9999*distmax;test=1;}
	 if(test==1 || pisoleil!=isoleilmin){pisoleil=isoleilmin;
	                                     pvie0=100;pvie=100;pboom=0;}
	}
	test=0;
	if(distplane>distmax && isoleilmin>=0){test=1;}
	if(test==1){
	 test=0;
	 if(pxtarget!=0){distmax+=11000;}
	 else{distmax=9000;}
	 while(px<(earthminx-distmax)){px+=1.9999*distmax;test=1;}
	 while(px>(earthminx+distmax)){px-=1.9999*distmax;test=1;}
	 while(py<(earthminy-distmax)){py+=1.9999*distmax;test=1;}
	 while(py>(earthminy+distmax)){py-=1.9999*distmax;test=1;}
	 while(pz<(earthminz-distmax)){pz+=1.9999*distmax;test=1;}
	 while(pz>(earthminz+distmax)){pz-=1.9999*distmax;test=1;}
	 if(test==1 || pisoleil!=isoleilmin){pisoleil=isoleilmin;
	                                     pvie0=100;pvie=100;pboom=0;}
	}
  }//dist0
	var distearth=1+Math.max(Math.abs(earthminx-px),Math.abs(earthminy-py))+Math.abs(earthminz-pz);
	if(distearth<earthminr*30){
	   px+=dtime*0.005*(px-earthminx)/distearth;
	   py+=dtime*0.005*(py-earthminy)/distearth;
	   pz+=dtime*0.005*(pz-earthminz)/distearth;
	   }
	var distsoleil=1+Math.max(Math.abs(soleilminx-px),Math.abs(soleilminy-py))+Math.abs(soleilminz-pz);
	if(distsoleil<soleilminr*30){
	   px+=dtime*0.005*(px-soleilminx)/distsoleil;
	   py+=dtime*0.005*(py-soleilminy)/distsoleil;
	   pz+=dtime*0.005*(pz-soleilminz)/distsoleil;
	   }
	var alt=z-30-distxy*0.5;//getterrainheight2(px+40*pcos1,py+40*psin1);
	var alt0=z-30-distxy*0.5;//getterrainheight(px+5*pcos1,py+5*psin1);
	if(pisoleil!=isoleilmin){
	    alt=npz[0]-30;
		alt0=npz[0]-30;}
	if(pz<(alt0+1)){pz=alt0+1.1;if(po2<-1.1){po2=-1.0;};};
	var t=timer();
	/*if (t>tpo1 && alt>(pz-5)){
	   tpo1=t+Math.random()*7000;tattack=0;
	   var alt1=getterrainheight(px+40*pcos1-15*psin1,px+40*psin1+15*psin1);
	   var alt2=getterrainheight(px+40*pcos1+15*psin1,px+40*psin1-15*psin1);
	   if(alt1<alt2){pkeys[37]=1;pkeys[39]=0;}else{pkeys[37]=0;pkeys[39]=1;};
	}*/
	pz-=alt0;
  if(t>tpo1){
    pkdo1=1;
    if(ptshoot<0 && Math.random()<0.5){
	   tpo1=t+Math.random()*20000;pkdo1=-1;
	   if(Math.random()>0.5){pkeys[37]=1;pkeys[39]=0;}else{pkeys[37]=0;pkeys[39]=1;};
    }
	ptshoot=Math.max(1,ptshoot);
  }
  if(t>tpo1){
	if(pvie>0 || (pdist*0.4)<Math.abs(pdo1)){
	 if(pvie<0 && Math.random()*20<0.001*dt){tattack=1;}
	 if(pkeys[37] || pkeys[39]){tattack=0;}
	 if(tattack){tattack=0;
	   tpo1=t+Math.random()*20000;
	   if(Math.random()>0.5){pkeys[37]=1;pkeys[39]=0;}else{pkeys[37]=0;pkeys[39]=1;};
	 }
	}else{
	 pkeys[37]=0;pkeys[39]=0;tattack=1;
     pdo1+=dirtir*Math.abs(pdist)*0.3;//cf testtir()
	 if(Math.random()>0.1){
       if(pdo1>(pdist/4)){pkeys[37]=1;pkeys[39]=0;tattack=0;tpo1=t+50;}
	   if(pdo1<(-pdist/4)){pkeys[37]=0;pkeys[39]=1;tattack=0;tpo1=t+50;}
	 }else{
       if(pdo1>(pdist/4)){pkeys[37]=0;pkeys[39]=1;tattack=0;tpo1=t+2000;}
	   if(pdo1<(-pdist/4)){pkeys[37]=1;pkeys[39]=0;tattack=0;tpo1=t+2000;}
	 }  
	 if(tattack){tattack=0;
	   tpo1=t+Math.random()*20000;
	   if(Math.random()>0.5){pkeys[37]=1;pkeys[39]=0;}else{pkeys[37]=0;pkeys[39]=1;};
	 }
    }
  }
	if (t>tpo1){if(Math.random()<0.001*dt){if(Math.random()<1/40){//40sec
	   tpo1=t+Math.random()*20000;
	   if(Math.random()>0.5){pkeys[37]=1;pkeys[39]=0;}else{pkeys[37]=0;pkeys[39]=1;};
	}}else{pkeys[37]=0;pkeys[39]=0;
	      if(po3<-2){pkeys[37]=1;};if(po3>2){pkeys[39]=1;};};
	}
  if(t>tpo2){	
	if(pvie<0 && pdist>Math.abs(pdo1/2)){
     pdo2-=dirtirz*Math.abs(pdist)*0.1;//cf testtir()
	 if(pdo2>(pdist/7)){pkeys[38]=0;pkeys[40]=1;tattack=0;tpo2=t+100;}
	 if(pdo2<(-pdist/5)){pkeys[38]=1;pkeys[40]=0;tattack=0;tpo2=t+100;}
	}
  }
    var h=0;if(tdogfight==1){h=Math.max(0,z-30-alt0);}
	h+=distxy*0.99;
	if (t>tpo2){if(Math.random()<0.001*dt){if(Math.random()<1/40){//40sec
	   tpo2=t+Math.random()*10000;
	   if(Math.random()>0.5){pkeys[40]=1;pkeys[38]=0;}else{pkeys[40]=0;pkeys[38]=1;};
	}}else{pkeys[40]=0;pkeys[38]=0;
	     if(pvie>0){
		  if(pz<18){pkeys[40]=1;};if(pz>40+h){pkeys[38]=1;};
		 }else{
		  if(pz<5.5){pkeys[40]=1;};if(pz>90+h){pkeys[38]=1;};
		 };
	 }
	}
	if(tdogfight==0 && pwar==0){if(pvplane<0.65){pvrun=1.3;}else{pvrun=1.0;};
	}else{if(pvplane<0.90){pvrun=1.5;}else{pvrun=1.2;};}
	if(tframe<ptshoot){pvrun=0.5;}
	if(pvie>0 || pdist<Math.abs(pdo1/4)){
	  if(pz>40+h || pvplane<0.5){pkeys[40]=0;pkeys[38]=1;if(pz>45.01+h){pz=45+h;};}
	  if(pz<18){pkeys[40]=1;pkeys[38]=0;if(pz<15){pz=15.01;};}
	}else{
	  if(pz>90+h || pvplane<0.5){pkeys[40]=0;pkeys[38]=1;if(pz>95.01+h){pz=95+h;};}
	  if(pz<5.5){pkeys[40]=1;pkeys[38]=0;if(pz<4){pz=4.01;};}
	}
	pz+=alt0;
	tattack=0;
    //left=37,up=38,right=39,down=40,pageup=33,pagedown=34,m=77,esc=27,h=72,shift=16
    //p=80,T=84
    if (pkeys[40]) {po2+=dt*0.015*pcos3;if(po2>89){po2=89;};po1+=dt*0.015*psin3;}
    if (pkeys[38]) {po2-=dt*0.015*pcos3;if(po2<-89){po2=-89;};po1-=dt*0.015*psin3;}
    if (pkeys[39]) {po3+=dt*0.019;if(po3>180){po3-=360;po30-=360;};}
    if (pkeys[37]) {po3-=dt*0.019;if(po3<-180){po3+=360;po30+=360;};}
	if (pkeys[33] || pkeys[16]) {pvrun+=dt*0.0003;if(pvrun>1.3){pvrun=1.3;};};
    if (pkeys[34]) {pvrun-=dt*0.0003;if(pvrun<0){pvrun=0;};};
	if (pkeys[32]) {pkeys[32]=0;if(tframe>(ptkeytir+80)){
	    ptkeytir=tframe;soundshoot();ptir();};}
	if(pvie>0 || pdist<(-Math.abs(pdo1/3))){
	 if(po3<-35.01){po3=-35;}
	 if(po3>35.01){po3=35;}
    }else{
	 if(po3<-45.01){po3=-45;}
	 if(po3>45.01){po3=45;}
	}
	if(po2<-18.01){po2=-18;}
	if(po2>10.01){po2=10;}
	//var pair=10000.0/(10000+z);
	////vplane+=0.4*((vrun-vplane)*0.0013*0.8*air*dt-dt*(air*0.0003*vplane+sin2*0.004));
	//pvplane+=0.7*((pvrun)*0.0003*pair*dt-dt*(pair*0.0003*pvplane+psin2*0.0024));
	var pair=1;//(4000-pz)/(4000+pz);if(pair<0){pair=0;};
	//vplane+=0.4*((vrun-vplane)*0.0013*0.8*air*dt-dt*(air*0.0003*vplane+sin2*0.004));
	var pvrun2=pvrun*((3-1.4*pvplane)/2)*3*pair*pair/(2+pair*pair);
	if(pdist>50 && pvie<0){if(pvrun2<1.5 && pdist>Math.abs(pdo1/2)){pvrun2=1.5;};}
	//pvplane+=0.8*((pvrun2)*0.0003*pair*dt-dt*(pair*0.0003*pvplane+(psin2+0.03)*0.0024));
	pvplane+=0.8*((pvrun2)*0.0003*pair*dt-dt*(pair*0.0003*pvplane+(psin2+0.01)*0.0));
	if(pvplane>4){pvplane=4;}//max vv=800
	//var pair=50000.0/(50000+pz);
	//pvplane+=0.4*((pvrun-pvplane)*0.0013*0.8*pair*dt-dt*(pair*0.0003*pvplane+psin2*0.004));
    var pvdt=dt*0.013*pvplane;var pvcruise=0.8;
	po1+=psin3*dt*0.013;
	po2-=Math.abs(Math.sin(degtorad(0.7*po3)))*dt*0.0015;
	po2+=(pvplane*pair-pvcruise)*pair*pcos2*pcos3*dt*0.01;
	if(po3>0.1){po3-=dt*0.001;};
	if(po3<-0.1){po3+=dt*0.001;};
	var dt1=(dt*0.002);
	if(dt1>0.8){dt1=0.8;}
	pdo3+=(po3-po30)-dt1*pdo3;
	pdo2+=(po2-po20)-dt1*pdo2;
	pdo1+=(po1-po10)-dt1*pdo1;
	if(pdo1<-20){pdo1=-20;}
	if(pdo1>20){pdo1=20;}
	//if((po1-po10)*psin3<0){po3-=po3*dt*0.0015;
	//   if(po3>0){pkeys[37]=0;}else{pkeys[39]=0;};}
	if(pkdo1==1){po1+=pdo1*dt*0.001;}
	else{po1+=sign(psin3)*Math.abs(pdo1*dt*0.001);}
	po2+=pdo2*dt*0.0025;
	po3+=pdo3*dt*0.0025;
	if(Math.abs(po3)<1.6){po3+=Math.cos(timer()*0.0015)*0.2*(1.6-Math.abs(po3));};
	px+=pvdt*pcos1*pcos2*1.7;
	py+=pvdt*psin1*pcos2*1.7;
	pz+=pvdt*psin2*1.7;
    if(po2>85){po2=84-(po2-85);po1=180+po1;po3=180+po3;};
    if(po2<-85){po2=-84-(po2+85);po1=180+po1;po3=180+po3;};
	if(po1>180){po1-=360;} 
	if(po1<-180){po1+=360;}
	if(po3>180){po3-=360;}
	if(po3<-180){po3+=360;}
    pcos1=Math.cos(degtorad(po1));psin1=Math.sin(degtorad(po1));
    pcos2=Math.cos(degtorad(po2));psin2=Math.sin(degtorad(po2));
    pcos3=Math.cos(degtorad(po3));psin3=Math.sin(degtorad(po3));
	pdmx=pcos1*pcos2;pdmy=psin1*pcos2;pdmz=psin2;
	if(tdogfight==1){pvie=-pvie;}
	pvie=pvie0;
}	
var tp3o1=0,tp3o2=0;
var p3vplane=0,p3dmx=0,p3dmy=0,p3dmz=0;
var p3keys=new Array(256),p3tkeytir=0,p3tfollow=0,p3tsmoke=0;
function moveplane3(dt){
    if(p3vie<100){p3vie+=Math.random()*dtime*0.0004;};
	if(p3vie>-300*tdogfight && p3vie<30 && tframe>p3tsmoke){
	    p3tsmoke=tframe+200+Math.random()*350;
	    addsmoke(p3x,p3y,p3z,1.5,0);}
	if(tdogfight==1){p3vie=-p3vie;}
	var p3dx=0,p3dy=0,p3dz=0,p3do1=0,p3do2=0,p3dist=1000,p3vie0=p3vie;
    p3dx=x-p3x;p3dy=y-p3y;p3dz=z-p3z;
	var ddir=p3cos1*p3dx+p3sin1*p3dy;
	if(p3vie<0 && (ddir>Math.abs(p3dz*0.3) || pvie<0)){
	   p3dist=p3dx*p3cos1*p3cos2+p3dy*p3sin1*p3cos2+p3dz*p3sin2;
	   p3do1=-p3dx*p3sin1+p3dy*p3cos1;
	   p3do2=p3dz;
	   if(p3dist>2 && p3dist<100 && Math.abs(p3do1)<p3dist/6 && Math.abs(p3do2)<p3dist/6){p3keys[32]=1;}
	}else{p3dx=px-p3x;p3dy=py-p3y;p3dz=pz-p3z;
	   p3dist=p3dx*p3cos1*p3cos2+p3dy*p3sin1*p3cos2+p3dz*p3sin2;
	   p3do1=-p3dx*p3sin1+p3dy*p3cos1;
	   p3do2=p3dz;
	   if(p3vie<99 && tdogfight==0){
	      if(p3dist>2 && p3dist<100 && Math.abs(p3do1)<p3dist/6 && Math.abs(p3do2)<p3dist/6){p3keys[32]=1;}
	   }
	}
	if(p3vie<99 || p3dist>(8+Math.abs(p3do1))){p3vie=-90;
	}else{p3do1=0;p3do2=0;}
	if(tframe<p3tfollow && p3vie0>99){p3do1=0;p3do2=0;p3vie=100;
	}else{if(Math.random()*500<dt*0.001){p3tfollow=tframe+20000;};}
	var p3o10=p3o1,p3o20=p3o2,p3o30=p3o3;
	var distmax=900; 
	while(p3x<(x-distmax)){p3x+=1.9999*distmax;}
	while(p3x>(x+distmax)){p3x-=1.9999*distmax;}
	while(p3y<(y-distmax)){p3y+=1.9999*distmax;}
	while(p3y>(y+distmax)){p3y-=1.9999*distmax;}
	var alt=getterrainheight2(p3x+40*p3cos1,p3y+40*p3sin1);
	var alt0=getterrainheight(p3x+5*p3cos1,p3y+5*p3sin1);
	if(p3z<(alt0+1)){p3z=alt0+1.1;if(p3o2<-1.1){p3o2=-1.0;};};
	var t=timer();
	if (t>tp3o1 && alt>(p3z-5)){
	   tp3o1=t+Math.random()*7000;tattackp3=0;
	   var alt1=getterrainheight(p3x+40*p3cos1-15*p3sin1,p3x+40*p3sin1+15*p3sin1);
	   var alt2=getterrainheight(p3x+40*p3cos1+15*p3sin1,p3x+40*p3sin1-15*p3sin1);
	   if(alt1<alt2){p3keys[37]=1;p3keys[39]=0;}else{p3keys[37]=0;p3keys[39]=1;};
	}
	p3z-=alt0;
	if(p3vie>0 || (p3dist*1.4)<Math.abs(p3do1)){
	 if(p3vie<0 && Math.random()*20<0.001*dt){tattackp3=1;}
	 if(p3keys[37] || p3keys[39]){tattackp3=0;}
	 if(tattackp3){tattackp3=0;
	   tp3o1=t+Math.random()*20000;
	   if(Math.random()>0.5){p3keys[37]=1;p3keys[39]=0;}else{p3keys[37]=0;p3keys[39]=1;};
	 }
	}else{
	 p3keys[37]=0;p3keys[39]=0;tattackp3=1;
     p3do1+=dirtir*Math.abs(p3dist)*0.3;
	 if(p3do1>(p3dist/4)){p3keys[37]=1;p3keys[39]=0;tattackp3=0;tp3o1=t+2;}
	 if(p3do1<(-p3dist/4)){p3keys[37]=0;p3keys[39]=1;tattackp3=0;tp3o1=t+2;}
	 if(tattackp3){tattackp3=0;
	   tp3o1=t+Math.random()*20000;
	   if(Math.random()>0.5){p3keys[37]=1;p3keys[39]=0;}else{p3keys[37]=0;p3keys[39]=1;};
	 }
    }	
	if (t>tp3o1){if(Math.random()<0.001*dt){if(Math.random()<1/40){//40sec
	   tp3o1=t+Math.random()*20000;
	   if(Math.random()>0.5){p3keys[37]=1;p3keys[39]=0;}else{p3keys[37]=0;p3keys[39]=1;};
	}}else{p3keys[37]=0;p3keys[39]=0;
	      if(p3o3<-2){p3keys[37]=1;};if(p3o3>2){p3keys[39]=1;};};
	}
	if(p3vie<0 && p3dist>Math.abs(p3do1/2)){
	 if(p3do2>(p3dist/7)){p3keys[38]=0;p3keys[40]=1;tattackp3=0;tp3o2=t+2;}
	 if(p3do2<(-p3dist/5)){p3keys[38]=1;p3keys[40]=0;tattackp3=0;tp3o2=t+2;}
	}
	var h=0;if(tdogfight==1){h=Math.max(0,z-30-alt0);}
	if (t>tp3o2){if(Math.random()<0.001*dt){if(Math.random()<1/40){//40sec
	   tp3o2=t+Math.random()*10000;
	   if(Math.random()>0.5){p3keys[40]=1;p3keys[38]=0;}else{p3keys[40]=0;p3keys[38]=1;};
	}}else{p3keys[40]=0;p3keys[38]=0;
	     if(p3vie>0){
		  if(p3z<18){p3keys[40]=1;};if(p3z>40+h){p3keys[38]=1;};
		 }else{
		  if(p3z<5.5){p3keys[40]=1;};if(p3z>90+h){p3keys[38]=1;};
		 };
	 }
	}
	if(tdogfight==0){if(p3vplane<0.65){p3vrun=1.3;}else{p3vrun=1.0;};
	}else{if(p3vplane<0.90){p3vrun=1.5;}else{p3vrun=1.2;};}
	if(p3vie>0 || p3dist<Math.abs(p3do1/4)){
	  if(p3z>40+h || p3vplane<0.5){p3keys[40]=0;p3keys[38]=1;if(p3z>45.01+h){p3z=45+h;};}
	  if(p3z<18){p3keys[40]=1;p3keys[38]=0;if(p3z<15){p3z=15.01;};}
	}else{
	  if(p3z>90+h || p3vplane<0.5){p3keys[40]=0;p3keys[38]=1;if(p3z>95.01+h){p3z=95+h;};}
	  if(p3z<5.5){p3keys[40]=1;p3keys[38]=0;if(p3z<4){p3z=4.01;};}
	}
	p3z+=alt0;
	tattackp3=0;
    //left=37,up3=38,right=39,down=40,p3ageup3=33,p3agedown=34,m=77,esc=27,h=72,shift=16
    //p3=80,T=84
    if (p3keys[40]) {p3o2+=dt*0.015*p3cos3;if(p3o2>89){p3o2=89;};p3o1+=dt*0.015*p3sin3;}
    if (p3keys[38]) {p3o2-=dt*0.015*p3cos3;if(p3o2<-89){p3o2=-89;};p3o1-=dt*0.015*p3sin3;}
    if (p3keys[37]) {p3o3+=dt*0.019;if(p3o3>180){p3o3-=360;p3o30-=360;};}
    if (p3keys[39]) {p3o3-=dt*0.019;if(p3o3<-180){p3o3+=360;p3o30+=360;};}
	if (p3keys[33] || p3keys[16]) {p3vrun+=dt*0.0003;if(p3vrun>1.3){p3vrun=1.3;};};
    if (p3keys[34]) {p3vrun-=dt*0.0003;if(p3vrun<0){p3vrun=0;};};
	if (p3keys[32]) {p3keys[32]=0;if(tframe>(p3tkeytir+80)){soundshoot();p3tir();};}
	if(p3vie>0 || p3dist<(-Math.abs(p3do1/3))){
	 if(p3o3<-35.01){p3o3=-35;}
	 if(p3o3>35.01){p3o3=35;}
    }else{
	 if(p3o3<-45.01){p3o3=-45;}
	 if(p3o3>45.01){p3o3=45;}
	}
	if(p3o2<-18.01){p3o2=-18;}
	if(p3o2>10.01){p3o2=10;}
	//var p3air=10000.0/(10000+z);
	////vplane+=0.4*((vrun-vplane)*0.0013*0.8*air*dt-dt*(air*0.0003*vplane+sin2*0.004));
	//p3vplane+=0.7*((p3vrun)*0.0003*p3air*dt-dt*(p3air*0.0003*p3vplane+p3sin2*0.0024));
	var p3air=(4000-p3z)/(4000+p3z);if(p3air<0){p3air=0;};
	//vplane+=0.4*((vrun-vplane)*0.0013*0.8*air*dt-dt*(air*0.0003*vplane+sin2*0.004));
	var p3vrun2=p3vrun*((3-1.4*p3vplane)/2)*3*p3air*p3air/(2+p3air*p3air);
	if(p3dist>50 && p3vie<0){
	  //if(p3vie0<0){if(p3vrun2<1.5 && p3dist>Math.abs(p3do1/2)){p3vrun2=1.5;}
	  if(p3vie0<0){if(p3vrun2<1.3 && p3dist>Math.abs(p3do1/2)){p3vrun2=1.3;}
	  }else{if(p3vrun2<1.2 && p3dist>Math.abs(p3do1/2)){p3vrun2=1.2;};};}
	//p3vplane+=0.8*((p3vrun2)*0.0003*p3air*dt-dt*(p3air*0.0003*p3vplane+(p3sin2+0.03)*0.0024));
	p3vplane+=0.8*((p3vrun2)*0.0003*p3air*dt-dt*(p3air*0.0003*p3vplane+(p3sin2+0.01)*0.0020));
	if(p3vplane>4){p3vplane=4;}//max vv=800
	//var p3air=50000.0/(50000+p3z);
	//p3vplane+=0.4*((p3vrun-p3vplane)*0.0013*0.8*p3air*dt-dt*(p3air*0.0003*p3vplane+p3sin2*0.004));
    var p3vdt=dt*0.013*p3vplane;var p3vcruise=0.8;
	p3o1+=p3sin3*dt*0.010;
	p3o2-=Math.abs(Math.sin(degtorad(0.7*p3o3)))*dt*0.0015;
	p3o2+=(p3vplane*p3air-p3vcruise)*p3air*p3cos2*p3cos3*dt*0.01;
	if(p3o3>0.1){p3o3-=dt*0.001;};
	if(p3o3<-0.1){p3o3+=dt*0.001;};
	var dt1=(dt*0.002);
	if(dt1>0.8){dt1=0.8;}
	p3do3+=(p3o3-p3o30)-dt1*p3do3;
	p3do2+=(p3o2-p3o20)-dt1*p3do2;
	p3do1+=(p3o1-p3o10)-dt1*p3do1;
	if(p3do1<-20){p3do1=-20;}
	if(p3do1>20){p3do1=20;}
	if((p3o1-p3o10)*p3sin3<-dtime*0.0001){p3o3-=p3o3*dt*0.0015;
	   if(p3o3>0){p3keys[37]=0;}else{p3keys[39]=0;};}
	p3o1+=p3do1*dt*0.001;
	p3o2+=p3do2*dt*0.0025;
	p3o3+=p3do3*dt*0.0025;
	if(Math.abs(p3o3)<1.6){p3o3+=Math.cos(timer()*0.0015)*0.2*(1.6-Math.abs(p3o3));};
	p3x+=p3vdt*p3cos1*p3cos2;
	p3y+=p3vdt*p3sin1*p3cos2;
	p3z+=p3vdt*p3sin2;
    if(p3o2>85){p3o2=84-(p3o2-85);p3o1=180+p3o1;p3o3=180+p3o3;};
    if(p3o2<-85){p3o2=-84-(p3o2+85);p3o1=180+p3o1;p3o3=180+p3o3;};
	if(p3o1>180){p3o1-=360;} 
	if(p3o1<-180){p3o1+=360;}
	if(p3o3>180){p3o3-=360;}
	if(p3o3<-180){p3o3+=360;}
    p3cos1=Math.cos(degtorad(p3o1));p3sin1=Math.sin(degtorad(p3o1));
    p3cos2=Math.cos(degtorad(p3o2));p3sin2=Math.sin(degtorad(p3o2));
    p3cos3=Math.cos(degtorad(p3o3));p3sin3=Math.sin(degtorad(p3o3));
	p3dmx=p3cos1*p3cos2;p3dmy=p3sin1*p3cos2;p3dmz=p3sin2;
	p3vie=p3vie0;
	if(tdogfight==1){p3vie=-p3vie;}
}
var radtodeg=180/Math.PI;
function diro1(dx,dy){ 
var do1;
if (Math.abs(dx)>Math.max(0.001,0.001*Math.abs(dy))){
   if(dx>0){do1=Math.atan(dy/dx)*radtodeg;
   }else{do1=180-Math.atan(dy/Math.abs(dx))*radtodeg;}
   }
else {if(dy>0){do1=90;}else{do1=-90;};}
return do1;
}
var tvolume=0,tspeed=0;
function setvolume(){
    testsounds();
    var volume=(0.09+(Math.max(0,vplane)*0.4047+vrun*0.4033)*0.9*1.38/vrunmax);
	if(tgaz==1){volume+=0.10;}
	if(tcar==1){volume+=0.27+0.05*Math.max(0,Math.min(5,planedo2));}
	if(volume>1){volume=1;};
    var speed=(0.14+(Math.max(0,vplane)*0.7+vrun*0.1)*0.9*1.38/vrunmax);
	if(tgaz==1){speed+=0.10;}
	if(tcar==1){speed+=0.27;}
	if(speed>1){speed=1;};
	if(Math.abs(tvolume-volume)<0.005 && Math.abs(tspeed-speed)<0.005){return;}
	tvolume=volume;tspeed=speed;
	var volume0=0.45*volume,volume1=0.32*volume;
	//var volume0=0.35*volume,volume1=0.85*volume;
if(twebaudio==0){
	myaudio.volume=volume0*(1-speed*0.75);
	myaudio1.volume=volume0*(1-speed*0.75);
	myaudio2.volume=volume1*speed;
	myaudio21.volume=volume1*speed;
}else{
  if(tfoot==1){
   	setvol(myaudiojet,0.01);
   	//setvol(myaudio,0.01);
	//setvol(myaudiocar,0.01);
  }else if(tcar==1){
   	setvol(myaudiojet,0.01);
   	//setvol(myaudio,0.01);
	//setvol(myaudiocar,volume*0.63);
	//setspeed(myaudiocar,speed*1.65);
  }else if(vrunmax<2.01){
   	setvol(myaudiojet,0.01);
   	//setvol(myaudiocar,0.01);
	//setvol(myaudio,volume*0.5);
	//setspeed(myaudio,speed+0.54);
  }else{
   	//setvol(myaudio,0.01);
   	//setvol(myaudiocar,0.01);
	setvol(myaudiojet,volume*0.5);
	setspeed(myaudiojet,speed+0.54);
  }  
	}
}
function testsounds(){	
if(twebaudio==0){
	if(tframe<tpneu){if(myaudiopneu.volume<0.3){myaudiopneu.volume=0.4;};
	}else{if(myaudiopneu.volume>0.1){myaudiopneu.volume=0.002;};}
	
	if(tframe<tshoot){if(myaudioshoot.volume<0.1){myaudioshoot.volume=0.18;};
	}else{if(myaudioshoot.volume>0.1){myaudioshoot.volume=0.002;};}
}else{
	if(tframe<tshoot){if(myaudioshoot.volume<0.1){myaudioshoot.volume=0.18;setvol(myaudioshoot,0.3);};
	}else{if(myaudioshoot.volume>0.1){myaudioshoot.volume=0.002;};setvol(myaudioshoot,0.002);}
}
}
var vertexCount = 0;
var vertexPositions = [];
var vertexTextureCoords = [];
var worldVertexPositionBuffer = null;
var worldVertexTextureCoordBuffer = null;
var world2VertexPositionBuffer = null;
var world2VertexTextureCoordBuffer = null;
var shipVertexPositionBuffer = null;
var shipVertexTextureCoordBuffer = null;
var skydomeVertexPositionBuffer = null;
var skydomeVertexTextureCoordBuffer = null;
var spitfireVertexPositionBuffer = null;
var spitfireVertexTextureCoordBuffer = null;
var spitfirecockpitVertexPositionBuffer = null;
var spitfirecockpitVertexTextureCoordBuffer = null;
var zeroVertexPositionBuffer = null;
var zeroVertexTextureCoordBuffer = null;
var f14cockpitVertexPositionBuffer = null;
var f14cockpitVertexTextureCoordBuffer = null;
var shipcarrierVertexPositionBuffer = null;
var shipcarrierVertexTextureCoordBuffer = null;
var fighterVertexPositionBuffer = null;
var fighterVertexTextureCoordBuffer = null;
var sailshipVertexPositionBuffer = null;
var sailshipVertexTextureCoordBuffer = null;
var tankVertexPositionBuffer = null;
var tankVertexTextureCoordBuffer = null;
var alphajetVertexPositionBuffer = null;
var alphajetVertexTextureCoordBuffer = null;
var alphajetcockpitVertexPositionBuffer = null;
var alphajetcockpitVertexTextureCoordBuffer = null;
var horselowVertexPositionBuffer = null;
var horselowVertexTextureCoordBuffer = null;

var horselowVertexPositions = null;
var horselowidleVertexPositions = null;
var horselowrun1VertexPositions = null;
var horselowrun2VertexPositions = null;

var elephantlowVertexPositionBuffer = null;
var elephantlowVertexTextureCoordBuffer = null;

var elephantlowVertexPositions = null;
var elephantlowidleVertexPositions = null;
var elephantlowrun1VertexPositions = null;
var elephantlowrun2VertexPositions = null;

var girafelowVertexPositionBuffer = null;
var girafelowVertexTextureCoordBuffer = null;

var girafelowVertexPositions = null;
var girafelowidleVertexPositions = null;
var girafelowrun1VertexPositions = null;
var girafelowrun2VertexPositions = null;

var birdVertexPositionBuffer = null;
var birdVertexTextureCoordBuffer = null;

var birdVertexPositions = null;
var birdidleVertexPositions = null;
var birdattackVertexPositions = null;

var antilopelowVertexPositionBuffer = null;
var antilopelowVertexTextureCoordBuffer = null;

var antilopelowVertexPositions = null;
var antilopelowidleVertexPositions = null;
var antilopelowrun1VertexPositions = null;
var antilopelowrun2VertexPositions = null;

var rocVertexPositionBuffer = null;
var rocVertexTextureCoordBuffer = null;
var spaceshipVertexPositionBuffer = null;
var spaceshipVertexTextureCoordBuffer = null;

  function loadWorld() {
    handleLoadedWorld(c150objtxt);
    worldVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, worldVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    worldVertexPositionBuffer.itemSize = 3;
    worldVertexPositionBuffer.numItems = vertexCount;

    worldVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, worldVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    worldVertexTextureCoordBuffer.itemSize = 2;
    worldVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
	
    handleLoadedWorld(c150minus6objtxt);
    world2VertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    world2VertexPositionBuffer.itemSize = 3;
    world2VertexPositionBuffer.numItems = vertexCount;

    world2VertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    world2VertexTextureCoordBuffer.itemSize = 2;
    world2VertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
    
	/*handleLoadedWorld(shipobjtxt);
    shipVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, shipVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    shipVertexPositionBuffer.itemSize = 3;
    shipVertexPositionBuffer.numItems = vertexCount;

    shipVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, shipVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    shipVertexTextureCoordBuffer.itemSize = 2;
    shipVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

    handleLoadedWorld(spitfirelowobjtxt);
    spitfireVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, spitfireVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    spitfireVertexPositionBuffer.itemSize = 3;
    spitfireVertexPositionBuffer.numItems = vertexCount;

    spitfireVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, spitfireVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    spitfireVertexTextureCoordBuffer.itemSize = 2;
    spitfireVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

	handleLoadedWorld(spitfirecockpitobjtxt);
    spitfirecockpitVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, spitfirecockpitVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    spitfirecockpitVertexPositionBuffer.itemSize = 3;
    spitfirecockpitVertexPositionBuffer.numItems = vertexCount;

    spitfirecockpitVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, spitfirecockpitVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    spitfirecockpitVertexTextureCoordBuffer.itemSize = 2;
    spitfirecockpitVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

    handleLoadedWorld(zeroobjtxt);
    zeroVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, zeroVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    zeroVertexPositionBuffer.itemSize = 3;
    zeroVertexPositionBuffer.numItems = vertexCount;

    zeroVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, zeroVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    zeroVertexTextureCoordBuffer.itemSize = 2;
    zeroVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
    */
	handleLoadedWorld(f14cockpitobjtxt);
    f14cockpitVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, f14cockpitVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    f14cockpitVertexPositionBuffer.itemSize = 3;
    f14cockpitVertexPositionBuffer.numItems = vertexCount;

    f14cockpitVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, f14cockpitVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    f14cockpitVertexTextureCoordBuffer.itemSize = 2;
    f14cockpitVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
	/*
	handleLoadedWorld(shipcarrierobjtxt);
    shipcarrierVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, shipcarrierVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    shipcarrierVertexPositionBuffer.itemSize = 3;
    shipcarrierVertexPositionBuffer.numItems = vertexCount;

    shipcarrierVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, shipcarrierVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    shipcarrierVertexTextureCoordBuffer.itemSize = 2;
    shipcarrierVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
    */
	
    handleLoadedWorld(skydomeobjtxt);
    skydomeVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, skydomeVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    skydomeVertexPositionBuffer.itemSize = 3;
    skydomeVertexPositionBuffer.numItems = vertexCount;

    skydomeVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, skydomeVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    skydomeVertexTextureCoordBuffer.itemSize = 2;
    skydomeVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
	

	handleLoadedWorld(fighterobjtxt);
    fighterVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, fighterVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    fighterVertexPositionBuffer.itemSize = 3;
    fighterVertexPositionBuffer.numItems = vertexCount;

    fighterVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, fighterVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    fighterVertexTextureCoordBuffer.itemSize = 2;
    fighterVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
    
	/*handleLoadedWorld(sailshipobjtxt);
    sailshipVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, sailshipVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    sailshipVertexPositionBuffer.itemSize = 3;
    sailshipVertexPositionBuffer.numItems = vertexCount;

    sailshipVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, sailshipVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    sailshipVertexTextureCoordBuffer.itemSize = 2;
    sailshipVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
    */
	/*handleLoadedWorld(tankobjtxt);
    tankVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, tankVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    tankVertexPositionBuffer.itemSize = 3;
    tankVertexPositionBuffer.numItems = vertexCount;

    tankVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, tankVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    tankVertexTextureCoordBuffer.itemSize = 2;
    tankVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
    */
    handleLoadedWorld(alphajetobjtxt);
    alphajetVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, alphajetVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    alphajetVertexPositionBuffer.itemSize = 3;
    alphajetVertexPositionBuffer.numItems = vertexCount;

    alphajetVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, alphajetVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    alphajetVertexTextureCoordBuffer.itemSize = 2;
    alphajetVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

	handleLoadedWorld(alphajetcockpitobjtxt);
    alphajetcockpitVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, alphajetcockpitVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    alphajetcockpitVertexPositionBuffer.itemSize = 3;
    alphajetcockpitVertexPositionBuffer.numItems = vertexCount;

    alphajetcockpitVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, alphajetcockpitVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    alphajetcockpitVertexTextureCoordBuffer.itemSize = 2;
    alphajetcockpitVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
	
	handleLoadedWorld(horse00objtxt);
    horselowVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, horselowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    horselowVertexPositionBuffer.itemSize = 3;
    horselowVertexPositionBuffer.numItems = vertexCount;

    horselowVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, horselowVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    horselowVertexTextureCoordBuffer.itemSize = 2;
    horselowVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

    horselowVertexPositions=new Float32Array(vertexCount*3);
    horselowidleVertexPositions=new Float32Array(vertexCount*3);
	for(var i=0;i<vertexCount*3;i++){
	    horselowVertexPositions[i]=vertexPositions[i];
	    horselowidleVertexPositions[i]=vertexPositions[i];}

	handleLoadedWorld(horse01objtxt);
    horselowrun1VertexPositions=new Float32Array(vertexCount*3);
	for(var i=0;i<vertexCount*3;i++){
	    horselowrun1VertexPositions[i]=vertexPositions[i]-horselowVertexPositions[i];}

	handleLoadedWorld(horse02objtxt);
    horselowrun2VertexPositions=new Float32Array(vertexCount*3);
	for(var i=0;i<vertexCount*3;i++){
	    horselowrun2VertexPositions[i]=vertexPositions[i]-horselowVertexPositions[i];}	


	handleLoadedWorld(elephant00objtxt);
    elephantlowVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, elephantlowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    elephantlowVertexPositionBuffer.itemSize = 3;
    elephantlowVertexPositionBuffer.numItems = vertexCount;

    elephantlowVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, elephantlowVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    elephantlowVertexTextureCoordBuffer.itemSize = 2;
    elephantlowVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

    elephantlowVertexPositions=new Float32Array(vertexCount*3);
    elephantlowidleVertexPositions=new Float32Array(vertexCount*3);
	for(var i=0;i<vertexCount*3;i++){
	    elephantlowVertexPositions[i]=vertexPositions[i];
	    elephantlowidleVertexPositions[i]=vertexPositions[i];}

	handleLoadedWorld(elephant01objtxt);
    elephantlowrun1VertexPositions=new Float32Array(vertexCount*3);
	for(var i=0;i<vertexCount*3;i++){
	    elephantlowrun1VertexPositions[i]=vertexPositions[i]-elephantlowVertexPositions[i];}

	handleLoadedWorld(elephant02objtxt);
    elephantlowrun2VertexPositions=new Float32Array(vertexCount*3);
	for(var i=0;i<vertexCount*3;i++){
	    elephantlowrun2VertexPositions[i]=vertexPositions[i]-elephantlowVertexPositions[i];}
	

	handleLoadedWorld(girafe00objtxt);
    girafelowVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, girafelowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    girafelowVertexPositionBuffer.itemSize = 3;
    girafelowVertexPositionBuffer.numItems = vertexCount;

    girafelowVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, girafelowVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    girafelowVertexTextureCoordBuffer.itemSize = 2;
    girafelowVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

    girafelowVertexPositions=new Float32Array(vertexCount*3);
    girafelowidleVertexPositions=new Float32Array(vertexCount*3);
	for(var i=0;i<vertexCount*3;i++){
	    girafelowVertexPositions[i]=vertexPositions[i];
	    girafelowidleVertexPositions[i]=vertexPositions[i];}

	handleLoadedWorld(girafe01objtxt);
    girafelowrun1VertexPositions=new Float32Array(vertexCount*3);
	for(var i=0;i<vertexCount*3;i++){
	    girafelowrun1VertexPositions[i]=vertexPositions[i]-girafelowVertexPositions[i];}

	handleLoadedWorld(girafe02objtxt);
    girafelowrun2VertexPositions=new Float32Array(vertexCount*3);
	for(var i=0;i<vertexCount*3;i++){
	    girafelowrun2VertexPositions[i]=vertexPositions[i]-girafelowVertexPositions[i];}	


	handleLoadedWorld(birdobjtxt);
    birdVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, birdVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    birdVertexPositionBuffer.itemSize = 3;
    birdVertexPositionBuffer.numItems = vertexCount;

    birdVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, birdVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    birdVertexTextureCoordBuffer.itemSize = 2;
    birdVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

    birdVertexPositions=new Float32Array(vertexCount*3);
    birdidleVertexPositions=new Float32Array(vertexCount*3);
	for(var i=0;i<vertexCount*3;i++){
	    birdVertexPositions[i]=vertexPositions[i];
	    birdidleVertexPositions[i]=vertexPositions[i];}

	handleLoadedWorld(bird2objtxt);
    birdattackVertexPositions=new Float32Array(vertexCount*3);
	for(var i=0;i<vertexCount*3;i++){
	    birdattackVertexPositions[i]=vertexPositions[i]-birdVertexPositions[i];}

	handleLoadedWorld(antilope00objtxt);
    antilopelowVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, antilopelowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    antilopelowVertexPositionBuffer.itemSize = 3;
    antilopelowVertexPositionBuffer.numItems = vertexCount;

    antilopelowVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, antilopelowVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    antilopelowVertexTextureCoordBuffer.itemSize = 2;
    antilopelowVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

    antilopelowVertexPositions=new Float32Array(vertexCount*3);
    antilopelowidleVertexPositions=new Float32Array(vertexCount*3);
	for(var i=0;i<vertexCount*3;i++){
	    antilopelowVertexPositions[i]=vertexPositions[i];
	    antilopelowidleVertexPositions[i]=vertexPositions[i];}

	handleLoadedWorld(antilope01objtxt);
    antilopelowrun1VertexPositions=new Float32Array(vertexCount*3);
	for(var i=0;i<vertexCount*3;i++){
	    antilopelowrun1VertexPositions[i]=vertexPositions[i]-antilopelowVertexPositions[i];}

	handleLoadedWorld(antilope02objtxt);
    antilopelowrun2VertexPositions=new Float32Array(vertexCount*3);
	for(var i=0;i<vertexCount*3;i++){
	    antilopelowrun2VertexPositions[i]=vertexPositions[i]-antilopelowVertexPositions[i];}	

	handleLoadedWorld(rocobjtxt);
    rocVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, rocVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    rocVertexPositionBuffer.itemSize = 3;
    rocVertexPositionBuffer.numItems = vertexCount;

    rocVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, rocVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    rocVertexTextureCoordBuffer.itemSize = 2;
    rocVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

	handleLoadedWorld(spaceshipobjtxt);
    spaceshipVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, spaceshipVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    spaceshipVertexPositionBuffer.itemSize = 3;
    spaceshipVertexPositionBuffer.numItems = vertexCount;

    spaceshipVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, spaceshipVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    spaceshipVertexTextureCoordBuffer.itemSize = 2;
    spaceshipVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

	}	

function handleLoadedWorld(data){//,vertexposbuff,vertextextbuff) { 
    var lines = data.split("\n");
    vertexCount = 0;
    vertexPositions = [];
    vertexTextureCoords = [];
    for (var i in lines) {
      var vals = lines[i].replace(/^\s+/, "").split(/\s+/);
      if (vals.length == 5 && vals[0] != "//") {
        // It is a line describing a vertex; get X, Y and Z first
        vertexPositions.push(parseFloat(vals[0]));
        vertexPositions.push(parseFloat(vals[1]));
        vertexPositions.push(parseFloat(vals[2]));

        // And then the texture coords
        vertexTextureCoords.push(parseFloat(vals[3]));
        vertexTextureCoords.push(parseFloat(vals[4]));

        vertexCount += 1;
      }
    }
	//setTimeout("delete("+data+");",5000);
}
function dirtext(dx,dy){
var do1=diro1(dx,dy)
switch (parseInt((do1+22.5)/45)){
	case 0:
		return "east";
	case 1:
		return "north east";
	case 2:
		return "north";
	case 3:
		return "north west";
	case 4:
		return "west";
	case -1:
	    return "south east";
	case 7:
		return "south east";
	case -2:
		return "south";
	case 6:
		return "south";
	case -3:
		return "south west";
	case 5:
		return "south west";
	case -4:
		return "west";
	default:
		return "direction";
 }
}
function airporttext(){
if(iairport>=0){return airportname[iairport];}
switch(parseInt(Math.random()*4)){
	case 0:
		return "ground airport";
	case 1:
		return "ground control";
	case 2:
		return "airport control";
	case 3: 
		return "ground airport control";
 }
}
function carriertext(){
switch(parseInt(Math.random()*3)){
	case 0:
		return "carrier";
	case 1:
		return "carrier control";
	case 2:
        return "aircraft carrier";
 }
} 
		
function begintext(){
switch(parseInt(Math.random()*4)){
	case 0:
		return "start";
	case 1:
		return "continue";
	case 2:
		return "begin";
	case 3: 
		return "engage";
 }
}
function approachtext(){
switch (parseInt(Math.random()*2)){
	case 0:
		return "approaching";
	case 1:
		return "your approach";
 }
}
function directiontext(){
switch (parseInt(Math.random()*2)){
	case 0:
		return "direction";
	case 1:
		return "azimut";
 }
}
function speak(textspeak){
var voicename="UK English Female";
responsiveVoice.speak(textspeak,voicename);
}
/*var paudiosrc=null,paudio=null,ptimeraudio=0;
function speak(textspeak){
if(paudio==null){paudio= new Audio();}
//paudiosrc ='http://translate.nogoogle.com/translate_tts?&tl=en&q='+encodeURIComponent(textspeak);
paudiosrc='http://translate.google.com/translate_tts?tl=en&q='+encodeURIComponent(textspeak)+'&ie=UTF-8&total=1&idx=0&client=t';
paudio.type="audio/x-wav" 
paudio.src=paudiosrc;
ptimeraudio=-1;
paudio.addEventListener('canplay',function(){
      if(ptimeraudio<0){ptimeraudio=1;paudio.play();};});
paudio.load();
}
*/
var radiotxt="",tradio=0,radiosource=0;
function subradio(){
testairport();
if(tframe<tradio+12000 || Math.random()<0.5){
  if(radiosource==0){if(shipcarrierz<0){radiosource=1;}}else{radiosource=0;};}
radiosource=0;
if((radiosource==0 || (tsea==0 && tgmap==0))&& iairport>=0){
  radiotxt=airporttext()+" to "+plane+" , "+begintext()+" "+approachtext()+" , "
  radiotxt+=directiontext()+" "+dirtext(airportx[iairport]-x,airporty[iairport]-y);
}else if(radiosource==0 || (tsea==0 && tgmap==0)){
  radiotxt=airporttext()+" to "+plane+" , "+begintext()+" "+approachtext()+" , "
  radiotxt+=directiontext()+" "+dirtext(pistex-x,pistey-y);
}else{
  radiotxt=carriertext()+" to "+plane+" , "+begintext()+" "+approachtext()+" , "
  radiotxt+=directiontext()+" "+dirtext(shipcarrierx-x,shipcarriery-y);
}
  //alert(radiotxt);
tradio=tframe;
try{speak(radiotxt);}catch(e){};
}
var geolocation="";
function geolocate(){
geolocation = "paris france";
geolocation=window.prompt("flyto : enter address or location");
//alert("geolocation="+geolocation);
if (geolocation.length>0){
  var geocoder = new nogoogle.maps.Geocoder();
  geocoder.geocode( { 'address': geolocation}, function(results, status) {
    if (status == nogoogle.maps.GeocoderStatus.OK) {
      var latlng=results[0].geometry.location;
	  lat=latlng.lat();
	  lng=latlng.lng();
	  flytolat=lat;flytolng=lng;flytoname=geolocation;
	  icombo=1;
	  document.getElementById('combo')[icombo].text=flytoname;
	  document.getElementById('combo').selectedIndex=icombo;
	  tgmap=1;tsea=0;getworldxy(zoom,lat,lng);tinitgmap=1;
    } else {
      alert('Geolocation not found ! ' + status);
    }
  });
}
document.getElementById('intext').focus();
}
var airports=[],airportname=[],airportx=[],airporty=[],nairport=0;
var airportlat=[],airportlng=[],airportz=[];
function getairports(){
  var request = {
    location: new nogoogle.maps.LatLng(lat,lng),
    radius: 40000,
	//rankby:"distance",//"prominence"
    types: ["airport"],
	name:"airport"
  };
  var service = new nogoogle.maps.places.PlacesService(map);
  service.nearbySearch(request, placecallback);
}
function placecallback(results, status){
  if (status == nogoogle.maps.places.PlacesServiceStatus.OK) {
	//alert(results[0].geometry.location.lat());
	//alert(results.length);
	//alert(results[0].name);
	var test=0,i=-1;
	nairport=0;
    for (var ii=0;ii<results.length;ii++){
	  if(results[ii].name.toLowerCase().indexOf("port")>=0){
	   nairport+=1;//results.length;
	   i+=1; 
	   airportname[i]=results[ii].name;
	  var latp=results[ii].geometry.location.lat();
	  var lngp=results[ii].geometry.location.lng();
	  var worldx0=worldx,worldy0=worldy;
	  airportlat[i]=latp;
	  airportlng[i]=lngp;
	  getworldxy(zoom,latp,lngp);
	  airportx[i]=xmaxmin2+(worldx-worldx0)*(xmax-xmin)/512;
	  airporty[i]=ymaxmin2+(worldy-worldy0)*(ymax-ymin)/512;
      airportz[i]=getterrainheight(airportx[i],airporty[i]);
	  worldx=worldx0;worldy=worldy0;
	  if(portname==airportname[i]){
	      portlat=latp;portlng=lngp;
		  portx=airportx[i];porty=airporty[i];
		  test=1;}
    }}
	if(test==0){portname0="";portname="";portlat=-99;iairport=-1;}
  }
  else{nairport=0;}
}
var distairport=99999,do1airport=0,iairport=0,tairport=0;
var portx=0,porty=0,portz=0,portname="",portname0="";
var portx0=0,porty0=0,portz0=0;
var portlat=-99,portlng=0;
function testairport(){
var test=0;
if(nairport==0){return 0;}
if(tframe<tairport || nairport==0){
   if(tframe<(tairport-15) || portname==portname0){return 0;}}
tairport=tframe+15000;
var distairport0=distairport,do1airport0=do1airport;
var iairport0=iairport,iairport1=-1;
distairport=99999;iairport=-1;
for(i=0;i<nairport;i++){
   var dx=airportx[i]-x;
   var dy=airporty[i]-y;
   var dist=Math.sqrt(dx*dx+dy*dy);
   if(dist<distairport){distairport=dist;iairport1=i;}
}
portx=99999;porty=99999;test=0;
if(iairport1>=0){
   portx=airportx[iairport1];porty=airporty[iairport1];
   portz=getterrainheight(portx,porty);
   do1airport=diro1(portx-x,porty-y);
   if(iairport1!=iairport0 || 
      Math.abs(distairport-distairport0)>(100+0.2*distairport) ||
	  Math.abs(do1airport-do1airport0)>35){
	    iairport=iairport1;
		portname=airportname[iairport1];
		test=1;//return 1;
	  }
}
if(test==0){
  iairport=iairport0;
  do1airport=do1airport0;
}
if(Math.abs(portlat-airportlat[iairport1])>0.05 ||
   Math.abs(portlng-airportlng[iairport1])>0.05){ 
	 if(portname!=portname0 && tframe>treinitgmap){
	   portlat=airportlat[iairport1];
	   portlng=airportlng[iairport1];
	   portname0=portname;getportmap();
}}
testtree=1;
return test;
}
var towers=[],towername=[],towerx=[],towery=[],ntower=0;
var towerlat=[],towerlng=[],towerz=[],towertype=[];
var towerwx=[],towerwy=[];
function gettowers(){
  var request = {
    location: new nogoogle.maps.LatLng(lat,lng),
    radius: 15000,
	//rankby:"distance",//"prominence"
    types: ["establishment"],
	name:"tower"
  };
  var service = new nogoogle.maps.places.PlacesService(map);
  ntower=0;
  service.nearbySearch(request, placecallbacktower);
}
function placecallbacktower(results, status, nextpage){
  if (status == nogoogle.maps.places.PlacesServiceStatus.OK) {
	//alert(results[0].geometry.location.lat());
    //alert(results.length);
	//alert(results[0].name);
	var test=0,i=-1;
    for (var ii=0;ii<results.length;ii++){
	  if(results[ii].name.toLowerCase().indexOf("tower")>=0 ||
	     results[ii].name.toLowerCase().indexOf("tour")>=0 ||
	     results[ii].name.toLowerCase().indexOf("building")>=0){
	   ntower+=1;//results.length;
	   i=ntower-1; 
	   //towername[i]=results[ii].name;
	  var latp=results[ii].geometry.location.lat();
	  var lngp=results[ii].geometry.location.lng();
	  var worldx0=worldx,worldy0=worldy;
	  towerlat[i]=latp;
	  towerlng[i]=lngp;
	  towertype[i]=1;
	  if(results[ii].name.toLowerCase().indexOf("building")>=0){
	    towertype[i]=2;}
	  else if(results[ii].name.toLowerCase().indexOf("tour")>=0){
        towertype[i]=3;}
	  getworldxy(zoom,latp,lngp);
	  towerwx[i]=worldx;
	  towerwy[i]=worldy;
	  towerx[i]=xmaxmin2+(worldx-worldx0)*(xmax-xmin)/512;
	  towery[i]=ymaxmin2+(worldy-worldy0)*(ymax-ymin)/512;
      towerz[i]=getterrainheight(towerx[i],towery[i]);
	  worldx=worldx0;worldy=worldy0;
    }}
	if(nextpage.hasNextPage && ntower<59){nextpage.nextPage();}
	else if(ntower<59){ntower0=ntower;
	                   setTimeout("gettowers1();",10);}
	else{updatetower();}
  }
  else if(ntower<59){ntower0=ntower;
	                 setTimeout("gettowers1();",10);}
  else{updatetower();}
}
var ntower0=0;
function gettowers1(){
  var request = {
    location: new nogoogle.maps.LatLng(lat,lng),
    radius: 15000,
	//rankby:"distance",//"prominence"
    types: ["establishment"],
	name:"tour"
  };
  var service = new nogoogle.maps.places.PlacesService(map);
  ntower0=ntower;
  service.nearbySearch(request, placecallbacktower1);
}
function placecallbacktower1(results, status, nextpage){
  if (status == nogoogle.maps.places.PlacesServiceStatus.OK) {
	//alert(results[0].geometry.location.lat());
    //alert(results.length);
	//alert(results[0].name);
	if(results.length>ntower0){ntower=0;ntower0=999;}
	else if(ntower0<998){ntower0=9999;}
	var test=0,i=-1;
	if(ntower0==999){
    for (var ii=0;ii<results.length;ii++){
	  if(results[ii].name.toLowerCase().indexOf("tower")>=0 ||
	     results[ii].name.toLowerCase().indexOf("tour")>=0 ||
	     results[ii].name.toLowerCase().indexOf("building")>=0){
	   ntower+=1;//results.length;
	   i=ntower-1; 
	   //towername[i]=results[ii].name;
	  var latp=results[ii].geometry.location.lat();
	  var lngp=results[ii].geometry.location.lng();
	  var worldx0=worldx,worldy0=worldy;
	  towerlat[i]=latp;
	  towerlng[i]=lngp;
	  towertype[i]=1;
	  if(results[ii].name.toLowerCase().indexOf("building")>=0){
	    towertype[i]=2;}
	  else if(results[ii].name.toLowerCase().indexOf("tour")>=0){
        towertype[i]=3;}
	  getworldxy(zoom,latp,lngp);
	  towerwx[i]=worldx;
	  towerwy[i]=worldy;
	  towerx[i]=xmaxmin2+(worldx-worldx0)*(xmax-xmin)/512;
	  towery[i]=ymaxmin2+(worldy-worldy0)*(ymax-ymin)/512;
      towerz[i]=getterrainheight(towerx[i],towery[i]);
	  worldx=worldx0;worldy=worldy0;
    }}
	if(nextpage.hasNextPage && ntower<59){nextpage.nextPage();}
	else if(ntower<59){setTimeout("gettowers2();",10);}
	else{updatetower();}
	}else{setTimeout("gettowers2();",10);}
  }
  else if(ntower<59){setTimeout("gettowers2();",10);}
  else{updatetower();}
}
function gettowers2(){
  var request = {
    location: new nogoogle.maps.LatLng(lat,lng),
    radius: 15000,
	//rankby:"distance",//"prominence"
    types: ["establishment"],
	name:"building"
  };
  var service = new nogoogle.maps.places.PlacesService(map);
  service.nearbySearch(request, placecallbacktower2);
}
function placecallbacktower2(results, status, nextpage){
  if (status == nogoogle.maps.places.PlacesServiceStatus.OK) {
	//alert(results[0].geometry.location.lat());
    //alert(results.length);
	//alert(results[0].name);
	var test=0,i=-1;
    for (var ii=0;ii<results.length;ii++){
	  if(results[ii].name.toLowerCase().indexOf("tower")>=0 ||
	     results[ii].name.toLowerCase().indexOf("tour")>=0 ||
	     results[ii].name.toLowerCase().indexOf("building")>=0){
	   ntower+=1;//results.length;
	   i=ntower-1; 
	   //towername[i]=results[ii].name;
	  var latp=results[ii].geometry.location.lat();
	  var lngp=results[ii].geometry.location.lng();
	  var worldx0=worldx,worldy0=worldy;
	  towerlat[i]=latp;
	  towerlng[i]=lngp;
	  towertype[i]=1;
	  if(results[ii].name.toLowerCase().indexOf("building")>=0){
	    towertype[i]=2;}
	  else if(results[ii].name.toLowerCase().indexOf("tour")>=0){
        towertype[i]=3;}
	  getworldxy(zoom,latp,lngp);
	  towerwx[i]=worldx;
	  towerwy[i]=worldy;
	  towerx[i]=xmaxmin2+(worldx-worldx0)*(xmax-xmin)/512;
	  towery[i]=ymaxmin2+(worldy-worldy0)*(ymax-ymin)/512;
      towerz[i]=getterrainheight(towerx[i],towery[i]);
	  worldx=worldx0;worldy=worldy0;
    }}
	if(nextpage.hasNextPage && ntower<59){nextpage.nextPage();}
	else if(ntower<59){setTimeout("gettowers3();",10);}
	else{updatetower();}
  }
  else if(ntower<59){setTimeout("gettowers3();",10);}
  else{updatetower();}
}
function gettowers3(){
  var request = {
    location: new nogoogle.maps.LatLng(lat,lng),
    radius: 15000,
	//rankby:"distance",//"prominence"
    types: ["city_hall"]//,
	//name:"hall"
  };
  var service = new nogoogle.maps.places.PlacesService(map);
  service.nearbySearch(request, placecallbacktower3);
}
function placecallbacktower3(results, status, nextpage){
  if (status == nogoogle.maps.places.PlacesServiceStatus.OK) {
	//alert(results[0].geometry.location.lat());
    //alert(results.length);
	//alert(results[0].name);
	var test=0,i=-1;
    for (var ii=0;ii<results.length;ii++){
	   ntower+=1;//results.length;
	   i=ntower-1; 
	   //towername[i]=results[ii].name;
	  var latp=results[ii].geometry.location.lat();
	  var lngp=results[ii].geometry.location.lng();
	  var worldx0=worldx,worldy0=worldy;
	  towerlat[i]=latp;
	  towerlng[i]=lngp;
	  towertype[i]=4;
	  getworldxy(zoom,latp,lngp);
	  towerwx[i]=worldx;
	  towerwy[i]=worldy;
	  towerx[i]=xmaxmin2+(worldx-worldx0)*(xmax-xmin)/512;
	  towery[i]=ymaxmin2+(worldy-worldy0)*(ymax-ymin)/512;
      towerz[i]=getterrainheight(towerx[i],towery[i]);
	  worldx=worldx0;worldy=worldy0;
    }//}
	if(nextpage.hasNextPage && ntower<59){nextpage.nextPage();}
	else{updatetower();}
  }
  else{updatetower();}
}
//getsrtmfile(lat,lng);
//getsrtmfile(-89,-179);
//getsrtmfile(89,179);
var srtmfolder="",srtmfolder0=folderdrive+"srtm/";
var srtmfile="",srtmfiles=[],isrtm=0,srtmvar="",srtmvars=[];
var srtmdata=[],srtmlat=[],srtmlng=[];
var lat5=0,lng5=0,lat50=0,lng40=0;
for(var i=0;i<4;i++){srtmfiles[i]="";
    srtmvars[i]="";srtmdata[i]=new Int16Array(601*601);
	srtmlat[i]=99999;srtmlng[i]=9999;}
function getsrtmfile(lat1,lng1){
if(lat1<-87 || lat1>87 || lng1<-177 || lng1>177){return "";}
lat5=-90+5*parseInt((lat1+90.0)/5);
lng5=-180+5*parseInt((lng1+180.0)/5);
if(lng5<=0){srtmfile="lngW"+(0-lng5);}
else{srtmfile="lngE"+(lng5);}
if(lat5>=0){srtmfile+="latN"+lat5;}
else{srtmfile+="latS"+(0-lat5);}
lat50=-60+50*parseInt((lat1+110.0)/50);
lng40=-180+40*parseInt((lng1+180.0)/40);
if(lng40<=0){srtmfolder="W"+(0-lng40);}
else{srtmfolder="E"+(lng40);}
if(lat50>=0){srtmfolder+="N"+lat50;}
else{srtmfolder+="S"+(0-lat50);}
srtmvar=srtmfile; 
srtmfile=srtmfolder+"/"+srtmfile+".js";
}
/*getworldxy(zoom,lat,lng);alert(lat+"/"+lng+"/"+worldx+"/"+worldy);
auxvar=worldy;
getworldxy(zoom,lat+1,lng);alert(lat+"/"+lng+"/"+(worldy-auxvar)+"/"+worldy);
getlatlng(zoom,worldx,worldy);alert(lat+"/"+lng+"/"+worldx+"/"+worldy);
*/
//testloadsrtmfile(lat,lng);
//testloadsrtmfile(lat,lng);
var itestloadsrtm=0,ttestloadsrtm=0;
function testloadsrtm(){
if(tframe<ttestloadsrtm){return;}
ttestloadsrtm=tframe+15000;
itestloadsrtm+=1;if(itestloadsrtm>=4){itestloadsrtm=0;}
var dx=0.2;
if(itestloadsrtm==0){testloadsrtmfile(lat-dx,lng-dx);}
if(itestloadsrtm==1){testloadsrtmfile(lat-dx,lng+dx);}
if(itestloadsrtm==2){testloadsrtmfile(lat+dx,lng+dx);}
if(itestloadsrtm==3){testloadsrtmfile(lat+dx,lng-dx);}
}
function testloadsrtmfile(lat1,lng1){
  getsrtmfile(lat1,lng1);
  if(srtmfile==""){return;}
  for(var i=0;i<4;i++){if(srtmfiles[i]==srtmfile){return;}}
  var distsrtm=0;
  for(var i=0;i<4;i++){
    var dist=Math.max(Math.abs(lat1-srtmlat[i]),Math.abs(lng1-srtmlng[i]));
    if(dist>distsrtm){isrtm=i;distsrtm=dist;}
  }
  //auxvar=isrtm;
  srtmfiles[isrtm]=srtmfile;
  srtmvars[isrtm]=srtmvar;
  srtmlat[isrtm]=lat5+2.5;
  srtmlng[isrtm]=lng5+2.5+1000;
  var worldx0=worldx,worldy0=worldy;
  /*getworldxy(zoom,lat5,lng5);
  srtmxmin[isrtm]=-worldx;
  srtmymin[isrtm]=-worldy;
  getworldxy(zoom,lat5+5,lng5+5);
  srtmxmax[isrtm]=-worldx;//alert(worldx-srtmxmin[isrtm]);
  srtmymax[isrtm]=-worldy;//alert(worldy-srtmymin[isrtm]);
  worldx=worldx0;worldy=worldy0;
  */
  //getworldxy(zoom,lat5+0.1,lng5-0.1);
  loadsrtmfile(isrtm);
}
function loadsrtmfile(iisrtm){
//alert("load "+srtmfolder0+srtmfiles[isrtm]);
var jsfilepath=srtmfiles[iisrtm];
jslist[njsfile]=document.createElement("script");
var js=jslist[njsfile];
js.type = "text/javascript";
js.src = srtmfolder0+jsfilepath;
js.async=true;
//js.onreadystatechange = jscallback;
tjsload+=1;jsfilelist[njsfile]="/srtm/"+jsfilepath;
var i=njsfile;
tloading[i]=1;
js.onload = function(){setTimeout("jscallback2("+iisrtm+");",100);
              setTimeout("deletejsfile("+i+");",4000);
			  tloading[i]=0;
			  };
njsfile+=1;
head.appendChild(js);
}
var val62=new Int16Array(256);
var abcd="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
for(var i=0;i<256;i++){val62[i]=0;}
for(var i=0;i<62;i++){val62[abcd.charCodeAt(i)]=i;};
function jscallback2(ii){
 //alert("callback "+srtmfiles[ii]+"/"+ii);
 var srtmtext=eval(srtmvars[ii]);
 //alert(srtmtext.length);
 var j=0,k=0,l=0,kl=0,n=0,p=0,x=0,ix=0,ixmax=601*600,jx=0;
 var jmax=srtmtext.length;//auxvar=0;
 while(j<jmax && ix<ixmax){
	//if(x>auxvar){auxvar=x;}
	if(jx>=600){jx=0;x=0;}
    k=val62[srtmtext.charCodeAt(j)];j++;
	l=val62[srtmtext.charCodeAt(j)];j++;
    kl=(k-30)*60+l;
	if(kl==0){
      k=val62[srtmtext.charCodeAt(j)];j++;
	  l=val62[srtmtext.charCodeAt(j)];j++;
	  kl=(k-30)*60+l;
	  for(var n=0;n<kl;n++){
    	  srtmdata[ii][ix]=x;ix++;jx++}
    }else{x+=kl;srtmdata[ii][ix]=x;
		  ix++;jx++}	
 }
 //alert("ix="+ix+"/"+(600*600)+"/isrtm="+isrtm+"/aux="+auxvar);
 srtmtext=null;
 eval(srtmvars[ii]+"=null;");
 //alert(srtmdata[i][0]); 
/*srtmxmin[ii]=-srtmxmin[ii];
srtmymin[ii]=-srtmymin[ii];
srtmxmax[ii]=-srtmxmax[ii];
srtmymax[ii]=-srtmymax[ii];
*/
srtmlng[ii]-=1000;
//updatesrtm();
ttestloadsrtm=0;
if(treinitsol>-1){treinitsol=tframe+7000;}
else{treinitsol=tframe+1500;}
}
function updatesrtm(){
//scaletexture=512/(xmax-xmin);
var lngx=0,laty=0;//auxvar=0;
var lng0=lng,lat0=lat;
getlatlng(zoom,worldx+256,worldy+256)
var lng1=lng,lat1=lat;
lng=lng0;lat=lat0;
for(var i=0;i<n;i++){
 lngx=lng+(i/n-0.5)*(lng1-lng)*2;
 //lngx=lng5+(i/n)*10;
 for(var j=0;j<n;j++){
    laty=lat+(j/n-0.5)*(lat1-lat)*2;	
	var h=0.12*(getsrtmheight(lngx,laty)-14-4);
	if(h<0){h=-0.15;}
	height1[i*n+j]=h;//h;
	//auxvar=Math.min(auxvar,height1[i*n+j]);
   }
 }
}
function getsrtmheight(lngx,laty){
	//var wx=worldx+(px-xmaxmin2)*scaletexture*10;
	//var wy=worldy+(py-ymaxmin2)*scaletexture*10;
	var jj=-1;
	for(var ii=0;ii<4;ii++){
	  if(Math.abs(lngx-srtmlng[ii])<2.5){
	   if(Math.abs(laty-srtmlat[ii])<2.5){
	     jj=ii;break;}}
	}
	if(jj<0){return -0.5;}
	//auxvar=Math.max(auxvar,jj);
	//auxvar+=1;
	var nny=0.0001+599.99*(lngx-srtmlng[jj]+2.5)/5;
	var nnx=0.0001+599.99*(laty-srtmlat[jj]+2.5)/5;
	nnx=600-nnx;
	//if(nnx>=ndata){nnx=ndata-1;}
	//if(nny>=ndata){nny=ndata-1;}
	//if(nnx<0){nnx=0;}
	//if(nny<0){nny=0;}
	var i=parseInt(nnx),j=parseInt(nny);
	var dx=nnx-i,dy=nny-j;
	var i1=i+1,j1=j+1,ndata=600;
	if(i1>=ndata){i1=ndata-1;}
	if(j1>=ndata){j1=ndata-1;}
	//var h=srtmdata[jj][i*ndata+j];
	//auxvar=i+10000*j;//Math.max(h,auxvar);
	//return h;
if(dx<=(1.0-dy)){ 
    var z00=srtmdata[jj][i*ndata+j];
    var z10=srtmdata[jj][i1*ndata+j];
    var z01=srtmdata[jj][i*ndata+j1];
    return ( dx*(z10-z00) +dy*(z01-z00) +z00);
}else{
    var z10=srtmdata[jj][i1*ndata+j];
    var z01=srtmdata[jj][i*ndata+j1];
    var z11=srtmdata[jj][i1*ndata+j1];
    return ( (1-dx)*(z01-z11) +(1-dy)*(z10-z11) +z11 );
	}
}
/*var map=new nogoogle.maps.Map(document.getElementById('mapdiv'), {
    center: new nogoogle.maps.LatLng(lat,lng),
    //disableDefaultUI:true,
	mapTypeId: nogoogle.maps.MapTypeId.HYBRID,
	zoom: 11 });
*/	
starname2[1]="the sun";startext[1]="a yellow star";
var tspeak=0,isoleilmin0=0,isoleilmin1=0;
function testspeak(){
  if(tspeak==0){tspeak=tframe;}
  if(tframe<tspeak+7000){return;}
  if(isoleilmin1!=isoleilmin0){
     tspeak=tframe;
	 try{
	 if(isoleilmin1==0){
	   switch (parseInt(Math.random()*4)){
	    case 0:speak("you are leaving "+starname2[isoleilmin0]+" stellar system");break;
	    case 1:speak("you are leaving "+starname2[isoleilmin0]+" stellar space");break;
	    case 2:speak("you are leaving "+starname2[isoleilmin0]+" solar system");break;
	    case 3:speak("you are leaving "+starname2[isoleilmin0]+" solar space");break;
		}}
	 if(isoleilmin1>0){
	   switch (parseInt(Math.random()*4)){
	    case 0:speak("you are entering "+starname2[isoleilmin1]+" stellar system");break;
	    case 1:speak("you are entering "+starname2[isoleilmin1]+" stellar space");break;
	    case 2:speak("you are entering "+starname2[isoleilmin1]+" solar system");break;
	    case 3:speak("you are entering "+starname2[isoleilmin1]+" solar space");break;
		}}
	 }catch(e){}
	 isoleilmin0=isoleilmin1;
	 }
}
/*interface Storage {
  getter any getItem(in DOMString key);
  setter creator void setItem(in DOMString key, in any data);
  deleter void removeItem(in DOMString key);
  void clear();
};*/
/*alert(localStorage);
localStorage.setItem("myvar","myvartest");
alert(localStorage.getItem("myvar"));
localStorage.clear();
alert(localStorage.getItem("myvar"));*/
 //tkey=timer();
 //testkeys();
 //document.getElementById('intext').focus();
  try{initparms();}catch(e){alert("error initparms()");}
  webGLStart();
speak("hello , how are you");

</script>
<script type="text/javascript" src="stats.js">
</script>
</body>
</html>
